<!-- /auth/admin-clients.html -->
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"/>
  <title>Administration clients ‚Äî Cofel</title>

  <!-- üîí Protection identique au portail interne -->
  <script src="./lock.js" type="module"></script>

  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

  <style>
    :root{
      --cofel:#5a2d82; --cofel-2:#7838a7;
      --glass: rgba(255,255,255,.12);
      --glass-soft: rgba(255,255,255,.06);
      --txt:#f5f7ff; --txt-dim:#dcd6ff; --accent:#c9b7ff;
      --radius:18px; --blur:18px; --shadow:0 10px 30px rgba(0,0,0,.35);
    }

    *{box-sizing:border-box;}
    html,body{height:100%; margin:0; padding:0;}

    body{
      color:var(--txt);
      font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text","Segoe UI",Roboto,Arial,sans-serif;
      background:
        radial-gradient(800px 500px at 20% -10%, rgba(255,255,255,.10), transparent 60%),
        radial-gradient(800px 500px at 110% 10%, rgba(255,255,255,.08), transparent 60%),
        linear-gradient(135deg, var(--cofel), var(--cofel-2));
      padding:20px;
    }

    .shell{
      max-width:1200px;
      margin:0 auto;
      width:100%;
    }

    /* HEADER */
    header{
      display:flex;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:18px;
    }

    .brand{
      display:flex; align-items:center; gap:12px;
      flex:1 1 auto;
    }
    .brand img{height:40px; border-radius:10px;}
    h1{margin:0; font-size:20px;}

    .actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }

    .btn{
      appearance:none; border:none; cursor:pointer;
      background:#fff; color:#1a102b;
      padding:10px 18px; border-radius:999px;
      font-weight:700; font-size:14px;
      box-shadow:0 10px 24px rgba(0,0,0,.25);
    }

    /* TABS */
    .tabs{
      display:flex;
      gap:10px;
      margin-bottom:18px;
      overflow-x:auto;
      -webkit-overflow-scrolling:touch;
    }

    .tab-btn{
      padding:10px 20px; cursor:pointer;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.35);
      background:rgba(0,0,0,.25); color:#fff;
      font-size:14px; font-weight:600;
      white-space:nowrap;
      flex-shrink:0;
    }
    .tab-btn.active{ background:#fff; color:#1a102b; }

    /* PANELS */
    .tab-panel{ display:none; }
    .tab-panel.active{ display:block; }

    .card{
      background:rgba(6,4,18,.85);
      border-radius:var(--radius);
      border:1px solid rgba(255,255,255,.22);
      box-shadow:var(--shadow);
      padding:16px;
      backdrop-filter:blur(var(--blur));
      width:100%;
      overflow:hidden;
    }

    /* TABLEAU RESPONSIVE */
    .table-container{
      width:100%;
      overflow-x:auto;
      -webkit-overflow-scrolling:touch;
    }

    table{
      width:100%;
      min-width:750px;
      border-collapse:collapse;
    }

    th, td{
      padding:10px 12px;
      font-size:14px;
    }

    th{
      background:rgba(0,0,0,.25);
      border-bottom:1px solid rgba(255,255,255,.22);
      text-transform:uppercase;
      color:var(--accent);
      font-size:11px;
    }

    .btn-row{
      padding:6px 10px; cursor:pointer; border-radius:8px;
      font-size:12px; margin:2px; border:none;
    }
    .btn-approve{ background:#4caf50; color:#fff; font-weight:700; }
    .btn-row-secondary{ background:#555; color:#fff; }
    .btn-row-reset{ background:#ffca28; color:#000; font-weight:700; }
    .btn-row-delete{ background:#c62828; color:#fff; }

    .empty{ text-align:center; padding:12px; color:var(--txt-dim); }

    /* MODALES */
    #modalApprove, #modalCreate{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.6);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:20;
      padding:20px;
    }

    .modal-card{
      width:100%;
      max-width:420px;
      background:rgba(25,15,45,.95);
      border-radius:16px;
      padding:20px;
      border:1px solid rgba(255,255,255,.22);
      box-shadow:0 12px 40px rgba(0,0,0,.45);
    }

    .modal-card h3{ margin-top:0; font-size:17px; }

    .modal-field{ margin-bottom:12px; }
    .modal-field label{ font-size:12px; color:var(--txt-dim); }
    .modal-field input,
    .modal-field select{
      width:100%; padding:12px; font-size:15px;
      background:rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.25);
      border-radius:8px; color:#fff;
    }

    .modal-actions{ text-align:right; margin-top:16px; }

    .btn-modal{
      padding:10px 16px; border:none; cursor:pointer;
      border-radius:999px; font-size:14px; font-weight:700;
    }
    .btn-cancel{ background:rgba(255,255,255,.08); color:#fff; }
    .btn-ok{ background:#fff; color:#1a102b; }

    /* üì± MOBILE ‚Äì OPTIMISATION iPhone */
    @media(max-width:700px){

      body{
        padding:10px;
      }

      h1{ font-size:18px; }

      .brand img{height:32px;}

      .btn{
        padding:12px 20px;
        font-size:15px;
      }

      .btn-row{
        padding:8px 12px;
        font-size:13px;
      }

      table{
        min-width:650px;
      }

      .modal-card{
        width:90%;
        padding:20px;
      }

      .table-container{
        margin-bottom:14px;
        border-radius:12px;
        border:1px solid rgba(255,255,255,.12);
      }
    }
  </style>

</head>

<body>

<script>
// V√©rifier que l'utilisateur connect√© est l'administrateur
const profile = JSON.parse(localStorage.getItem("cofel_client_profile") || "{}");

if (profile.email !== "commercial@cofel72.fr") {
    alert("‚õî Acc√®s r√©serv√© √† l'administrateur.");
    window.location.href = "../index.html";
}
</script>

<div class="shell">

  <header>
    <div class="brand">
      <img src="../assets/logo cofel.jpg">
      <h1>Administration des comptes clients</h1>
    </div>

    <div class="actions">
      <button id="btnCreateClient" class="btn">‚ûï Cr√©er un client</button>
      <button id="btnBack" class="btn">‚¨Ö Retour</button>
    </div>
  </header>

  <!-- TABS -->
  <div class="tabs">
    <button class="tab-btn active" data-tab="clients">Clients</button>
    <button class="tab-btn" data-tab="requests">Demandes</button>
  </div>

  <!-- PANEL : CLIENTS -->
  <div id="clients" class="tab-panel active">
    <div class="card">
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>Email</th>
              <th>Soci√©t√©</th>
              <th>Contact</th>
              <th>Remise</th>
              <th>Configs</th>
              <th>Statut</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="tbodyClients">
            <tr><td colspan="7" class="empty">Chargement‚Ä¶</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- PANEL : DEMANDES -->
  <div id="requests" class="tab-panel">
    <div class="card">
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>Soci√©t√©</th>
              <th>Nom</th>
              <th>Email</th>
              <th>T√©l√©phone</th>
              <th>Message</th>
              <th>Cr√©√©</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="reqTbody">
            <tr><td colspan="7" class="empty">Chargement‚Ä¶</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- MODALE APPROBATION -->
  <div id="modalApprove">
    <div class="modal-card">
      <h3>Approuver l‚Äôacc√®s</h3>

      <div class="modal-field">
        <label>Remise (%)</label>
        <input id="approveDiscount" type="number" min="0" max="90" value="0">
      </div>

      <div class="modal-actions">
        <button class="btn-modal btn-cancel" id="approveCancel">Annuler</button>
        <button class="btn-modal btn-ok" id="approveSave">Approuver</button>
      </div>

      <div id="approveMsg"></div>
    </div>
  </div>

  <!-- MODALE CREATION CLIENT -->
  <div id="modalCreate">
    <div class="modal-card">
      <h3>Cr√©er un client manuellement</h3>

      <div class="modal-field">
        <label>Email</label>
        <input id="createEmail" type="email" placeholder="client@exemple.com">
      </div>

      <div class="modal-field">
        <label>Soci√©t√©</label>
        <input id="createCompany" type="text" placeholder="Nom de soci√©t√©">
      </div>

      <div class="modal-field">
        <label>Nom du contact</label>
        <input id="createName" type="text" placeholder="Nom et pr√©nom">
      </div>

      <div class="modal-field">
        <label>Remise (%)</label>
        <input id="createDiscount" type="number" min="0" max="90" value="0">
      </div>

      <div class="modal-actions">
        <button class="btn-modal btn-cancel" id="createCancel">Annuler</button>
        <button class="btn-modal btn-ok" id="createSave">Cr√©er</button>
      </div>

      <div id="createMsg" style="margin-top:10px;"></div>
    </div>
  </div>

</div>

<script>
/* ===================== LOGIQUE DE LA PAGE ===================== */

const WORKER_BASE = "https://cofel-auth.sonveven.workers.dev";

/* TABS */
const tabButtons = document.querySelectorAll(".tab-btn");
const tabPanels  = document.querySelectorAll(".tab-panel");

tabButtons.forEach(btn => {
  btn.addEventListener("click", () => {
    tabButtons.forEach(b => b.classList.remove("active"));
    btn.classList.add("active");

    const target = btn.getAttribute("data-tab");

    tabPanels.forEach(p => {
      p.classList.remove("active");
      if (p.id === target) p.classList.add("active");
    });
  });
});

/* ===================== TABLEAU CLIENTS ===================== */

const tbodyClients = document.getElementById("tbodyClients");

function formatRate(rate){
  return ((rate || 0) * 100).toFixed(1) + " %";
}

function formatDate(iso){
  if(!iso) return "‚Äî";
  const d = new Date(iso);
  if(isNaN(d)) return "‚Äî";
  return d.toLocaleDateString("fr-FR") + " " + d.toLocaleTimeString("fr-FR",{hour:"2-digit",minute:"2-digit"});
}

async function loadClients(){
  tbodyClients.innerHTML = `<tr><td colspan="7" class="empty">Chargement‚Ä¶</td></tr>`;
  try{
    const r = await fetch(`${WORKER_BASE}/clients`);
    const data = await r.json();

    if(!data.clients || !data.clients.length){
      tbodyClients.innerHTML = `<tr><td colspan="7" class="empty">Aucun client.</td></tr>`;
      return;
    }

    tbodyClients.innerHTML = data.clients.map(c => {
      const status = c.status === "active" ? "üü¢ Actif" : "üî¥ Inactif";
      const configs = JSON.parse(c.allowed_configurators || "[]");

      return `
        <tr>
          <td>${c.email}</td>
          <td>${c.company || "‚Äî"}</td>
          <td>${c.contact_name || "‚Äî"}</td>
          <td>${formatRate(c.discount_rate)}</td>
          <td>${configs.join(", ") || "‚Äî"}</td>
          <td>${status}</td>
          <td>
            <button class="btn-row btn-row-secondary btn-edit" data-email="${c.email}">‚úè Modifier</button>
            <button class="btn-row btn-row-reset btn-reset" data-email="${c.email}">üîÅ Reset MDP</button>
            <button class="btn-row btn-row-delete btn-delete" data-email="${c.email}">üóë Supprimer</button>
          </td>
        </tr>
      `;
    }).join("");

  } catch(err){
    tbodyClients.innerHTML = `<tr><td colspan="7" class="empty">Erreur de chargement.</td></tr>`;
  }
}

/* ===================== ACTIONS CLIENTS ===================== */

tbodyClients.addEventListener("click", async e => {
  const email = e.target.dataset.email;
  if (!email) return;

  /* Reset mot de passe */
  if (e.target.classList.contains("btn-reset")){
    if (!confirm("R√©initialiser le mot de passe ?")) return;

    const r = await fetch(`${WORKER_BASE}/client-reset-password`, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ email })
    });

    const out = await r.json();
    alert("Nouveau mot de passe : " + out.password);
    return;
  }

  /* Supprimer */
  if (e.target.classList.contains("btn-delete")){
    if (!confirm("Supprimer ce client ?")) return;

    await fetch(`${WORKER_BASE}/client-delete`, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ email })
    });

    alert("Client supprim√©.");
    loadClients();
    return;
  }

  /* Modifier */
  if (e.target.classList.contains("btn-edit")){
    window.open(
      `./edit-client.html?email=${encodeURIComponent(email)}`,
      "_blank",
      "width=520,height=720,top=100,left=100"
    );
    return;
  }
});

/* ===================== TABLEAU DEMANDES ===================== */

const reqTbody = document.getElementById("reqTbody");
let approvalTargetId = null;

async function loadRequests(){
  reqTbody.innerHTML = `<tr><td colspan="7" class="empty">Chargement‚Ä¶</td></tr>`;
  
  try{
    const r = await fetch(`${WORKER_BASE}/pending-requests`);
    const data = await r.json();

    if(!data.requests || !data.requests.length){
      reqTbody.innerHTML = `<tr><td colspan="7" class="empty">Aucune demande en attente.</td></tr>`;
      return;
    }

    reqTbody.innerHTML = data.requests.map(r => `
      <tr>
        <td>${r.company}</td>
        <td>${r.name}</td>
        <td>${r.email}</td>
        <td>${r.phone || "‚Äî"}</td>
        <td>${r.message || "‚Äî"}</td>
        <td>${formatDate(r.created_at)}</td>
        <td>
          <button class="btn-row btn-approve" data-id="${r.id}">‚úî</button>
          <button class="btn-row btn-row-secondary btn-reject" data-id="${r.id}">‚ùå</button>
        </td>
      </tr>
    `).join("");

  }catch(err){
    reqTbody.innerHTML = `<tr><td colspan="7" class="empty">Erreur de chargement.</td></tr>`;
  }
}

/* ACTIONS DEMANDES */

reqTbody.addEventListener("click", async e => {
  const id = e.target.dataset.id;
  if (!id) return;

  /* Refuser */
  if (e.target.classList.contains("btn-reject")){
    if (!confirm("Refuser cette demande ?")) return;

    await fetch(`${WORKER_BASE}/access-request-reject`, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ id })
    });

    alert("Demande refus√©e.");
    loadRequests();
    return;
  }

  /* Approuver */
  if (e.target.classList.contains("btn-approve")){
    approvalTargetId = id;
    document.getElementById("modalApprove").style.display = "flex";
  }
});

/* BOUTON RETOUR */
document.getElementById("btnBack").onclick = () => {
  location.href = "../index.html";
};

/* CHARGEMENT */
loadClients();
loadRequests();

/* APPROBATION */
const modalApprove = document.getElementById("modalApprove");
const approveDiscount = document.getElementById("approveDiscount");
const approveMsg = document.getElementById("approveMsg");

document.getElementById("approveCancel").onclick = () => {
  modalApprove.style.display = "none";
  approveMsg.textContent = "";
};

document.getElementById("approveSave").onclick = async () => {

  if (!approvalTargetId){
    alert("Erreur : aucun ID de demande.");
    return;
  }

  approveMsg.textContent = "";
  approveMsg.style.color = "#ffb3b3";

  const discount = Number(approveDiscount.value || 0);
  if (discount < 0 || discount > 90){
    approveMsg.textContent = "Remise invalide.";
    return;
  }

  try{
    const res = await fetch(`${WORKER_BASE}/admin-approve`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        requestId: approvalTargetId,
        discount: discount,
        configs: [
          "enseigne-drapeau",
          "lettre-alu-alupvc",
          "lettre-boitier",
          "lettres-pvc",
          "rampe-lumineuse",
          "tole-tablette",
          "tolerie-dibond",
          "totems"
        ]
      })
    });

    const out = await res.json();
    if (!out.ok) throw new Error();

  } catch(err){
    approveMsg.textContent = "Erreur serveur.";
    return;
  }

  approveMsg.style.color = "#b7ffcf";
  approveMsg.textContent = "Acc√®s approuv√©.";
  alert("Acc√®s approuv√©.");

  modalApprove.style.display = "none";
  loadRequests();
  loadClients();
};

/* CREATION */
const modalCreate   = document.getElementById("modalCreate");
const btnCreate     = document.getElementById("btnCreateClient");
const createEmail   = document.getElementById("createEmail");
const createCompany = document.getElementById("createCompany");
const createName    = document.getElementById("createName");
const createDiscount= document.getElementById("createDiscount");
const createMsg     = document.getElementById("createMsg");

btnCreate.onclick = () => {
  createEmail.value   = "";
  createCompany.value = "";
  createName.value    = "";
  createDiscount.value= "0";
  createMsg.textContent = "";
  modalCreate.style.display = "flex";
};

document.getElementById("createCancel").onclick = () => {
  modalCreate.style.display = "none";
};

document.getElementById("createSave").onclick = async () => {
  createMsg.textContent = "";
  createMsg.style.color = "#ffb3b3";

  const email = (createEmail.value || "").trim();
  if (!email.includes("@")){
    createMsg.textContent = "Email invalide.";
    return;
  }

  const discount = Number(createDiscount.value || 0);
  if (discount < 0 || discount > 90){
    createMsg.textContent = "Remise incorrecte.";
    return;
  }

  try{
    const r = await fetch(`${WORKER_BASE}/client-create`, {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({
        email,
        company: (createCompany.value || "").trim(),
        name: (createName.value || "").trim(),
        discount,
        configs: [
          "enseigne-drapeau",
          "lettre-alu-alupvc",
          "lettre-boitier",
          "lettres-pvc",
          "rampe-lumineuse",
          "tole-tablette",
          "tolerie-dibond",
          "totems"
        ]
      })
    });

    const out = await r.json();

    if(!out.ok){
      createMsg.textContent = "Erreur.";
      return;
    }

    createMsg.style.color = "#b7ffcf";
    createMsg.textContent = "Client cr√©√©.";

    alert("Client cr√©√© ! Mot de passe : " + out.password);

    modalCreate.style.display = "none";
    loadClients();

  }catch(err){
    createMsg.textContent = "Erreur serveur.";
  }
};
</script>

</body>
</html>

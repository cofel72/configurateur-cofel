<!-- /auth/admin-clients.html -->
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"/>
  <title>Administration clients ‚Äî Cofel</title>

  <!-- üîí Protection identique au portail interne -->
  <script src="./lock.js" type="module"></script>

  <!-- ‚úÖ CSS commun + th√®me DARK -->
  <link rel="stylesheet" href="../styles/cofel.css" />
  <link rel="stylesheet" href="../styles/cofel-components.css" />
  <link rel="stylesheet" href="../styles/cofel-glass.css" />
  <link rel="stylesheet" href="/styles/cofel-theme-apple-dark.css" />

  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

<style>
  :root{
    --txt:#f5f7ff;
    --txt-dim: rgba(255,255,255,.68);
    --accent: rgba(255,255,255,.82);
    --radius:18px;
    --blur:18px;
    --shadow: 0 10px 30px rgba(0,0,0,.35);

    --glass: rgba(255,255,255,.10);
    --glass-soft: rgba(255,255,255,.06);
    --stroke: rgba(255,255,255,.18);
    --stroke-soft: rgba(255,255,255,.12);
  }

  *{box-sizing:border-box;}
  html,body{height:100%; margin:0; padding:0;}

  body{
    color:var(--txt);
    font-family:-apple-system,"SF Pro Text",BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
    background:#000;                 /* ‚úÖ plus de violet */
    padding:20px;
  }

  .shell{
    max-width:1200px;
    margin:0 auto;
    width:100%;
  }

  /* HEADER */
  header{
    display:flex;
    flex-wrap:wrap;
    align-items:center;
    justify-content:space-between;
    gap:12px;
    margin-bottom:18px;

    padding:14px 14px;
    border-radius:20px;
    background: rgba(255,255,255,.06);
    border:1px solid var(--stroke-soft);
    backdrop-filter: blur(var(--blur));
    -webkit-backdrop-filter: blur(var(--blur));
    box-shadow: var(--shadow);
  }

  .brand{
    display:flex; align-items:center; gap:12px;
    flex:1;
    min-width:240px;
  }
  .brand img{height:40px; width:auto; border-radius:10px;}
  h1{margin:0; font-size:18px; letter-spacing:.2px;}

  .actions{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    justify-content:flex-end;
  }

  /* ‚úÖ Boutons (plus de blanc) */
  .btn{
    appearance:none;
    border:none;
    cursor:pointer;
    font-weight:800;
    color:var(--txt);
    background: linear-gradient(180deg, rgba(255,255,255,.14), rgba(255,255,255,.06));
    border:1px solid rgba(255,255,255,.18);
    border-radius:999px;
    padding:10px 16px;
    box-shadow: 0 10px 24px rgba(0,0,0,.25);
    backdrop-filter: blur(var(--blur));
    -webkit-backdrop-filter: blur(var(--blur));
    transition: transform .16s, box-shadow .16s, background .16s, opacity .16s;
  }
  .btn:hover{
    background: linear-gradient(180deg, rgba(255,255,255,.18), rgba(255,255,255,.08));
    transform: translateY(-1px);
    box-shadow: 0 14px 30px rgba(0,0,0,.35);
  }
  .btn:active{
    transform: translateY(1px);
    box-shadow: 0 6px 16px rgba(0,0,0,.28);
  }

  /* TABS */
  .tabs{
    display:flex;
    gap:10px;
    margin-bottom:18px;
    overflow-x:auto;
    padding-bottom:2px;
  }

  .tab-btn{
    padding:10px 18px;
    border-radius:999px;
    border:1px solid rgba(255,255,255,.18);
    background: rgba(255,255,255,.06);
    color: rgba(255,255,255,.86);
    font-size:14px;
    font-weight:800;
    white-space:nowrap;
    cursor:pointer;
    transition: background .16s, transform .16s, box-shadow .16s, border-color .16s;
  }
  .tab-btn:hover{
    background: rgba(255,255,255,.10);
    transform: translateY(-1px);
    box-shadow: 0 10px 24px rgba(0,0,0,.22);
  }
  .tab-btn.active{
    background: linear-gradient(180deg, rgba(255,255,255,.18), rgba(255,255,255,.08));
    border-color: rgba(255,255,255,.26);
    color:#fff;
  }

  .tab-panel{ display:none; }
  .tab-panel.active{ display:block; }

  .card{
    background: rgba(255,255,255,.06);
    border:1px solid rgba(255,255,255,.14);
    border-radius:var(--radius);
    box-shadow:var(--shadow);
    padding:16px;
    backdrop-filter: blur(var(--blur));
    -webkit-backdrop-filter: blur(var(--blur));
  }

  /* Recherche */
  #searchClient{
    width:100%;
    padding:12px;
    border-radius:14px;
    border:1px solid rgba(255,255,255,.18);
    margin-bottom:14px;
    font-size:15px;
    background:rgba(255,255,255,.06);
    color:var(--txt);
    outline:none;
    transition: border-color .18s, box-shadow .18s, background .18s;
  }
  #searchClient::placeholder{ color: rgba(255,255,255,.55); }
  #searchClient:focus{
    border-color: rgba(255,255,255,.34);
    background: rgba(255,255,255,.08);
    box-shadow: 0 0 0 3px rgba(255,255,255,.14);
  }

  /*******************************
     AFFICHAGE NORMAL (DESKTOP)
  *******************************/
  table{
    width:100%;
    border-collapse:collapse;
  }
  th, td{
    padding:10px;
    font-size:14px;
    vertical-align:top;
  }
  th{
    background: rgba(255,255,255,.06);
    color: rgba(255,255,255,.75);
    font-size:11px;
    text-transform:uppercase;
    letter-spacing:.35px;
    border-bottom:1px solid rgba(255,255,255,.12);
  }
  tbody tr + tr td{
    border-top:1px solid rgba(255,255,255,.08);
  }
  td{ color: rgba(255,255,255,.92); }

  .empty{ color: var(--txt-dim); }

  /* ‚úÖ Boutons actions ligne harmonis√©s */
  .btn-row{
    appearance:none;
    border:none;
    cursor:pointer;
    font-weight:800;
    padding:8px 10px;
    font-size:12px;
    border-radius:10px;
    color:#fff;
    background: linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.06));
    border:1px solid rgba(255,255,255,.16);
    box-shadow: 0 10px 22px rgba(0,0,0,.22);
    transition: transform .16s, box-shadow .16s, background .16s, opacity .16s;
    margin:2px 4px 2px 0;
  }
  .btn-row:hover{
    background: linear-gradient(180deg, rgba(255,255,255,.16), rgba(255,255,255,.08));
    transform: translateY(-1px);
    box-shadow: 0 14px 28px rgba(0,0,0,.32);
  }
  .btn-row:active{
    transform: translateY(1px);
    box-shadow: 0 6px 16px rgba(0,0,0,.26);
  }

  /* Variantes (reste lisible, pas flashy) */
  .btn-approve{ border-color: rgba(140,255,190,.35); }
  .btn-row-secondary{ border-color: rgba(255,255,255,.18); opacity:.95; }
  .btn-row-reset{ border-color: rgba(255,220,120,.35); color:#fff; }
  .btn-row-delete{ border-color: rgba(255,120,120,.40); color:#fff; }

  /*******************************
       MODE PORTRAIT iPHONE
       ‚Üí Table transform√©e en cartes
  *******************************/
  @media(max-width:700px){

    thead{ display:none; }

    table tr{
      display:block;
      background: rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.12);
      margin-bottom:12px;
      padding:12px;
      border-radius:14px;
    }

    table td{
      display:flex;
      justify-content:space-between;
      padding:8px 4px;
      font-size:15px;
      border-bottom:1px solid rgba(255,255,255,0.08);
    }
    table td:last-child{ border-bottom:none; }

    table td:nth-child(1)::before{content:"Email : "; color: rgba(255,255,255,.72);}
    table td:nth-child(2)::before{content:"Soci√©t√© : "; color: rgba(255,255,255,.72);}
    table td:nth-child(3)::before{content:"Contact : "; color: rgba(255,255,255,.72);}
    table td:nth-child(4)::before{content:"Remise : "; color: rgba(255,255,255,.72);}
    table td:nth-child(5)::before{content:"Remise SR : "; color: rgba(255,255,255,.72);}
    table td:nth-child(6)::before{content:"Configs : "; color: rgba(255,255,255,.72);}
    table td:nth-child(7)::before{content:"Statut : "; color: rgba(255,255,255,.72);}
    table td:nth-child(8)::before{content:"Actions : "; color: rgba(255,255,255,.72);}

    .btn-row{
      padding:10px 14px;
      font-size:14px;
      margin:4px 2px;
    }

    h1{ font-size:16px; }
    body{ padding:12px; }
  }

  /*******************************
       MODALES
  *******************************/
  #modalApprove,#modalCreate{
    position:fixed;
    inset:0;
    background:rgba(0,0,0,.70);
    display:none;
    align-items:center;
    justify-content:center;
    z-index:20;
    padding:20px;
  }
  .modal-card{
    background: rgba(255,255,255,.08);
    border:1px solid rgba(255,255,255,.16);
    box-shadow: 0 16px 40px rgba(0,0,0,.45);
    backdrop-filter: blur(var(--blur));
    -webkit-backdrop-filter: blur(var(--blur));
    padding:18px;
    border-radius:16px;
    width:100%;
    max-width:420px;
  }
  .modal-card h3{ margin:0 0 12px; letter-spacing:.2px; }

  .modal-field{ margin-bottom:12px; }
  .modal-field label{
    display:block;
    font-weight:800;
    font-size:12px;
    color: rgba(255,255,255,.78);
    margin-bottom:6px;
  }
  .modal-field input,.modal-field select{
    width:100%;
    padding:12px;
    font-size:15px;
    background:rgba(255,255,255,.06);
    border-radius:14px;
    border:1px solid rgba(255,255,255,.18);
    color:#fff;
    outline:none;
  }
  .modal-field input:focus,.modal-field select:focus{
    border-color: rgba(255,255,255,.34);
    box-shadow: 0 0 0 3px rgba(255,255,255,.14);
  }

  .modal-actions{
    display:flex;
    gap:10px;
    justify-content:flex-end;
    margin-top:12px;
  }

  .btn-modal{
    appearance:none;
    border:none;
    cursor:pointer;
    font-weight:900;
    padding:10px 14px;
    border-radius:999px;
    color:#fff;
    background: linear-gradient(180deg, rgba(255,255,255,.14), rgba(255,255,255,.06));
    border:1px solid rgba(255,255,255,.18);
    box-shadow: 0 10px 22px rgba(0,0,0,.22);
    transition: transform .16s, box-shadow .16s, background .16s;
  }
  .btn-modal:hover{
    background: linear-gradient(180deg, rgba(255,255,255,.18), rgba(255,255,255,.08));
    transform: translateY(-1px);
    box-shadow: 0 14px 28px rgba(0,0,0,.32);
  }
  .btn-modal:active{
    transform: translateY(1px);
    box-shadow: 0 6px 16px rgba(0,0,0,.26);
  }
  .btn-cancel{
    background: rgba(255,255,255,.08);
    border:1px solid rgba(255,255,255,.14);
  }

</style>
</head>

<body>

<script>
/****************************************************
 * PROTECTION ADMIN ‚Äî acc√®s r√©serv√© aux FULL ADMINS
 ****************************************************/
const profile = JSON.parse(localStorage.getItem("cofel_client_profile") || "{}");
const FULL_ADMINS = ["commercial@cofel72.fr"];
if (!FULL_ADMINS.includes(profile.email || "")) {
  alert("‚õî Acc√®s r√©serv√© √† l'administrateur complet.");
  window.location.href = "../index.html";
}
</script>

<div class="shell">

  <header>
    <div class="brand">
      <img src="../assets/logo cofel.jpg" alt="Cofel">
      <h1>Administration des comptes clients</h1>
    </div>

    <div class="actions">
      <button id="btnCreateClient" class="btn">‚ûï Cr√©er un client</button>
      <button id="btnBack" class="btn">‚¨Ö Retour</button>
    </div>
  </header>

  <!-- ===== M√âMO REMISES (indicatif) ===== -->
  <section class="memo-remises" style="
    margin:14px 0 18px;
    padding:14px 16px;
    border-radius:16px;
    background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.05));
    border:1px solid rgba(255,255,255,.14);
    backdrop-filter: blur(var(--blur));
    -webkit-backdrop-filter: blur(var(--blur));
  ">
    <h3 style="margin:0 0 8px;">üìù M√©mo remises SR (indicatif)</h3>
    <ul style="margin:0; padding-left:18px; line-height:1.5;">
      <li><b>Megamark</b> : -60% <span style="opacity:.85;">(discount_sr = 0.60)</span></li>
      <li><b>Pano</b> : -50% <span style="opacity:.85;">(discount_sr = 0.50)</span></li>
      <li><b>Client Cofel</b> : -40% <span style="opacity:.85;">(discount_sr = 0.40)</span></li>
    </ul>
    <div style="margin-top:8px; opacity:.85; font-size:12px;">
      Info interne / aide-m√©moire ‚Äî n‚Äôimpacte pas les prix ni les clients.
    </div>
  </section>

  <!-- TABS -->
  <div class="tabs">
    <button class="tab-btn active" data-tab="clients">Clients</button>
    <button class="tab-btn" data-tab="requests">Demandes</button>
  </div>

  <!-- PANEL : CLIENTS -->
  <div id="clients" class="tab-panel active">

    <!-- üîé RECHERCHE CLIENTS -->
    <input
      id="searchClient"
      type="text"
      placeholder="Rechercher (email, soci√©t√©, contact‚Ä¶)"
    />

    <div class="card">
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>Email</th>
              <th>Soci√©t√©</th>
              <th>Contact</th>
              <th>Remise</th>
              <th>Remise SR</th>
              <th>Configs</th>
              <th>Statut</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="tbodyClients">
            <tr><td colspan="8" class="empty">Chargement‚Ä¶</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- PANEL : DEMANDES -->
  <div id="requests" class="tab-panel">
    <div class="card">
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>Soci√©t√©</th>
              <th>Nom</th>
              <th>Email</th>
              <th>T√©l√©phone</th>
              <th>Message</th>
              <th>Cr√©√©</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="reqTbody">
            <tr><td colspan="7" class="empty">Chargement‚Ä¶</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- MODALE APPROBATION -->
  <div id="modalApprove">
    <div class="modal-card">
      <h3>Approuver l‚Äôacc√®s</h3>

      <div class="modal-field">
        <label>Remise (%)</label>
        <input id="approveDiscount" type="number" min="0" max="90" value="0">
      </div>

      <div class="modal-field">
        <label>Remise SR (%)</label>
        <input id="approveDiscountSR" type="number" min="0" max="90" value="0">
      </div>

      <div class="modal-actions">
        <button class="btn-modal btn-cancel" id="approveCancel">Annuler</button>
        <button class="btn-modal" id="approveSave">Approuver</button>
      </div>

      <div id="approveMsg" style="margin-top:10px;"></div>
    </div>
  </div>

  <!-- MODALE CREATION CLIENT -->
  <div id="modalCreate">
    <div class="modal-card">
      <h3>Cr√©er un client manuellement</h3>

      <div class="modal-field">
        <label>Email</label>
        <input id="createEmail" type="email" placeholder="client@exemple.com">
      </div>

      <div class="modal-field">
        <label>Soci√©t√©</label>
        <input id="createCompany" type="text" placeholder="Nom de soci√©t√©">
      </div>

      <div class="modal-field">
        <label>Nom du contact</label>
        <input id="createName" type="text" placeholder="Nom et pr√©nom">
      </div>

      <div class="modal-field">
        <label>Remise (%)</label>
        <input id="createDiscount" type="number" min="0" max="90" value="0">
      </div>

      <div class="modal-field">
        <label>Remise SR (%)</label>
        <input id="createDiscountSR" type="number" min="0" max="90" value="0">
      </div>

      <div class="modal-actions">
        <button class="btn-modal btn-cancel" id="createCancel">Annuler</button>
        <button class="btn-modal" id="createSave">Cr√©er</button>
      </div>

      <div id="createMsg" style="margin-top:10px;"></div>
    </div>
  </div>

</div>

<script>
/* ===================== LOGIQUE DE LA PAGE ===================== */

const WORKER_BASE = "https://cofel-auth.sonveven.workers.dev";

/* TABS */
const tabButtons = document.querySelectorAll(".tab-btn");
const tabPanels  = document.querySelectorAll(".tab-panel");

tabButtons.forEach(btn => {
  btn.addEventListener("click", () => {
    tabButtons.forEach(b => b.classList.remove("active"));
    btn.classList.add("active");

    const target = btn.getAttribute("data-tab");

    tabPanels.forEach(p => {
      p.classList.remove("active");
      if (p.id === target) p.classList.add("active");
    });
  });
});

/* ===================== TABLEAU CLIENTS ===================== */

const tbodyClients = document.getElementById("tbodyClients");

/* ===================== RECHERCHE CLIENTS ===================== */
document.getElementById("searchClient").addEventListener("input", function () {
  const term = this.value.toLowerCase().trim();
  const rows = document.querySelectorAll("#tbodyClients tr");

  rows.forEach(row => {
    const text = row.innerText.toLowerCase();
    row.style.display = text.includes(term) ? "" : "none";
  });
});

function formatRate(rate){
  return ((rate || 0) * 100).toFixed(1) + " %";
}

function formatDate(iso){
  if(!iso) return "‚Äî";
  const d = new Date(iso);
  if(isNaN(d)) return "‚Äî";
  return d.toLocaleDateString("fr-FR") + " " + d.toLocaleTimeString("fr-FR",{hour:"2-digit",minute:"2-digit"});
}

async function loadClients(){
  tbodyClients.innerHTML = `<tr><td colspan="8" class="empty">Chargement‚Ä¶</td></tr>`;
  try{
    const r = await fetch(`${WORKER_BASE}/clients`);
    const data = await r.json();

    if(!data.clients || !data.clients.length){
      tbodyClients.innerHTML = `<tr><td colspan="8" class="empty">Aucun client.</td></tr>`;
      return;
    }

    tbodyClients.innerHTML = data.clients.map(c => {
      const status = c.status === "active" ? "üü¢ Actif" : "üî¥ Inactif";
      const configs = JSON.parse(c.allowed_configurators || "[]");

      return `
        <tr>
          <td>${c.email}</td>
          <td>${c.company || "‚Äî"}</td>
          <td>${c.contact_name || "‚Äî"}</td>
          <td>${formatRate(c.discount_rate)}</td>
          <td>${formatRate(c.discount_sr)}</td>
          <td>${configs.join(", ") || "‚Äî"}</td>
          <td>${status}</td>
          <td>
            <button class="btn-row btn-row-secondary btn-edit" data-email="${c.email}">‚úè Modifier</button>
            <button class="btn-row btn-row-reset btn-reset" data-email="${c.email}">üîÅ Reset MDP</button>
            <button class="btn-row btn-row-delete btn-delete" data-email="${c.email}">üóë Supprimer</button>
          </td>
        </tr>
      `;
    }).join("");

  } catch(err){
    tbodyClients.innerHTML = `<tr><td colspan="8" class="empty">Erreur de chargement.</td></tr>`;
  }
}

/* ===================== ACTIONS CLIENTS ===================== */

tbodyClients.addEventListener("click", async e => {
  const email = e.target.dataset.email;
  if (!email) return;

  /* Reset mot de passe */
  if (e.target.classList.contains("btn-reset")){
    if (!confirm("R√©initialiser le mot de passe ?")) return;

    const r = await fetch(`${WORKER_BASE}/client-reset-password`, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ email })
    });

    const out = await r.json();
    alert("Nouveau mot de passe : " + out.password);
    return;
  }

  /* Supprimer */
  if (e.target.classList.contains("btn-delete")){
    if (!confirm("Supprimer ce client ?")) return;

    await fetch(`${WORKER_BASE}/client-delete`, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ email })
    });

    alert("Client supprim√©.");
    loadClients();
    return;
  }

  /* Modifier */
  if (e.target.classList.contains("btn-edit")){
    window.open(
      `./edit-client.html?email=${encodeURIComponent(email)}`,
      "_blank",
      "width=520,height=720,top=100,left=100"
    );
    return;
  }
});

/* ===================== TABLEAU DEMANDES ===================== */

const reqTbody = document.getElementById("reqTbody");
let approvalTargetId = null;

async function loadRequests(){
  reqTbody.innerHTML = `<tr><td colspan="7" class="empty">Chargement‚Ä¶</td></tr>`;

  try{
    const r = await fetch(`${WORKER_BASE}/pending-requests`);
    const data = await r.json();

    if(!data.requests || !data.requests.length){
      reqTbody.innerHTML = `<tr><td colspan="7" class="empty">Aucune demande en attente.</td></tr>`;
      return;
    }

    reqTbody.innerHTML = data.requests.map(r => `
      <tr>
        <td>${r.company}</td>
        <td>${r.name}</td>
        <td>${r.email}</td>
        <td>${r.phone || "‚Äî"}</td>
        <td>${r.message || "‚Äî"}</td>
        <td>${formatDate(r.created_at)}</td>
        <td>
          <button class="btn-row btn-approve" data-id="${r.id}">‚úî</button>
          <button class="btn-row btn-row-secondary btn-reject" data-id="${r.id}">‚ùå</button>
        </td>
      </tr>
    `).join("");

  }catch(err){
    reqTbody.innerHTML = `<tr><td colspan="7" class="empty">Erreur de chargement.</td></tr>`;
  }
}

/* ACTIONS DEMANDES */

reqTbody.addEventListener("click", async e => {
  const id = e.target.dataset.id;
  if (!id) return;

  /* Refuser */
  if (e.target.classList.contains("btn-reject")){
    if (!confirm("Refuser cette demande ?")) return;

    await fetch(`${WORKER_BASE}/access-request-reject`, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ id })
    });

    alert("Demande refus√©e.");
    loadRequests();
    return;
  }

  /* Approuver */
  if (e.target.classList.contains("btn-approve")){
    approvalTargetId = id;
    document.getElementById("approveDiscount").value = "0";
    document.getElementById("approveDiscountSR").value = "0";
    document.getElementById("modalApprove").style.display = "flex";
  }
});

/* BOUTON RETOUR */
document.getElementById("btnBack").onclick = () => {
  location.href = "../index.html";
};

/* CHARGEMENT */
loadClients();
loadRequests();

/* APPROBATION */
const modalApprove = document.getElementById("modalApprove");
const approveDiscount = document.getElementById("approveDiscount");
const approveDiscountSR = document.getElementById("approveDiscountSR");
const approveMsg = document.getElementById("approveMsg");

document.getElementById("approveCancel").onclick = () => {
  modalApprove.style.display = "none";
  approveMsg.textContent = "";
};

document.getElementById("approveSave").onclick = async () => {

  if (!approvalTargetId){
    alert("Erreur : aucun ID de demande.");
    return;
  }

  approveMsg.textContent = "";
  approveMsg.style.color = "#ffb3b3";

  const discount = Number(approveDiscount.value || 0);
  if (discount < 0 || discount > 90){
    approveMsg.textContent = "Remise invalide.";
    return;
  }

  const discountSR = Number(approveDiscountSR.value || 0);
  if (discountSR < 0 || discountSR > 90){
    approveMsg.textContent = "Remise SR invalide.";
    return;
  }

  try{
    const res = await fetch(`${WORKER_BASE}/admin-approve`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        requestId: approvalTargetId,
        discount: discount,
        discount_sr: discountSR,
        configs: [
          "enseigne-drapeau",
          "lettre-alu-alupvc",
          "lettre-boitier",
          "lettres-pvc",
          "rampe-lumineuse",
          "tole-tablette",
          "tolerie-dibond",
          "totems",
          "souples-rigides-adhesifs"
        ]
      })
    });

    const out = await res.json();
    if (!out.ok) throw new Error();

  } catch(err){
    approveMsg.textContent = "Erreur serveur.";
    return;
  }

  approveMsg.style.color = "#b7ffcf";
  approveMsg.textContent = "Acc√®s approuv√©.";
  alert("Acc√®s approuv√©.");

  modalApprove.style.display = "none";
  loadRequests();
  loadClients();
};

/* CREATION */
const modalCreate   = document.getElementById("modalCreate");
const btnCreate     = document.getElementById("btnCreateClient");
const createEmail   = document.getElementById("createEmail");
const createCompany = document.getElementById("createCompany");
const createName    = document.getElementById("createName");
const createDiscount= document.getElementById("createDiscount");
const createDiscountSR= document.getElementById("createDiscountSR");
const createMsg     = document.getElementById("createMsg");

btnCreate.onclick = () => {
  createEmail.value   = "";
  createCompany.value = "";
  createName.value    = "";
  createDiscount.value= "0";
  createDiscountSR.value= "0";
  createMsg.textContent = "";
  modalCreate.style.display = "flex";
};

document.getElementById("createCancel").onclick = () => {
  modalCreate.style.display = "none";
};

document.getElementById("createSave").onclick = async () => {
  createMsg.textContent = "";
  createMsg.style.color = "#ffb3b3";

  const email = (createEmail.value || "").trim();
  if (!email.includes("@")){
    createMsg.textContent = "Email invalide.";
    return;
  }

  const discount = Number(createDiscount.value || 0);
  if (discount < 0 || discount > 90){
    createMsg.textContent = "Remise incorrecte.";
    return;
  }

  const discountSR = Number(createDiscountSR.value || 0);
  if (discountSR < 0 || discountSR > 90){
    createMsg.textContent = "Remise SR incorrecte.";
    return;
  }

  try{
    const r = await fetch(`${WORKER_BASE}/client-create`, {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({
        email,
        company: (createCompany.value || "").trim(),
        name: (createName.value || "").trim(),
        discount,
        discount_sr: discountSR,
        configs: [
          "enseigne-drapeau",
          "lettre-alu-alupvc",
          "lettre-boitier",
          "lettres-pvc",
          "rampe-lumineuse",
          "tole-tablette",
          "tolerie-dibond",
          "totems",
          "souples-rigides-adhesifs"
        ]
      })
    });

    const out = await r.json();

    if(!out.ok){
      createMsg.textContent = "Erreur.";
      return;
    }

    createMsg.style.color = "#b7ffcf";
    createMsg.textContent = "Client cr√©√©.";

    alert("Client cr√©√© ! Mot de passe : " + out.password);

    modalCreate.style.display = "none";
    loadClients();

  }catch(err){
    createMsg.textContent = "Erreur serveur.";
  }
};
</script>

</body>
</html>

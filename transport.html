<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Calculateur Transport ‚Äî Cofel</title>

  <!-- ‚úÖ CSS commun + th√®me DARK -->
  <link rel="stylesheet" href="./styles/cofel.css" />
  <link rel="stylesheet" href="./styles/cofel-components.css" />
  <link rel="stylesheet" href="./styles/cofel-glass.css" />
  <link rel="stylesheet" href="/styles/cofel-theme-apple-dark.css" />

  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

  <style>
    :root{
      --txt:#f5f7ff;
      --txt-dim: rgba(255,255,255,.68);
      --accent: rgba(255,255,255,.82);

      --glass1: rgba(255,255,255,.12);
      --glass2: rgba(255,255,255,.06);
      --border: rgba(255,255,255,.16);

      --radius:18px;
      --blur:18px;
      --shadow:0 10px 30px rgba(0,0,0,.45);
    }

    *{box-sizing:border-box}
    html,body{height:100%}

    body{
      margin:0;
      color:var(--txt);
      font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text","Segoe UI",Roboto,Arial,sans-serif;
      background:#000; /* ‚úÖ plus de violet */
    }

    .hero{ padding:22px 20px 10px; }
    .hero-inner{
      max-width:1100px; margin:0 auto;
      display:flex; align-items:center; justify-content:space-between; gap:14px;
    }

    .brand{
      display:flex; align-items:center; gap:12px;
      padding:10px 14px; border-radius:16px;
      background: linear-gradient(180deg, var(--glass1), var(--glass2));
      border:1px solid var(--border);
      backdrop-filter: blur(var(--blur));
      -webkit-backdrop-filter: blur(var(--blur));
      box-shadow: var(--shadow);
    }
    .brand img{height:42px; width:auto; border-radius:10px}
    .brand h1{ margin:0; font-size:20px; letter-spacing:.2px; }

    .hero-actions{ display:flex; align-items:center; gap:10px; }

    .wrap{ max-width:1100px; margin:18px auto 40px; padding:0 20px; }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.05));
      border:1px solid rgba(255,255,255,.14);
      border-radius:20px;
      padding:18px;
      box-shadow:var(--shadow);
      backdrop-filter: blur(var(--blur));
      -webkit-backdrop-filter: blur(var(--blur));
      margin-bottom:16px;
    }

    h2{ margin:0 0 12px; font-size: clamp(18px, 2.4vw, 22px); letter-spacing:.2px; }
    label{font-weight:800; font-size:12px; color:rgba(255,255,255,.78)}
    .grid{ display:grid; gap:12px; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); }

    select{
      width:100%;
      padding:12px;
      color:var(--txt);
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.16);
      border-radius:14px;
      outline:none;
      backdrop-filter: blur(var(--blur));
      -webkit-backdrop-filter: blur(var(--blur));
      appearance:none;
      transition: border-color .18s ease, background .18s ease, box-shadow .18s ease;
    }
    select:focus{
      border-color: rgba(255,255,255,.30);
      background: rgba(255,255,255,.08);
      box-shadow: 0 0 0 3px rgba(255,255,255,.12);
    }
    /* ‚úÖ options non violettes */
    select option{ background:#0b0b0b; color:#fff; }

    .price-box{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      background: linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.05));
      border:1px solid rgba(255,255,255,.14);
      border-radius:16px;
      padding:14px 16px;
      margin-top:12px;
    }
    .price{ font-size:24px; font-weight:900; letter-spacing:.2px; }
    .muted{ color:var(--txt-dim); font-size:12px; }

    .info-note{
      margin-top:14px;
      font-size:13px;
      color:var(--txt-dim);
      background: rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.12);
      border-radius:14px;
      padding:10px 12px;
    }

    /* ‚úÖ Boutons harmonis√©s (plus de blanc) */
    .btn{
      appearance:none;
      border:none;
      cursor:pointer;
      font-weight:900;
      color:var(--txt);
      background: linear-gradient(180deg, rgba(255,255,255,.14), rgba(255,255,255,.06));
      border:1px solid rgba(255,255,255,.18);
      border-radius:14px;
      padding:10px 14px;
      box-shadow: 0 10px 24px rgba(0,0,0,.25);
      backdrop-filter: blur(var(--blur));
      -webkit-backdrop-filter: blur(var(--blur));
      transition: transform .16s ease, box-shadow .16s ease, background .16s ease, opacity .16s ease;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    .btn:hover{
      background: linear-gradient(180deg, rgba(255,255,255,.18), rgba(255,255,255,.08));
      transform: translateY(-1px);
      box-shadow: 0 14px 30px rgba(0,0,0,.35);
    }
    .btn:active{ transform: translateY(1px); box-shadow: 0 6px 16px rgba(0,0,0,.28); }
    .btn[disabled]{ opacity:.45; cursor:not-allowed; box-shadow:none; transform:none; }

    .btn-ghost{
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.14);
    }

    .stack{ display:flex; gap:10px; flex-wrap:wrap; }

    .toast{
      position:fixed; right:16px; bottom:16px;
      background: rgba(255,255,255,.10);
      color: #fff;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.16);
      box-shadow: 0 12px 30px rgba(0,0,0,.45);
      backdrop-filter: blur(var(--blur));
      -webkit-backdrop-filter: blur(var(--blur));
      display:none;
      z-index:9999;
    }
    .toast.show{ display:block; }

    @media (max-width:720px){
      .brand h1{display:none;}
      .price{font-size:20px}
    }
    /* ‚úÖ FIX: texte lisible si la zone prix est claire */
.price-box{
  color:#0b0b0b; /* couleur par d√©faut √† l'int√©rieur de la box */
}

.price-box .muted{
  color: rgba(0,0,0,.65);
}

#priceValue{
  color:#0b0b0b; /* le montant */
  text-shadow:none;
}
/* ‚úÖ Message au-dessus du prix (contexte) : lisible */
#currentContext{
  color:#0b0b0b;              /* texte bien visible */
  opacity: .85;               /* un peu plus doux */
}

/* Optionnel : si tu veux aussi ‚Äúbooster‚Äù la lisibilit√© avec un fond */
#currentContext{
  display:inline-block;
  padding:4px 8px;
  border-radius:10px;
  background: rgba(255,255,255,.65);
  border: 1px solid rgba(0,0,0,.08);
}

  </style>
</head>

<body>
  <header class="hero">
    <div class="hero-inner">
      <div class="brand">
        <img src="/assets/ESO-rect1.png" alt="ESO">
        <h1>Calculateur Transport ‚Äî Cofel</h1>
      </div>
      <div class="hero-actions">
        <a href="./index.html" class="btn btn-ghost">‚üµ Accueil</a>
      </div>
    </div>
  </header>

  <main class="wrap">
    <section class="card">
      <h2>üßÆ S√©lection</h2>

      <div class="grid">
        <div>
          <label for="typeSelect">Type de transport</label>
          <select id="typeSelect">
            <option value="messagerie">Messagerie</option>
            <option value="affretement">Affr√®tement</option>
          </select>
        </div>

        <div>
          <label for="deptSelect">D√©partement</label>
          <select id="deptSelect">
            <option value="">‚Äî Choisir un d√©partement ‚Äî</option>
          </select>
        </div>

        <div>
          <label id="thirdLabel" for="thirdSelect">Poids (kg)</label>
          <select id="thirdSelect" disabled>
            <option value="">‚Äî Choisir ‚Äî</option>
          </select>
        </div>
      </div>

      <div class="info-note">
        Le transport par <strong>messagerie</strong> s‚Äôapplique uniquement pour les colis et pour les palettes
        d‚Äôune dimension maximale de <strong>120 √ó 80 cm</strong>.
      </div>

      <div class="price-box">
        <div>
          <div class="muted" id="currentContext">S√©lection en attente‚Ä¶</div>
          <div class="price" id="priceValue">‚Äî</div>
        </div>
        <div class="stack">
          <button id="addBtn" class="btn" disabled>‚ûï Ajouter au devis</button>
          <button id="resetBtn" class="btn btn-ghost">R√©initialiser</button>
        </div>
      </div>
    </section>
  </main>

  <div id="toast" class="toast">Ajout√© au devis ! Retournez √† l‚Äôaccueil pour le voir.</div>

  <script>
    // ================== CONFIG CSV ==================
    const CSV_MESSAGERIE_URL  = "./data/transport_messagerie.csv";
    const CSV_AFFRETEMENT_URL = "./data/transport_affretement.csv";

    const fmtEUR  = n => (Number(n || 0))
      .toFixed(2)
      .replace('.', ',') + " ‚Ç¨";

    const stripBOM = s => s.replace(/^\uFEFF/, "");

    async function loadCSV(url){
      const res  = await fetch(url, { cache: "no-store" });
      let text   = await res.text();
      text       = stripBOM(text);

      const lines = text.split(/\r?\n/).filter(l => l.trim().length > 0);
      if(!lines.length) return [];

      // D√©tection ; ou ,
      const sep = (lines[0].match(/;/g) || []).length > (lines[0].match(/,/g) || []).length
        ? ";"
        : ",";

      const split = l => l.split(sep).map(c => c.replace(/^"(.*)"$/,"$1").trim());

      const headers = split(lines[0]).map(h =>
        h.toLowerCase()
         .replace(/\s+/g,'')
         .replace("d√©partement","departement")
      );

      return lines.slice(1).map(l => {
        const c = split(l);
        const r = {};
        headers.forEach((h,i) => r[h] = c[i]);

        return {
          departement : (r.departement || "").trim(),
          poids_kg    : (r.poids_kg || r["poids(kg)"] || "").trim(),
          longueur_m  : (r.longueur_m || r["longueurpalette(m)"] || "").trim(),
          prix_ht     : String((r.prix_ht || r.prix || "0")).replace(",",".")
        };
      });
    }

    // ================== ETAT & RACCourcis DOM ==================
    const state = {
      type : "messagerie",
      dept : "",
      third: "",
      mess : [],
      affr : []
    };

    const $          = id => document.getElementById(id);
    const typeSelect = $("typeSelect");
    const deptSelect = $("deptSelect");
    const thirdSelect= $("thirdSelect");
    const thirdLabel = $("thirdLabel");
    const ctx        = $("currentContext");
    const priceEl    = $("priceValue");
    const resetBtn   = $("resetBtn");
    const addBtn     = $("addBtn");
    const toast      = $("toast");

    const byDept = (rows, d) => rows.filter(r => r.departement === d);

    // ================== RENDERS ==================
    function renderDepartments(){
      const rows = state.type === "messagerie" ? state.mess : state.affr;
      const depts = Array.from(new Set(rows.map(r => r.departement)))
        .filter(Boolean)
        .sort((a,b) => a.localeCompare(b, "fr"));

      deptSelect.innerHTML =
        `<option value="">‚Äî Choisir un d√©partement ‚Äî</option>` +
        depts.map(d => `<option value="${d}">${d}</option>`).join("");

      state.dept  = "";
      state.third = "";
      thirdSelect.innerHTML = `<option value="">‚Äî Choisir ‚Äî</option>`;
      thirdSelect.disabled  = true;
      addBtn.disabled       = true;
      renderPrice();
    }

    function renderThirdSelector(){
      const isMess = state.type === "messagerie";

      thirdLabel.textContent = isMess ? "Poids (kg)" : "Longueur palette (m)";
      thirdSelect.disabled   = !state.dept;

      if(!state.dept){
        thirdSelect.innerHTML = `<option value="">‚Äî Choisir ‚Äî</option>`;
        state.third = "";
        addBtn.disabled = true;
        renderPrice();
        return;
      }

      const rowsDept = byDept(isMess ? state.mess : state.affr, state.dept);

      if(isMess){
        const opts = [...new Set(
          rowsDept.map(r => r.poids_kg).filter(Boolean)
        )].sort((a,b) => parseFloat(a) - parseFloat(b));

        thirdSelect.innerHTML =
          `<option value="">‚Äî Choisir ‚Äî</option>` +
          opts.map(v => `<option value="${v}">${v}</option>`).join("");
      } else {
        const opts = [...new Set(
          rowsDept.map(r => r.longueur_m).filter(Boolean)
        )];

        thirdSelect.innerHTML =
          `<option value="">‚Äî Choisir ‚Äî</option>` +
          opts.map(v => `<option value="${v}">${v}</option>`).join("");
      }

      state.third = "";
      addBtn.disabled = true;
      renderPrice();
    }

    function renderPrice(){
      if(!state.dept || !state.third){
        ctx.textContent   = "S√©lection en attente‚Ä¶";
        priceEl.textContent = "‚Äî";
        addBtn.disabled   = true;
        return;
      }

      const isMess = state.type === "messagerie";
      const rows   = byDept(isMess ? state.mess : state.affr, state.dept);
      const key    = isMess ? "poids_kg" : "longueur_m";

      const selected = rows.find(r => (r[key] || "").trim() === state.third.trim());

      if(!selected){
        ctx.textContent   = "Aucune ligne trouv√©e";
        priceEl.textContent = "‚Äî";
        addBtn.disabled   = true;
        return;
      }

      ctx.textContent = `${isMess ? "Messagerie" : "Affr√®tement"} ‚Ä¢ Dept ${state.dept} ‚Ä¢ ` +
                        `${isMess ? "Poids" : "Longueur"} : ${state.third}`;
      priceEl.textContent = fmtEUR(selected.prix_ht);
      addBtn.disabled = false;
    }

    // ================== AJOUT AU DEVIS ==================
    function addToDevis(){
      const isMess = state.type === "messagerie";
      const label = isMess
        ? `Transport ‚Äî Messagerie ‚Äî Dept ${state.dept} ‚Äî ${state.third} kg`
        : `Transport ‚Äî Affr√®tement ‚Äî Dept ${state.dept} ‚Äî ${state.third} m`;

      let pu = parseFloat(
        priceEl.textContent.replace(/\s|‚Ç¨|,/g, ch => ch === "," ? "." : "")
      );
      if(isNaN(pu)) pu = 0;

      const payload = {
        id         : "tr_" + Date.now(),
        designation: label,
        quantite   : 1,
        pu_net_ht  : pu,
        type       : "transport",
        ts         : Date.now()
      };

      try{
        localStorage.setItem("cofel_transport_add", JSON.stringify(payload));
        toast.classList.add("show");
        setTimeout(() => toast.classList.remove("show"), 2500);
      }catch(e){
        alert("Impossible d‚Äôajouter au devis (localStorage).");
        console.error(e);
      }
    }

    // ================== EVENTS ==================
    typeSelect.onchange = () => {
      state.type = typeSelect.value;
      renderDepartments();
    };

    deptSelect.onchange = () => {
      state.dept = deptSelect.value;
      renderThirdSelector();
    };

    thirdSelect.onchange = () => {
      state.third = thirdSelect.value;
      renderPrice();
    };

    resetBtn.onclick = () => {
      typeSelect.value = "messagerie";
      state.type  = "messagerie";
      state.dept  = "";
      state.third = "";
      renderDepartments();
    };

    addBtn.onclick = addToDevis;

    // ================== INIT ==================
    (async () => {
      state.mess = await loadCSV(CSV_MESSAGERIE_URL);
      state.affr = await loadCSV(CSV_AFFRETEMENT_URL);
      renderDepartments();
    })();
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Configurateur ‚Äî Rampe lumineuse (PLL) | Cofel</title>

  <!-- Styles Cofel (IDENTIQUES √† T√¥le Tablette) -->
  <link rel="stylesheet" href="../styles/cofel.css">
  <link rel="stylesheet" href="../styles/cofel-components.css">
  <link rel="stylesheet" href="../styles/cofel-glass.css">
</head>

<body>

<!-- ===================== HEADER ===================== -->
<header class="cofel-header">
  <div class="row">
    <a class="cofel-back" href="../index.html">‚¨Ö Retour accueil (Devis)</a>
    <div class="cofel-brand">
      <img src="../assets/logo cofel.jpg" alt="Cofel" />
      <h1 class="cofel-title">Configurateur ‚Äî Rampe lumineuse (PLL)</h1>
    </div>
  </div>
</header>

<!-- ===================== CONTENU ===================== -->
<div class="cofel-container">

  <h1>Rampe lumineuse (PLL)</h1>

  <!-- Dimensions -->
  <fieldset>
    <legend>üìè Dimensions & quantit√©</legend>
    <div class="grid">
      <div>
        <label for="longueur">Longueur de rampe (mm)</label>
        <input type="number" id="longueur" min="1" placeholder="Ex : 2500" />
        <div class="hint">Tarif rampe (laquage inclus) : <b>100,00 ‚Ç¨ HT / m</b></div>
      </div>

      <div>
        <label for="quantite">Quantit√©</label>
        <input type="number" id="quantite" min="1" value="1" />
      </div>
    </div>
  </fieldset>

  <!-- Fixation -->
  <fieldset>
    <legend>Fixation (laquage inclus)</legend>

    <div class="radio-row">
      <label>
        <input type="radio" name="fixation" value="directe" checked>
        Fixation directe ‚Äî <b>5,00 ‚Ç¨ / u</b>
      </label>

      <label>
        <input type="radio" name="fixation" value="platine">
        Platine avec d√©port ‚Äî <b>15,00 ‚Ç¨ / u</b>
      </label>
    </div>

    <div id="blocDeport" class="hidden" style="margin-top:10px">
      <label for="deport">D√©port souhait√© (mm)</label>
      <input type="number" id="deport" min="0" step="1" placeholder="Ex : 120" />
      <div class="hint">Le d√©port est informatif (pas d‚Äôimpact tarifaire).</div>
    </div>
  </fieldset>

  <!-- R√©sultats -->
  <div class="result">
    <p>Prix unitaire HT : <b><span id="prixUHT">0,00</span> ‚Ç¨</b></p>

    <div class="hint">
      Longueur : <span id="lenM">0,000</span> m ‚Ä¢
      Fixations : <span id="nbFix">0</span> u (<span id="typeFix">directe</span>)
    </div>

    <p>Total HT : <b><span id="prixHT">0,00</span> ‚Ç¨</b></p>
    <p>Total TTC : <b><span id="prixTTC">0,00</span> ‚Ç¨</b></p>
  </div>

</div>

<!-- Bouton devis (m√™me logique que T√¥le Tablette) -->
<button id="btnAddDevis">‚ûï Ajouter au devis</button>

<footer class="cofel-footer">
  ¬© Cofel ‚Äî ZA du Perquoi, 72560 Chang√© ‚Äî SIRET 927 659 458 00024 ‚Äî TVA FR80927659458
</footer>

<!-- ===================== LOGIQUE ===================== -->
<script>
/*** CONFIG ***/
const TVA = 0.20;
const COEF_PUBLIC = 2;
const PRICE_RAMPE_ML = 100.00;
const PRICE_FIX_DIRECTE = 5.00;
const PRICE_FIX_PLATINE = 15.00;

/*** DOM ***/
const $ = id => document.getElementById(id);
const elL = $('longueur');
const elQ = $('quantite');
const elBlocDeport = $('blocDeport');
const elPrixUHT = $('prixUHT');
const elPrixHT = $('prixHT');
const elPrixTTC = $('prixTTC');
const elLenM = $('lenM');
const elNbFix = $('nbFix');
const elTypeFix = $('typeFix');

function euro(n){
  return (isFinite(n)?n:0).toFixed(2).replace('.', ',');
}
function round3(n){
  return Math.round(n*1000)/1000;
}

function compute(){
  // remise client auto
  let remiseClient = 1;
  try{
    const p = JSON.parse(localStorage.getItem('cofel_client_profile'));
    if(p?.discountRate) remiseClient = 1 - p.discountRate;
  }catch{}

  const Lmm = Math.max(0, Number(elL.value||0));
  const Lm = Lmm / 1000;
  const Q = Math.max(1, Number(elQ.value||1));

  const fixVal = document.querySelector('input[name="fixation"]:checked').value;
  const fixPrice = fixVal === 'platine' ? PRICE_FIX_PLATINE : PRICE_FIX_DIRECTE;
  const nbFix = Math.max(2, Math.ceil(Lm) + 1);

  const rampeInterne = PRICE_RAMPE_ML * Lm;
  const fixInterne = fixPrice * nbFix;

  const unitInterne = rampeInterne + fixInterne;
  const unitPublic = unitInterne * COEF_PUBLIC * remiseClient;

  const totalHT = unitPublic * Q;
  const totalTTC = totalHT * (1 + TVA);

  elLenM.textContent = round3(Lm).toFixed(3).replace('.', ',');
  elNbFix.textContent = nbFix;
  elTypeFix.textContent = fixVal;
  elPrixUHT.textContent = euro(unitPublic);
  elPrixHT.textContent = euro(totalHT);
  elPrixTTC.textContent = euro(totalTTC);
}

function toggleBlocks(){
  const fixVal = document.querySelector('input[name="fixation"]:checked').value;
  elBlocDeport.classList.toggle('hidden', fixVal !== 'platine');
}

['input','change'].forEach(evt=>{
  document.addEventListener(evt, e=>{
    if(e.target.matches('#longueur,#quantite,#deport,input[name="fixation"]')){
      toggleBlocks();
      compute();
    }
  });
});

toggleBlocks();
compute();
</script>

<!-- ===================== MOTEUR DE DEVIS ===================== -->
<script src="../js/devis-core.js"></script>
<script>
document.getElementById('btnAddDevis').addEventListener('click',()=>{
  try{
    if(!window.Devis) throw new Error("Moteur de devis introuvable.");

    const qte = Math.max(1, Number(elQ.value||1));
    const Lmm = Math.max(0, Number(elL.value||0));
    if(!Lmm){ alert("Renseigne la longueur."); return; }

    const fixVal = document.querySelector('input[name="fixation"]:checked').value;
    const totalHT = Number(elPrixHT.innerText.replace(',','.')) || 0;
    const pu = qte>0 ? totalHT/qte : 0;

    const designation = `Rampe lumineuse (PLL) ‚Äî L ${Lmm} mm ‚Äî Fixation ${fixVal}`;

    Devis.addLine({
      type: 'Rampe lumineuse (PLL)',
      designation,
      quantite: qte,
      pu_public_ht: Number(pu.toFixed(2))
    });

    alert("‚úÖ Ligne ajout√©e au devis !");
  }catch(err){
    alert(err.message);
  }
});
</script>

</body>
</html>

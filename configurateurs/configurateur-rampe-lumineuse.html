<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Configurateur ‚Äî Rampe lumineuse (PLL) | Cofel</title>

  <link rel="stylesheet" href="../styles/cofel-components.css">
  <link rel="stylesheet" href="../styles/cofel-glass.css">
</head>

<body>

<!-- ===================== HEADER ===================== -->
<header class="cofel-header">
  <div class="row">
    <a class="cofel-back" href="../index.html">‚¨Ö Retour accueil (Devis)</a>
    <div class="cofel-brand">
      <img src="../assets/logo cofel.jpg" alt="Cofel" />
      <h1 class="cofel-title">Configurateur ‚Äî Rampe lumineuse (PLL)</h1>
    </div>
  </div>
</header>


<!-- ===================== CONTENU ===================== -->
<div class="cofel-container">
  <section>
    <fieldset>
      <legend>üìè Dimensions & quantit√©</legend>
      <div class="grid">
        <div>
          <label for="longueur">Longueur de rampe (mm)</label>
          <input type="number" id="longueur" min="1" placeholder="Ex : 2500" />
          <!-- info tarif masqu√©e visuellement -->
          <div class="hint">Tarif rampe (laquage inclus) : <b>100,00 ‚Ç¨ HT / m</b></div>
        </div>
        <div>
          <label for="quantite">Quantit√©</label>
          <input type="number" id="quantite" min="1" value="1" />
        </div>
      </div>
    </fieldset>

    <fieldset style="margin-top:20px">
      <legend> Fixation (laquage inclus)</legend>
      <div class="radio-row">
        <label><input type="radio" name="fixation" value="directe" checked> Fixation directe <span>‚Äî <b>5,00 ‚Ç¨ / u</b></span></label>
        <label><input type="radio" name="fixation" value="platine"> Platine avec d√©port <span>‚Äî <b>15,00 ‚Ç¨ / u</b></span></label>
      </div>

      <div id="blocDeport" class="hidden" style="margin-top:10px">
        <label for="deport">D√©port souhait√© (mm)</label>
        <input type="number" id="deport" min="0" step="1" placeholder="Ex : 120" />
        <div class="hint"> Le d√©port est informatif (pas d‚Äôimpact tarifaire).</div>
      </div>
    </fieldset>

    <div class="result" style="margin-top:20px">
      <div>Prix unitaire HT : <b><span id="prixUHT">0,00</span> ‚Ç¨</b></div>
     <div class="hint">
        Longueur : <span id="lenM">0,000</span> m ‚Ä¢
        Fixations : <span id="nbFix">0</span> u (<span id="typeFix">directe</span>)
      </div>
      <div style="margin-top:10px">Total HT : <b><span id="prixHT">0,00</span> ‚Ç¨</b></div>
      <div>Total TTC (TVA 20%) : <b><span id="prixTTC">0,00</span> ‚Ç¨</b></div>
    </div>

    <div style="margin-top:16px;display:flex;gap:10px;flex-wrap:wrap;">
      <button id="btnAddDevis" class="btn">‚ûï Ajouter au devis</button>
      <button id="btnReset" class="btn"> üîÑ R√©initialiser</button>
    </div>
    </section>
</div>


<footer class="cofel-footer">
  ¬© Cofel ‚Äî ZA du Perquoi, 72560 Chang√© ‚Äî SIRET 927 659 458 00024 ‚Äî TVA FR80927659458
</footer>


<script>
/*** CONFIG ***/
const TVA = 0.20;
const PRICE_RAMPE_ML = 100.00;           // laquage inclus (m√©moire projet)
const PRICE_FIX_DIRECTE = 5.00;
const PRICE_FIX_PLATINE = 15.00;

/*** DOM ***/
const $ = id => document.getElementById(id);
const elL = $('longueur');
const elQ = $('quantite');
const elBlocDeport = $('blocDeport');
const elPrixUHT = $('prixUHT');
const elPrixHT = $('prixHT');
const elPrixTTC = $('prixTTC');
const elLenM = $('lenM');
const elNbFix = $('nbFix');
const elTypeFix = $('typeFix');

function euro(n){return (isFinite(n)?n:0).toFixed(2).replace('.', ',');}
function round3(n){return Math.round(n*1000)/1000;}

function compute(){
  // === Remise automatique client ===
  let remiseClient = 1;
  try {
      const p = JSON.parse(localStorage.getItem('cofel_client_profile'));
      if (p && typeof p.discountRate === 'number') remiseClient = 1 - p.discountRate;
  } catch(e){}

  const Lmm = Math.max(0, Number(elL.value||0));
  const Lm = Lmm / 1000;
  const Q = Math.max(1, Number(elQ.value||1));
  const fixVal = (document.querySelector('input[name="fixation"]:checked')||{}).value || 'directe';
  const fixPrice = (fixVal === 'platine') ? PRICE_FIX_PLATINE : PRICE_FIX_DIRECTE;
  const nbFix = Math.max(2, Math.ceil(Lm) + 1);
  const rampeHT = PRICE_RAMPE_ML * Lm;
  const fixHT = fixPrice * nbFix;
  // === Coefficient tarif public Cofel ===
const COEF_PUBLIC = 2;

// === Base interne ===
const unitHT_interne = (rampeHT + fixHT);

// === Prix public avant remise ===
const unitHT_public_base = unitHT_interne * COEF_PUBLIC;

// === Prix net client (apr√®s remise) ===
const unitHT = unitHT_public_base * remiseClient;

  const totalHT = unitHT * Q;
  const totalTTC = totalHT * (1 + TVA);

  elLenM.textContent = round3(Lm).toFixed(3).replace('.', ',');
  elNbFix.textContent = nbFix;
  elTypeFix.textContent = fixVal;
  elPrixUHT.textContent = euro(unitHT);
  elPrixHT.textContent = euro(totalHT);
  elPrixTTC.textContent = euro(totalTTC);
}

function toggleBlocks(){
  const fixVal = (document.querySelector('input[name="fixation"]:checked')||{}).value || 'directe';
  elBlocDeport.classList.toggle('hidden', fixVal!=='platine');
}

['input','change'].forEach(evt=>{
  [longueur, quantite, deport, ...document.querySelectorAll('input[name="fixation"]')]
    .forEach(el=>el.addEventListener(evt, ()=>{toggleBlocks();compute();}));
});

document.getElementById('btnReset').addEventListener('click',()=>{
  elL.value='';elQ.value=1;document.querySelector('input[value="directe"]').checked=true;
  $('deport').value='';toggleBlocks();compute();
});

toggleBlocks();
compute();
</script>

<!-- ===================== MOTEUR DE DEVIS ===================== -->
<script src="../js/devis-core.js"></script>
<script>
(function(){
  const btn = document.getElementById('btnAddDevis');
  if(!btn)return;
  function parseTotalHTPublic(){
    const txt=document.getElementById('prixHT').innerText.trim();
    return Number(txt.replace(/\s/g,'').replace(',','.'))||0;
  }
  btn.addEventListener('click',()=>{
    try{
      if(!window.Devis) throw new Error("Moteur de devis introuvable.");
      const Lmm=Math.max(0,Number(document.getElementById('longueur').value||0));
      const qte=Math.max(1,Number(document.getElementById('quantite').value||1));
      if(!(Lmm>0)){alert("Renseigne la longueur de rampe.");return;}
      const fixVal=(document.querySelector('input[name=\"fixation\"]:checked')||{}).value||'directe';
      const deport=Number(document.getElementById('deport')?.value||0);
      const total_ht_public=parseTotalHTPublic();
      if(total_ht_public<=0){alert("Le prix est √† 0, v√©rifie les param√®tres.");return;}
      const pu_public_ht=qte>0?total_ht_public/qte:0;
      const parts=[`Rampe lumineuse (PLL)`,`L ${Lmm} mm`,`Fixation: ${fixVal}`];
      if(fixVal==='platine'&&deport>0)parts.push(`D√©port ${deport} mm`);
      const designation=parts.join(' ‚Äî ');
      Devis.addLine({
        type:'Rampe lumineuse (PLL)',
        designation,
        quantite:qte,
        pu_public_ht:Number(pu_public_ht.toFixed(2))
      });
      alert(`‚úÖ Ligne ajout√©e au devis !\n${designation}\nQt√© : ${qte}\nPU HT : ${pu_public_ht.toFixed(2)} ‚Ç¨`);
    }catch(err){console.error(err);alert('Erreur : '+err.message);}    
  });
})();
</script>

</body>
</html>






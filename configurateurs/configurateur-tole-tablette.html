<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>Configurateur T√¥le Tablette ‚Äì Cofel</title>

<!-- Styles communs Cofel (si pr√©sents) -->
<link rel="stylesheet" href="../styles/cofel.css">
<link rel="stylesheet" href="../styles/cofel-components.css">
<link rel="stylesheet" href="../styles/cofel-glass.css">
<link rel="stylesheet" href="/styles/cofel-theme-apple-dark.css">

<style>
  /* s√©curit√© si .hidden n'existe pas dans tes CSS */
  .hidden{ display:none !important; }

  /* Bouton RAL (style ‚Äúpastille‚Äù) */
  .ral-btn{
    display:inline-flex;
    align-items:center;
    gap:10px;
    padding:10px 12px;
    border:1px solid var(--glass-hr, rgba(255,255,255,.18));
    border-radius:14px;
    background:var(--glass, rgba(255,255,255,.06));
    color:var(--txt, #fff);
    text-decoration:none;
    user-select:none;
    white-space:nowrap;
    cursor:pointer;
  }
  .ral-btn:hover{ filter:brightness(1.12); }
  .ral-btn:disabled{
    opacity:.45;
    cursor:not-allowed;
    filter:none;
  }

  /* Modal */
  html.ral-lock, body.ral-lock{ overflow:hidden; }

  .ral-modal{
    position:fixed;
    inset:0;
    z-index:9999;
    display:flex;
    align-items:center;
    justify-content:center;
    padding:14px;
  }
  .ral-backdrop{
    position:absolute;
    inset:0;
    background:rgba(0,0,0,.65);
    backdrop-filter: blur(10px);
  }
  .ral-card{
    position:relative;
    width:min(980px, calc(100vw - 24px));
    max-height:calc(100vh - 24px);
    overflow:hidden;
    border-radius:18px;
    border:1px solid var(--glass-hr, rgba(255,255,255,.18));
    background:rgba(18,18,18,.86);
    box-shadow: 0 12px 35px rgba(0,0,0,.55);
    display:flex;
    flex-direction:column;
  }
  .ral-head{
    display:flex;
    justify-content:space-between;
    gap:12px;
    padding:14px 14px 10px;
    border-bottom:1px solid var(--glass-hr, rgba(255,255,255,.12));
  }
  .ral-title{
    font-weight:700;
    font-size:16px;
    line-height:1.2;
  }
  .ral-sub{
    margin-top:4px;
    font-size:13px;
    color:var(--txt-dim, rgba(255,255,255,.72));
  }
  .ral-close{
    background:transparent;
    border:1px solid var(--glass-hr, rgba(255,255,255,.18));
    border-radius:12px;
    color:var(--txt, #fff);
    padding:8px 10px;
    cursor:pointer;
  }

  .ral-toolbar{
    display:flex;
    gap:10px;
    padding:12px 14px;
    align-items:center;
    border-bottom:1px solid var(--glass-hr, rgba(255,255,255,.12));
    flex-wrap:wrap;
  }
  .ral-tabs{
    display:flex;
    gap:8px;
  }
  .ral-tab{
    padding:8px 10px;
    border-radius:12px;
    border:1px solid var(--glass-hr, rgba(255,255,255,.18));
    background:transparent;
    color:var(--txt, #fff);
    cursor:pointer;
  }
  .ral-tab.is-active{
    background:rgba(255,255,255,.08);
  }
  .ral-search{
    flex:1;
    min-width:220px;
    padding:10px 12px;
    border-radius:12px;
    border:1px solid var(--glass-hr, rgba(255,255,255,.18));
    background:rgba(255,255,255,.06));
    color:var(--txt, #fff);
    outline:none;
  }

  .ral-content{
    padding:14px;
    overflow:auto;
  }
  .ral-group{
    margin-bottom:14px;
    padding:12px;
    border-radius:16px;
    background:rgba(255,255,255,.04);
    border:1px solid rgba(255,255,255,.08);
  }
  .ral-group h3{
    margin:0 0 10px 0;
    font-size:14px;
    color:var(--txt, #fff);
  }
  .ral-grid{
    display:flex;
    flex-wrap:wrap;
    gap:8px;
  }
  .ral-chip{
    padding:8px 10px;
    border-radius:999px;
    border:1px solid rgba(255,255,255,.18);
    background:rgba(255,255,255,.06);
    color:var(--txt, #fff);
    cursor:pointer;
  }
  .ral-chip:hover{ filter:brightness(1.12); }

  .ral-empty{
    padding:16px;
    color:var(--txt-dim, rgba(255,255,255,.72));
  }

  .ral-foot{
    padding:10px 14px 14px;
    border-top:1px solid var(--glass-hr, rgba(255,255,255,.12));
  }
  .ral-toast{
    font-size:13px;
    color:var(--txt, #fff);
    min-height:18px;
    margin-bottom:6px;
  }
  .ral-note{
    font-size:12px;
    color:var(--txt-dim, rgba(255,255,255,.72));
  }
</style>

</head>
<body>

<header class="cofel-header">
  <div class="row">
    <a class="cofel-back" href="../index.html">‚¨Ö Retour accueil (Devis)</a>
    <div class="cofel-brand">
      <img src="../assets/logo cofel.jpg" alt="Cofel" />
      <h1 class="cofel-title">Configurateur ‚Äî T√¥le Tablette</h1>
    </div>
  </div>
</header>

<div class="cofel-container">
  <h1>T√¥le Tablette</h1>

  <!-- Quantit√© -->
  <fieldset>
    <legend>Quantit√©</legend>
    <div class="grid">
      <div>
        <label for="quantite">Quantit√©</label>
        <input type="number" id="quantite" min="1" value="1" />
      </div>
    </div>
  </fieldset>

  <!-- Dimensions -->
  <fieldset>
    <legend>Dimensions</legend>
    <div class="grid">

      <div>
        <label for="largeur">Largeur (mm)</label>
        <input type="number" id="largeur" placeholder="Ex : 1500" min="1" />
      </div>

      <div>
        <label for="hauteur">Hauteur (mm)</label>
        <input type="number" id="hauteur" placeholder="Ex : 500" min="1" />
      </div>

      <!-- ‚úÖ PLIS -->
      <div>
        <label for="plis">Plis (retours de t√¥le) en mm</label>
        <input type="number" id="plis" placeholder="Ex : 50" min="0" />
        <div class="hint">1 pli en haut + bas + droite + gauche = 4 √ó plis</div>
      </div>

      <div>
        <label>Surface t√¥le (auto)</label>
        <input id="surfaceCalc" disabled value="0.000 m¬≤" />
        <div class="hint">Surface = (L √ó H) / 1 000 000 (avec plis)</div>
      </div>

    </div>

  </fieldset>

  <!-- Mati√®re t√¥le tablette -->
  <fieldset>
    <legend>Mati√®re</legend>
    <div class="grid">
      <div>
        <label>Mati√®re de la t√¥le tablette</label>
        <div class="radio-row" id="matiereRow">
          <label><input type="radio" name="matiere" value="brut"> Alu 20/10 <b>brut</b></label>
          <label><input type="radio" name="matiere" value="prelaque" checked> <b>Pr√©laqu√©</b></label>
          <label><input type="radio" name="matiere" value="laque"> Alu 20/10 <b>laqu√©</b></label>
        </div>
      </div>

      <!-- ‚úÖ Bouton RAL + popup (d√©sactiv√© si pas ‚Äúpr√©laqu√©‚Äù) -->
      <div style="display:flex;justify-content:flex-end;align-items:flex-start;">
        <button type="button" id="btnRal" class="ral-btn" aria-haspopup="dialog">
          üé® RAL disponibles (pr√©-laqu√©)
        </button>
      </div>
    </div>
  </fieldset>

  <!-- Ajourage + PMMA + LED -->
  <fieldset>
    <legend>Ajourage / Remplissage</legend>

    <label class="radio-row" style="padding:0;border:none">
      <span><input type="checkbox" id="optAjour" /> Ajourage de la face avant</span>
    </label>

    <div id="blockAjour" class="hidden" style="margin-top:8px">
      <div class="grid">
        <div>
          <label for="ajourLargeur">Ajourage ‚Äì largeur (mm)</label>
          <input type="number" id="ajourLargeur" min="0" placeholder="Ex : 800" />

          <label for="ajourHauteur" style="margin-top:10px">Ajourage ‚Äì hauteur (mm)</label>
          <input type="number" id="ajourHauteur" min="0" placeholder="Ex : 300" />

          <label for="pmmaSurface" style="margin-top:10px">Surface ajour√©e (auto)</label>
          <input id="pmmaSurface" disabled value="0.000 m¬≤" />

          <div class="hint">Surface ajour√©e = (largeur √ó hauteur) / 1 000 000</div>
        </div>

        <div>
          <label for="pmmaSel">Type de PMMA</label>
          <select id="pmmaSel"><option value="">(aucun)</option></select>
        </div>
      </div>

      <div class="grid">
        <div>
          <label class="radio-row" style="padding:0;border:none">
            <span><input type="checkbox" id="optLED" /> √âclairage LED (utilise surface ajour√©e)</span>
          </label>
        </div>
      </div>
    </div>
  </fieldset>

  <!-- Fixation -->
  <fieldset>
    <legend>Fixation de la t√¥le tablette (choix exclusif)</legend>
    <div class="radio-row">
      <label><input type="radio" name="fixation" value="aucune" checked> Aucune</label>
      <label><input type="radio" name="fixation" value="boite"> Bo√Æte √† chaussure</label>
      <label>
        <input type="radio" name="fixation" value="chassis30">
        Ch√¢ssis tube aluminium 30√ó30
      </label>
      <label>
        <input type="radio" name="fixation" value="chassis40">
        Ch√¢ssis tube aluminium 40√ó40
      </label>
      <label>
        <input type="radio" name="fixation" value="chassis50">
        Ch√¢ssis tube aluminium 50√ó50
      </label>
      <label><input type="radio" name="fixation" value="corniere"> Corni√®re</label>
      <label><input type="radio" name="fixation" value="lisse"> Pose sur lisse</label>
    </div>

    <div id="fixBoite" class="hidden">
      <div class="radio-row" style="margin-top:8px">
        <label><input type="radio" name="boiteMat" value="brut" checked> Bo√Æte en alu 20/10 <b>brut</b></label>
        <label><input type="radio" name="boiteMat" value="laque"> Bo√Æte en alu 20/10 <b>laqu√©</b></label>
      </div>
      <div class="hint">La bo√Æte a la <b>m√™me dimension</b> que la t√¥le.</div>
    </div>

    <div id="fixChassis" class="hidden">
      <div class="hint hidden" style="margin-top:8px">
        Lin√©aire ch√¢ssis = <b>p√©rim√®tre</b> (2√ó(L+H)).<br />
        Goussets = minimum 4, puis +4 par m¬≤ (arrondi √† l‚Äôentier sup.).
      </div>
      <div class="hidden" style="margin-top:8px">
        <label for="goussetPrixU">Gousset ‚Ç¨/u</label>
        <input type="number" id="goussetPrixU" placeholder="‚Ç¨/u (auto/manuel)" min="0" step="0.01" />
      </div>
    </div>

    <div id="fixCorniere" class="hidden">
      <div class="hint">Longueur = p√©rim√®tre (2√ó(L+H)).</div>
    </div>

    <!-- ‚úÖ MODIF : longueur + nombre de lisses -->
    <div id="fixLisse" class="hidden" style="margin-top:8px">
      <div class="grid">
        <div>
          <label for="lisseLongueur">Longueur d‚Äôune lisse (mm)</label>
          <input type="number" id="lisseLongueur" min="0" placeholder="Ex : 10000" />
        </div>
        <div>
          <label for="lisseNb">Nombre de lisses</label>
          <input type="number" id="lisseNb" min="1" value="1" />
        </div>
      </div>
      <div class="hint">Ex : 2 listes de 10 m ‚Üí Longueur 10000 mm + Nombre 2.</div>
    </div>

  </fieldset>

  <!-- R√©sultats -->
  <div class="result">
    <p>Prix unitaire HT : <span id="prixUHT">0,00</span> ‚Ç¨</p>
    <p>Total HT : <span id="prixHT">0,00</span> ‚Ç¨</p>
    <p>Total TTC : <span id="prixTTC">0,00</span> ‚Ç¨</p>
  </div>
</div>

<footer class="cofel-footer">
  ¬© Cofel ‚Äî ZA du Perquoi, 72560 Chang√© ‚Äî SIRET 927 659 458 00024 ‚Äî TVA FR80927659458
</footer>

<!-- ‚úÖ POPUP RAL -->
<div id="ralModal" class="ral-modal hidden" role="dialog" aria-modal="true" aria-labelledby="ralTitle">
  <div class="ral-backdrop" data-close="1"></div>

  <div class="ral-card">
    <div class="ral-head">
      <div>
        <div id="ralTitle" class="ral-title">RAL disponibles ‚Äî T√¥le aluminium 15/10 pr√©-laqu√©e</div>
        <div class="ral-sub">Format 3000 √ó 1500 ‚Ä¢ Satin√© / Brillante ‚Ä¢ Clique un RAL pour le copier</div>
      </div>
      <button type="button" id="ralClose" class="ral-close" aria-label="Fermer">‚úï</button>
    </div>

    <div class="ral-toolbar">
      <div class="ral-tabs" role="tablist" aria-label="Finition">
        <button type="button" class="ral-tab is-active" data-finish="satine" role="tab" aria-selected="true">Satin√©</button>
        <button type="button" class="ral-tab" data-finish="brillante" role="tab" aria-selected="false">Brillante</button>
      </div>
      <input id="ralSearch" class="ral-search" type="text" placeholder="Rechercher : 7016, gris, noir, bleu‚Ä¶" />
    </div>

    <div id="ralContent" class="ral-content"></div>

    <div class="ral-foot">
      <div id="ralToast" class="ral-toast" aria-live="polite"></div>
      <div class="ral-note">R√©f√©rence indicative : valider la teinte finale avec un nuancier officiel RAL / √©chantillon mati√®re.</div>
    </div>
  </div>
</div>

<!-- ======= LOGIQUE ======= -->
<script>
/*** CONFIG ***/
const TVA = 0.20;
const CSV_URL = "https://raw.githubusercontent.com/stevens-cofel/configurateur-cofel/refs/heads/main/toles_tabelette";
const CORNIERE_PRICE_ML = 6.5;
const CHASSIS_BASE_30 = 10.5; // ‚Ç¨/ml interne base 30√ó30

const CHASSIS_PRICE_ML = {
  30: CHASSIS_BASE_30,
  40: +(CHASSIS_BASE_30 * 1.10).toFixed(2),
  50: +(CHASSIS_BASE_30 * 1.10 * 1.10).toFixed(2)
};

const MATERIAL_PRICE_M2 = {
  brut: 71.5,
  prelaque: 89.0,
  laque: 105.0
};
const BOX_PRICE_M2 = {
  brut: 71.5,
  laque: 105.0
};
const AJOURAGE_PRICE_M2 = 99.0;
const LISSE_PRICE_ML = 25;  // prix interne en ‚Ç¨/m√®tre lin√©aire

/*** STATE / DOM ***/
const $ = id => document.getElementById(id);
let HEADS=[], ROWS=[], MAP=null;

const elQ=$('quantite');
const elL=$('largeur'), elH=$('hauteur'), elP=$('plis'), elSurf=$('surfaceCalc');

const elOptAjour=$('optAjour'), elBlockAjour=$('blockAjour');
const elPMMA=$('pmmaSel'), elPMMASurface=$('pmmaSurface');
const elLED=$('optLED');

const elAjourL = $('ajourLargeur');
const elAjourH = $('ajourHauteur');

const fixRadios=[...document.querySelectorAll('input[name="fixation"]')];
const elFixBoite=$('fixBoite'), elFixChassis=$('fixChassis'), elFixCorniere=$('fixCorniere');
const elGoussetPrixU=$('goussetPrixU');

const elUHT=$('prixUHT'), elHT=$('prixHT'), elTTC=$('prixTTC');

/* ‚úÖ Robustesse : on cr√©e aussi les alias utilis√©s plus bas (√©vite de d√©pendre des ‚Äúglobals‚Äù des id) */
const quantite = elQ;
const largeur  = elL;
const hauteur  = elH;
const plis     = elP;
const ajourLargeur = elAjourL;
const ajourHauteur = elAjourH;
const optAjour = elOptAjour;
const pmmaSel  = elPMMA;
const optLED   = elLED;
const goussetPrixU = elGoussetPrixU;

/*** UTILS ***/
function norm(s){return String(s||'').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'');}
function numFR(v){
  if(v===null||v===undefined) return NaN;
  let s=String(v).trim().replace(/‚Ç¨/g,'').replace(/[\u00A0\u202F]/g,'').replace(/\s+/g,'');
  if(s.includes(',') && s.includes('.')) s=s.replace(/\./g,'');
  s=s.replace(',', '.');
  const m=s.match(/-?\d+(\.\d+)?/);
  return m?parseFloat(m[0]):NaN;
}
function euro(n){return (isFinite(n)?n:0).toFixed(2).replace('.', ',');}
function areaM2(Lmm,Hmm){return (Math.max(0,Number(Lmm||0))*Math.max(0,Number(Hmm||0)))/1e6;}
function perimeterMeters(Lmm,Hmm){return 2*((Lmm/1000)+(Hmm/1000));}

/* ==========================
   POPUP RAL (d'apr√®s TON PDF)
   ========================== */
const RAL_DATA = {
  satine: {
    "Blanc cass√©": ["1013"],
    "Blanc": ["9001","9002","9003","9018"],
    "Noir": ["9004","9005","9011"],
    "Gris": ["7001","7003","7004","7005","7006","7010","7011","7012","7013","7015","7016","7021","7022","7023","7024","7030","7031","7032","7033","7035","7036","7037","7038","7039","7040","7042","7043","7044","7046","7047"],
    "Brun": ["1247","8003","8004","8011","8012","8014","8016","8017","8019","8022","8025","8028"],
    "Vert": ["6005","6006","6019","6021"],
    "Ivoire": ["1014","1015"],
    "Beige": ["1001","1019"],
    "Rouge": ["3003","3004","3009","3011","3012"],
    "Bleu": ["5003","5008","5009","5014"]
  },
  brillante: {
    "Blanc": ["9001","9002","9003"],
    "Noir": ["9005"],
    "Gris": ["7001","7005","7006","7010","7011","7012","7015","7016","7021","7022","7024","7030","7031","7032","7035","7036","7037","7038","7039","7040","7042","7043","7047"],
    "Brun": ["8011","8014","8017","8019"],
    "Vert": ["6005","6021"],
    "Ivoire": ["1013","1015"],
    "Galet": ["9660"],
    "Jaune": ["1023"],
    "Rouge": ["3002","3003","3004","3020"],
    "Bleu": ["5002","5010","5017"]
  }
};

let ralFinish = "satine";
let ralToastTimer = null;

function setRalToast(msg){
  const el = document.getElementById("ralToast");
  if(!el) return;
  el.textContent = msg || "";
  clearTimeout(ralToastTimer);
  if(msg){
    ralToastTimer = setTimeout(()=>{ el.textContent=""; }, 1200);
  }
}

function renderRal(){
  const cont = document.getElementById("ralContent");
  if(!cont) return;

  const q = norm((document.getElementById("ralSearch")?.value || "").trim());
  cont.innerHTML = "";

  const groups = RAL_DATA[ralFinish] || {};
  let any = false;

  Object.entries(groups).forEach(([family, codes])=>{
    const famNorm = norm(family);
    const filtered = codes.filter(code=>{
      if(!q) return true;
      const codeStr = String(code);
      return famNorm.includes(q) || codeStr.includes(q) || (`ral ${codeStr}`).includes(q);
    });

    if(!filtered.length) return;
    any = true;

    const sec = document.createElement("section");
    sec.className = "ral-group";
    sec.innerHTML = `<h3>${family}</h3>`;

    const grid = document.createElement("div");
    grid.className = "ral-grid";

    filtered.forEach(code=>{
      const b = document.createElement("button");
      b.type = "button";
      b.className = "ral-chip";
      b.dataset.code = String(code);
      b.textContent = `RAL ${code}`;
      grid.appendChild(b);
    });

    sec.appendChild(grid);
    cont.appendChild(sec);
  });

  if(!any){
    cont.innerHTML = `<div class="ral-empty">Aucun r√©sultat pour cette recherche.</div>`;
  }
}

function openRalModal(){
  const modal = document.getElementById("ralModal");
  if(!modal) return;
  modal.classList.remove("hidden");
  document.documentElement.classList.add("ral-lock");
  document.body.classList.add("ral-lock");

  const s = document.getElementById("ralSearch");
  if(s){ s.value = ""; }

  renderRal();
  setRalToast("");
  setTimeout(()=>{ document.getElementById("ralSearch")?.focus(); }, 50);
}

function closeRalModal(){
  const modal = document.getElementById("ralModal");
  if(!modal) return;
  modal.classList.add("hidden");
  document.documentElement.classList.remove("ral-lock");
  document.body.classList.remove("ral-lock");
  setRalToast("");
}

function updateRalBtn(){
  const btn = document.getElementById("btnRal");
  if(!btn) return;
  const mat = (document.querySelector('input[name="matiere"]:checked')||{}).value || "prelaque";
  const enabled = (mat === "prelaque");
  btn.disabled = !enabled;
  btn.title = enabled
    ? "Voir les RAL disponibles en t√¥le pr√©-laqu√©e"
    : "Disponible uniquement si la mati√®re s√©lectionn√©e est : Pr√©laqu√©";
}

function initRalModal(){
  const btn = document.getElementById("btnRal");
  const modal = document.getElementById("ralModal");
  const closeBtn = document.getElementById("ralClose");

  if(btn){
    btn.addEventListener("click", ()=>{
      if(btn.disabled) return;
      openRalModal();
    });
  }

  if(closeBtn) closeBtn.addEventListener("click", closeRalModal);

  if(modal){
    modal.addEventListener("click", (e)=>{
      const t = e.target;
      if(t && t.dataset && t.dataset.close === "1") closeRalModal();
    });
  }

  document.addEventListener("keydown", (e)=>{
    if(e.key === "Escape"){
      const m = document.getElementById("ralModal");
      if(m && !m.classList.contains("hidden")) closeRalModal();
    }
  });

  // Tabs
  document.querySelectorAll(".ral-tab").forEach(tab=>{
    tab.addEventListener("click", ()=>{
      document.querySelectorAll(".ral-tab").forEach(x=>{
        x.classList.remove("is-active");
        x.setAttribute("aria-selected","false");
      });
      tab.classList.add("is-active");
      tab.setAttribute("aria-selected","true");
      ralFinish = tab.dataset.finish || "satine";
      renderRal();
    });
  });

  // Search
  document.getElementById("ralSearch")?.addEventListener("input", renderRal);

  // Click chip => copie
  document.getElementById("ralContent")?.addEventListener("click", async (e)=>{
    const chip = e.target?.closest?.(".ral-chip");
    if(!chip) return;
    const txt = chip.textContent || "";
    try{
      await navigator.clipboard.writeText(txt);
      setRalToast(`‚úÖ ${txt} copi√©`);
    }catch(err){
      window.prompt("Copie ce RAL :", txt);
    }
  });

  updateRalBtn();
}

/*** SURFACE AVEC PLIS (t√¥le compl√®te) ***/
function currentSurface(){
  const L = Number(elL.value || 0);
  const H = Number(elH.value || 0);
  const P = Number(elP.value || 0); // plis en mm

  // d√©velopp√© = largeur + 2 plis ; hauteur + 2 plis
  const Ldev = L + (2 * P);
  const Hdev = H + (2 * P);

  const A = areaM2(Ldev, Hdev);

  elSurf.value = `${A.toFixed(3)} m¬≤`;
  return A;
}

/*** PERIMETRE ***/
function currentPerimeter(){ return perimeterMeters(elL.value, elH.value); }

/*** CSV PARSER + MAPPING ***/
function parseCSVAuto(text){
  const raw = String(text||'').replace(/^\uFEFF/,'');
  const lines = raw.split(/\r\n|\n|\r/).filter(l=>l.trim()!=='');
  if(!lines.length) return {rawHeads:[], rows:[]};
  const first = lines[0];
  const sep = ((first.match(/;/g)||[]).length > (first.match(/,/g)||[]).length) ? ';' : ',';

  function parseLine(line){
    const out=[]; let cur=''; let inQ=false;
    for(let i=0;i<line.length;i++){
      const ch=line[i], nx=line[i+1];
      if(ch==='"'){ if(inQ && nx==='"'){cur+='"'; i++;} else inQ=!inQ; }
      else if(ch===sep && !inQ){ out.push(cur); cur=''; }
      else{ cur+=ch; }
    }
    out.push(cur);
    return out;
  }

  const rawHeads=parseLine(first).map(s=>s.replace(/^"+|"+$/g,'').trim());
  const rows = lines.slice(1).map(line=>{
    const cells=parseLine(line).map(s=>s.replace(/^"+|"+$/g,'').trim());
    const o={}; rawHeads.forEach((h,i)=>o[h]=cells[i]??'' ); return o;
  });
  return {rawHeads, rows};
}

function buildMapping(heads){
  const n = heads.map(h=>norm(h));
  const find=(needle)=>{ const i=n.indexOf(norm(needle)); return i>=0?heads[i]:null; };
  const like=(...res)=>{ for(let i=0;i<n.length;i++){ const k=n[i]; if(res.every(r=>r.test(k))) return heads[i]; } return null; };

  return {
    TITRE:  find('titre') || like(/titre/),
    PROD:   find('produit') || like(/produit/),
    PROD_REL: like(/produit.*lie/),
    ETAPE:  find('nom √©tape') || like(/nom.*etape|etape/),
    MIN:    find('temps en minute') || like(/minute/),
    TH:     find('tauxhoraire_eur_h') || like(/taux.*horaire|eur.*h/),
    MAT:    find('coutmatiere_eur') || like(/matiere.*eur/),
    FORMULE: find('formule cout') || like(/formule/),
    TARIF_M2: find('tarif_m2_eur') || like(/tarif.*m2/),
    TARIF_ML: find('tarif m√®tre lin√©aire en eur') || like(/tarif.*metre.*lineaire/),
    OBLIG:  find('obligatoire') || like(/oblig/),
    COMM:   find('commentaire') || like(/comment/),
    ECLAIR: like(/(led|eclair|√©clair)/)
  };
}

async function loadCSV(){
  try{
    const r = await fetch(CSV_URL, {cache:'no-store'});
    if(!r.ok) throw new Error('HTTP '+r.status);
    const txt = await r.text();
    const {rawHeads, rows} = parseCSVAuto(txt);
    HEADS=rawHeads; ROWS=rows; MAP=buildMapping(HEADS);
    refreshPMMACatalog(ROWS);
    compute();
  }catch(e){
    console.error('Erreur CSV:', e?.message||e);
  }
}

function refreshPMMACatalog(rows){
  const pmmas = new Map();
  rows.forEach(r=>{
    const s = norm([r[MAP.ETAPE], r[MAP.PROD], r[MAP.TITRE], r[MAP.COMM]].join(' '));
    if(/pmma/.test(s)){
      const label = (r[MAP.ETAPE] || r[MAP.PROD] || 'PMMA').trim();
      const priceM2 = numFR(r[MAP.TARIF_M2]);
      if(label) pmmas.set(label, isFinite(priceM2)?priceM2:NaN);
    }
  });
  const cur=elPMMA.value; elPMMA.innerHTML='';
  const o0=document.createElement('option'); o0.value=''; o0.textContent='(aucun)'; elPMMA.appendChild(o0);
  [...pmmas.entries()].forEach(([label, val])=>{
    const o=document.createElement('option');
    o.value=label;
    o.textContent = label;
    o.dataset.price = isFinite(val)?val:'';
    elPMMA.appendChild(o);
  });
  if([...pmmas.keys()].includes(cur)) elPMMA.value=cur;
}

function autoFindPrice(keywordRe, type='m2'){
  if(!ROWS.length) return NaN;
  for(const r of ROWS){
    const bag = norm([r[MAP.ETAPE], r[MAP.PROD], r[MAP.TITRE], r[MAP.COMM]].join(' '));
    if(!keywordRe.test(bag)) continue;
    if(type==='m2'){ const v=numFR(r[MAP.TARIF_M2]); if(isFinite(v)) return v; }
    if(type==='ml'){ const v=numFR(r[MAP.TARIF_ML]); if(isFinite(v)) return v; }
    if(type==='u'){  const v=numFR(r[MAP.MAT]);     if(isFinite(v)) return v; }
  }
  return NaN;
}

/*** CALCUL COMPLET ***/
function compute(){

  let remiseClient = 1;
  try {
      const p = JSON.parse(localStorage.getItem('cofel_client_profile'));
      if (p && typeof p.discountRate === 'number') remiseClient = 1 - p.discountRate;
  } catch(e){}

  const Q = Math.max(1, Number(elQ.value||1));
  const A = currentSurface();
  const P = currentPerimeter();

  const mat = (document.querySelector('input[name="matiere"]:checked')||{}).value || 'prelaque';
  const matM2 = MATERIAL_PRICE_M2[mat] ?? 0;
  const base_interne = matM2 * A;

  // ======== MAJORATION PETITES SURFACES (invisible client) ========
  let coefSmall = 1;
  if (A < 0.10) {
      coefSmall = 3.0;        // +200%
  } else if (A <= 0.20) {
      coefSmall = 2.5;        // +150%
  } else if (A <= 0.75) {
      coefSmall = 1.5;        // +50%
  }
  const base_interne_major√© = base_interne * coefSmall;

  let ajourage_interne=0, pmma_interne=0, led_interne=0, pmmaSurf=0;

  if(elOptAjour.checked){
    const ajL = Math.max(0, Number(elAjourL.value || 0));
    const ajH = Math.max(0, Number(elAjourH.value || 0));

    pmmaSurf = areaM2(ajL, ajH); // m¬≤ ajour√©s

    if (elPMMASurface){
      elPMMASurface.value = pmmaSurf.toFixed(3) + ' m¬≤';
    }

    // Surface ajour√©e r√©elle (sert pour PMMA/LED)
    pmmaSurf = areaM2(ajL, ajH); // m¬≤ ajour√©s

    // ‚úÖ Ajourage : minimum factur√© = 1 m¬≤ (99‚Ç¨), puis 99‚Ç¨/m¬≤ au-del√†
    const ajourageFactureM2 = Math.max(1, pmmaSurf);
    ajourage_interne = AJOURAGE_PRICE_M2 * ajourageFactureM2;

    const selectedPMMA = elPMMA.options[elPMMA.selectedIndex];
    let pmmaM2 = selectedPMMA && selectedPMMA.dataset.price ? Number(selectedPMMA.dataset.price) : NaN;
    if(isFinite(pmmaM2)) pmma_interne = pmmaM2 * pmmaSurf;

    if(elLED.checked){
      let ledM2 = autoFindPrice(/(led|eclairage|√©clairage)/,'m2');
      if(isFinite(ledM2)) led_interne = ledM2 * pmmaSurf;
    }
  } else {
    if (elPMMASurface){
      elPMMASurface.value = "0.000 m¬≤";
    }
  }

  const fixVal = (document.querySelector('input[name="fixation"]:checked')||{}).value || 'aucune';
  let fix_interne=0, nbGoussets=0;

  if(fixVal==='boite'){
    const boiteMat = (document.querySelector('input[name="boiteMat"]:checked')||{}).value || 'brut';
    const boiteM2 = BOX_PRICE_M2[boiteMat] || 0;
    fix_interne = boiteM2 * A;

  }else if(
    fixVal === 'chassis30' ||
    fixVal === 'chassis40' ||
    fixVal === 'chassis50'
  ){

    const section =
      fixVal === 'chassis30' ? 30 :
      fixVal === 'chassis40' ? 40 : 50;

    const chLinCost = CHASSIS_PRICE_ML[section] * P;

    nbGoussets = Math.max(4, Math.ceil(4 + 4 * A));
    let gusU = autoFindPrice(/gousset/,'u');
    if(!isFinite(gusU)) gusU = Number(elGoussetPrixU?.value||0);

    const gusCost = (isFinite(gusU)?gusU:0) * nbGoussets;

    fix_interne = chLinCost + gusCost;
  }

  else if(fixVal==='corniere'){
    fix_interne = CORNIERE_PRICE_ML * P;
  } else if (fixVal === 'lisse') {
    const lisseMM = Number(document.getElementById("lisseLongueur")?.value || 0);
    const lisseNb = Math.max(1, Number(document.getElementById("lisseNb")?.value || 1));

    const lisseMLUnit = lisseMM / 1000;              // mm ‚Üí m
    const lisseMLTotal = lisseMLUnit * lisseNb;      // total ml factur√©

    if (lisseMLTotal > 0) {
      fix_interne = LISSE_PRICE_ML * lisseMLTotal;   // prix interne
    }
  }

  const unitHT_interne = base_interne_major√© + ajourage_interne + pmma_interne + led_interne + fix_interne;

  // === Coefficient tarif public Cofel ===
  const COEF_PUBLIC = 2;

  // === Prix public avant remise ===
  const unitHT_public_base = unitHT_interne * COEF_PUBLIC;

  // === Prix net client ===
  const unitHT_public = unitHT_public_base * remiseClient;

  const totalHT_public = unitHT_public * Q;
  const totalTTC_public = totalHT_public * (1+TVA);

  elUHT.textContent = euro(unitHT_public);
  elHT.textContent  = euro(totalHT_public);
  elTTC.textContent = euro(totalTTC_public);

  updateRalBtn();
}

/*** UI TOGGLES ***/
function toggleBlocks(){
  elBlockAjour.classList.toggle('hidden', !elOptAjour.checked);
  const fixVal = (document.querySelector('input[name="fixation"]:checked')||{}).value || 'aucune';
  elFixBoite.classList.toggle('hidden', fixVal!=='boite');
  elFixChassis.classList.toggle(
    'hidden',
    !(fixVal === 'chassis30' || fixVal === 'chassis40' || fixVal === 'chassis50')
  );
  elFixCorniere.classList.toggle('hidden', fixVal!=='corniere');
  const elFixLisse = document.getElementById('fixLisse');
  elFixLisse.classList.toggle('hidden', fixVal!=='lisse');

  updateRalBtn();
}

/*** EVENTS ***/
['input','change'].forEach(evt=>{
 [
    quantite, largeur, hauteur, plis,
    ajourLargeur, ajourHauteur,
    document.getElementById('lisseLongueur'),
    document.getElementById('lisseNb'),           // ‚úÖ AJOUT : nb de lisses
    ...document.querySelectorAll('input[name="matiere"]'),
    optAjour, pmmaSel,
    optLED, ...fixRadios, goussetPrixU,
    ...document.querySelectorAll('input[name="boiteMat"]')
 ]
 .forEach(el=>{
    if(!el || !el.addEventListener) return;
    el.addEventListener(evt, ()=>{
      toggleBlocks();
      compute();
    });
  });
});

/*** INIT ***/
initRalModal();
loadCSV();
toggleBlocks();
compute();
</script>

<script src="../js/devis-core.js"></script>

<button id="btnAddDevis">‚ûï Ajouter au devis</button>

<script>
(function(){
  const btn = document.getElementById('btnAddDevis');
  if(!btn) return;

  function parseTotalHTPublic(){
    const txt = document.getElementById('prixHT').innerText.trim();
    return Number(txt.replace(/\s/g,'').replace(',', '.')) || 0;
  }

  // Traduction mati√®re pour d√©signation
  const MAT_LABELS = {
    brut: "T√¥le aluminium 20/10 brut",
    prelaque: "T√¥le aluminium 20/10 pr√©laqu√©e",
    laque: "T√¥le aluminium 20/10 laqu√©e"
  };

  btn.addEventListener('click', () => {
    try{
      if(!window.Devis) throw new Error("Moteur de devis introuvable.");

      const qte = Math.max(1, Number(document.getElementById('quantite').value || 1));
      const Lmm = Math.max(0, Number(document.getElementById('largeur').value || 0));
      const Hmm = Math.max(0, Number(document.getElementById('hauteur').value || 0));
      const Pmm = Math.max(0, Number(document.getElementById('plis').value || 0));

      if(!(Lmm>0) || !(Hmm>0)){ alert("Renseigne largeur et hauteur."); return; }

      const mat = (document.querySelector('input[name="matiere"]:checked')||{}).value || 'prelaque';

      const ajour = document.getElementById('optAjour').checked;
      const pmmaSel = document.getElementById('pmmaSel');
      const pmmaLabel = pmmaSel && pmmaSel.value ? pmmaSel.value : '';

      const ajLmm = Math.max(0, Number(document.getElementById('ajourLargeur').value || 0));
      const ajHmm = Math.max(0, Number(document.getElementById('ajourHauteur').value || 0));
      const pmmaSurf = (ajLmm>0 && ajHmm>0) ? (ajLmm*ajHmm/1e6) : 0;

      const led = document.getElementById('optLED').checked;

      const fixVal = (document.querySelector('input[name="fixation"]:checked')||{}).value || 'aucune';

      // Pose sur lisse
      const lisseMM = Number(document.getElementById("lisseLongueur")?.value || 0);
      const lisseNb = Math.max(1, Number(document.getElementById("lisseNb")?.value || 1));
      const lisseMLUnit = lisseMM / 1000;
      const lisseMLTotal = lisseMLUnit * lisseNb;

      const boiteMat = (document.querySelector('input[name="boiteMat"]:checked')||{}).value || '';
      const gusU = document.getElementById('goussetPrixU')?.value || '';

      const total_ht_public = parseTotalHTPublic();
      if (total_ht_public <= 0){ alert("Le prix est √† 0, v√©rifie les param√®tres."); return; }
      const pu_public_ht = qte>0 ? (total_ht_public / qte) : 0;

      const parts = [
        `T√¥le Tablette`,
        `L ${Lmm} √ó H ${Hmm} mm`,
        `Plis : ${Pmm} mm`,
        MAT_LABELS[mat] || "T√¥le aluminium 20/10"
      ];

      if (ajour){
        const pmmaBits = [];
        if (pmmaLabel) pmmaBits.push(pmmaLabel);
        if (pmmaSurf>0) pmmaBits.push(`${pmmaSurf.toFixed(3)} m¬≤`);
        parts.push(`Ajour√©${pmmaBits.length? ' + PMMA ('+pmmaBits.join(' ¬∑ ')+')':''}`);
        if (led) parts.push(`LED`);
      }

      if (fixVal==='boite'){
        parts.push(`Fixation: bo√Æte${boiteMat? ' ('+boiteMat+')':''}`);
      }else if(fixVal.startsWith('chassis')){
        const size =
          fixVal === 'chassis30' ? '30√ó30' :
          fixVal === 'chassis40' ? '40√ó40' :
          '50√ó50';

        parts.push(
          `Fixation: ch√¢ssis tube aluminium ${size}${gusU ? ' ¬∑ gousset ' + gusU + ' ‚Ç¨/u' : ''}`
        );
      }
      else if(fixVal==='corniere'){
        parts.push(`Fixation: corni√®re`);
      } else if(fixVal === 'lisse') {
        parts.push(`Fixation: pose sur lisse ‚Äî ${lisseNb} √ó ${lisseMM} mm (${lisseMLTotal.toFixed(2)} ml)`);
      }else{
        parts.push(`Fixation: aucune`);
      }

      const designation = parts.join(' ‚Äî ');

      Devis.addLine({
        type: 'T√¥le Tablette',
        designation,
        quantite: qte,
        pu_public_ht: Number(pu_public_ht.toFixed(2))
      });

      alert(`‚úÖ Ligne ajout√©e au devis !\n${designation}\nQt√© : ${qte}\nPU HT : ${pu_public_ht.toFixed(2)} ‚Ç¨`);

    }catch(err){
      console.error(err);
      alert('Erreur lors de l‚Äôajout au devis : ' + err.message);
    }
  });
})();
</script>

</body>
</html>

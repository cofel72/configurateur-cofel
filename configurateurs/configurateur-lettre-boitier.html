<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>

<link rel="stylesheet" href="../styles/cofel.css">
<link rel="stylesheet" href="../styles/cofel-components.css">
<link rel="stylesheet" href="../styles/cofel-glass.css">

<title>Configurateur ‚Äî Lettres Bo√Ætiers | Cofel</title>

<style>
.grid-vertical{
  display:grid;
  grid-template-columns:1fr;
  gap:8px;
}

/* ‚úÖ S√©curit√© : on masque les selects natifs (sinon double rendu selon CSS mutualis√©) */
.native-select{ display:none !important; }

/* ‚úÖ Harmonisation couleurs : on suit les tokens "glass" du th√®me mutualis√© */
.cofel-header.glass{
  background: var(--glass, rgba(255,255,255,.12));
  backdrop-filter: blur(var(--blur, 18px));
  border-bottom: 1px solid var(--glass-stroke, rgba(255,255,255,.18));
}

.panel.glass,
.card.glass{
  background: var(--glass-soft, rgba(255,255,255,.06));
  border: 1px solid var(--glass-stroke, rgba(255,255,255,.18));
}

/* Champs (inputs / selects / toggle custom) */
.panel.glass input,
.panel.glass select,
.cselect-toggle{
  background: rgba(255,255,255,.10);
  color: var(--txt, #fff);
  border: 1px solid rgba(255,255,255,.18);
}

.panel.glass input::placeholder{
  color: rgba(255,255,255,.60);
}

/* Menu d√©roulant custom : coh√©rent (fonc√© neutre, pas violet forc√©) */
.cselect-menu{
  background: rgba(20, 14, 30, .96);
  color: var(--txt, #fff);
  border: 1px solid rgba(255,255,255,.18);
  backdrop-filter: blur(10px);
}

.cselect-option{ padding: 10px 12px; }
.cselect-option:hover{ background: rgba(255,255,255,.10); }
</style>
<link rel="stylesheet" href="/styles/cofel-theme-apple-dark.css">

</head>

<body>

<header class="cofel-header glass">
  <div class="row">
    <a class="cofel-back" href="../index.html">‚¨Ö Retour accueil (devis)</a>
    <div class="cofel-brand">
      <img src="../assets/logo cofel.jpg" alt="Cofel" />
      <h1 class="cofel-title">Configurateur ‚Äî Lettres Bo√Ætiers</h1>
    </div>
  </div>
</header>

<div class="cofel-container">

  <!-- ================= PARAM√àTRES ================= -->
  <section class="panel glass">
    <h2>‚öôÔ∏è Param√®tres</h2>

    <div class="card glass">

      <div class="grid">
        <div>
          <label for="famille">Type de lettre bo√Ætier</label>

          <select id="famille" class="native-select">
            <option value="">‚Äî s√©lectionnez ‚Äî</option>
          </select>

          <div class="cselect" data-bind="famille">
            <button type="button" class="cselect-toggle">
              <span class="cselect-label">‚Äî s√©lectionnez ‚Äî</span>
              <span class="cselect-caret"></span>
            </button>
            <div class="cselect-menu"></div>
          </div>
        </div>

        <div>
          <label for="quantite">Quantit√©</label>
          <input type="number" id="quantite" value="1" min="1"/>
        </div>
      </div>

      <div class="grid">
        <div>
          <label for="hauteur">Hauteur (mm)</label>
          <input type="number" id="hauteur" placeholder="Ex : 325" min="1"/>
          <div id="rangesHelp" class="help"></div>
        </div>

        <div>
          <label for="variant">√âclairage</label>

          <select id="variant" class="native-select">
            <option value="">‚Äî (aucun filtre) ‚Äî</option>
          </select>

          <div class="cselect" data-bind="variant">
            <button type="button" class="cselect-toggle">
              <span class="cselect-label">‚Äî (aucun filtre) ‚Äî</span>
              <span class="cselect-caret"></span>
            </button>
            <div class="cselect-menu"></div>
          </div>

          <div id="variantHelp" class="help"></div>
          <div id="lightingInfo" class="help hidden"></div>
        </div>
      </div>

      <div class="grid">
        <div>
          <h3 class="card-title">Suppl√©ments</h3>

          <div class="grid-vertical">
            <label class="option-item">
              <input type="checkbox" id="optLisse">
              <span>Pose sur lisse</span>
            </label>
          </div>

          <!-- ‚úÖ MODIF : longueur + nombre de lisses -->
          <div id="lisseBlock" class="hidden" style="margin-top:10px">
            <div class="grid">
              <div>
                <label for="lisseLongueur">Longueur d‚Äôune lisse (mm)</label>
                <input type="number" id="lisseLongueur" placeholder="Ex : 10000">
              </div>
              <div>
                <label for="lisseNb">Nombre de lisses</label>
                <input type="number" id="lisseNb" min="1" value="1">
              </div>
            </div>
            <div class="help"></div>
          </div>
        </div>
      </div>

    </div>
  </section>

  <!-- ================= R√âCAP ================= -->
  <section class="panel glass">
    <h2>üßæ R√©capitulatif</h2>

    <div class="result">
      <p>Prix HT : <b><span id="prixHT">0,00</span> ‚Ç¨</b></p>
      <p>Prix TTC : <b><span id="prixTTC">0,00</span> ‚Ç¨</b></p>
      <div class="muted">TVA 20 % incluse dans le calcul.</div>
      <div class="muted">üìê Plan de pose inclus avec nos lettres bo√Ætiers.</div>
    </div>

    <div style="margin-top:16px;display:flex;gap:10px;flex-wrap:wrap;">
      <button id="btnAddDevis" class="btn">‚ûï Ajouter au devis</button>
      <button id="btnReset" class="btn btn-ghost">üîÑ R√©initialiser</button>
    </div>
  </section>

</div>

<footer class="cofel-footer">
  ¬© Cofel ‚Äî ZA du Perquoi, 72560 Chang√© ‚Äî SIRET 927 659 458 00024 ‚Äî TVA FR80927659458
</footer>

<script>
/* ======================= CONFIG ======================= */
const TVA = 0.20;
const COEF_PUBLIC = 2;

/**
 * ‚úÖ OPTION B ‚Äî correction globale des tarifs issus du CSV
 * Ton CSV a √©t√© rempli avec une logique "-30%" (donc 70% du prix initial),
 * mais tu veux finalement √™tre √† "50% du prix initial".
 * => facteur = 0.50 / 0.70 = 0.714285714
 *
 * ‚ö†Ô∏è Si au contraire ton CSV repr√©sente "30% du prix initial" (0.30√ó),
 * alors mets plut√¥t : 0.50 / 0.30 = 1.666666667
 */
const COEF_CORRECTION_CSV = 0.714285714;

/* Suppl√©ment lisse (INTERNE) ‚Äî NON multipli√© par quantit√© */
const TARIF_LISSE_INTERNE_ML = 25; // ‚Ç¨/ml

const FAMILLES = [
  { name: "Bo√Ætier B√¢ton ‚Äì face PMMA blanc diffusant",
    url: "https://raw.githubusercontent.com/stevens-cofel/configurateur-cofel/refs/heads/main/lettres/lettre%20boitier%20baton%20chants%20alu%20laqu%C3%A9%20et%20face%20PMMA%20blanc%20diffusant.csv" },
  { name: "Bo√Ætier B√¢ton ‚Äì face Dibond",
    url: "https://raw.githubusercontent.com/stevens-cofel/configurateur-cofel/refs/heads/main/lettres/Lettre%20boitier%20laqu%C3%A9e%20B%C3%A2ton%20chants%20aluminium%20et%20face%20avant%20type%20Dibond.csv" },
  { name: "Bo√Ætier Fantaisie ‚Äì face Dibond",
    url: "https://raw.githubusercontent.com/stevens-cofel/configurateur-cofel/refs/heads/main/lettres/Lettre%20boitier%20laqu%C3%A9e%20Fantaisie%20chants%20aluminium%20et%20face%20avant%20type%20Dibond.csv" },
  { name: "Bo√Ætier Fantaisie ‚Äì face PMMA blanc diffusant",
    url: "https://raw.githubusercontent.com/stevens-cofel/configurateur-cofel/refs/heads/main/lettres/Lettre%20boitier%20Fantaisie%20chants%20laqu%C3%A9s%20et%20faces%20PMMA%20blanc%20diffusant.csv" }
];

/* ======================= STATE ======================= */
let CURRENT=null, HEADS=[], ROWS=[], MAP=null;

const $ = id => document.getElementById(id);

const elFam = $("famille");
const elQ   = $("quantite");
const elH   = $("hauteur");
const elVar = $("variant");
const elVarHelp = $("variantHelp");
const elRanges  = $("rangesHelp");
const elHT  = $("prixHT");
const elTTC = $("prixTTC");
const elOptLisse = $("optLisse");
const elLongLisse = $("lisseLongueur");
const elNbLisse = $("lisseNb"); // ‚úÖ AJOUT
const elLightingInfo = document.getElementById("lightingInfo");

function updateLisseUI(){
  const block = document.getElementById("lisseBlock");
  if (!block) return;
  if (elOptLisse.checked) block.classList.remove("hidden");
  else block.classList.add("hidden");
}

/* ======================= UTILS ======================= */
function normKey(k){
  return String(k||'').toLowerCase()
    .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
    .replace(/[^a-z0-9]+/g,'')
    .trim();
}

function numFR(v){
  if(v==null) return NaN;
  let s = String(v).trim().replace(/‚Ç¨/g,'')
    .replace(/[\u00A0\u202F]/g,'')
    .replace(/\s+/g,'');
  if(s.includes(',') && s.includes('.')) s=s.replace(/\./g,'');
  s=s.replace(',','.');
  const m=s.match(/-?\d+(\.\d+)?/);
  return m ? parseFloat(m[0]) : NaN;
}

function euro(n){
  return (isFinite(n)?n:0).toFixed(2).replace('.',',');
}

/* =====================================================
   ‚úÖ REMISE S√âRIE (quantit√©) ‚Äî "moins agressive"
   R√®gle demand√©e :
   - 1 √† 4 : 0%
   - 5 √† 10 : -5%
   - 11+ : -10%
   ‚ö†Ô∏è S'applique uniquement sur les LETTRES (pas sur la lisse)
===================================================== */
function getRemiseSerieFactor(q){
  q = Math.max(1, parseInt(q, 10) || 1);
  if (q >= 11) return 0.90; // -10%
  if (q >= 5)  return 0.95; // -5%
  return 1.00;             // 0%
}

/* ======================= CUSTOM SELECT ======================= */
const customSelects=new Map();

function buildCustomFromNative(native){
  const wrap=document.querySelector('.cselect[data-bind="'+native.id+'"]');
  if(!wrap) return;

  const toggle=wrap.querySelector('.cselect-toggle');
  const label=wrap.querySelector('.cselect-label');
  const menu =wrap.querySelector('.cselect-menu');
  menu.innerHTML='';

  Array.from(native.options).forEach(opt=>{
    const d=document.createElement('div');
    d.className='cselect-option';
    d.setAttribute('role','option');
    d.dataset.value=opt.value;
    d.textContent=opt.textContent;
    if(opt.selected) d.setAttribute('aria-selected','true');

    d.addEventListener('click',()=>{ setNativeValue(native,opt.value); closeMenu(native.id); });
    menu.appendChild(d);
  });

  label.textContent = native.selectedOptions[0]?.textContent || "";

  toggle.onclick = ()=> {
    const exp = wrap.getAttribute('aria-expanded')==='true';
    exp ? closeMenu(native.id) : openMenu(native.id);
  };

  customSelects.set(native.id,{wrap,toggle,labelSpan:label,menu,native});
}

function setNativeValue(native,val){
  if(native.value !== val){
    native.value = val;
    native.dispatchEvent(new Event('change',{bubbles:true}));
  }
  const api = customSelects.get(native.id);
  if(api){
    api.labelSpan.textContent = native.selectedOptions[0]?.textContent || "";
    Array.from(api.menu.children).forEach(n=>{
      n.setAttribute('aria-selected', n.dataset.value===val ? 'true':'false');
    });
  }
}

function openMenu(id){
  const api = customSelects.get(id);
  if(!api) return;

  const {wrap,toggle,menu} = api;
  wrap.setAttribute('aria-expanded','true');

  const r=toggle.getBoundingClientRect();
  menu.style.left = Math.round(r.left)+'px';
  menu.style.top  = Math.round(r.bottom+6)+'px';
  menu.style.width= Math.round(r.width)+'px';

  if(menu.parentElement!==document.body) document.body.appendChild(menu);
  menu.style.display='block';

  const onDocClick = (e)=>{
    if(!wrap.contains(e.target) && !menu.contains(e.target)) closeMenu(id);
  };
  const onViewport = ()=> closeMenu(id);

  window.addEventListener('scroll',onViewport,{passive:true});
  window.addEventListener('resize',onViewport);
  document.addEventListener('click',onDocClick);

  api.__off = ()=>{
    window.removeEventListener('scroll',onViewport);
    window.removeEventListener('resize',onViewport);
    document.removeEventListener('click',onDocClick);
  };
}

function closeMenu(id){
  const api = customSelects.get(id);
  if(!api) return;

  const {wrap,menu,__off} = api;
  wrap.setAttribute('aria-expanded','false');
  menu.style.display='none';
  if(menu.parentElement!==wrap) wrap.appendChild(menu);

  if(typeof __off==='function') __off();
  api.toggle.focus();
}

/* ======================= CSV PARSER ======================= */
function parseCSVLine(line,sep=','){
  const out=[]; let cur='', inQ=false;
  for(let i=0;i<line.length;i++){
    const ch=line[i], nx=line[i+1];
    if(ch==='"'){
      if(inQ && nx==='"'){ cur+='"'; i++; }
      else inQ=!inQ;
    } else if(ch===sep && !inQ){
      out.push(cur); cur='';
    } else cur+=ch;
  }
  out.push(cur);
  return out;
}

function normalizeWeirdCSV(text){
  let t=text.replace(/^\uFEFF/,'').replace(/\r/g,'');
  const manyQuotes=(t.match(/"/g)||[]).length>50;
  const fewNewlines=(t.match(/\n/g)||[]).length<3;
  if(manyQuotes && fewNewlines){
    t=t.replace(/""/g,'"');
    const blocks=[], re=/"([^"]*)"/g; let m;
    while((m=re.exec(t))!==null) blocks.push(m[1]);
    if(!blocks.length) return text;
    const cols=parseCSVLine(blocks[0],',').length;
    const lines=[];
    for(let i=0;i<blocks.length;i+=cols){
      lines.push(blocks.slice(i,i+cols).map(s=>'"'+s+'"').join(','));
    }
    return lines.join('\n');
  }
  return t.split('\n').map(l=>{
    const s=l.trim();
    return (s.startsWith('"') && s.endsWith('"')) ? s.slice(1,-1) : s;
  }).join('\n');
}

function parseCSVAuto(text){
  const norm=normalizeWeirdCSV(text);
  const lines=norm.split('\n').filter(l=>l.trim()!=='');
  if(!lines.length) return {rawHeads:[],rows:[]};

  const first=lines[0];
  const sep=((first.match(/;/g)||[]).length > (first.match(/,/g)||[]).length) ? ';' : ',';

  const rawHeads=parseCSVLine(first,sep).map(s=>s.replace(/^"+|"+$/g,'').trim());
  const rows=lines.slice(1).map(line=>{
    const cells=parseCSVLine(line,sep).map(s=>s.replace(/^"+|"+$/g,'').trim());
    const o={}; rawHeads.forEach((h,i)=>o[h]=cells[i]??'');
    return o;
  });

  return {rawHeads,rows};
}

/* ======================= MAPPING CSV ‚Üí champs utiles ======================= */
function buildMapping(rawHeads){
  const NK = rawHeads.map(normKey);
  const find = (k)=>{
    const i = NK.indexOf(k);
    return i>=0 ? rawHeads[i] : null;
  };
  const loose = (...reg)=> {
    for(let i=0;i<NK.length;i++){
      if(reg.every(r=>r.test(NK[i]))) return rawHeads[i];
    }
    return null;
  };

  const hminKey = find('hauteurminmm') || loose(/hauteur/,/min/);
  const hmaxKey = find('hauteurmaxmm') || loose(/hauteur/,/max/);
  const baseKey = find('prixunitaireeur') || loose(/prix|tarif/,/eur|ht|unitaire/);
  const variantKey = find('eclairage') || loose(/eclair|led/);

  return {hminKey,hmaxKey,baseKey,variantKey};
}

/* ======================= UI BUILDERS ======================= */
function fillFamilles(){
  elFam.innerHTML =
    '<option value="">‚Äî s√©lectionnez ‚Äî</option>' +
    FAMILLES.map((f,i)=>`<option value="${i}">${f.name}</option>`).join('');
  buildCustomFromNative(elFam);
}

function buildVariantUI(){
  elVar.innerHTML = '<option value="">‚Äî (aucun filtre) ‚Äî</option>';
  elVarHelp.textContent = '';

  if(!MAP?.variantKey){
    buildCustomFromNative(elVar);
    return;
  }

  const key=MAP.variantKey;
  const values=[...new Set(ROWS.map(r=>String(r[key]||'').trim()).filter(Boolean))].sort();

  elVar.innerHTML =
    '<option value="">‚Äî s√©lectionnez ‚Äî</option>' +
    values.map(v=>`<option value="${v}">${v}</option>`).join('');

  elVarHelp.textContent = values.length ? `Filtre sur ¬´ ${key} ¬ª` : '';
  buildCustomFromNative(elVar);
}

function buildRangesHelp(){
  if(!MAP?.hmaxKey){ elRanges.innerHTML=''; return; }
  const kmax=MAP.hmaxKey;
  const maxVals = ROWS.map(r=>numFR(r[kmax])).filter(Number.isFinite);
  if(!maxVals.length){ elRanges.innerHTML=''; return; }
  const maxH = Math.max(...maxVals);
  elRanges.innerHTML = `Hauteur maximale ${Math.round(maxH)} mm`;
}

/* Info √©clairage */
function updateLightingInfo(){
  if (!elLightingInfo) return;

  elLightingInfo.classList.add("hidden");
  elLightingInfo.textContent = "";
  if (!elVar.value) return;

  const famName = (CURRENT?.name || "").toLowerCase();

  if (famName.includes("pmma")) {
    elLightingInfo.textContent = "üí° √âclairage par la face avant (PMMA diffusant).";
    elLightingInfo.classList.remove("hidden");
  }

  if (famName.includes("dibond")) {
    elLightingInfo.textContent = "üí° R√©tro-√©clairage : diffusion lumineuse par l‚Äôarri√®re de la lettre.";
    elLightingInfo.classList.remove("hidden");
  }
}

/* Filtre lignes CSV selon variant */
function filterRowsByVariant(rows){
  if(!MAP?.variantKey) return rows;
  const v=elVar.value;
  if(!v) return rows;
  return rows.filter(r => String(r[MAP.variantKey]||'').trim() === v);
}

/* Trouve la ligne CSV correspondant √† la hauteur */
function findRowForHeight(H){
  const kmin=MAP.hminKey;
  const kmax=MAP.hmaxKey;

  let rows=filterRowsByVariant(ROWS);
  if(!rows.length) return null;

  rows = rows.map(r=>{
    const a=numFR(kmin?r[kmin]:0);
    const b=numFR(r[kmax]);
    return {...r, __a:a, __b:b};
  }).filter(r=>Number.isFinite(r.__b))
    .sort((a,b)=>a.__a!==b.__a ? a.__a-b.__a : a.__b-b.__b);

  const exact=rows.find(r=>H>=r.__a && H<=r.__b);
  if(exact) return exact;

  let best=null, bestDist=Infinity;
  for(const r of rows){
    const d = (H<r.__a) ? (r.__a-H) : (H-r.__b);
    if(d<bestDist){ bestDist=d; best=r; }
  }
  return best || rows[0];
}

/* ======================= COMPUTE ======================= */
function compute(){
  updateLisseUI();

  let remiseClient = 1;
  try {
    const p = JSON.parse(localStorage.getItem("cofel_client_profile"));
    if (p && typeof p.discountRate === "number") remiseClient = 1 - p.discountRate;
  } catch(e){}

  const H = Number(elH.value || 0);
  const Q = Math.max(1, parseInt(elQ.value || 1, 10) || 1);

  // Si un champ "variant" existe dans le CSV, on force la s√©lection
  if (MAP?.variantKey && !elVar.value){
    elHT.textContent="0,00";
    elTTC.textContent="0,00";
    updateLightingInfo();
    return;
  }

  if(!(H>0) || !ROWS.length || !MAP?.hmaxKey || !MAP?.baseKey){
    elHT.textContent="0,00";
    elTTC.textContent="0,00";
    updateLightingInfo();
    return;
  }

  const row = findRowForHeight(H);

  // ‚úÖ Prix unitaire interne issu du CSV (corrig√© par COEF_CORRECTION_CSV)
  const base_interne_raw = row ? numFR(row[MAP.baseKey]) : 0;
  const base_interne = base_interne_raw * COEF_CORRECTION_CSV;

  // ‚úÖ Lisse NON multipli√©e par quantit√©, mais multipli√©e par nb lisses
  let supplement_lisse_interne = 0;
  let Lmm = 0, nbL = 1, LmlUnit = 0, LmlTotal = 0;
  if (elOptLisse && elOptLisse.checked){
    Lmm = Number(elLongLisse.value || 0);
    nbL = Math.max(1, parseInt(elNbLisse?.value || 1, 10));
    if (Lmm > 0){
      LmlUnit = Lmm / 1000;
      LmlTotal = LmlUnit * nbL;
      supplement_lisse_interne = TARIF_LISSE_INTERNE_ML * LmlTotal;
    }
  }

  /* =============================
     ‚úÖ REMISE S√âRIE SUR LES LETTRES
     - On applique le facteur sur (base_interne * Q)
     - La lisse reste hors remise s√©rie
  ============================== */
  const total_interne_lettres = base_interne * Q;
  const serieFactor = getRemiseSerieFactor(Q);
  const total_interne_lettres_serie = total_interne_lettres * serieFactor;

  const total_interne = total_interne_lettres_serie + supplement_lisse_interne;

  const total_public_brut = total_interne * COEF_PUBLIC;
  const total_net_client = total_public_brut * remiseClient;

  const pu_public_ht = Q > 0 ? (total_net_client / Q) : 0;

  elHT.textContent  = euro(total_net_client);
  elTTC.textContent = euro(total_net_client * (1 + TVA));

  window._LETTER_BOITIER_LAST = {
    pu_public_ht : Number(pu_public_ht.toFixed(2)),
    total_net_ht : Number(total_net_client.toFixed(2)),
    supplement_lisse_interne : Number(supplement_lisse_interne.toFixed(2)),
    lmm: Lmm,
    nbLisse: nbL,
    lmlTotal: LmlTotal,
    // debug √©ventuel
    serieFactor,
    total_interne_lettres,
    total_interne_lettres_serie
  };

  updateLightingInfo();
}

/* ======================= LOADERS ======================= */
async function fetchText(url){
  const r = await fetch(url, {cache:"no-store"});
  if(!r.ok) throw new Error("HTTP " + r.status);
  return await r.text();
}

async function loadFamily(f){
  const txt = await fetchText(f.url);
  const {rawHeads,rows} = parseCSVAuto(txt);
  HEADS = rawHeads;
  ROWS  = rows;
  MAP   = buildMapping(HEADS);
  buildVariantUI();
  buildRangesHelp();
  compute();
}

/* ======================= INIT & BIND ======================= */
function bind(){
  elFam.addEventListener("change", async ()=>{
    const i = parseInt(elFam.value,10);
    if (isNaN(i)){
      CURRENT = null; ROWS = []; MAP = null;
      compute();
      return;
    }

    CURRENT = FAMILLES[i];
    try {
      await loadFamily(CURRENT);
    } catch(e){
      console.error(e);
      alert("Erreur chargement CSV.");
    }
  });

  elQ.addEventListener("input", compute);

  elH.addEventListener("input", ()=>{
    buildRangesHelp();
    compute();
  });

  elVar.addEventListener("change", ()=>{
    buildRangesHelp();
    compute();
  });

  elOptLisse.addEventListener("change", compute);
  elLongLisse.addEventListener("input", compute);
  elNbLisse.addEventListener("input", compute); // ‚úÖ AJOUT

  $("btnReset").addEventListener("click", ()=>{
    elFam.value = "";
    buildCustomFromNative(elFam);

    CURRENT = null; ROWS = []; MAP = null;

    elVar.innerHTML = '<option value="">‚Äî (aucun filtre) ‚Äî</option>';
    buildCustomFromNative(elVar);

    elQ.value = 1;
    elH.value = "";
    elRanges.innerHTML = "";

    elOptLisse.checked = false;
    elLongLisse.value = "";
    if (elNbLisse) elNbLisse.value = 1;
    updateLisseUI();

    compute();
  });
}

(function init(){
  fillFamilles();
  bind();
  updateLisseUI();
})();
</script>

<script src="../js/devis-core.js"></script>

<script>
document.getElementById("btnAddDevis").addEventListener("click", () => {
  try {
    if (!window.Devis) throw new Error("Moteur de devis introuvable.");

    const famIdx = parseInt(document.getElementById("famille").value, 10);
    if (isNaN(famIdx)) {
      alert("Choisis d'abord une famille de lettres bo√Ætiers.");
      return;
    }

    const familleName = (FAMILLES[famIdx] || {}).name || "Lettres bo√Ætiers";
    const qte = Math.max(1, parseInt(document.getElementById("quantite").value || 1, 10) || 1);
    const H   = Number(document.getElementById("hauteur").value || 0);
    const variant = document.getElementById("variant").value;

    if (!(H > 0)) {
      alert("Saisis une hauteur valide.");
      return;
    }

    const p = window._LETTER_BOITIER_LAST;
    if (!p) {
      alert("Erreur interne : le calcul n‚Äôa pas √©t√© trouv√©.");
      return;
    }

    const optLisse = document.getElementById("optLisse").checked;
    const lisseLongueur = Number(document.getElementById("lisseLongueur").value || 0);
    const lisseNb = Math.max(1, parseInt(document.getElementById("lisseNb")?.value || 1, 10));
    const lisseML = (lisseLongueur / 1000) * lisseNb;

    let designation = `${familleName} ‚Äî H ${H} mm`;
    if (variant) designation += ` ‚Äî √âclairage: ${variant}`;
    if (optLisse){
      designation += (lisseLongueur > 0)
        ? ` ‚Äî Pose sur lisse ‚Äî ${lisseNb} √ó ${lisseLongueur} mm (${lisseML.toFixed(2)} ml)`
        : ` ‚Äî Pose sur lisse`;
    }

    const total_ht_affiche = parseFloat(
      document.getElementById("prixHT").innerText.replace(",", ".")
    ) || 0;

    if (total_ht_affiche <= 0) {
      alert("Le prix calcul√© est √† 0. V√©rifie famille / hauteur / √©clairage.");
      return;
    }

    Devis.addLine({
      type: "Lettres Bo√Ætiers",
      designation,
      quantite: qte,
      pu_public_ht: p.pu_public_ht,
      pu_net_ht: Number(p.pu_public_ht.toFixed(2)),
      total_ligne_ht: Number(p.total_net_ht.toFixed(2))
    });

    alert("‚úÖ Ligne ajout√©e au devis !");
  } catch (err) {
    console.error(err);
    alert("Erreur lors de l‚Äôajout au devis : " + err.message);
  }
});
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Configurateur ‚Äî Lettres Bo√Ætiers | Cofel</title>

<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

<style>
  :root{
    --violet:#5a2d82;
    --violet-2:#7838a7;
    --glass: rgba(255,255,255,.08);
    --glass-hr: rgba(255,255,255,.14);
    --txt:#f5f7ff;
    --txt-dim:#e6e6ff;
    --accent:#c9b7ff;
    --radius:18px;
    --blur:18px;
    --shadow: 0 10px 30px rgba(0,0,0,.35);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--txt);
    font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text","Segoe UI",Roboto,Arial,sans-serif;
    background:
      radial-gradient(800px 500px at 20% -10%, rgba(255,255,255,.10), transparent 60%),
      radial-gradient(800px 500px at 110% 10%, rgba(255,255,255,.08), transparent 60%),
      linear-gradient(135deg, var(--violet), var(--violet-2));
  }

  /* HERO */
  .hero{position:relative;z-index:1;padding:40px 20px 24px;}
  .hero-inner{max-width:1200px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;gap:16px;}
  .brand{
    display:flex;align-items:center;gap:14px;
    backdrop-filter:blur(var(--blur));
    background:linear-gradient(180deg,rgba(255,255,255,.14),rgba(255,255,255,.06));
    border:1px solid rgba(255,255,255,.18);
    padding:10px 14px;border-radius:14px;box-shadow:var(--shadow);
  }
  .brand img{height:42px;width:auto;border-radius:10px}
  .brand h1{font-size:clamp(18px,2.6vw,22px);margin:0}
  .tagline{max-width:1200px;margin:18px auto 0;padding:0 20px;color:var(--txt-dim)}

  /* PANELS */
  .wrap{max-width:1200px;margin:26px auto;padding:0 20px 40px;}
  .panel{
    background:linear-gradient(180deg,rgba(255,255,255,.16),rgba(255,255,255,.06));
    border:1px solid var(--glass-hr);
    border-radius:20px;padding:18px;box-shadow:var(--shadow);backdrop-filter:blur(var(--blur));
    margin-bottom:18px;
  }
  .panel h2{margin:0 0 12px;font-size:clamp(18px,2.4vw,22px);letter-spacing:.2px}
  .card{
    background:var(--glass);
    border:1px solid var(--glass-hr);
    border-radius:16px;padding:14px;box-shadow:var(--shadow);
    backdrop-filter:blur(var(--blur));
  }
  .grid{display:grid;gap:12px;grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
  .help{color:var(--txt-dim);font-size:12px;margin-top:6px}

  label{font-weight:700;font-size:13px;color:var(--accent);} 
  input[type="number"]{
    width:100%; padding:10px 12px; margin-top:6px;
    border-radius:12px; outline:none; color:var(--txt);
    border:1px solid var(--glass-hr);
    background:linear-gradient(180deg,rgba(255,255,255,.14),rgba(255,255,255,.06));
    box-shadow:var(--shadow);
    transition:border-color .18s, box-shadow .18s;
  }

  /* Option LISSE */
  .option-item{
    display:flex;align-items:center;gap:10px;cursor:pointer;
    border-radius:14px;padding:10px;
    border:1px solid rgba(255,255,255,.24);
    background:rgba(255,255,255,.12);
    margin-bottom:8px;color:var(--txt);
  }
  .option-item input[type="checkbox"]{
    appearance:none;width:20px;height:20px;border-radius:6px;
    border:1px solid rgba(255,255,255,.7);background:rgba(255,255,255,.15);
  }
  .option-item input[type="checkbox"]:checked{
    background:var(--violet-2);
    border-color:#fff;
  }

  #blockLisse{
    margin-top:10px;
    padding:12px;
    border:1px solid rgba(255,255,255,.22);
    border-radius:14px;
    background:rgba(255,255,255,.08);
    display:none;
  }

  /* RESULT */
  .result{
    text-align:center;padding:16px;
    background:linear-gradient(180deg,rgba(255,255,255,.14),rgba(255,255,255,.06));
    border:1px solid var(--glass-hr); border-radius:16px;
    box-shadow:0 8px 22px rgba(0,0,0,.28);
    font-size:18px;
  }
  .result b{font-size:20px}

  footer{
    color:#f3ecff;font-size:12px;text-align:center;padding:24px 10px;opacity:.9;
  }
</style>
</head>
<body>

<!-- ========= HERO ========= -->
<div class="hero">
  <div class="hero-inner">
    <div class="brand">
      <img src="../assets/logo cofel.jpg" alt="Cofel" />
      <h1>Configurateur ‚Äî Lettres Bo√Ætiers</h1>
    </div>
    <a class="brand" href="../index.html" style="text-decoration:none;color:inherit">‚¨Ö Retour accueil (devis)</a>
  </div>
  <div class="tagline">Choisissez la famille, la hauteur et l‚Äô√©clairage. Les montants s‚Äôactualisent automatiquement.</div>
</div>

<!-- ========= CONTENU ========= -->
<main class="wrap">
<section class="panel">
  <h2>‚öôÔ∏è Param√®tres</h2>

  <!-- Famille / Quantit√© -->
  <div class="card grid">
    <div>
      <label for="famille">Type de lettre bo√Ætier</label>
      <select id="famille" class="native-select">
        <option value="">‚Äî s√©lectionnez ‚Äî</option>
      </select>

      <div class="cselect" data-bind="famille" aria-haspopup="listbox" aria-expanded="false">
        <button type="button" class="cselect-toggle">
          <span class="cselect-label">‚Äî s√©lectionnez ‚Äî</span>
          <span class="cselect-caret"></span>
        </button>
        <div class="cselect-menu" role="listbox"></div>
      </div>
    </div>

    <div>
      <label for="quantite">Quantit√©</label>
      <input type="number" id="quantite" min="1" value="1"/>
    </div>
  </div>

  <!-- Hauteur / Variant -->
  <div class="card grid">
    <div>
      <label for="hauteur">Hauteur (mm)</label>
      <input type="number" id="hauteur" placeholder="Ex : 325" min="1"/>
      <div id="rangesHelp" class="help"></div>
    </div>

    <div>
      <label for="variant">√âclairage (si pr√©sent)</label>

      <select id="variant" class="native-select">
        <option value="">‚Äî (aucun filtre) ‚Äî</option>
      </select>

      <div class="cselect" data-bind="variant" aria-haspopup="listbox" aria-expanded="false">
        <button type="button" class="cselect-toggle">
          <span class="cselect-label">‚Äî (aucun filtre) ‚Äî</span>
          <span class="cselect-caret"></span>
        </button>
        <div class="cselect-menu" role="listbox"></div>
      </div>

      <div id="variantHelp" class="help"></div>
      <div id="dibondRule" class="help" style="display:none">
        Pour les faces Dibond : r√©tro√©clairage obligatoire si √©clairage
      </div>
    </div>
  </div>

  <!-- ========= OPTION LISSE ========= -->
  <div class="card">
    <label class="option-item">
      <input type="checkbox" id="optLisse">
      <span>Pose sur lisse</span>
    </label>

    <div id="blockLisse">
      <label for="lisseLongueur">Longueur de la lisse (mm)</label>
      <input type="number" id="lisseLongueur" placeholder="Ex : 3000" min="0">
      <div class="help">Tarif lisse : 25 ‚Ç¨/ml interne ‚Üí 50 ‚Ç¨/ml public (avant remise)</div>
    </div>
  </div>

</section>
<section class="panel">
  <h2>üßæ R√©capitulatif</h2>

  <div class="result">
    <p>Prix HT : <b><span id="prixHT">0,00</span> ‚Ç¨</b></p>
    <p>Prix TTC : <b><span id="prixTTC">0,00</span> ‚Ç¨</b></p>
    <div class="help">TVA 20 % incluse dans le calcul.</div>
  </div>

  <div style="margin-top:16px;display:flex;gap:10px;flex-wrap:wrap;">
    <button id="btnAddDevis" class="btn">‚ûï Ajouter au devis</button>
    <button id="btnReset" class="btn btn-ghost">üîÑ R√©initialiser</button>
  </div>
</section>
</main>

<footer>
  ¬© Cofel ‚Äî ZA du Perquoi, 72560 Chang√© ‚Äî SIRET 927 659 458 00024 ‚Äî TVA FR80927659458
</footer>

<!-- ======================== JS ======================== -->
<script>
/* ===== CONFIG ===== */
const TVA = 0.20;
const UPLIFT_PUBLIC = 2.0;

/* Tarif lisse interne ‚Üí 25 ‚Ç¨/ml */
const TARIF_LISSE_INTERNE_ML = 25;

/* CSV familles */
const FAMILLES = [
  { name: "Bo√Ætier B√¢ton ‚Äì face PMMA blanc diffusant",
    url: "https://raw.githubusercontent.com/stevens-cofel/configurateur-cofel/refs/heads/main/lettres/lettre%20boitier%20baton%20chants%20alu%20laqu%C3%A9%20et%20face%20PMMA%20blanc%20diffusant.csv" },

  { name: "Bo√Ætier B√¢ton ‚Äì face Dibond",
    url: "https://raw.githubusercontent.com/stevens-cofel/configurateur-cofel/refs/heads/main/lettres/Lettre%20boitier%20laqu%C3%A9e%20B%C3%A2ton%20chants%20aluminium%20et%20face%20avant%20type%20Dibond.csv" },

  { name: "Bo√Ætier Fantaisie ‚Äì face Dibond",
    url: "https://raw.githubusercontent.com/stevens-cofel/configurateur-cofel/refs/heads/main/lettres/Lettre%20boitier%20laqu%C3%A9e%20Fantaisie%20chants%20aluminium%20et%20face%20avant%20type%20Dibond.csv" },

  { name: "Bo√Ætier Fantaisie ‚Äì face PMMA blanc diffusant",
    url: "https://raw.githubusercontent.com/stevens-cofel/configurateur-cofel/refs/heads/main/lettres/Lettre%20boitier%20Fantaisie%20chants%20laqu%C3%A9s%20et%20faces%20PMMA%20blanc%20diffusant.csv" }
];

/* ===== STATE ===== */
let CURRENT = null, HEADS = [], ROWS = [], MAP = null;

const $ = id => document.getElementById(id);

const elFam = $("famille");
const elQ = $("quantite");
const elH = $("hauteur");
const elVar = $("variant");
const elVarHelp = $("variantHelp");
const elRanges = $("rangesHelp");
const elHT = $("prixHT");
const elTTC = $("prixTTC");
const elDibondRule = $("dibondRule");

/* Lisse */
const elOptLisse = $("optLisse");
const elLongLisse = $("lisseLongueur");
const blockLisse = $("blockLisse");

/* ===== UTILS ===== */
function normKey(k){
  return String(k||'').toLowerCase()
    .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
    .replace(/[^a-z0-9]+/g,'').trim();
}
function numFR(v){
  if(v==null) return NaN;
  let s=String(v).trim().replace(/‚Ç¨/g,'')
    .replace(/[\u00A0\u202F]/g,'')
    .replace(/\s+/g,'');
  if(s.includes(',') && s.includes('.')) s=s.replace(/\./g,'');
  s=s.replace(',','.');
  const m=s.match(/-?\d+(\.\d+)?/);
  return m ? parseFloat(m[0]) : NaN;
}
function euro(n){ return (isFinite(n)?n:0).toFixed(2).replace('.',','); }

/* ===== CUSTOM SELECT ===== */
const customSelects = new Map();

function buildCustomFromNative(native){
  const wrap = document.querySelector('.cselect[data-bind="'+native.id+'"]');
  if(!wrap) return;

  const toggle = wrap.querySelector('.cselect-toggle');
  const label  = wrap.querySelector('.cselect-label');
  const menu   = wrap.querySelector('.cselect-menu');

  menu.innerHTML = "";

  Array.from(native.options).forEach(opt=>{
    const d=document.createElement("div");
    d.className="cselect-option";
    d.setAttribute("role","option");
    d.tabIndex = -1;
    d.dataset.value = opt.value;
    d.textContent = opt.textContent;
    if(opt.selected) d.setAttribute("aria-selected","true");

    d.onclick = ()=>{ setNativeValue(native,opt.value); closeMenu(native.id); };
    menu.appendChild(d);
  });

  label.textContent = native.selectedOptions[0]?.textContent || "";

  toggle.onclick = ()=>{
    wrap.getAttribute("aria-expanded")==="true"
      ? closeMenu(native.id)
      : openMenu(native.id);
  };

  customSelects.set(native.id, {wrap,toggle,label,menu,native});
}

function setNativeValue(native,val){
  if(native.value !== val){
    native.value = val;
    native.dispatchEvent(new Event("change",{bubbles:true}));
  }
  const api = customSelects.get(native.id);
  if(api){
    api.label.textContent = native.selectedOptions[0]?.textContent || "";
  }
}

function openMenu(id){
  const api = customSelects.get(id);
  if(!api) return;

  const {wrap,toggle,menu} = api;

  wrap.setAttribute("aria-expanded","true");

  const r = toggle.getBoundingClientRect();
  menu.style.left = r.left+"px";
  menu.style.top  = (r.bottom+6)+"px";
  menu.style.width = r.width+"px";

  if(menu.parentElement !== document.body){
    document.body.appendChild(menu);
  }
  menu.style.display = "block";

  const closeAll = e=>{
    if(!wrap.contains(e.target) && !menu.contains(e.target)){
      closeMenu(id);
    }
  };
  setTimeout(()=>document.addEventListener("click",closeAll),50);
  api.__closeAll = closeAll;
}

function closeMenu(id){
  const api = customSelects.get(id);
  if(!api) return;
  const {wrap,menu,__closeAll} = api;

  wrap.setAttribute("aria-expanded","false");
  menu.style.display="none";

  if(menu.parentElement !== wrap){
    wrap.appendChild(menu);
  }
  if(__closeAll){
    document.removeEventListener("click",__closeAll);
  }
}

/* ===== CSV ===== */
function parseCSVLine(line,sep=','){
  const out=[]; let cur=""; let inQ=false;
  for(let i=0;i<line.length;i++){
    const ch=line[i], nx=line[i+1];
    if(ch==='"'){
      if(inQ && nx==='"'){ cur+='"'; i++; }
      else inQ=!inQ;
    }else if(ch===sep && !inQ){
      out.push(cur); cur="";
    }else cur+=ch;
  }
  out.push(cur);
  return out;
}

function parseCSVAuto(text){
  const lines=text.split(/\r?\n/).filter(l=>l.trim()!=="");
  if(!lines.length) return {rawHeads:[],rows:[]};

  const first=lines[0];
  const sep=((first.match(/;/g)||[]).length>(first.match(/,/g)||[]).length)?';':',';

  const rawHeads=parseCSVLine(lines[0],sep).map(s=>s.replace(/^"+|"+$/g,"").trim());

  const rows=lines.slice(1).map(line=>{
    const cells=parseCSVLine(line,sep).map(s=>s.replace(/^"+|"+$/g,"").trim());
    const o={};
    rawHeads.forEach((h,i)=>o[h]=cells[i]??"");
    return o;
  });
  return {rawHeads,rows};
}

function buildMapping(rawHeads){
  const NK=rawHeads.map(normKey);
  const find = key => {const i=NK.indexOf(key); return i>=0?rawHeads[i]:null;};
  const loose=(...r)=>{for(let i=0;i<NK.length;i++){if(r.every(rx=>rx.test(NK[i]))) return rawHeads[i];}return null;};

  return {
    hminKey: find("hauteurminmm") || loose(/hauteur/,/min/),
    hmaxKey: find("hauteurmaxmm") || loose(/hauteur/,/max/),
    baseKey: find("prixunitaireeur") || loose(/prix|ht|unitaire/),
    variantKey: find("eclairage") || loose(/eclair|led/)
  };
}

/* ===== FILTRES ===== */
function filterRowsByVariant(rows){
  if(!MAP?.variantKey) return rows;
  const v = elVar.value;
  if(!v) return rows;
  return rows.filter(r=>String(r[MAP.variantKey]||"").trim()===v);
}

function findRowForHeight(H){
  const rows=filterRowsByVariant(ROWS);
  if(!rows.length) return null;

  const aKey=MAP.hminKey, bKey=MAP.hmaxKey;

  let converted = rows.map(r=>({
    ...r,
    __a: numFR(r[aKey]||0),
    __b: numFR(r[bKey]||0)
  })).filter(r=>Number.isFinite(r.__b))
    .sort((a,b)=>a.__a - b.__a);

  let exact = converted.find(r=>H>=r.__a && H<=r.__b);
  if(exact) return exact;

  return converted[converted.length-1];
}

/* ===== COMPUTE ===== */
function compute(){
  let remiseClient = 1;
  try{
    const p = JSON.parse(localStorage.getItem("cofel_client_profile"));
    if(p && typeof p.discountRate==="number"){
      remiseClient = 1 - p.discountRate;
    }
  }catch(e){}

  const Q = Math.max(1,Number(elQ.value||1));
  const H = Number(elH.value||0);

  /* √âclairage obligatoire si filtre */
  if(MAP?.variantKey && !elVar.value){
    elHT.textContent="0,00";
    elTTC.textContent="0,00";
    return;
  }

  if(!(H>0) || !ROWS.length){
    elHT.textContent="0,00";
    elTTC.textContent="0,00";
    return;
  }

  const row = findRowForHeight(H);
  const base_interne = row ? numFR(row[MAP.baseKey]) : 0;

  let pu_public = base_interne * UPLIFT_PUBLIC;

  /* ========= AJOUT POSE SUR LISSE ========= */
  if(elOptLisse.checked){
    const mm = Number(elLongLisse.value||0);
    if(mm>0){
      const ml = mm/1000;
      const prix_lisse_interne = TARIF_LISSE_INTERNE_ML * ml;
      const prix_lisse_public  = prix_lisse_interne * UPLIFT_PUBLIC;
      pu_public += prix_lisse_public;
    }
  }

  /* Remise */
  pu_public *= remiseClient;

  const totalHT  = pu_public * Q;
  const totalTTC = totalHT * (1+TVA);

  elHT.textContent  = euro(totalHT);
  elTTC.textContent = euro(totalTTC);
}

/* ===== LOADING ===== */
async function fetchText(url){
  const r = await fetch(url,{cache:"no-store"});
  if(!r.ok) throw new Error("HTTP "+r.status);
  return await r.text();
}
async function loadFamily(f){
  const txt = await fetchText(f.url);
  const parsed = parseCSVAuto(txt);

  HEADS = parsed.rawHeads;
  ROWS  = parsed.rows;
  MAP   = buildMapping(HEADS);

  buildVariantUI();
  buildRangesHelp();
  compute();
}

function buildVariantUI(){
  elVar.innerHTML = '<option value="">‚Äî (aucun filtre) ‚Äî</option>';
  elVarHelp.textContent = "";

  if(!MAP?.variantKey){
    buildCustomFromNative(elVar);
    return;
  }

  const key = MAP.variantKey;
  const values = [...new Set(
    ROWS.map(r=>String(r[key]||"").trim())
  )].filter(Boolean).sort();

  if(values.length){
    elVar.innerHTML =
      '<option value="">‚Äî s√©lectionnez ‚Äî</option>' +
      values.map(v=>`<option value="${v}">${v}</option>`).join('');
    elVarHelp.textContent = `Filtre sur : ${key}`;
  }

  buildCustomFromNative(elVar);
}

function buildRangesHelp(){
  if(!MAP?.hmaxKey){
    elRanges.textContent="";
    return;
  }
  const vals = ROWS.map(r=>numFR(r[MAP.hmaxKey])).filter(Number.isFinite);
  if(!vals.length) return;
  elRanges.textContent = `Hauteur maximale : ${Math.max(...vals)} mm`;
}

/* ===== INIT ===== */
function fillFamilles(){
  elFam.innerHTML =
    '<option value="">‚Äî s√©lectionnez ‚Äî</option>' +
    FAMILLES.map((f,i)=>`<option value="${i}">${f.name}</option>`).join('');
  buildCustomFromNative(elFam);
}

function init(){
  fillFamilles();

  elFam.onchange = async ()=>{
    const i = parseInt(elFam.value,10);
    if(isNaN(i)){
      CURRENT=null; ROWS=[]; MAP=null;
      compute();
      return;
    }
    CURRENT = FAMILLES[i];
    try{ await loadFamily(CURRENT); }
    catch(e){ alert("Erreur de chargement CSV"); }
  };

  elQ.oninput = compute;
  elH.oninput = compute;
  elVar.onchange = compute;

  /* ----- Lisse ----- */
  elOptLisse.onchange = ()=>{
    blockLisse.style.display = elOptLisse.checked ? "block" : "none";
    compute();
  };
  elLongLisse.oninput = compute;

  $("btnReset").onclick = ()=>{
    elFam.value = "";
    buildCustomFromNative(elFam);

    elVar.innerHTML = '<option value="">‚Äî (aucun filtre) ‚Äî</option>';
    buildCustomFromNative(elVar);

    elQ.value = 1;
    elH.value = "";
    elOptLisse.checked=false;
    elLongLisse.value="";
    blockLisse.style.display="none";

    CURRENT=null; ROWS=[]; MAP=null;
    elRanges.textContent="";
    compute();
  };
}
init();
</script>

<!-- ========== DEVIS ========== -->
<script src="../js/devis-core.js"></script>
<script>
$("btnAddDevis").onclick = ()=>{
  try{
    if(!window.Devis) throw new Error("Moteur de devis introuvable");

    const famIdx = parseInt(elFam.value,10);
    if(isNaN(famIdx)){ alert("Choisis une famille."); return; }

    const famName = FAMILLES[famIdx].name;
    const qte = Math.max(1, Number(elQ.value||1));
    const H = Number(elH.value||0);

    if(!(H>0)){ alert("Saisis une hauteur valide."); return; }

    const variant = elVar.value;
    const total_ht = parseFloat(elHT.innerText.replace(',','.')) || 0;

    if(total_ht <= 0){ alert("Prix invalid√©."); return; }

    const pu_public_ht = total_ht / qte;

    let designation = `${famName} ‚Äî H ${H} mm`;
    if(variant) designation += ` ‚Äî √âclairage : ${variant}`;

    if(elOptLisse.checked){
      const Lmm = Number(elLongLisse.value||0);
      designation += ` ‚Äî Pose sur lisse (${Lmm} mm)`;
    }

    Devis.addLine({
      type:"Lettres Bo√Ætiers",
      designation,
      quantite:qte,
      pu_public_ht:Number(pu_public_ht.toFixed(2))
    });

    alert(`Ligne ajout√©e au devis :\n${designation}`);
  }
  catch(err){
    alert("Erreur : "+err.message);
  }
};
</script>

</body>
</html>

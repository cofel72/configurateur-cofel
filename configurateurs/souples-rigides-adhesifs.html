<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>Configurateur — Supports Souples, Rigides & Adhésifs | Cofel</title>

<!-- Styles communs Cofel -->
<link rel="stylesheet" href="../styles/cofel.css">
<link rel="stylesheet" href="../styles/cofel-components.css">
<link rel="stylesheet" href="../styles/cofel-glass.css">
<link rel="stylesheet" href="../styles/cofel-config-steps.css">
</head>

<body>

<header class="cofel-header">
  <div class="row">
    <a href="../index.html" class="cofel-back">⬅ Retour</a>
    <div class="cofel-brand">
      <img src="../assets/logo cofel.jpg" alt="Cofel">
      <h1 class="cofel-title">Supports Souples, Rigides & Adhésifs</h1>
    </div>
  </div>
</header>

<div class="wrapper">

  <!-- BARRE D'ÉTAPES -->
  <div class="steps-nav" id="stepsNav">
    <div class="step-item active" data-step="1">1. Support</div>
    <div class="step-item locked" data-step="2">2. Impression</div>
    <div class="step-item locked" data-step="3">3. Matière</div>
    <div class="step-item locked" data-step="4">4. Variantes</div>
    <div class="step-item locked" data-step="5">5. Découpe</div>
    <div class="step-item locked" data-step="6">6. Lamination</div>
    <div class="step-item locked" data-step="7">7. Blanc</div>
    <div class="step-item locked" data-step="8" id="stepOeillets">8. Œillets</div>
    <div class="step-item locked" data-step="9">9. Format</div>
    <div class="step-item locked" data-step="10">10. Récapitulatif</div>
  </div>

  <!-- ÉTAPE 1 -->
  <section class="step-section active" id="step1">
    <fieldset>
      <legend>Choix du support</legend>
      <div class="radio-row">
        <label><input type="radio" name="support" value="souple"> Support souple</label>
        <label><input type="radio" name="support" value="rigide"> Support rigide</label>
      </div>
    </fieldset>
    <div class="nav-buttons"><button class="btn-nav" id="next1" type="button">Étape suivante ➜</button></div>
  </section>

  <!-- ÉTAPE 2 -->
  <section class="step-section" id="step2">
    <fieldset>
      <legend>Impression</legend>
      <div class="radio-row">
        <label><input type="radio" name="impression" value="avec"> Avec impression</label>
        <label><input type="radio" name="impression" value="sans"> Sans impression</label>
      </div>
    </fieldset>
    <div class="nav-buttons">
      <button class="btn-nav" id="prev2" type="button">⬅ Précédent</button>
      <button class="btn-nav" id="next2" type="button">Étape suivante ➜</button>
    </div>
  </section>

  <!-- ÉTAPE 3 -->
  <section class="step-section" id="step3">
    <fieldset>
      <legend>Matière</legend>
      <div id="listeMatieres" class="radio-row"></div>
    </fieldset>
    <div class="nav-buttons">
      <button class="btn-nav" id="prev3" type="button">⬅ Précédent</button>
      <button class="btn-nav" id="next3" type="button">Étape suivante ➜</button>
    </div>
  </section>

  <!-- ÉTAPE 4 -->
  <section class="step-section" id="step4">
    <fieldset>
      <legend>Variantes de la matière</legend>
      <div id="listeVariantes" class="radio-row"></div>
    </fieldset>
    <div class="nav-buttons">
      <button class="btn-nav" id="prev4" type="button">⬅ Précédent</button>
      <button class="btn-nav" id="next4" type="button">Étape suivante ➜</button>
    </div>
  </section>

  <!-- ÉTAPE 5 -->
  <section class="step-section" id="step5">
    <fieldset>
      <legend>Type de découpe</legend>
      <div id="decoupeContainer" class="radio-row"></div>
    </fieldset>
    <div class="nav-buttons">
      <button class="btn-nav" id="prev5" type="button">⬅ Précédent</button>
      <button class="btn-nav" id="next5" type="button">Étape suivante ➜</button>
    </div>
  </section>

  <!-- ÉTAPE 6 -->
  <section class="step-section" id="step6">
    <fieldset>
      <legend>Lamination</legend>
      <div id="laminationContainer" class="radio-row"></div>
      <p id="laminationInfo" class="hint"></p>
    </fieldset>
    <div class="nav-buttons">
      <button class="btn-nav" id="prev6" type="button">⬅ Précédent</button>
      <button class="btn-nav" id="next6" type="button">Étape suivante ➜</button>
    </div>
  </section>

  <!-- ÉTAPE 7 -->
  <section class="step-section" id="step7">
    <fieldset>
      <legend>Blanc de soutien</legend>
      <div id="blancContainer" class="radio-row"></div>
      <p id="blancInfo" class="hint"></p>
    </fieldset>
    <div class="nav-buttons">
      <button class="btn-nav" id="prev7" type="button">⬅ Précédent</button>
      <button class="btn-nav" id="next7" type="button">Étape suivante ➜</button>
    </div>
  </section>

  <!-- ÉTAPE 8 -->
  <section class="step-section" id="step8">
    <fieldset>
      <legend>Œillets (Akilux uniquement)</legend>
      <div id="oeilletsContainer"></div>
      <p id="oeilletsInfo" class="hint"></p>
    </fieldset>
    <div class="nav-buttons">
      <button class="btn-nav" id="prev8" type="button">⬅ Précédent</button>
      <button class="btn-nav" id="next8" type="button">Étape suivante ➜</button>
    </div>
  </section>

  <!-- ÉTAPE 9 -->
  <section class="step-section" id="step9">
    <fieldset>
      <legend>Format & Quantité</legend>

      <label>Largeur (mm)</label>
      <input type="number" id="largeur" min="1" placeholder="Ex : 1200">

      <label>Hauteur (mm)</label>
      <input type="number" id="hauteur" min="1" placeholder="Ex : 800">

      <label>Quantité</label>
      <input type="number" id="quantite" min="1" value="1">
    </fieldset>

    <div class="nav-buttons">
      <button class="btn-nav" id="prev9" type="button">⬅ Précédent</button>
      <button class="btn-nav" id="next9" type="button">Étape suivante ➜</button>
    </div>
  </section>

  <!-- ÉTAPE 10 -->
  <section class="step-section" id="step10">
    <fieldset>
      <legend>Récapitulatif</legend>
      <div id="recap"></div>
    </fieldset>

    <div class="nav-buttons">
      <button class="btn-nav" id="prev10" type="button">⬅ Précédent</button>
      <button class="btn-nav" id="addToDevisBtn" type="button">➕ Ajouter au devis</button>
      <button class="btn-nav" id="resetBtn" type="button">↺ Réinitialiser</button>
    </div>
  </section>

</div>

<footer class="cofel-footer">
  © Cofel — Supports Souples, Rigides & Adhésifs
</footer>

<!-- Ruleset -->
<script src="../js/souples-rigides-adhesifs-rules.js"></script>

<!-- Méthode de calcul des prix -->
<script src="../js/methode-prix-matieres-souples-rigides-impression.js"></script>

<!-- Script principal -->
<script src="../js/souples-rigides-adhesifs.js"></script>

<!-- ===== Bridge: écrit EXACTEMENT dans devisCourant_v1 (format attendu par index.html) ===== -->
<script>
(function(){
  function q(sel){ return document.querySelector(sel); }
  function qa(sel){ return Array.from(document.querySelectorAll(sel)); }

  const STORAGE_KEY = "devisCourant_v1"; // ✅ celui de ton index.html
  const TVA_RATE = 0.20;

  function genId(){
    try{
      if(window.crypto && typeof crypto.randomUUID === "function") return crypto.randomUUID();
    }catch(e){}
    return "L_" + Date.now() + "_" + Math.random().toString(16).slice(2);
  }

  function round2(n){
    n = Number(n);
    return Number.isFinite(n) ? Math.round(n * 100) / 100 : 0;
  }

  function getCheckedText(containerSel){
    const root = q(containerSel);
    if(!root) return "";
    const checked = root.querySelector('input:checked');
    if(!checked) return "";
    const lab = checked.closest('label');
    return (lab ? lab.textContent : checked.value || "").trim();
  }

  function getCheckedTexts(containerSel){
    const root = q(containerSel);
    if(!root) return [];
    const checked = qa(containerSel + ' input:checked');
    return checked.map(el=>{
      const lab = el.closest('label');
      return (lab ? lab.textContent : el.value || "").trim();
    }).filter(Boolean);
  }

  function extractTotalFromRecap(){
    const recap = q('#recap');
    if(!recap) return null;

    const texts = [];
    texts.push(recap.innerText || recap.textContent || "");
    recap.querySelectorAll('*').forEach(el=>{
      const t = (el.innerText || el.textContent || "").trim();
      if(t && t.length <= 250) texts.push(t);
    });

    const joined = texts.join("\n");

    const moneyRe = /(\d[\d\s]*([.,]\d+)?)\s*(?:€|eur\b)/gi;
    let m;
    const candidates = [];
    while((m = moneyRe.exec(joined)) !== null){
      const num = parseFloat(String(m[1]).replace(/\s+/g,'').replace(',', '.'));
      if(Number.isFinite(num)) candidates.push(num);
    }

    if(candidates.length === 0){
      const totalRe = /total[^0-9]{0,25}(\d[\d\s]*([.,]\d+)?)/i;
      const mt = joined.match(totalRe);
      if(mt){
        const num = parseFloat(String(mt[1]).replace(/\s+/g,'').replace(',', '.'));
        if(Number.isFinite(num)) candidates.push(num);
      }
    }

    if(candidates.length === 0) return null;
    return round2(Math.max(...candidates));
  }

  function readStore(){
    try{ return JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}") || {}; }
    catch(e){ return {}; }
  }
  function writeStore(st){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(st));
  }

  function buildLineForIndex(){
    const support = (q('input[name="support"]:checked')?.value || "").trim();
    const impression = (q('input[name="impression"]:checked')?.value || "").trim();

    const matiere = getCheckedText('#listeMatieres');
    const variante = getCheckedText('#listeVariantes');
    const decoupe = getCheckedText('#decoupeContainer');
    const lamination = getCheckedText('#laminationContainer');
    const blanc = getCheckedText('#blancContainer');
    const oeillets = getCheckedTexts('#oeilletsContainer');

    const w = parseInt(q('#largeur')?.value || "0", 10);
    const h = parseInt(q('#hauteur')?.value || "0", 10);
    const qty = Math.max(1, parseInt(q('#quantite')?.value || "1", 10) || 1);

    const parts = [];
    if(support) parts.push(support === "souple" ? "Support souple" : "Support rigide");
    if(impression) parts.push(impression === "avec" ? "Avec impression" : "Sans impression");
    if(matiere) parts.push(matiere);
    if(variante) parts.push(variante);
    if(decoupe) parts.push("Découpe : " + decoupe);
    if(lamination) parts.push("Lamination : " + lamination);
    if(blanc) parts.push("Blanc : " + blanc);
    if(oeillets.length) parts.push("Œillets : " + oeillets.join(", "));
    if(w > 0 && h > 0) parts.push(`Format : ${w}×${h} mm`);

    const designation = parts.join(" • ") || "Supports Souples, Rigides & Adhésifs";

    const totalHT = extractTotalFromRecap();
    const safeTotalHT = (totalHT != null ? totalHT : 0);
    const puHT = safeTotalHT / qty;

    const id = genId();

    // ✅ FORMAT EXACT attendu par ton index.html / Devis-core
    return {
      id,
      type: "configurateur",
      designation,
      quantite: qty,
      pu_net_ht: round2(puHT),
      total_ligne_ht: round2(round2(puHT) * qty),

      // meta (n’impacte pas le devis, mais utile)
      meta: {
        configurateur: "Supports Souples, Rigides & Adhésifs",
        largeur_mm: Number.isFinite(w) ? w : null,
        hauteur_mm: Number.isFinite(h) ? h : null,
        totalHT_detected: totalHT,
        tva: TVA_RATE
      }
    };
  }

  function addLineToIndexStore(line){
    const st = readStore();
    if(!Array.isArray(st.lignes)) st.lignes = [];
    st.lignes.push(line);
    writeStore(st);
  }

  document.addEventListener('DOMContentLoaded', function(){
    const addBtn = q('#addToDevisBtn');
    const resetBtn = q('#resetBtn');

    if(addBtn){
      addBtn.addEventListener('click', function(){
        try{
          const line = buildLineForIndex();
          addLineToIndexStore(line);

          const msg =
            "Ligne ajoutée au devis ✅\n\n" +
            "PU HT (net) : " + line.pu_net_ht.toFixed(2).replace('.', ',') + " €\n" +
            "Total HT : " + line.total_ligne_ht.toFixed(2).replace('.', ',') + " €\n\n" +
            "Revenir au devis maintenant ?";

          if(confirm(msg)) location.href = "/"; // ✅ retour index
        }catch(err){
          console.error(err);
          alert("Erreur Ajouter au devis : " + (err?.message || err));
        }
      });
    }

    if(resetBtn){
      resetBtn.addEventListener('click', function(){
        if(confirm("Réinitialiser ce configurateur ?")) location.reload();
      });
    }
  });
})();
</script>

</body>
</html>

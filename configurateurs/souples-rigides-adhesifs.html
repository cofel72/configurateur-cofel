<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>Configurateur — Supports Souples, Rigides & Adhésifs | Cofel</title>

<!-- Styles communs Cofel -->
<link rel="stylesheet" href="../styles/cofel.css">
<link rel="stylesheet" href="../styles/cofel-components.css">
<link rel="stylesheet" href="../styles/cofel-glass.css">
<link rel="stylesheet" href="../styles/cofel-config-steps.css">

</head>

<body>

<header class="cofel-header">
  <div class="row">
    <a href="../index.html" class="cofel-back">⬅ Retour</a>
    <div class="cofel-brand">
      <img src="../assets/logo cofel.jpg" alt="Cofel">
      <h1 class="cofel-title">Supports Souples, Rigides & Adhésifs</h1>
    </div>
  </div>
</header>

<div class="wrapper">

  <!-- BARRE D'ÉTAPES -->
  <div class="steps-nav" id="stepsNav">
    <div class="step-item active" data-step="1">1. Support</div>
    <div class="step-item locked" data-step="2">2. Impression</div>
    <div class="step-item locked" data-step="3">3. Matière</div>
    <div class="step-item locked" data-step="4">4. Variantes</div>
    <div class="step-item locked" data-step="5">5. Découpe</div>
    <div class="step-item locked" data-step="6">6. Lamination</div>
    <div class="step-item locked" data-step="7">7. Blanc</div>
    <div class="step-item locked" data-step="8" id="stepOeillets">8. Œillets</div>
    <div class="step-item locked" data-step="9">9. Format</div>
    <div class="step-item locked" data-step="10">10. Récapitulatif</div>
  </div>

  <!-- ÉTAPE 1 -->
  <section class="step-section active" id="step1">
    <fieldset>
      <legend>Choix du support</legend>
      <div class="radio-row">
        <label><input type="radio" name="support" value="souple"> Support souple</label>
        <label><input type="radio" name="support" value="rigide"> Support rigide</label>
      </div>
    </fieldset>
    <div class="nav-buttons"><button class="btn-nav" id="next1">Étape suivante ➜</button></div>
  </section>

  <!-- ÉTAPE 2 -->
  <section class="step-section" id="step2">
    <fieldset>
      <legend>Impression</legend>
      <div class="radio-row">
        <label><input type="radio" name="impression" value="avec"> Avec impression</label>
        <label><input type="radio" name="impression" value="sans"> Sans impression</label>
      </div>
    </fieldset>
    <div class="nav-buttons">
      <button class="btn-nav" id="prev2">⬅ Précédent</button>
      <button class="btn-nav" id="next2">Étape suivante ➜</button>
    </div>
  </section>

  <!-- ÉTAPE 3 -->
  <section class="step-section" id="step3">
    <fieldset>
      <legend>Matière</legend>
      <div id="listeMatieres" class="radio-row"></div>
    </fieldset>
    <div class="nav-buttons">
      <button class="btn-nav" id="prev3">⬅ Précédent</button>
      <button class="btn-nav" id="next3">Étape suivante ➜</button>
    </div>
  </section>

  <!-- ÉTAPE 4 -->
  <section class="step-section" id="step4">
    <fieldset>
      <legend>Variantes de la matière</legend>
      <div id="listeVariantes" class="radio-row"></div>
    </fieldset>
    <div class="nav-buttons">
      <button class="btn-nav" id="prev4">⬅ Précédent</button>
      <button class="btn-nav" id="next4">Étape suivante ➜</button>
    </div>
  </section>

  <!-- ÉTAPE 5 -->
  <section class="step-section" id="step5">
    <fieldset>
      <legend>Type de découpe</legend>
      <div id="decoupeContainer" class="radio-row"></div>
    </fieldset>
    <div class="nav-buttons">
      <button class="btn-nav" id="prev5">⬅ Précédent</button>
      <button class="btn-nav" id="next5">Étape suivante ➜</button>
    </div>
  </section>

  <!-- ÉTAPE 6 -->
  <section class="step-section" id="step6">
    <fieldset>
      <legend>Lamination</legend>
      <div id="laminationContainer" class="radio-row"></div>
      <p id="laminationInfo" class="hint"></p>
    </fieldset>
    <div class="nav-buttons">
      <button class="btn-nav" id="prev6">⬅ Précédent</button>
      <button class="btn-nav" id="next6">Étape suivante ➜</button>
    </div>
  </section>

  <!-- ÉTAPE 7 -->
  <section class="step-section" id="step7">
    <fieldset>
      <legend>Blanc de soutien</legend>
      <div id="blancContainer" class="radio-row"></div>
      <p id="blancInfo" class="hint"></p>
    </fieldset>
    <div class="nav-buttons">
      <button class="btn-nav" id="prev7">⬅ Précédent</button>
      <button class="btn-nav" id="next7">Étape suivante ➜</button>
    </div>
  </section>

  <!-- ÉTAPE 8 -->
  <section class="step-section" id="step8">
    <fieldset>
      <legend>Œillets (Akilux uniquement)</legend>
      <div id="oeilletsContainer"></div>
      <p id="oeilletsInfo" class="hint"></p>
    </fieldset>
    <div class="nav-buttons">
      <button class="btn-nav" id="prev8">⬅ Précédent</button>
      <button class="btn-nav" id="next8">Étape suivante ➜</button>
    </div>
  </section>

  <!-- ÉTAPE 9 -->
  <section class="step-section" id="step9">
    <fieldset>
      <legend>Format & Quantité</legend>

      <label>Largeur (mm)</label>
      <input type="number" id="largeur" min="1" placeholder="Ex : 1200">

      <label>Hauteur (mm)</label>
      <input type="number" id="hauteur" min="1" placeholder="Ex : 800">

      <label>Quantité</label>
      <input type="number" id="quantite" min="1" value="1">
    </fieldset>

    <div class="nav-buttons">
      <button class="btn-nav" id="prev9">⬅ Précédent</button>
      <button class="btn-nav" id="next9">Étape suivante ➜</button>
    </div>
  </section>

  <!-- ÉTAPE 10 -->
  <section class="step-section" id="step10">
    <fieldset>
      <legend>Récapitulatif</legend>
      <div id="recap"></div>
    </fieldset>

    <div class="nav-buttons">
      <button class="btn-nav" id="prev10">⬅ Précédent</button>
      <button class="btn-nav" id="addToDevisBtn">➕ Ajouter au devis</button>
      <button class="btn-nav" id="resetBtn">↺ Réinitialiser</button>
    </div>
  </section>

</div>

<footer class="cofel-footer">
  © Cofel — Supports Souples, Rigides & Adhésifs
</footer>

<!-- Ruleset -->
<script src="../js/souples-rigides-adhesifs-rules.js"></script>

<!-- Méthode de calcul des prix -->
<script src="../js/methode-prix-matieres-souples-rigides-impression.js"></script>

<!-- Script principal -->
<script src="../js/souples-rigides-adhesifs.js"></script>

<!-- ===== Bridge "Ajouter au devis" (robuste + compatible index) ===== -->
<script>
(function(){
  function q(sel){ return document.querySelector(sel); }
  function qa(sel){ return Array.from(document.querySelectorAll(sel)); }

  function getCheckedText(containerSel){
    const root = q(containerSel);
    if(!root) return "";
    const checked = root.querySelector('input:checked');
    if(!checked) return "";
    const lab = checked.closest('label');
    return (lab ? lab.textContent : checked.value || "").trim();
  }

  function getCheckedTexts(containerSel){
    const root = q(containerSel);
    if(!root) return [];
    const checked = qa(containerSel + ' input:checked');
    return checked.map(el=>{
      const lab = el.closest('label');
      return (lab ? lab.textContent : el.value || "").trim();
    }).filter(Boolean);
  }

  function extractTotalFromRecap(){
  const recap = q('#recap');
  if(!recap) return null;

  // On collecte plusieurs sources de texte (au cas où le total est dans un sous-bloc)
  const texts = [];
  texts.push(recap.innerText || recap.textContent || "");

  recap.querySelectorAll('*').forEach(el=>{
    const t = (el.innerText || el.textContent || "").trim();
    if(t && t.length <= 200) texts.push(t);
  });

  const joined = texts.join("\n");

  // 1) On récupère tous les montants suivis de € ou EUR
  const moneyRe = /(\d[\d\s]*([.,]\d+)?)\s*(€|eur)\b/gi;
  let m;
  const candidates = [];
  while((m = moneyRe.exec(joined)) !== null){
    const num = parseFloat(String(m[1]).replace(/\s+/g,'').replace(',', '.'));
    if(Number.isFinite(num)) candidates.push(num);
  }

  // 2) Fallback : si le récap écrit "Total HT : 25,56" sans € (rare)
  if(candidates.length === 0){
    const totalRe = /total[^0-9]{0,20}(\d[\d\s]*([.,]\d+)?)/i;
    const mt = joined.match(totalRe);
    if(mt){
      const num = parseFloat(String(mt[1]).replace(/\s+/g,'').replace(',', '.'));
      if(Number.isFinite(num)) candidates.push(num);
    }
  }

  if(candidates.length === 0) return null;

  // On prend le plus grand montant trouvé (généralement le TOTAL, pas le PU)
  const max = Math.max(...candidates);
  return Math.round(max * 100) / 100;
}

  function buildLine(){
    const support = (q('input[name="support"]:checked')?.value || "").trim();
    const impression = (q('input[name="impression"]:checked')?.value || "").trim();

    const matiere = getCheckedText('#listeMatieres');
    const variante = getCheckedText('#listeVariantes');
    const decoupe = getCheckedText('#decoupeContainer');
    const lamination = getCheckedText('#laminationContainer');
    const blanc = getCheckedText('#blancContainer');
    const oeillets = getCheckedTexts('#oeilletsContainer');

    const w = parseInt(q('#largeur')?.value || "0", 10);
    const h = parseInt(q('#hauteur')?.value || "0", 10);
    const qty = Math.max(1, parseInt(q('#quantite')?.value || "1", 10) || 1);

  const totalHT = extractTotalFromRecap();
const tvaRate = 0.20;

const safeTotalHT = (totalHT != null ? totalHT : 0);
const puHT = safeTotalHT / qty;

const totalTTC = Math.round(safeTotalHT * (1 + tvaRate) * 100) / 100;
const puTTC = Math.round((totalTTC / qty) * 100) / 100;

const line = {
  designation,
  description: designation,
  produit: "Supports Souples, Rigides & Adhésifs",
  configurateur: "Supports Souples, Rigides & Adhésifs",

  // quantités
  qte: qty,
  qty: qty,
  quantite: qty,

  // unité
  unite: "u",
  unit: "u",

  // dimensions
  largeur_mm: Number.isFinite(w) ? w : null,
  hauteur_mm: Number.isFinite(h) ? h : null,

  // === PRIX HT (plein de noms possibles pour être compatible avec index) ===
  pu_ht: Math.round(puHT * 100) / 100,
  puHT: Math.round(puHT * 100) / 100,
  prix_unitaire_ht: Math.round(puHT * 100) / 100,
  unit_price_ht: Math.round(puHT * 100) / 100,

  total_ht: Math.round(safeTotalHT * 100) / 100,
  totalHT: Math.round(safeTotalHT * 100) / 100,
  montant_ht: Math.round(safeTotalHT * 100) / 100,
  montantHT: Math.round(safeTotalHT * 100) / 100,
  total: Math.round(safeTotalHT * 100) / 100,

  // === PRIX TTC (au cas où index affiche en TTC) ===
  pu_ttc: puTTC,
  puTTC: puTTC,
  total_ttc: totalTTC,
  totalTTC: totalTTC,
  montant_ttc: totalTTC,

  // TVA
  tva: tvaRate,

  createdAt: new Date().toISOString()
};


    return line;
  }

  function safeParseJSON(v){
    try{ return JSON.parse(v); }catch(e){ return null; }
  }

  function looksLikeLineArray(arr){
    if(!Array.isArray(arr)) return false;
    if(arr.length === 0) return true;
    const x = arr[arr.length-1];
    return x && typeof x === "object" && (
      "designation" in x || "description" in x || "produit" in x || "total_ht" in x || "totalHT" in x
    );
  }

  function pushIntoValue(v, line){
    // v peut être: Array ou Object {lines/lignes/items/...}
    if(Array.isArray(v)){
      v.push(line);
      return { updated: true, out: v };
    }
    if(v && typeof v === "object"){
      const props = ["lines","lignes","items","rows","articles","produits"];
      for(const p of props){
        if(Array.isArray(v[p])){
          v[p].push(line);
          return { updated: true, out: v };
        }
      }
      // structure {devis:{lines:[]}}
      if(v.devis && typeof v.devis === "object"){
        for(const p of props){
          if(Array.isArray(v.devis[p])){
            v.devis[p].push(line);
            return { updated: true, out: v };
          }
        }
      }
    }
    return { updated: false, out: v };
  }

  function writePending(line){
    const raw = JSON.stringify(line);
    // clé "pont" fiable entre configurateur -> index
    sessionStorage.setItem("cofel_pending_devis_line", raw);
    localStorage.setItem("cofel_pending_devis_line", raw);
  }

  function addLineToAllLikelyStorages(line){
    writePending(line);

    const writtenKeys = [];

    // 1) si une API devis existe déjà (certains configurateurs Cofel)
    const candidates = [
      window.cofelDevisAddLine,
      window.addLineToDevis,
      window.addLineToQuote
    ];
    for(const fn of candidates){
      if(typeof fn === "function"){
        fn(line);
        return { via: "function", keys: writtenKeys };
      }
    }
    if(window.cofelDevis && typeof window.cofelDevis.addLine === "function"){
      window.cofelDevis.addLine(line);
      return { via: "cofelDevis.addLine", keys: writtenKeys };
    }

    // 2) sinon on pousse dans TOUT ce qui ressemble à un stockage devis existant
    const allKeys = Object.keys(localStorage);
    const devisKeys = allKeys.filter(k => /devis|quote|lines|lignes/i.test(k));

    for(const k of devisKeys){
      const raw = localStorage.getItem(k);
      const parsed = safeParseJSON(raw);
      if(parsed == null) continue;

      // array direct
      if(looksLikeLineArray(parsed)){
        parsed.push(line);
        localStorage.setItem(k, JSON.stringify(parsed));
        writtenKeys.push(k);
        continue;
      }

      // object avec lines/lignes/items...
      const res = pushIntoValue(parsed, line);
      if(res.updated){
        localStorage.setItem(k, JSON.stringify(res.out));
        writtenKeys.push(k);
      }
    }

    // 3) et on écrit AUSSI dans des clés “standards” (au cas où Index les attend)
    const standardKeys = [
      "cofel_devis_lines",
      "cofel_devis_lignes",
      "cofel_devis",
      "devis_lines",
      "quote_lines"
    ];

    for(const k of standardKeys){
      const raw = localStorage.getItem(k);
      const parsed = safeParseJSON(raw);

      if(parsed == null){
        // si clé absente/non JSON => on initialise en tableau
        localStorage.setItem(k, JSON.stringify([line]));
        writtenKeys.push(k);
        continue;
      }

      if(Array.isArray(parsed)){
        parsed.push(line);
        localStorage.setItem(k, JSON.stringify(parsed));
        writtenKeys.push(k);
        continue;
      }

      const res = pushIntoValue(parsed, line);
      if(res.updated){
        localStorage.setItem(k, JSON.stringify(res.out));
        writtenKeys.push(k);
        continue;
      }

      // objet mais pas de tableau => on crée lines[]
      if(parsed && typeof parsed === "object"){
        parsed.lines = Array.isArray(parsed.lines) ? parsed.lines : [];
        parsed.lines.push(line);
        localStorage.setItem(k, JSON.stringify(parsed));
        writtenKeys.push(k);
      }
    }

    return { via: "localStorage", keys: Array.from(new Set(writtenKeys)) };
  }

  document.addEventListener('DOMContentLoaded', function(){
    const addBtn = q('#addToDevisBtn');
    const resetBtn = q('#resetBtn');

    if(addBtn){
      addBtn.addEventListener('click', function(){
        const line = buildLine();
        const res = addLineToAllLikelyStorages(line);

        const msg =
          "Ligne enregistrée ✅\n" +
          "Méthode : " + res.via + "\n" +
          (res.keys && res.keys.length ? ("Clés mises à jour :\n- " + res.keys.join("\n- ")) : "Clés mises à jour : (via pending / function)") +
          "\n\nRevenir au devis maintenant ?";

        const go = confirm(msg);
        if(go) location.href = "../index.html";
      });
    }

    if(resetBtn){
      resetBtn.addEventListener('click', function(){
        const ok = confirm("Réinitialiser ce configurateur ?");
        if(ok) location.reload();
      });
    }
  });
})();
</script>

</body>
</html>

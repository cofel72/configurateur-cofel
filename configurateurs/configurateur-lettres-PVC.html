<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Configurateur — Lettres PVC | Cofel</title>

  <link rel="stylesheet" href="../styles/cofel.css">
  <link rel="stylesheet" href="../styles/cofel-components.css">
  <link rel="stylesheet" href="../styles/cofel-glass.css">
  <link rel="stylesheet" href="/styles/cofel-theme-apple-dark.css">

</head>

<body>

<header class="cofel-header">
  <div class="row">
    <a class="cofel-back" href="../index.html">⬅ Retour accueil (Devis)</a>
    <div class="cofel-brand">
      <img src="/assets/ESO-rect1.png" alt="ESO">

      <h1 class="cofel-title">Configurateur — Lettres PVC</h1>
    </div>
  </div>
</header>

<div class="cofel-container">

  <!-- === PARAMÈTRES === -->
  <fieldset>
    <legend>Paramètres</legend>

    <div class="grid">
      <div>
        <label for="hauteur">Hauteur (mm)</label>
        <input type="number" id="hauteur" placeholder="Ex : 250" min="0">
      </div>

      <div>
        <label for="epaisseur">Épaisseur (mm)</label>
        <select id="epaisseur">
          <option value="">— Sélectionnez —</option>
          <option value="10">10 mm</option>
          <option value="19">19 mm</option>
          <option value="30">30 mm</option>
        </select>
      </div>

      <div>
        <label for="quantite">Quantité</label>
        <input type="number" id="quantite" min="1" value="1">
      </div>
    </div>
  </fieldset>

  <!-- === OPTIONS === -->
  <fieldset>
    <legend>Options</legend>

    <div class="radio-row">
      <label><input type="checkbox" id="optLaquage"> Laquage</label>
      <label><input type="checkbox" id="optFixation"> Fixation</label>
      <label><input type="checkbox" id="optRetro"> Rétroéclairage</label>
      <label><input type="checkbox" id="optLisse"> Pose sur lisse</label>
    </div>

    <div id="retroNotice" class="notice-glass hidden">
      <b>Indisponible sur 10&nbsp;mm :</b> le rétroéclairage nécessite une épaisseur minimale de <b>19&nbsp;mm</b>.
    </div>

    <div class="hint" style="color:var(--txt-dim);margin-top:6px;font-size:13px;">
      Le rétroéclairage est disponible uniquement pour les chants 19 mm et 30 mm.
    </div>
  </fieldset>

  <!-- === LONGUEUR LISSE === -->
  <!-- ✅ MODIF : longueur + nombre de lisses -->
  <div id="blockLisse" class="notice-glass hidden" style="margin-top:10px;">
    <div class="grid">
      <div>
        <label for="lisseLongueur">Longueur d’une lisse (mm)</label>
        <input type="number" id="lisseLongueur" min="0" placeholder="Ex : 10000">
      </div>
      <div>
        <label for="lisseNb">Nombre de lisses</label>
        <input type="number" id="lisseNb" min="1" value="1">
      </div>
    </div>
    <div class="hint" style="color:var(--txt-dim);margin-top:6px;font-size:13px;">
      
    </div>
  </div>

  <!-- === RÉSULTATS === -->
  <div class="result">
    <p>Prix unitaire HT : <span id="prixUHT">0,00</span> €</p>
    <p>Total HT : <span id="prixHT">0,00</span> €</p>
    <p>Total TTC : <span id="prixTTC">0,00</span> €</p>
  </div>

  <div class="cofel-actions">
    <button id="btnAddDevis" class="cofel-fab">➕ Ajouter au devis</button>
  </div>

</div>

<footer class="cofel-footer">
  © Cofel — ZA du Perquoi, 72560 Changé — SIRET …
</footer>

<!-- ===================== MOTEUR DE DEVIS ===================== -->
<script src="../js/devis-core.js"></script>

<script>
/* ================================
   CONFIG
================================ */
const TVA = 0.20;
const COEF_PUBLIC = 2;
const LISSE_PRICE_ML = 25; // €/ml interne

const CSV_URL =
  "https://raw.githubusercontent.com/stevens-cofel/configurateur-cofel/refs/heads/main/configurateurs/Lettre%20PVC.csv";

let DATA = [];
let BY_THICK = {};
const $ = (id) => document.getElementById(id);

/* ================================
   UTILS
================================ */
function parseEuroFR(s) {
  if (s == null) return NaN;
  let t = String(s)
    .replace(/€/g, "")
    .replace(/\s|[\u00A0\u202F]/g, "")
    .trim()
    .replace(",", ".");
  const m = t.match(/-?\d+(\.\d+)?/);
  return m ? parseFloat(m[0]) : NaN;
}

function parseIntFR(s) {
  if (s == null) return NaN;
  let t = String(s).replace(/\s|[\u00A0\u202F]/g, "").trim();
  const m = t.match(/\d+/);
  return m ? parseInt(m[0], 10) : NaN;
}

function euro(n) {
  return (isFinite(n) ? n : 0).toFixed(2).replace(".", ",");
}

/* ================================
   CSV
================================ */
async function loadCSV() {
  const r = await fetch(CSV_URL, { cache: "no-store" });
  if (!r.ok) throw new Error("CSV introuvable");
  const txt = await r.text();

  const first = txt.split(/\r?\n/)[0] || "";
  const sep =
    (first.match(/;/g) || []).length >= (first.match(/,/g) || []).length
      ? ";"
      : ",";

  const lines = txt.split(/\r?\n/).filter((l) => l.trim() !== "");
  const maybeHeader = isNaN(parseIntFR(lines[0].split(sep)[1]));
  const start = maybeHeader ? 1 : 0;

  DATA = lines
    .slice(start)
    .map((l) => {
      const p = l.split(sep).map((x) => x.trim());
      return {
        type: p[0] || "Lettre PVC",
        hauteur: parseIntFR(p[1]),
        epaisseur: parseIntFR(p[2]),
        base: parseEuroFR(p[3]),
        laquage: parseEuroFR(p[4]),
        fixation: parseEuroFR(p[5]),
        retro: parseEuroFR(p[6]),
      };
    })
    .filter((r) => isFinite(r.hauteur) && isFinite(r.epaisseur));

  BY_THICK = {};
  DATA.forEach((r) => {
    if (!BY_THICK[r.epaisseur]) BY_THICK[r.epaisseur] = new Set();
    BY_THICK[r.epaisseur].add(r.hauteur);
  });

  for (const k in BY_THICK) {
    BY_THICK[k] = Array.from(BY_THICK[k]).sort((a, b) => a - b);
  }
}

function findRowFor(h, e) {
  const pal = BY_THICK[e];
  if (!pal) return null;

  let chosen = pal[pal.length - 1];
  for (const v of pal) {
    if (v >= h) { chosen = v; break; }
  }
  return DATA.find((r) => r.epaisseur === e && r.hauteur === chosen);
}

/* ================================
   REMISE CLIENT (auto)
================================ */
function getRemiseClientFactor() {
  let remiseClient = 1;
  try {
    const p = JSON.parse(localStorage.getItem("cofel_client_profile"));
    if (p && typeof p.discountRate === "number") remiseClient = 1 - p.discountRate;
  } catch (e) {}
  return remiseClient;
}

/* ================================
   REMISE SÉRIE (quantité)
   ✅ s'applique uniquement sur les LETTRES (pas sur la lisse)
   Ajuste les paliers ci-dessous selon ta politique commerciale.
================================ */
function getRemiseSerieFactor(q){
  // facteur = 1 - remise
  if (q >= 50) return 0.75; // -25%
  if (q >= 20) return 0.80; // -20%
  if (q >= 10) return 0.85; // -15%
  if (q >= 6)  return 0.90; // -10%
  if (q >= 3)  return 0.95; // -5%
  return 1.00;             // 0%
}

/* ================================
   UI RULES
================================ */
function updateRetroUI() {
  const e = parseFloat($("epaisseur").value) || 0;
  const retro = $("optRetro");
  const msg = $("retroNotice");

  if (e === 10) {
    retro.checked = false;
    retro.disabled = true;
    msg.classList.remove("hidden");
  } else {
    retro.disabled = false;
    msg.classList.add("hidden");
  }
}

function updateLisseUI() {
  const box = $("blockLisse");
  const chk = $("optLisse");
  if (!box || !chk) return;
  box.classList.toggle("hidden", !chk.checked);
}

/* ================================
   CALCUL (PATCH)
   ✅ lisse NON multipliée par quantité
   ✅ ajout "nombre de lisses"
   ✅ remise série par quantité sur les LETTRES uniquement
================================ */
function calcTotalsNet(row, q) {
  const e = parseFloat($("epaisseur").value) || 0;
  const laq = $("optLaquage").checked;
  const fix = $("optFixation").checked;
  const retro = $("optRetro").checked;
  const useLisse = $("optLisse").checked;

  // 1) Prix interne UNITAIRE de la lettre (sans lisse)
  let unit_interne_lettre = (row.base || 0);
  if (laq) unit_interne_lettre += (row.laquage || 0);
  if (fix) unit_interne_lettre += (row.fixation || 0);
  if (retro && e >= 19) unit_interne_lettre += (row.retro || 0);

  // 2) Prix interne TOTAL lettres (avant remise série)
  const total_interne_lettres = unit_interne_lettre * q;

  // ✅ Remise série selon quantité (s'applique sur les lettres uniquement)
  const serieFactor = getRemiseSerieFactor(q);
  const total_interne_lettres_serie = total_interne_lettres * serieFactor;

  // 3) Lisse : 1 seule fois (interne), pas multipliée par q
  // ✅ mais multipliée par le nombre de lisses
  let lmm = 0, lmlUnit = 0, lmlTotal = 0, lisseNb = 1, lisse_interne = 0;
  if (useLisse) {
    lmm = Number($("lisseLongueur").value || 0);
    lisseNb = Math.max(1, parseInt($("lisseNb")?.value || 1, 10));
    lmlUnit = lmm / 1000;
    lmlTotal = lmlUnit * lisseNb;

    if (lmlTotal > 0) lisse_interne = LISSE_PRICE_ML * lmlTotal;
  }

  // 4) Total interne global
  const total_interne = total_interne_lettres_serie + lisse_interne;

  // 5) Public puis remise client
  const total_public = total_interne * COEF_PUBLIC;
  const total_net = total_public * getRemiseClientFactor();

  // 6) PU net réparti (pour affichage + devis sur 1 ligne)
  const unit_net = q > 0 ? (total_net / q) : 0;

  return {
    unit_net,
    total_net,
    lmm,
    lmlUnit,
    lmlTotal,
    lisseNb,
    unit_interne_lettre,
    lisse_interne,
    // infos utiles (debug/affichage éventuel)
    serieFactor,
    total_interne_lettres,
    total_interne_lettres_serie
  };
}

/* ================================
   COMPUTE
================================ */
function compute() {
  const h = parseFloat($("hauteur").value) || 0;
  const e = parseFloat($("epaisseur").value) || 0;
  const q = Math.max(1, parseInt($("quantite").value) || 1);

  const row = findRowFor(h, e);
  if (!row) {
    $("prixUHT").textContent = "0,00";
    $("prixHT").textContent = "0,00";
    $("prixTTC").textContent = "0,00";
    return;
  }

  const { unit_net, total_net } = calcTotalsNet(row, q);

  const totalHT = total_net;
  const totalTTC = totalHT * (1 + TVA);

  $("prixUHT").textContent = euro(unit_net);
  $("prixHT").textContent  = euro(totalHT);
  $("prixTTC").textContent = euro(totalTTC);
}

/* ================================
   EVENTS
================================ */
function bindEvents() {
  ["input", "change"].forEach((evt) => {
    [
      "hauteur",
      "epaisseur",
      "quantite",
      "optLaquage",
      "optFixation",
      "optRetro",
      "optLisse",
      "lisseLongueur",
      "lisseNb", // ✅ AJOUT
    ].forEach((id) => {
      const el = $(id);
      if (!el) return;
      el.addEventListener(evt, () => {
        updateRetroUI();
        updateLisseUI();
        compute();
      });
    });
  });
}

/* ================================
   INIT
================================ */
loadCSV()
  .then(() => {
    bindEvents();
    updateRetroUI();
    updateLisseUI();
    compute();
  })
  .catch((e) => {
    console.error(e);
    alert("Erreur lors du chargement du CSV Lettre PVC.");
  });

/* ================================
   AJOUT AU DEVIS
   ✅ même calcul que l'affichage (PU réparti)
================================ */
$("btnAddDevis").addEventListener("click", () => {
  try {
    if (!window.Devis) throw new Error("Module devis introuvable.");

    const h = parseFloat($("hauteur").value) || 0;
    const e = parseFloat($("epaisseur").value) || 0;
    const q = Math.max(1, parseInt($("quantite").value) || 1);

    const row = findRowFor(h, e);
    if (!row) {
      alert("Aucune donnée trouvée pour cette configuration.");
      return;
    }

    const laq = $("optLaquage").checked;
    const fix = $("optFixation").checked;
    const retro = $("optRetro").checked;

    const { unit_net, total_net, lmm, lmlTotal, lisseNb } = calcTotalsNet(row, q);

    let designation = `Lettre PVC ${h} mm (ép. ${e} mm)`;
    if (laq) designation += " — Laquage";
    if (fix) designation += " — Fixation";
    if (retro && e >= 19) designation += " — Rétroéclairage";
    if (lmm > 0) designation += ` — Pose sur lisse — ${lisseNb} × ${lmm} mm (${lmlTotal.toFixed(2)} ml)`;

    Devis.addLine({
      type: "Lettre PVC",
      designation,
      quantite: q,
      pu_public_ht: Number(unit_net.toFixed(2)),
      pu_net_ht: Number(unit_net.toFixed(2)),
      total_ligne_ht: Number(total_net.toFixed(2)),
    });

    alert(
      `✅ Ligne ajoutée au devis !\n${designation}\nQté : ${q}\nPU HT : ${unit_net.toFixed(2)} €`
    );
  } catch (err) {
    console.error(err);
    alert("Erreur : " + err.message);
  }
});
</script>

</body>
</html>


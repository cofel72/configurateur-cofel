<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>Configurateur ‚Äì T√¥lerie & Ch√¢ssis aluminium</title>

<!-- ‚úÖ CSS de base -->
<link rel="stylesheet" href="../styles/cofel.css" />
<link rel="stylesheet" href="../styles/cofel-components.css" />
<link rel="stylesheet" href="../styles/cofel-glass.css" />
<link rel="stylesheet" href="/styles/cofel-theme-apple-dark.css">

<style>
.cofel-header.glass{
  background: rgba(90,45,130,.35);
  backdrop-filter: blur(18px);
  border-bottom: 1px solid rgba(255,255,255,.15);
}
.cofel-header .cofel-title{color:#ffffff;}
.cofel-header .cofel-back{color:rgba(255,255,255,.85);}
.cofel-header .cofel-back:hover{color:#fff;}
.muted{opacity:.7;font-size:13px;}

/* s√©curit√© si .hidden n'existe pas dans tes CSS */
.hidden{ display:none !important; }

/* Bouton RAL (style ‚Äúpastille‚Äù comme T√¥le Tablette) */
.ral-btn{
  display:inline-flex;
  align-items:center;
  gap:10px;
  padding:10px 12px;
  border:1px solid var(--glass-hr, rgba(255,255,255,.18));
  border-radius:14px;
  background:var(--glass, rgba(255,255,255,.06));
  color:var(--txt, #fff);
  user-select:none;
  white-space:nowrap;
  cursor:pointer;
}
.ral-btn:hover{ filter:brightness(1.12); }
.ral-btn:disabled{
  opacity:.45;
  cursor:not-allowed;
  filter:none;
}

/* Modal */
html.ral-lock, body.ral-lock{ overflow:hidden; }

.ral-modal{
  position:fixed;
  inset:0;
  z-index:9999;
  display:flex;
  align-items:center;
  justify-content:center;
  padding:14px;
}
.ral-backdrop{
  position:absolute;
  inset:0;
  background:rgba(0,0,0,.65);
  backdrop-filter: blur(10px);
}
.ral-card{
  position:relative;
  width:min(980px, calc(100vw - 24px));
  max-height:calc(100vh - 24px);
  overflow:hidden;
  border-radius:18px;
  border:1px solid var(--glass-hr, rgba(255,255,255,.18));
  background:rgba(18,18,18,.86);
  box-shadow: 0 12px 35px rgba(0,0,0,.55);
  display:flex;
  flex-direction:column;
}
.ral-head{
  display:flex;
  justify-content:space-between;
  gap:12px;
  padding:14px 14px 10px;
  border-bottom:1px solid var(--glass-hr, rgba(255,255,255,.12));
}
.ral-title{
  font-weight:700;
  font-size:16px;
  line-height:1.2;
}
.ral-sub{
  margin-top:4px;
  font-size:13px;
  color:var(--txt-dim, rgba(255,255,255,.72));
}
.ral-close{
  background:transparent;
  border:1px solid var(--glass-hr, rgba(255,255,255,.18));
  border-radius:12px;
  color:var(--txt, #fff);
  padding:8px 10px;
  cursor:pointer;
}

.ral-toolbar{
  display:flex;
  gap:10px;
  padding:12px 14px;
  align-items:center;
  border-bottom:1px solid var(--glass-hr, rgba(255,255,255,.12));
  flex-wrap:wrap;
}
.ral-tabs{
  display:flex;
  gap:8px;
}
.ral-tab{
  padding:8px 10px;
  border-radius:12px;
  border:1px solid var(--glass-hr, rgba(255,255,255,.18));
  background:transparent;
  color:var(--txt, #fff);
  cursor:pointer;
}
.ral-tab.is-active{
  background:rgba(255,255,255,.08);
}
.ral-search{
  flex:1;
  min-width:220px;
  padding:10px 12px;
  border-radius:12px;
  border:1px solid var(--glass-hr, rgba(255,255,255,.18));
  background:rgba(255,255,255,.06);
  color:var(--txt, #fff);
  outline:none;
}

.ral-content{
  padding:14px;
  overflow:auto;
}
.ral-group{
  margin-bottom:14px;
  padding:12px;
  border-radius:16px;
  background:rgba(255,255,255,.04);
  border:1px solid rgba(255,255,255,.08);
}
.ral-group h3{
  margin:0 0 10px 0;
  font-size:14px;
  color:var(--txt, #fff);
}
.ral-grid{
  display:flex;
  flex-wrap:wrap;
  gap:8px;
}
.ral-chip{
  padding:8px 10px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.18);
  background:rgba(255,255,255,.06);
  color:var(--txt, #fff);
  cursor:pointer;
}
.ral-chip:hover{ filter:brightness(1.12); }

.ral-empty{
  padding:16px;
  color:var(--txt-dim, rgba(255,255,255,.72));
}

.ral-foot{
  padding:10px 14px 14px;
  border-top:1px solid var(--glass-hr, rgba(255,255,255,.12));
}
.ral-toast{
  font-size:13px;
  color:var(--txt, #fff);
  min-height:18px;
  margin-bottom:6px;
}
.ral-note{
  font-size:12px;
  color:var(--txt-dim, rgba(255,255,255,.72));
}
</style>

</head>

<body>

<header class="cofel-header glass">
  <div class="row">
    <a class="cofel-back" href="../index.html">‚¨Ö Retour accueil (Devis)</a>
    <div class="cofel-brand">
      <img src="../assets/logo cofel.jpg" alt="Cofel" />
      <h1 class="cofel-title">Configurateur ‚Äî T√¥lerie & Ch√¢ssis</h1>
    </div>
  </div>
</header>

<main class="wrap">

<!-- TYPE -->
<fieldset>
  <legend>Type de produit</legend>
  <div class="radio-row">
    <label><input type="radio" name="typeProduit" value="panneau" checked> Panneau / T√¥lerie</label>
    <label><input type="radio" name="typeProduit" value="chassis"> Ch√¢ssis aluminium</label>
  </div>
</fieldset>

<!-- ===================== PANNEAU ===================== -->
<div id="blockPanneau">

<fieldset>
  <div class="grid">
    <div>
      <label>Famille</label>
      <select id="famille">
        <option value="alu">Aluminium</option>
        <option value="dibond">Alu/PVC (type Dibond 3mm)</option>
      </select>
    </div>
    <div>
      <label>Quantit√©</label>
      <input type="number" id="quantite" value="1" min="1">
    </div>
  </div>
</fieldset>

<!-- ‚úÖ ALU + Bouton RAL √† droite du bloc (comme les autres configurateurs) -->
<fieldset id="blockAlu">
  <legend>Aluminium</legend>

  <div class="grid">
    <div>
      <div class="radio-row">
        <label><input type="radio" name="matAlu" value="alu15_pre" checked> 15/10 Pr√©laqu√©</label>
        <label><input type="radio" name="matAlu" value="alu15_laq"> 15/10 Laqu√©</label>
        <label><input type="radio" name="matAlu" value="alu20_pre"> 20/10 Pr√©laqu√©</label>
        <label><input type="radio" name="matAlu" value="alu20_laq"> 20/10 Laqu√©</label>
      </div>
      <div class="muted" style="margin-top:6px">Le bouton RAL s‚Äôactive uniquement si une finition ‚ÄúPr√©laqu√©‚Äù est s√©lectionn√©e.</div>
    </div>

    <div style="display:flex;justify-content:flex-end;align-items:flex-start;">
      <button type="button" id="btnRal" class="ral-btn" aria-haspopup="dialog">
        üé® RAL disponibles (pr√©-laqu√©)
      </button>
    </div>
  </div>
</fieldset>

<fieldset id="blockDibond" style="display:none">
  <legend>Dibond</legend>
  <div class="radio-row">
    <label><input type="radio" name="matDibond" value="dibond_pre" checked> Pr√©laqu√©</label>
    <label><input type="radio" name="matDibond" value="dibond_laq"> Laqu√©</label>
  </div>
</fieldset>

<fieldset>
  <legend>Dimensions panneau</legend>
  <div class="grid">
    <div><label>Largeur (mm)</label><input type="number" id="largeur"></div>
    <div><label>Hauteur (mm)</label><input type="number" id="hauteur"></div>
  </div>
  <label>Surface</label>
  <input id="surface" disabled value="0,000 m¬≤">
</fieldset>

</div>

<!-- ===================== CH√ÇSSIS ===================== -->
<div id="blockChassis" style="display:none">

<fieldset>
  <legend>Ch√¢ssis aluminium</legend>

  <div class="radio-row">
    <label><input type="radio" name="sectionChassis" value="30" checked> 30√ó30 mm</label>
    <label><input type="radio" name="sectionChassis" value="40"> 40√ó40 mm</label>
    <label><input type="radio" name="sectionChassis" value="50"> 50√ó50 mm</label>
  </div>

  <div class="grid">
    <div><label>Largeur ext√©rieure (mm)</label><input type="number" id="chL"></div>
    <div><label>Hauteur ext√©rieure (mm)</label><input type="number" id="chH"></div>
  </div>

  <p class="muted">Calcul identique au configurateur T√¥le Tablette</p>
</fieldset>

</div>

<div class="result">
  <p>Total HT : <b><span id="prixHT">0,00</span> ‚Ç¨</b></p>
  <p>Total TTC : <b><span id="prixTTC">0,00</span> ‚Ç¨</b></p>
</div>

</main>

<button id="btnAddDevis">‚ûï Ajouter au devis</button>

<!-- ‚úÖ POPUP RAL -->
<div id="ralModal" class="ral-modal hidden" role="dialog" aria-modal="true" aria-labelledby="ralTitle">
  <div class="ral-backdrop" data-close="1"></div>

  <div class="ral-card">
    <div class="ral-head">
      <div>
        <div id="ralTitle" class="ral-title">RAL disponibles ‚Äî T√¥le aluminium 15/10 pr√©-laqu√©e</div>
        <div class="ral-sub">Format 3000 √ó 1500 ‚Ä¢ Satin√© / Brillante ‚Ä¢ Clique un RAL pour le copier</div>
      </div>
      <button type="button" id="ralClose" class="ral-close" aria-label="Fermer">‚úï</button>
    </div>

    <div class="ral-toolbar">
      <div class="ral-tabs" role="tablist" aria-label="Finition">
        <button type="button" class="ral-tab is-active" data-finish="satine" role="tab" aria-selected="true">Satin√©</button>
        <button type="button" class="ral-tab" data-finish="brillante" role="tab" aria-selected="false">Brillante</button>
      </div>
      <input id="ralSearch" class="ral-search" type="text" placeholder="Rechercher : 7016, gris, noir, bleu‚Ä¶" />
    </div>

    <div id="ralContent" class="ral-content"></div>

    <div class="ral-foot">
      <div id="ralToast" class="ral-toast" aria-live="polite"></div>
      <div class="ral-note">R√©f√©rence indicative : valider la teinte finale avec un nuancier officiel RAL / √©chantillon mati√®re.</div>
    </div>
  </div>
</div>

<script>
const TVA = 0.20;
const COEF_PUBLIC = 2;

/* ===== PRIX PANNEAUX ===== */
const PRICE_PANEL = {
  alu15_pre: 82, alu15_laq: 94,
  alu20_pre: 89, alu20_laq: 105,
  dibond_pre: 50, dibond_laq: 71
};

/* ===== PRIX CH√ÇSSIS (IDENTIQUES T√îLE TABLETTE) ===== */
const CHASSIS_BASE_30 = 10.5; // ‚Ç¨/ml interne

const CHASSIS_ML = {
  30: CHASSIS_BASE_30,
  40: +(CHASSIS_BASE_30 * 1.10).toFixed(2),
  50: +(CHASSIS_BASE_30 * 1.10 * 1.10).toFixed(2)
};

const GOUSSET_PRICE = 6.5; // ‚Ç¨/u interne

const $ = id => document.getElementById(id);
const euro = n => (isFinite(n)?n:0).toFixed(2).replace('.',',');

/* ==========================
   POPUP RAL (identique aux autres)
   ========================== */
const RAL_DATA = {
  satine: {
    "Blanc cass√©": ["1013"],
    "Blanc": ["9001","9002","9003","9018"],
    "Noir": ["9004","9005","9011"],
    "Gris": ["7001","7003","7004","7005","7006","7010","7011","7012","7013","7015","7016","7021","7022","7023","7024","7030","7031","7032","7033","7035","7036","7037","7038","7039","7040","7042","7043","7044","7046","7047"],
    "Brun": ["1247","8003","8004","8011","8012","8014","8016","8017","8019","8022","8025","8028"],
    "Vert": ["6005","6006","6019","6021"],
    "Ivoire": ["1014","1015"],
    "Beige": ["1001","1019"],
    "Rouge": ["3003","3004","3009","3011","3012"],
    "Bleu": ["5003","5008","5009","5014"]
  },
  brillante: {
    "Blanc": ["9001","9002","9003"],
    "Noir": ["9005"],
    "Gris": ["7001","7005","7006","7010","7011","7012","7015","7016","7021","7022","7024","7030","7031","7032","7035","7036","7037","7038","7039","7040","7042","7043","7047"],
    "Brun": ["8011","8014","8017","8019"],
    "Vert": ["6005","6021"],
    "Ivoire": ["1013","1015"],
    "Galet": ["9660"],
    "Jaune": ["1023"],
    "Rouge": ["3002","3003","3004","3020"],
    "Bleu": ["5002","5010","5017"]
  }
};

let ralFinish = "satine";
let ralToastTimer = null;

function ralNorm(s){
  return String(s||'').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'');
}

function setRalToast(msg){
  const el = document.getElementById("ralToast");
  if(!el) return;
  el.textContent = msg || "";
  clearTimeout(ralToastTimer);
  if(msg){
    ralToastTimer = setTimeout(()=>{ el.textContent=""; }, 1200);
  }
}

function renderRal(){
  const cont = document.getElementById("ralContent");
  if(!cont) return;

  const q = ralNorm((document.getElementById("ralSearch")?.value || "").trim());
  cont.innerHTML = "";

  const groups = RAL_DATA[ralFinish] || {};
  let any = false;

  Object.entries(groups).forEach(([family, codes])=>{
    const famNorm = ralNorm(family);
    const filtered = codes.filter(code=>{
      if(!q) return true;
      const codeStr = String(code);
      return famNorm.includes(q) || codeStr.includes(q) || (`ral ${codeStr}`).includes(q);
    });

    if(!filtered.length) return;
    any = true;

    const sec = document.createElement("section");
    sec.className = "ral-group";
    sec.innerHTML = `<h3>${family}</h3>`;

    const grid = document.createElement("div");
    grid.className = "ral-grid";

    filtered.forEach(code=>{
      const b = document.createElement("button");
      b.type = "button";
      b.className = "ral-chip";
      b.dataset.code = String(code);
      b.textContent = `RAL ${code}`;
      grid.appendChild(b);
    });

    sec.appendChild(grid);
    cont.appendChild(sec);
  });

  if(!any){
    cont.innerHTML = `<div class="ral-empty">Aucun r√©sultat pour cette recherche.</div>`;
  }
}

function openRalModal(){
  const modal = document.getElementById("ralModal");
  if(!modal) return;
  modal.classList.remove("hidden");
  document.documentElement.classList.add("ral-lock");
  document.body.classList.add("ral-lock");

  const s = document.getElementById("ralSearch");
  if(s){ s.value = ""; }

  renderRal();
  setRalToast("");
  setTimeout(()=>{ document.getElementById("ralSearch")?.focus(); }, 50);
}

function closeRalModal(){
  const modal = document.getElementById("ralModal");
  if(!modal) return;
  modal.classList.add("hidden");
  document.documentElement.classList.remove("ral-lock");
  document.body.classList.remove("ral-lock");
  setRalToast("");
}

function updateRalBtn(){
  const btn = document.getElementById("btnRal");
  if(!btn) return;

  const typeProd = document.querySelector('input[name="typeProduit"]:checked')?.value || 'panneau';
  const fam = document.getElementById('famille')?.value || 'alu';

  // Actif uniquement si : type panneau + famille alu + radio "pr√©laqu√©" s√©lectionn√©
  let enabled = false;
  if(typeProd === 'panneau' && fam === 'alu'){
    const mat = document.querySelector('input[name="matAlu"]:checked')?.value || '';
    enabled = mat.includes('_pre');
  }

  btn.disabled = !enabled;
  btn.title = enabled
    ? "Voir les RAL disponibles en t√¥le pr√©-laqu√©e"
    : "Disponible uniquement sur : Panneau / Aluminium en finition Pr√©laqu√©e.";
}

function initRalModal(){
  const btn = document.getElementById("btnRal");
  const modal = document.getElementById("ralModal");
  const closeBtn = document.getElementById("ralClose");

  if(btn){
    btn.addEventListener("click", ()=>{
      if(btn.disabled) return;
      openRalModal();
    });
  }

  if(closeBtn) closeBtn.addEventListener("click", closeRalModal);

  if(modal){
    modal.addEventListener("click", (e)=>{
      const t = e.target;
      if(t && t.dataset && t.dataset.close === "1") closeRalModal();
    });
  }

  document.addEventListener("keydown", (e)=>{
    if(e.key === "Escape"){
      const m = document.getElementById("ralModal");
      if(m && !m.classList.contains("hidden")) closeRalModal();
    }
  });

  // Tabs
  document.querySelectorAll(".ral-tab").forEach(tab=>{
    tab.addEventListener("click", ()=>{
      document.querySelectorAll(".ral-tab").forEach(x=>{
        x.classList.remove("is-active");
        x.setAttribute("aria-selected","false");
      });
      tab.classList.add("is-active");
      tab.setAttribute("aria-selected","true");
      ralFinish = tab.dataset.finish || "satine";
      renderRal();
    });
  });

  // Search
  document.getElementById("ralSearch")?.addEventListener("input", renderRal);

  // Click chip => copie
  document.getElementById("ralContent")?.addEventListener("click", async (e)=>{
    const chip = e.target?.closest?.(".ral-chip");
    if(!chip) return;
    const txt = chip.textContent || "";
    try{
      await navigator.clipboard.writeText(txt);
      setRalToast(`‚úÖ ${txt} copi√©`);
    }catch(err){
      window.prompt("Copie ce RAL :", txt);
    }
  });

  updateRalBtn();
}

function toggleUI(){
  const type = document.querySelector('input[name="typeProduit"]:checked').value;
  $('blockPanneau').style.display = type==='panneau'?'':'none';
  $('blockChassis').style.display = type==='chassis'?'':'none';

  // ‚úÖ bascule Alu / Dibond selon Famille
  const fam = $('famille')?.value || 'alu';
  $('blockAlu').style.display = fam==='alu' ? '' : 'none';
  $('blockDibond').style.display = fam==='dibond' ? '' : 'none';

  updateRalBtn();
}

function selectedPanelKey(){
  return $('famille').value === 'alu'
    ? document.querySelector('input[name="matAlu"]:checked').value
    : document.querySelector('input[name="matDibond"]:checked').value;
}

function compute(){
  toggleUI();

  let remise = 1;
  try{
    const p = JSON.parse(localStorage.getItem('cofel_client_profile'));
    if(p?.discountRate) remise = 1 - p.discountRate;
  }catch{}

  const type = document.querySelector('input[name="typeProduit"]:checked').value;

  /* ===== PANNEAU ===== */
  if(type==='panneau'){
    const L = Number($('largeur').value||0);
    const H = Number($('hauteur').value||0);
    const Q = Math.max(1,Number($('quantite').value||1));
    const surf = (L*H)/1e6;
    $('surface').value = surf.toFixed(3).replace('.',',')+' m¬≤';

    if(surf<=0){ $('prixHT').textContent='0,00'; $('prixTTC').textContent='0,00'; return; }

    const pu = PRICE_PANEL[selectedPanelKey()] * surf;
    const total = pu * COEF_PUBLIC * remise * Q;

    $('prixHT').textContent = euro(total);
    $('prixTTC').textContent = euro(total*(1+TVA));

    window._LAST = {
      pu_public_ht: (total/Q).toFixed(2),
      quantite: Q,
      type:'panneau',
      designation: `Panneau ${$('famille').value==='alu'?'Alu':'Dibond'} ‚Äî ${L}√ó${H} mm`
    };
    return;
  }

  /* ===== CH√ÇSSIS ===== */
  const L = Number($('chL').value||0);
  const H = Number($('chH').value||0);
  if(L<=0 || H<=0){ $('prixHT').textContent='0,00'; $('prixTTC').textContent='0,00'; return; }

  const section = document.querySelector('input[name="sectionChassis"]:checked').value;
  const perimetre_ml = ((L+H)*2)/1000;
  const surface_m2 = (L*H)/1e6;

  const goussets = Math.max(4, Math.ceil(surface_m2)*4);
  const interne = perimetre_ml*CHASSIS_ML[section] + goussets*GOUSSET_PRICE;
  const total = interne * COEF_PUBLIC * remise;

  $('prixHT').textContent = euro(total);
  $('prixTTC').textContent = euro(total*(1+TVA));

  window._LAST = {
    pu_public_ht: total.toFixed(2),
    quantite: 1,
    type:'chassis',
    designation:`Ch√¢ssis alu ${section}√ó${section} ‚Äî ${L}√ó${H} mm`
  };
}

initRalModal();
document.addEventListener('input', compute);
document.addEventListener('change', compute);
compute();
</script>

<script src="../js/devis-core.js"></script>

<script>
$('btnAddDevis').addEventListener('click',()=>{
  if(!window._LAST || !window.Devis) return alert("Erreur devis");

  const data = window._LAST;

  Devis.addLine({
    type: data.type==='chassis'?'Ch√¢ssis aluminium':'T√¥lerie & Panneaux',
    designation: data.designation || 'Panneau',
    quantite: data.quantite || 1,
    pu_public_ht: Number(data.pu_public_ht)
  });

  alert("‚úÖ Ligne ajout√©e au devis !");
});
</script>

</body>
</html>


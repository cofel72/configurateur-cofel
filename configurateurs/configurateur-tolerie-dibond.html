<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>Configurateur – Tôlerie & Châssis aluminium</title>

<!-- ✅ CSS de base (manquait) -->
<link rel="stylesheet" href="../styles/cofel.css" />
<link rel="stylesheet" href="../styles/cofel-components.css" />
<link rel="stylesheet" href="../styles/cofel-glass.css" />

<style>
.cofel-header.glass{
  background: rgba(90,45,130,.35);
  backdrop-filter: blur(18px);
  border-bottom: 1px solid rgba(255,255,255,.15);
}
.cofel-header .cofel-title{color:#ffffff;}
.cofel-header .cofel-back{color:rgba(255,255,255,.85);}
.cofel-header .cofel-back:hover{color:#fff;}
.muted{opacity:.7;font-size:13px;}
</style>
  <link rel="stylesheet" href="/styles/cofel-theme-apple-dark.css">

</head>

<body>

<!-- ✅ Ajout de "glass" pour que ton style .cofel-header.glass s'applique -->
<header class="cofel-header glass">
  <div class="row">
    <a class="cofel-back" href="../index.html">⬅ Retour accueil (Devis)</a>
    <div class="cofel-brand">
      <img src="../assets/logo cofel.jpg" alt="Cofel" />
      <h1 class="cofel-title">Configurateur — Tôlerie & Châssis</h1>
    </div>
  </div>
</header>

<main class="wrap">

<!-- TYPE -->
<fieldset>
  <legend>Type de produit</legend>
  <div class="radio-row">
    <label><input type="radio" name="typeProduit" value="panneau" checked> Panneau / Tôlerie</label>
    <label><input type="radio" name="typeProduit" value="chassis"> Châssis aluminium</label>
  </div>
</fieldset>

<!-- ===================== PANNEAU ===================== -->
<div id="blockPanneau">

<fieldset>
  <div class="grid">
    <div>
      <label>Famille</label>
      <select id="famille">
        <option value="alu">Aluminium</option>
        <option value="dibond">Alu/PVC (type Dibond 3mm)</option>
      </select>
    </div>
    <div>
      <label>Quantité</label>
      <input type="number" id="quantite" value="1" min="1">
    </div>
  </div>
</fieldset>

<fieldset id="blockAlu">
  <legend>Aluminium</legend>
  <div class="radio-row">
    <label><input type="radio" name="matAlu" value="alu15_pre" checked> 15/10 Prélaqué</label>
    <label><input type="radio" name="matAlu" value="alu15_laq"> 15/10 Laqué</label>
    <label><input type="radio" name="matAlu" value="alu20_pre"> 20/10 Prélaqué</label>
    <label><input type="radio" name="matAlu" value="alu20_laq"> 20/10 Laqué</label>
  </div>
</fieldset>

<fieldset id="blockDibond" style="display:none">
  <legend>Dibond</legend>
  <div class="radio-row">
    <label><input type="radio" name="matDibond" value="dibond_pre" checked> Prélaqué</label>
    <label><input type="radio" name="matDibond" value="dibond_laq"> Laqué</label>
  </div>
</fieldset>

<fieldset>
  <legend>Dimensions panneau</legend>
  <!-- ✅ si jamais grid-dimensions n'est plus défini dans tes CSS, on garde une grille sûre -->
  <div class="grid">
    <div><label>Largeur (mm)</label><input type="number" id="largeur"></div>
    <div><label>Hauteur (mm)</label><input type="number" id="hauteur"></div>
  </div>
  <label>Surface</label>
  <input id="surface" disabled value="0,000 m²">
</fieldset>

</div>

<!-- ===================== CHÂSSIS ===================== -->
<div id="blockChassis" style="display:none">

<fieldset>
  <legend>Châssis aluminium</legend>

  <div class="radio-row">
    <label><input type="radio" name="sectionChassis" value="30" checked> 30×30 mm</label>
    <label><input type="radio" name="sectionChassis" value="40"> 40×40 mm</label>
    <label><input type="radio" name="sectionChassis" value="50"> 50×50 mm</label>
  </div>

  <div class="grid">
    <div><label>Largeur extérieure (mm)</label><input type="number" id="chL"></div>
    <div><label>Hauteur extérieure (mm)</label><input type="number" id="chH"></div>
  </div>

  <p class="muted">Calcul identique au configurateur Tôle Tablette</p>
</fieldset>

</div>

<div class="result">
  <p>Total HT : <b><span id="prixHT">0,00</span> €</b></p>
  <p>Total TTC : <b><span id="prixTTC">0,00</span> €</b></p>
</div>

</main>

<button id="btnAddDevis">➕ Ajouter au devis</button>

<script>
const TVA = 0.20;
const COEF_PUBLIC = 2;

/* ===== PRIX PANNEAUX ===== */
const PRICE_PANEL = {
  alu15_pre: 82, alu15_laq: 94,
  alu20_pre: 89, alu20_laq: 105,
  dibond_pre: 50, dibond_laq: 71
};

/* ===== PRIX CHÂSSIS (IDENTIQUES TÔLE TABLETTE) ===== */
const CHASSIS_BASE_30 = 10.5; // €/ml interne

const CHASSIS_ML = {
  30: CHASSIS_BASE_30,
  40: +(CHASSIS_BASE_30 * 1.10).toFixed(2),
  50: +(CHASSIS_BASE_30 * 1.10 * 1.10).toFixed(2)
};

const GOUSSET_PRICE = 6.5; // €/u interne

const $ = id => document.getElementById(id);
const euro = n => (isFinite(n)?n:0).toFixed(2).replace('.',',');

function toggleUI(){
  const type = document.querySelector('input[name="typeProduit"]:checked').value;
  $('blockPanneau').style.display = type==='panneau'?'':'none';
  $('blockChassis').style.display = type==='chassis'?'':'none';

  // ✅ bascule Alu / Dibond selon Famille
  const fam = $('famille')?.value || 'alu';
  $('blockAlu').style.display = fam==='alu' ? '' : 'none';
  $('blockDibond').style.display = fam==='dibond' ? '' : 'none';
}

function selectedPanelKey(){
  return $('famille').value === 'alu'
    ? document.querySelector('input[name="matAlu"]:checked').value
    : document.querySelector('input[name="matDibond"]:checked').value;
}

function compute(){
  toggleUI();

  let remise = 1;
  try{
    const p = JSON.parse(localStorage.getItem('cofel_client_profile'));
    if(p?.discountRate) remise = 1 - p.discountRate;
  }catch{}

  const type = document.querySelector('input[name="typeProduit"]:checked').value;

  /* ===== PANNEAU ===== */
  if(type==='panneau'){
    const L = Number($('largeur').value||0);
    const H = Number($('hauteur').value||0);
    const Q = Math.max(1,Number($('quantite').value||1));
    const surf = (L*H)/1e6;
    $('surface').value = surf.toFixed(3).replace('.',',')+' m²';

    if(surf<=0){ $('prixHT').textContent='0,00'; $('prixTTC').textContent='0,00'; return; }

    const pu = PRICE_PANEL[selectedPanelKey()] * surf;
    const total = pu * COEF_PUBLIC * remise * Q;

    $('prixHT').textContent = euro(total);
    $('prixTTC').textContent = euro(total*(1+TVA));

    window._LAST = {
      pu_public_ht: (total/Q).toFixed(2),
      quantite: Q,
      type:'panneau',
      designation: `Panneau ${$('famille').value==='alu'?'Alu':'Dibond'} — ${L}×${H} mm`
    };
    return;
  }

  /* ===== CHÂSSIS ===== */
  const L = Number($('chL').value||0);
  const H = Number($('chH').value||0);
  if(L<=0 || H<=0){ $('prixHT').textContent='0,00'; $('prixTTC').textContent='0,00'; return; }

  const section = document.querySelector('input[name="sectionChassis"]:checked').value;
  const perimetre_ml = ((L+H)*2)/1000;
  const surface_m2 = (L*H)/1e6;

  const goussets = Math.max(4, Math.ceil(surface_m2)*4);
  const interne = perimetre_ml*CHASSIS_ML[section] + goussets*GOUSSET_PRICE;
  const total = interne * COEF_PUBLIC * remise;

  $('prixHT').textContent = euro(total);
  $('prixTTC').textContent = euro(total*(1+TVA));

  window._LAST = {
    pu_public_ht: total.toFixed(2),
    quantite: 1,
    type:'chassis',
    designation:`Châssis alu ${section}×${section} — ${L}×${H} mm`
  };
}

document.addEventListener('input', compute);
document.addEventListener('change', compute);
compute();
</script>

<script src="../js/devis-core.js"></script>

<script>
$('btnAddDevis').addEventListener('click',()=>{
  if(!window._LAST || !window.Devis) return alert("Erreur devis");

  const data = window._LAST;

  Devis.addLine({
    type: data.type==='chassis'?'Châssis aluminium':'Tôlerie & Panneaux',
    designation: data.designation || 'Panneau',
    quantite: data.quantite || 1,
    pu_public_ht: Number(data.pu_public_ht)
  });

  alert("✅ Ligne ajoutée au devis !");
});
</script>

</body>
</html>



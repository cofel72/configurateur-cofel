<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>Configurateur — Enseignes Drapeaux | Cofel</title>

<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

<style>
  :root{
    --violet:#5a2d82;
    --violet-2:#7838a7;
    --glass: rgba(255,255,255,.08);
    --glass-hr: rgba(255,255,255,.14);
    --txt:#f5f7ff;
    --txt-dim:#e6e6ff;
    --accent:#c9b7ff;
    --radius:18px;
    --blur:18px;
    --shadow:0 10px 30px rgba(0,0,0,.35);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--txt);
    font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text","Segoe UI",Roboto,Arial,sans-serif;
    background:
      radial-gradient(800px 500px at 20% -10%, rgba(255,255,255,.10), transparent 60%),
      radial-gradient(800px 500px at 110% 10%, rgba(255,255,255,.08), transparent 60%),
      linear-gradient(135deg, var(--violet), var(--violet-2));
  }

  .hero{position:relative; z-index:1; padding:40px 20px 24px;}
  .hero-inner{ max-width:1200px; margin:0 auto; display:flex; align-items:center; justify-content:space-between; gap:16px; }
  .brand{ display:flex; align-items:center; gap:14px; backdrop-filter: blur(var(--blur)); background: linear-gradient(180deg, rgba(255,255,255,.14), rgba(255,255,255,.06)); border:1px solid rgba(255,255,255,.18); padding:10px 14px; border-radius:14px; box-shadow: var(--shadow); }
  .brand img{height:42px; width:auto; border-radius:10px}
  .brand h1{font-size: clamp(18px, 2.6vw, 22px); margin:0;}
  .tagline{max-width:1200px;margin:18px auto 0;padding:0 20px;color:var(--txt-dim)}
  .wrap{max-width:1200px; margin:26px auto; padding:0 20px 40px;}

  .panel{ background: linear-gradient(180deg, rgba(255,255,255,.16), rgba(255,255,255,.06)); border:1px solid rgba(255,255,255,.2); border-radius:20px; padding:18px; box-shadow:var(--shadow); margin-bottom:18px; }
  .panel h2{margin:0 0 12px; color:var(--accent)}

  .card{ background: linear-gradient(180deg, rgba(255,255,255,.14), rgba(255,255,255,.06)); border:1px solid rgba(255,255,255,.18); border-radius:16px; padding:14px; box-shadow:var(--shadow); }
  .grid{display:grid; gap:12px; grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
  .muted{color:var(--txt-dim); font-size:12px; margin-top:6px;}

  label{font-weight:700; font-size:13px; color:var(--accent);} 
  input[type="number"], select{
    width:100%; margin-top:6px; padding:12px;
    background: rgba(255,255,255,.10); color:var(--txt);
    border:1px solid rgba(255,255,255,.24); border-radius:14px; outline:none;
  }
  select option{ background:#3c1f61; color:#fff; }

  /* custom select... (identique version précédente) */
  .native-select{ position:absolute !important; opacity:0 !important; pointer-events:none !important; width:0; height:0; }
  .cselect{ position:relative; margin-top:6px; }
  .cselect-toggle{ width:100%; display:flex; align-items:center; justify-content:space-between; padding:12px; border-radius:14px; background:rgba(255,255,255,.10); border:1px solid rgba(255,255,255,.24); cursor:pointer; }
  .cselect-label{flex:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;}
  .cselect-caret{width:10px;height:10px;background-image:linear-gradient(45deg,transparent 50%,var(--txt) 50%),linear-gradient(135deg,var(--txt) 50%,transparent 50%);background-size:6px 6px;background-repeat:no-repeat;}

  .cselect-menu{ position:fixed; left:0; top:0; width:280px; z-index:99999; max-height:320px; overflow:auto; padding:6px; border-radius:14px; border:1px solid rgba(255,255,255,.22); background:#3c1f61; display:none; }
  .cselect-option{ border-radius:10px; margin:4px 0; padding:10px 12px; cursor:pointer; color:#fff; background: rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.18); }

  .option-item{
    display:flex; align-items:center; gap:10px; cursor:pointer;
    padding:10px 14px; border-radius:14px;
    background: linear-gradient(180deg, rgba(255,255,255,.18), rgba(255,255,255,.08));
    border:1px solid rgba(255,255,255,.24);
  }
  .option-item input{
    appearance:none; width:20px; height:20px; border-radius:6px;
    background:rgba(255,255,255,.15); border:1px solid rgba(255,255,255,.6);
  }

  .result{
    text-align:center; padding:16px;
    background: rgba(255,255,255,.10); border:1px solid rgba(255,255,255,.22);
    border-radius:16px; font-size:18px;
  }

  .btn{ background:#fff; color:#000; padding:10px 14px; border-radius:12px; cursor:pointer; font-weight:700; }
  .btn-ghost{ background:transparent; color:var(--txt); border:1px solid rgba(255,255,255,.24); }

</style>
</head>
<body>

<div class="hero">
  <div class="hero-inner">
    <div class="brand">
      <img src="../assets/logo cofel.jpg" />
      <h1>Configurateur — Enseignes Drapeaux</h1>
    </div>
    <a class="brand" href="../index.html" style="text-decoration:none;color:inherit">⬅ Retour devis</a>
  </div>
  <div class="tagline">Choisissez la forme, la dimension et les options. Les montants s’actualisent automatiquement.</div>
</div>

<main class="wrap">
<!-- ===================== LOGIQUE CONFIGURATEUR DRAPEAUX ===================== -->
<script>
/* ========= CONSTANTES ========= */
const TVA = 0.20;
const UPLIFT_PUBLIC = 2.0;
const CSV_URL =
  "https://raw.githubusercontent.com/stevens-cofel/configurateur-cofel/refs/heads/main/Enseigne%20drapeaux.csv";

let HEADS = [], ROWS = [], MAP = null;

/* ========= Raccourci DOM ========= */
const $ = (id) => document.getElementById(id);

const elForme = $("forme");
const elDim = $("dimension");
const elQ = $("quantite");
const elPot = $("potence");

const elFinPre = $("finPre");
const elFinLq = $("finLq");
const elFinAj = $("finAj");

const elHT = $("prixHT");
const elTTC = $("prixTTC");

const elHelpDim = $("helpDim");
const elNoteForme = $("noteForme");
const elHelpFinit = $("helpFinition");

/* ========= OUTILS ========= */
function normKey(k) {
  return String(k || "")
    .toLowerCase()
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g, "")
    .replace(/[^a-z0-9+]+/g, "")
    .trim();
}

function numFR(v) {
  if (v == null) return NaN;
  let s = String(v)
    .trim()
    .replace(/€/g, "")
    .replace(/[\u00A0\u202F]/g, "")
    .replace(/\s+/g, "");
  if (s.includes(",") && s.includes(".")) s = s.replace(/\./g, "");
  s = s.replace(",", ".");
  const m = s.match(/-?\d+(\.\d+)?/);
  return m ? parseFloat(m[0]) : NaN;
}

function euro(n) {
  return (isFinite(n) ? n : 0).toFixed(2).replace(".", ",");
}

function distinct(arr) {
  return [...new Set(arr)];
}

/* ========= CSV PARSER ========= */
function parseCSVAuto(text) {
  const raw = String(text || "").replace(/^\uFEFF/, "");
  const lines = raw
    .split(/\r\n|\n|\r/)
    .filter((l) => l.trim() !== "");

  if (!lines.length) return { rawHeads: [], rows: [] };

  const first = lines[0];
  const sep =
    (first.match(/;/g) || []).length >
    (first.match(/,/g) || []).length
      ? ";"
      : ",";

  function parseCSVLine(line) {
    let out = [],
      cur = "",
      inQ = false;

    for (let i = 0; i < line.length; i++) {
      const ch = line[i],
        nx = line[i + 1];
      if (ch === '"') {
        if (inQ && nx === '"') {
          cur += '"';
          i++;
        } else inQ = !inQ;
      } else if (ch === sep && !inQ) {
        out.push(cur);
        cur = "";
      } else cur += ch;
    }
    out.push(cur);
    return out;
  }

  const rawHeads = parseCSVLine(first).map((s) =>
    s.replace(/^"+|"+$/g, "").trim()
  );

  const rows = lines.slice(1).map((line) => {
    const cells = parseCSVLine(line).map((s) =>
      s.replace(/^"+|"+$/g, "").trim()
    );
    const o = {};
    rawHeads.forEach((h, i) => (o[h] = cells[i] ?? ""));
    return o;
  });

  return { rawHeads, rows };
}

/* ========= MAPPING CSV → CHAMPS ========= */
function buildMapping(rawHeads) {
  const nk = rawHeads.map(normKey);
  const find = (k) => {
    const i = nk.indexOf(k);
    return i >= 0 ? rawHeads[i] : null;
  };
  const like = (...arr) => {
    for (let i = 0; i < nk.length; i++) {
      if (arr.every((re) => re.test(nk[i]))) return rawHeads[i];
    }
    return null;
  };

  return {
    FORME: find("forme") || like(/forme/),
    DIM: find("dimensionmm") || like(/dimension|dim/),
    FIN: find("finition") || like(/fini/),
    PRIX: find("prixeurl") || like(/prix|eur/),
    OPT_AJL: find("opt_ajourage+lumineux") || like(/ajour|lum/)
  };
}

/* ========= CUSTOM SELECTS ========= */
const customSelects = new Map();

function buildCustomFromNative(native) {
  const wrap = document.querySelector(
    '.cselect[data-bind="' + native.id + '"]'
  );
  if (!wrap) return;

  const toggle = wrap.querySelector(".cselect-toggle");
  const labelSpan = wrap.querySelector(".cselect-label");
  const menu = wrap.querySelector(".cselect-menu");

  menu.innerHTML = "";
  Array.from(native.options).forEach((opt) => {
    const d = document.createElement("div");
    d.className = "cselect-option";
    d.dataset.value = opt.value;
    d.textContent = opt.textContent;

    if (opt.selected) d.setAttribute("aria-selected", "true");

    d.addEventListener("click", () => {
      setNativeValue(native, opt.value);
      closeMenu(native.id);
    });

    menu.appendChild(d);
  });

  labelSpan.textContent =
    native.selectedOptions[0]?.textContent || "";

  toggle.onclick = () => {
    const exp = wrap.getAttribute("aria-expanded") === "true";
    exp ? closeMenu(native.id) : openMenu(native.id);
  };

  customSelects.set(native.id, {
    wrap,
    toggle,
    labelSpan,
    menu,
    native
  });
}

function setNativeValue(native, val) {
  if (native.value !== val) {
    native.value = val;
    native.dispatchEvent(
      new Event("change", { bubbles: true })
    );
  }
  const api = customSelects.get(native.id);
  if (!api) return;
  api.labelSpan.textContent =
    native.selectedOptions[0]?.textContent || "";
  Array.from(api.menu.children).forEach((el) => {
    el.setAttribute(
      "aria-selected",
      el.dataset.value === val ? "true" : "false"
    );
  });
}

function openMenu(id) {
  const api = customSelects.get(id);
  if (!api) return;
  const { wrap, toggle, menu } = api;

  wrap.setAttribute("aria-expanded", "true");
  const r = toggle.getBoundingClientRect();
  menu.style.left = r.left + "px";
  menu.style.top = r.bottom + 6 + "px";
  menu.style.width = r.width + "px";
  menu.style.display = "block";

  const onClick = (e) => {
    if (!wrap.contains(e.target) && !menu.contains(e.target))
      closeMenu(id);
  };

  document.addEventListener("click", onClick);
  api._off = () =>
    document.removeEventListener("click", onClick);
}

function closeMenu(id) {
  const api = customSelects.get(id);
  if (!api) return;
  const { wrap, menu, _off } = api;

  wrap.setAttribute("aria-expanded", "false");
  menu.style.display = "none";
  if (typeof _off === "function") _off();
}

/* ========= FILTRES DRAPEAUX ========= */
function getFinition() {
  if (elFinAj.checked) return "ajour";
  if (elFinLq.checked) return "laque";
  return "prelaque";
}

function filteredPool() {
  let pool = [...ROWS];

  if (elForme.value)
    pool = pool.filter(
      (r) =>
        String(r[MAP.FORME]).toLowerCase() ===
        elForme.value.toLowerCase()
    );

  const finSel = getFinition();

  return pool.filter((r) => {
    const fin = String(r[MAP.FIN]).trim().toLowerCase();
    const ajl =
      String(r[MAP.OPT_AJL]).trim().toLowerCase() === "vrai";

    if (finSel === "ajour") return ajl;
    if (finSel === "laque") return fin === "laqué" && !ajl;
    return fin === "prélaqué" && !ajl;
  });
}

function populateFormes() {
  const formes = distinct(
    ROWS.map((r) => String(r[MAP.FORME] || "").toLowerCase())
  ).filter(Boolean);

  elForme.innerHTML =
    '<option value="">(choisir)</option>' +
    formes
      .map((f) => `<option value="${f}">${f}</option>`)
      .join("");

  buildCustomFromNative(elForme);
}

function populateDimensions() {
  const pool = filteredPool();
  const dims = distinct(
    pool
      .map((r) => String(r[MAP.DIM] || "").trim())
      .filter(Boolean)
  ).sort();

  elDim.innerHTML =
    '<option value="">(choisir la dimension)</option>' +
    dims.map((d) => `<option value="${d}">${d}</option>`).join("");

  elHelpDim.textContent =
    dims.length > 0
      ? "Dimensions disponibles : " + dims.join(" • ")
      : "";

  buildCustomFromNative(elDim);
}

function findRow() {
  const pool = filteredPool();
  if (!pool.length) return null;
  if (elDim.value)
    return (
      pool.find(
        (r) => String(r[MAP.DIM]).trim() === elDim.value
      ) || null
    );
  return pool[0];
}

/* ========= CALCUL PRINCIPAL ========= */
function compute() {
  /* === Remise automatique client === */
  let remiseClient = 1;
  try {
    const p = JSON.parse(
      localStorage.getItem("cofel_client_profile")
    );
    if (p && typeof p.discountRate === "number")
      remiseClient = 1 - p.discountRate;
  } catch {}

  /* === Mode tarif index-test === */
  const mode =
    localStorage.getItem("cofel_price_mode") || "client";
  // client = prix public
  // pro = prix remisé

  const row = findRow();
  const Q = Math.max(1, Number(elQ.value || 1));

  if (!row) {
    elHT.textContent = "0,00";
    elTTC.textContent = "0,00";
    return;
  }

  const unit_interne = numFR(row[MAP.PRIX]) || 0;

  const unit_public = unit_interne * UPLIFT_PUBLIC;
  const unit_remise = unit_public * remiseClient;

  const unit_affiche =
    mode === "pro" ? unit_remise : unit_public;

  const total_public = unit_public * Q;
  const total_remise = unit_remise * Q;

  const totalHT = unit_affiche * Q;

  elHT.textContent = euro(totalHT);
  elTTC.textContent = euro(totalHT * (1 + TVA));

  /* ==== STOCKAGE POUR ADDLINE ==== */
  window._DRAPEAU_LAST = {
    pu_public_ht: Number(unit_public.toFixed(2)),
    pu_remise_ht: Number(unit_remise.toFixed(2)),
    total_public_ht: Number(total_public.toFixed(2)),
    total_remise_ht: Number(total_remise.toFixed(2))
  };
}

/* ========= LOAD CSV ========= */
async function loadCSV() {
  try {
    const r = await fetch(CSV_URL, { cache: "no-store" });
    const txt = await r.text();
    const parsed = parseCSVAuto(txt);

    HEADS = parsed.rawHeads;
    ROWS = parsed.rows;
    MAP = buildMapping(HEADS);

    populateFormes();
    populateDimensions();
    compute();
  } catch (e) {
    alert("Erreur de chargement CSV.");
  }
}

/* ========= ÉVÉNEMENTS ========= */
["change", "input"].forEach((ev) => {
  elForme.addEventListener(ev, () => {
    populateDimensions();
    compute();
  });
  elDim.addEventListener(ev, compute);
  elQ.addEventListener(ev, compute);
  elFinPre.addEventListener(ev, () => {
    populateDimensions();
    compute();
  });
  elFinLq.addEventListener(ev, () => {
    populateDimensions();
    compute();
  });
  elFinAj.addEventListener(ev, () => {
    populateDimensions();
    compute();
  });
});

window.addEventListener("cofel-price-mode-changed", compute);

/* ========= INIT ========= */
buildCustomFromNative(elForme);
buildCustomFromNative(elDim);
loadCSV();
</script>
<!-- ===================== MOTEUR DE DEVIS ===================== -->
<script src="../js/devis-core.js"></script>

<!-- ===================== ADD LINE ===================== -->
<script>
document.getElementById("btnAddDevis").addEventListener("click", () => {

  try {
    if (!window.Devis) {
      alert("Erreur interne : moteur de devis introuvable.");
      return;
    }

    const qte = Math.max(1, Number(document.getElementById("quantite").value || 1));

    const p = window._DRAPEAU_LAST;
    if (!p) {
      alert("Erreur : aucun calcul disponible.");
      return;
    }

    const forme = document.getElementById("forme").value || "";
    const dim   = document.getElementById("dimension").value || "";
    const pot   = (document.getElementById("potence")?.value || "").trim();

    const finSel =
      document.getElementById("finAj").checked ? "ajour" :
      document.getElementById("finLq").checked ? "laque" : "prelaque";

    const parts = [];
    if (forme) parts.push(forme);
    if (dim)   parts.push(dim);
    if (pot)   parts.push(`potence ${pot} mm`);

    if (finSel === "ajour") parts.push("ajourage lumineux laqué");
    else if (finSel === "laque") parts.push("laqué");
    else parts.push("prélaqué");

    const designation = "Enseigne Drapeau" + (parts.length ? " — " + parts.join(" / ") : "");

    /* === Envoi complet au devis === */
    Devis.addLine({
      type: "Enseigne Drapeau",
      designation,
      quantite: qte,

      pu_public_ht: p.pu_public_ht,     // prix public unitaire
      pu_remise_ht: p.pu_remise_ht,     // prix net unitaire
      total_public_ht: p.total_public_ht,
      total_remise_ht: p.total_remise_ht
    });

    /* === Popup simple comme demandé === */
    alert("✅ Ligne ajoutée au devis !");
  }
  catch(err) {
    console.error(err);
    alert("Erreur lors de l’ajout au devis : " + err.message);
  }
});
</script>

</body>
</html>

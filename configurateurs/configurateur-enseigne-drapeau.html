<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>Configurateur â€” Enseignes Drapeaux | Cofel</title>

<link rel="stylesheet" href="../styles/cofel.css">
<link rel="stylesheet" href="../styles/cofel-components.css">
<link rel="stylesheet" href="../styles/cofel-glass.css">
</head>

<body>

<header class="cofel-header">
  <div class="row">
    <a class="cofel-back" href="../index.html">â¬… Retour accueil (Devis)</a>
    <div class="cofel-brand">
      <img src="../assets/logo cofel.jpg" alt="Cofel">
      <h1 class="cofel-title">Configurateur â€” Enseignes Drapeaux</h1>
    </div>
  </div>
</header>

<div class="cofel-container">
  <h1>Enseigne Drapeau</h1>

  <!-- PARAMÃˆTRES -->
  <fieldset>
    <legend>ParamÃ¨tres</legend>
    <div class="grid">

      <div>
        <label>Forme</label>
        <select id="forme">
          <option value="">(choisir)</option>
        </select>
      </div>

      <div>
        <label>Dimension</label>
        <select id="dimension">
          <option value="">(choisir)</option>
        </select>
      </div>

      <div>
        <label>QuantitÃ©</label>
        <input type="number" id="quantite" min="1" value="1">
      </div>

      <div>
        <label>Longueur de potence (mm)</label>
        <input type="number" id="potence" min="0" placeholder="ex : 600">
        <div class="hint">Information indicative (sans impact tarifaire).</div>
      </div>

    </div>
  </fieldset>

  <!-- FINITION -->
  <fieldset>
    <legend>Finition</legend>
    <div class="radio-row">
      <label><input type="radio" name="finition" value="prelaque" checked> PrÃ©laquÃ©</label>
      <label><input type="radio" name="finition" value="laque"> LaquÃ©</label>
      <label><input type="radio" name="finition" value="ajour"> Ajourage lumineux</label>
    </div>
    <div id="helpFinition" class="hint"></div>
  </fieldset>

  <!-- RÃ‰SULTAT -->
  <div class="result">
    <p>Total HT : <b><span id="prixHT">0,00</span> â‚¬</b></p>
    <p>Total TTC : <b><span id="prixTTC">0,00</span> â‚¬</b></p>
  </div>

  <div style="margin-top:16px; display:flex; gap:10px; flex-wrap:wrap;">
    <button id="btnAddDevis" class="btn">âž• Ajouter au devis</button>
    <button id="btnReset" class="btn">ðŸ”„ RÃ©initialiser</button>
  </div>
</div>

<footer class="cofel-footer">
Â© Cofel â€” ZA du Perquoi, 72560 ChangÃ© â€” SIRET 927 659 458 00024 â€” TVA FR80927659458
</footer>

<script>
/* ================= CONFIG ================= */
const TVA = 0.20;
const COEF_PUBLIC = 2;
const CSV_URL = "https://raw.githubusercontent.com/stevens-cofel/configurateur-cofel/refs/heads/main/Enseigne%20drapeaux.csv";

/* ================= UTILS ================= */
const $ = id => document.getElementById(id);
const euro = n => (isFinite(n)?n:0).toFixed(2).replace('.',',');
const numFR = v => parseFloat(String(v).replace(',', '.')) || 0;
const norm = s => String(s||'').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'');

/* ================= DOM ================= */
const elForme=$('forme'), elDim=$('dimension'), elQ=$('quantite');
const elHT=$('prixHT'), elTTC=$('prixTTC'), elHelp=$('helpFinition');

/* ================= CSV ================= */
let ROWS=[], MAP={};

function parseCSV(txt){
  const lines=txt.split(/\r?\n/).filter(l=>l.trim());
  const sep = lines[0].includes(';') ? ';' : ',';
  const heads=lines[0].split(sep).map(h=>h.trim());
  const rows=lines.slice(1).map(l=>{
    const c=l.split(sep);
    const o={}; heads.forEach((h,i)=>o[h]=c[i]);
    return o;
  });
  return {heads, rows};
}

function buildMap(heads){
  const n=heads.map(norm);
  const find=r=>heads[n.findIndex(h=>r.test(h))];
  return {
    FORME: find(/forme/),
    DIM: find(/dimension/),
    FIN: find(/finition/),
    PRIX: find(/prix/)
  };
}

/* ================= UI ================= */
function populateFormes(){
  const f=[...new Set(ROWS.map(r=>r[MAP.FORME]).filter(Boolean))];
  elForme.innerHTML='<option value=""></option>'+f.map(v=>`<option>${v}</option>`).join('');
}

function populateDims(){
  const d=[...new Set(
    ROWS.filter(r=>!elForme.value||r[MAP.FORME]===elForme.value)
        .map(r=>r[MAP.DIM]).filter(Boolean)
  )];
  elDim.innerHTML='<option value=""></option>'+d.map(v=>`<option>${v}</option>`).join('');
}

function getFinition(){
  return document.querySelector('input[name="finition"]:checked').value;
}

/* ================= CALCUL ================= */
function compute(){
  const row = ROWS.find(r =>
    r[MAP.FORME]===elForme.value &&
    r[MAP.DIM]===elDim.value &&
    norm(r[MAP.FIN])===norm(getFinition())
  );

  if(!row){
    elHT.textContent='0,00';
    elTTC.textContent='0,00';
    return;
  }

  let unit = numFR(row[MAP.PRIX]) * COEF_PUBLIC;

  let remise=1;
  try{
    const p=JSON.parse(localStorage.getItem('cofel_client_profile'));
    if(p?.discountRate) remise=1-p.discountRate;
  }catch{}

  const total = unit * elQ.value * remise;
  elHT.textContent=euro(total);
  elTTC.textContent=euro(total*(1+TVA));
}

/* ================= EVENTS ================= */
['change','input'].forEach(e=>{
  document.addEventListener(e,ev=>{
    if(ev.target===elForme){ populateDims(); }
    compute();
  });
});

$('btnReset').onclick=()=>{
  elForme.value='';
  elDim.value='';
  elQ.value=1;
  populateFormes();
  populateDims();
  compute();
};

/* ================= INIT ================= */
fetch(CSV_URL)
.then(r=>r.text())
.then(t=>{
  const {heads,rows}=parseCSV(t);
  ROWS=rows;
  MAP=buildMap(heads);
  populateFormes();
  populateDims();
  compute();
});
</script>

<script src="../js/devis-core.js"></script>
<script>
$('btnAddDevis').onclick=()=>{
  const q=elQ.value;
  const ht=parseFloat(elHT.textContent.replace(',','.'))||0;
  if(!ht){ alert("Configuration incomplÃ¨te"); return; }

  const d=[
    elForme.value,
    elDim.value,
    getFinition(),
    $('potence').value?`potence ${$('potence').value} mm`:null
  ].filter(Boolean).join(' â€” ');

  Devis.addLine({
    type:"Enseigne Drapeau",
    designation:d,
    quantite:q,
    pu_public_ht: ht/q
  });

  alert("âœ… AjoutÃ© au devis");
};
</script>

</body>
</html>

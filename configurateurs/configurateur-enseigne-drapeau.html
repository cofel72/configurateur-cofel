<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>Configurateur â€” Enseigne Drapeau | Cofel</title>

<link rel="stylesheet" href="../styles/cofel.css">
<link rel="stylesheet" href="../styles/cofel-components.css">
<link rel="stylesheet" href="../styles/cofel-glass.css">
</head>

<body>

<!-- ================= HEADER ================= -->
<header class="cofel-header">
  <div class="row">
    <a class="cofel-back" href="../index.html">â¬… Retour accueil (Devis)</a>
    <div class="cofel-brand">
      <img src="../assets/logo cofel.jpg" alt="Cofel" />
      <h1 class="cofel-title">Configurateur â€” Enseigne Drapeau</h1>
    </div>
  </div>
</header>

<!-- ================= CONTENU ================= -->
<div class="cofel-container">

  <!-- PARAMÃˆTRES -->
  <fieldset>
    <legend>ParamÃ¨tres</legend>

    <div class="grid">

      <div>
        <label for="forme">Forme</label>
        <select id="forme" class="native-select"></select>

        <div class="cselect" data-bind="forme" aria-expanded="false">
          <button type="button" class="cselect-toggle">
            <span class="cselect-label">(choisir)</span>
            <span class="cselect-caret"></span>
          </button>
          <div class="cselect-menu"></div>
        </div>
        <div id="noteForme" class="hint"></div>
      </div>

      <div>
        <label for="dimension">Dimension</label>
        <select id="dimension" class="native-select"></select>

        <div class="cselect" data-bind="dimension" aria-expanded="false">
          <button type="button" class="cselect-toggle">
            <span class="cselect-label">(choisir)</span>
            <span class="cselect-caret"></span>
          </button>
          <div class="cselect-menu"></div>
        </div>
        <div id="helpDim" class="hint"></div>
      </div>

      <div>
        <label for="quantite">QuantitÃ©</label>
        <input type="number" id="quantite" min="1" value="1">
      </div>

      <div>
        <label for="potence">Longueur de potence (mm)</label>
        <input type="number" id="potence" min="0" placeholder="ex : 600">
      </div>

    </div>
  </fieldset>

  <!-- FINITION -->
  <fieldset>
    <legend>Finition</legend>

    <div class="radio-row">
      <label class="pill">
        <input type="radio" name="finition" value="prelaque" checked>
        PrÃ©laquÃ©
      </label>

      <label class="pill">
        <input type="radio" name="finition" value="laque">
        LaquÃ©
      </label>

      <label class="pill">
        <input type="radio" name="finition" value="ajour">
        Ajourage + PMMA + LED
      </label>
    </div>

    <div id="helpFinition" class="hint"></div>
  </fieldset>

  <!-- RÃ‰SULTATS -->
  <div class="result">
    <p>Total HT : <span id="prixHT">0,00</span> â‚¬</p>
    <p>Total TTC : <span id="prixTTC">0,00</span> â‚¬</p>
  </div>

  <!-- ACTIONS -->
  <div style="margin-top:16px;display:flex;gap:10px;flex-wrap:wrap;">
    <button id="btnAddDevis" class="btn">âž• Ajouter au devis</button>
    <button id="btnReset" class="btn">ðŸ”„ RÃ©initialiser</button>
  </div>

</div>

<footer class="cofel-footer">
  Â© Cofel â€” ZA du Perquoi, 72560 ChangÃ©
</footer>

<!-- ================= LOGIQUE ================= -->
<script>
const TVA = 0.20;
const CSV_URL = "https://raw.githubusercontent.com/stevens-cofel/configurateur-cofel/refs/heads/main/Enseigne%20drapeaux.csv";

const $ = id => document.getElementById(id);
const elForme=$("forme"), elDim=$("dimension"), elQ=$("quantite"), elPot=$("potence");
const elHT=$("prixHT"), elTTC=$("prixTTC");
const elHelpDim=$("helpDim"), elNote=$("noteForme"), elHelpFinition=$("helpFinition");

let ROWS=[], MAP=null;

function euro(n){return (isFinite(n)?n:0).toFixed(2).replace('.',',');}
function numFR(v){
  if(!v) return NaN;
  return Number(String(v).replace(',','.').replace(/[^\d.]/g,''));
}

function parseCSV(text){
  const [h,...l]=text.trim().split(/\r?\n/);
  const heads=h.split(';');
  return l.map(r=>{
    const o={}; r.split(';').forEach((v,i)=>o[heads[i]]=v); return o;
  });
}

function build(){
  const formes=[...new Set(ROWS.map(r=>r.Forme))];
  elForme.innerHTML='<option value=""></option>'+formes.map(f=>`<option>${f}</option>`).join('');
}

function compute(){
  const row=ROWS.find(r=>r.Forme===elForme.value && r.Dimension===elDim.value);
  if(!row){ elHT.textContent='0,00'; elTTC.textContent='0,00'; return; }

  let price=numFR(row.Prix);
  price*=2; // coef public

  let remise=1;
  try{
    const p=JSON.parse(localStorage.getItem('cofel_client_profile'));
    if(p?.discountRate) remise=1-p.discountRate;
  }catch{}

  const total=price*elQ.value*remise;
  elHT.textContent=euro(total);
  elTTC.textContent=euro(total*(1+TVA));
}

fetch(CSV_URL).then(r=>r.text()).then(t=>{
  ROWS=parseCSV(t);
  build();
  compute();
});

["input","change"].forEach(e=>{
  document.addEventListener(e,ev=>{
    if(ev.target.matches("select,input")) compute();
  });
});
</script>

<script src="../js/devis-core.js"></script>
<script>
document.getElementById("btnAddDevis").addEventListener("click",()=>{
  const q=Number(elQ.value||1);
  const pu=Number(elHT.textContent.replace(',','.'))/q;
  Devis.addLine({
    type:"Enseigne Drapeau",
    designation:`${elForme.value} ${elDim.value} ${elPot.value?elPot.value+' mm':''}`,
    quantite:q,
    pu_public_ht:Number(pu.toFixed(2))
  });
  alert("âœ… AjoutÃ© au devis");
});
</script>

</body>
</html>

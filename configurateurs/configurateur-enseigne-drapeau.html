<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>Configurateur ‚Äî Enseignes Drapeaux | Cofel</title>

<link rel="stylesheet" href="../styles/cofel.css">
<link rel="stylesheet" href="../styles/cofel-components.css">
<link rel="stylesheet" href="../styles/cofel-glass.css">
</head>

<body>

<header class="cofel-header">
  <div class="row">
    <a class="cofel-back" href="../index.html">‚¨Ö Retour accueil (Devis)</a>
    <div class="cofel-brand">
      <img src="../assets/logo cofel.jpg" alt="Cofel">
      <h1 class="cofel-title">Configurateur ‚Äî Enseignes Drapeaux</h1>
    </div>
  </div>
</header>

<div class="cofel-container">
  <h1>Enseigne Drapeau</h1>

  <!-- PARAM√àTRES -->
  <fieldset>
    <legend>Param√®tres</legend>
    <div class="grid">

      <div>
        <label>Forme</label>
        <select id="forme">
          <option value="">(choisir)</option>
        </select>
      </div>

      <div>
        <label>Dimension</label>
        <select id="dimension">
          <option value="">(choisir)</option>
        </select>
      </div>

      <div>
        <label>Quantit√©</label>
        <input type="number" id="quantite" min="1" value="1">
      </div>

      <div>
        <label>Longueur de potence (mm)</label>
        <input type="number" id="potence" min="0" placeholder="ex : 600">
        <div class="hint">Information indicative (sans impact tarifaire).</div>
      </div>

    </div>
  </fieldset>

  <!-- FINITION -->
  <fieldset>
    <legend>Finition</legend>
    <div class="radio-row" id="finitionRow">
      <label><input type="radio" name="finition" value="prelaque" checked> Pr√©laqu√©</label>
      <label><input type="radio" name="finition" value="laque"> Laqu√©</label>
      <label><input type="radio" name="finition" value="ajour"> Ajourage lumineux</label>
    </div>
    <div id="helpFinition" class="hint"></div>
  </fieldset>

  <!-- R√âSULTAT -->
  <div class="result">
    <p>Total HT : <b><span id="prixHT">0,00</span> ‚Ç¨</b></p>
    <p>Total TTC : <b><span id="prixTTC">0,00</span> ‚Ç¨</b></p>
  </div>

  <div style="margin-top:16px; display:flex; gap:10px; flex-wrap:wrap;">
    <button id="btnAddDevis" class="btn">‚ûï Ajouter au devis</button>
    <button id="btnReset" class="btn">üîÑ R√©initialiser</button>
  </div>
</div>

<footer class="cofel-footer">
¬© Cofel ‚Äî ZA du Perquoi, 72560 Chang√© ‚Äî SIRET 927 659 458 00024 ‚Äî TVA FR80927659458
</footer>

<script>
/* ================= CONFIG ================= */
const TVA = 0.20;
const COEF_PUBLIC = 2;
const CSV_URL = "https://raw.githubusercontent.com/stevens-cofel/configurateur-cofel/refs/heads/main/Enseigne%20drapeaux.csv";

/* ================= UTILS ================= */
const $ = id => document.getElementById(id);
const euro = n => (isFinite(n)?n:0).toFixed(2).replace('.',',');
const numFR = v => parseFloat(String(v).replace(',', '.')) || 0;
const norm = s => String(s||'').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'');

function isTruthy(v){
  const t = norm(v).trim();
  return t === "1" || t === "true" || t === "vrai" || t === "yes" || t === "oui";
}

/* ================= DOM ================= */
const elForme = $('forme');
const elDim   = $('dimension');
const elQ     = $('quantite');
const elHT    = $('prixHT');
const elTTC   = $('prixTTC');
const elHelp  = $('helpFinition');

function getFinition(){
  return document.querySelector('input[name="finition"]:checked')?.value || "prelaque";
}
function setFinition(value){
  const r = document.querySelector(`input[name="finition"][value="${value}"]`);
  if(r && !r.disabled) r.checked = true;
}

/* ================= CSV ================= */
let ROWS = [];
let MAP  = {};

function normalizeCSVText(txt){
  // Certains exports arrivent sur 1 seule ligne : on r√©ins√®re des retours ligne avant "Enseigne drapeau,..."
  if(!txt.includes('\n') && txt.includes('Enseigne drapeau')){
    txt = txt.replace(/\s+(?=Enseigne drapeau[,;])/g, '\n');
  }
  return txt;
}

function parseCSV(txt){
  txt = normalizeCSVText(txt);

  const lines = txt.split(/\r?\n/).map(l=>l.trim()).filter(l=>l);
  const sep = (lines[0] || "").includes(';') ? ';' : ',';
  const heads = (lines[0] || "").split(sep).map(h=>h.trim());

  const rows = lines.slice(1).map(l=>{
    const c = l.split(sep);
    const o = {};
    heads.forEach((h,i)=>o[h]= (c[i] ?? "").trim());
    return o;
  });

  return {heads, rows};
}

function buildMap(heads){
  const n = heads.map(norm);
  const find = (re) => {
    const idx = n.findIndex(h => re.test(h));
    return idx >= 0 ? heads[idx] : null;
  };
  return {
    FORME: find(/forme/),
    DIM:   find(/dimension/),
    FIN:   find(/finition/),
    PRIX:  find(/prix/),
    AJ:    find(/ajour|lumineux|opt_ajourage/)
  };
}

/* ================= UI ================= */
function uniqueSorted(arr){
  // tri simple : √ò400, √ò500... puis 400 x 400...
  return [...new Set(arr)].sort((a,b)=>String(a).localeCompare(String(b), 'fr', {numeric:true}));
}

function populateFormes(){
  const f = uniqueSorted(ROWS.map(r=>r[MAP.FORME]).filter(Boolean));
  elForme.innerHTML = '<option value="">(choisir)</option>' + f.map(v=>`<option>${v}</option>`).join('');
}

function populateDims(){
  const dims = uniqueSorted(
    ROWS
      .filter(r => !elForme.value || r[MAP.FORME] === elForme.value)
      .map(r => r[MAP.DIM])
      .filter(Boolean)
  );

  const current = elDim.value;
  elDim.innerHTML = '<option value="">(choisir)</option>' + dims.map(v=>`<option>${v}</option>`).join('');

  // Si la dimension courante n'existe plus, on reset
  if(current && !dims.includes(current)){
    elDim.value = '';
  }else{
    elDim.value = current;
  }
}

function finitionsDisponibles(){
  const base = ROWS.filter(r =>
    (!elForme.value || r[MAP.FORME] === elForme.value) &&
    (!elDim.value   || r[MAP.DIM]   === elDim.value)
  );

  let hasPrelaque = base.some(r => norm(r[MAP.FIN]).includes('prelaque'));
  let hasLaque    = base.some(r => norm(r[MAP.FIN]).includes('laque') && !isTruthy(r[MAP.AJ]));
  let hasAjour    = base.some(r => isTruthy(r[MAP.AJ]) || norm(r[MAP.FIN]).includes('ajour'));

  return {hasPrelaque, hasLaque, hasAjour};
}

function applyFinitionAvailability(){
  const {hasPrelaque, hasLaque, hasAjour} = finitionsDisponibles();

  const rPre = document.querySelector('input[name="finition"][value="prelaque"]');
  const rLaq = document.querySelector('input[name="finition"][value="laque"]');
  const rAjo = document.querySelector('input[name="finition"][value="ajour"]');

  if(rPre) rPre.disabled = !hasPrelaque;
  if(rLaq) rLaq.disabled = !hasLaque;
  if(rAjo) rAjo.disabled = !hasAjour;

  // Si la finition choisie n'est pas dispo (cas typique du "rond" en pr√©laqu√©), on bascule automatiquement
  const cur = getFinition();
  if((cur==='prelaque' && !hasPrelaque) || (cur==='laque' && !hasLaque) || (cur==='ajour' && !hasAjour)){
    if(hasLaque) setFinition('laque');
    else if(hasPrelaque) setFinition('prelaque');
    else if(hasAjour) setFinition('ajour');
  }

  // Message d'aide
  let msg = "";
  if(elForme.value && norm(elForme.value).includes('rond') && !hasPrelaque){
    msg = "‚ÑπÔ∏è Sur les drapeaux ronds, la finition ¬´ Pr√©laqu√© ¬ª n‚Äôest pas tarif√©e dans le CSV : passe en ¬´ Laqu√© ¬ª (ou ¬´ Ajourage lumineux ¬ª si disponible).";
  }else if(getFinition()==='ajour'){
    msg = "‚ÑπÔ∏è ¬´ Ajourage lumineux ¬ª = tarif avec option ajourage+lumineux (colonne opt_ajourage+lumineux).";
  }else{
    msg = "";
  }
  elHelp.textContent = msg;
}

/* ================= CALCUL ================= */
function findRow(){
  const finChoice = getFinition();

  return ROWS.find(r => {
    const okForme = r[MAP.FORME] === elForme.value;
    const okDim   = r[MAP.DIM]   === elDim.value;

    if(!okForme || !okDim) return false;

    const fin = norm(r[MAP.FIN]);
    const aj  = isTruthy(r[MAP.AJ]);

    if(finChoice === 'prelaque'){
      return fin.includes('prelaque') && !aj;
    }
    if(finChoice === 'laque'){
      return fin.includes('laque') && !aj && !fin.includes('ajour');
    }
    // ajour
    return aj || fin.includes('ajour') || (fin.includes('laque') && aj);
  });
}

function compute(){
  applyFinitionAvailability();

  const row = findRow();

  if(!row){
    elHT.textContent = '0,00';
    elTTC.textContent = '0,00';
    return;
  }

  let unitPublic = numFR(row[MAP.PRIX]) * COEF_PUBLIC;

  let remise = 1;
  try{
    const p = JSON.parse(localStorage.getItem('cofel_client_profile'));
    if(p?.discountRate) remise = 1 - p.discountRate;
  }catch{}

  const qte = Math.max(1, parseFloat(elQ.value) || 1);
  const total = unitPublic * qte * remise;

  elHT.textContent  = euro(total);
  elTTC.textContent = euro(total * (1 + TVA));
}

/* ================= EVENTS ================= */
elForme.addEventListener('change', ()=>{
  populateDims();
  compute();
});
elDim.addEventListener('change', compute);
elQ.addEventListener('input', compute);
document.querySelectorAll('input[name="finition"]').forEach(r => r.addEventListener('change', compute));

$('btnReset').onclick = ()=>{
  elForme.value = '';
  elDim.value   = '';
  elQ.value     = 1;
  // reset finition
  const rPre = document.querySelector('input[name="finition"][value="prelaque"]');
  if(rPre){ rPre.disabled = false; rPre.checked = true; }
  document.querySelectorAll('input[name="finition"]').forEach(r => r.disabled = false);

  populateFormes();
  populateDims();
  compute();
};

/* ================= INIT ================= */
fetch(CSV_URL, {cache:"no-store"})
  .then(r=>r.text())
  .then(t=>{
    const {heads, rows} = parseCSV(t);
    ROWS = rows;
    MAP  = buildMap(heads);

    // S√©curit√© : si une colonne manque, on √©vite de planter
    if(!MAP.FORME || !MAP.DIM || !MAP.FIN || !MAP.PRIX){
      console.error("Colonnes CSV non reconnues :", MAP, heads);
      alert("‚ö†Ô∏è CSV non reconnu (colonnes). V√©rifie l‚Äôen-t√™te du fichier.");
      return;
    }

    populateFormes();
    populateDims();
    compute();
  })
  .catch(err=>{
    console.error(err);
    alert("‚ö†Ô∏è Impossible de charger le CSV.");
  });
</script>

<script src="../js/devis-core.js"></script>
<script>
$('btnAddDevis').onclick = ()=>{
  const q = Math.max(1, parseFloat($('quantite').value) || 1);
  const ht = numFR($('prixHT').textContent);
  if(!ht){ alert("Configuration incompl√®te"); return; }

  const forme = $('forme').value;
  const dim   = $('dimension').value;
  const fin   = document.querySelector('input[name="finition"]:checked')?.value || '';
  const pot   = $('potence').value;

  const d = [
    forme,
    dim,
    fin,
    pot ? `potence ${pot} mm` : null
  ].filter(Boolean).join(' ‚Äî ');

  const pu = ht / q;

  Devis.addLine({
    id: `EDR-${Date.now()}`,
    designation: `Enseigne drapeau ‚Äî ${d}`,
    quantite: q,
    pu_net_ht: pu,
    total_ligne_ht: ht,

    // compat √©ventuelle
    type: "Enseigne Drapeau",
    pu_public_ht: pu
  });

  alert("‚úÖ Ajout√© au devis");
};
</script>


</body>
</html>


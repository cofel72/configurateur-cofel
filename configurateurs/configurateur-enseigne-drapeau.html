<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>Configurateur ‚Äî Enseignes Drapeaux | Cofel</title>

<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  
<link rel="stylesheet" href="../styles/cofel.css">
<link rel="stylesheet" href="../styles/cofel-components.css">
<link rel="stylesheet" href="../styles/cofel-glass.css">


</head>
<body>

  <!-- ===== HERO ===== -->
 <header class="cofel-header">
  <div class="row">
    <a class="cofel-back" href="../index.html">‚¨Ö Retour accueil (Devis)</a>

    <div class="cofel-brand">
      <img src="../assets/logo cofel.jpg" alt="Cofel" />
      <h1 class="cofel-title">Configurateur ‚Äî Enseignes Drapeaux</h1>
    </div>
  </div>
</header>

<div class="cofel-container">

  <main class="wrap">

    <!-- Param√®tres principaux -->
    <section class="panel" aria-label="Param√®tres">
      <h2>‚öôÔ∏è Param√®tres</h2>
      <div class="card grid">
        <div>
          <label for="forme">Forme</label>
          <select id="forme" class="native-select"><option value="">(choisir)</option></select>
          <div class="cselect" data-bind="forme" aria-haspopup="listbox" aria-expanded="false">
            <button type="button" class="cselect-toggle">
              <span class="cselect-label">(choisir)</span>
              <span class="cselect-caret" aria-hidden="true"></span>
            </button>
            <div class="cselect-menu" role="listbox"></div>
          </div>
          <div id="noteForme" class="muted"></div>
        </div>

        <div>
          <label for="dimension">Dimension</label>
          <select id="dimension" class="native-select"><option value="">(choisir la dimension)</option></select>
          <div class="cselect" data-bind="dimension" aria-haspopup="listbox" aria-expanded="false">
            <button type="button" class="cselect-toggle">
              <span class="cselect-label">(choisir la dimension)</span>
              <span class="cselect-caret" aria-hidden="true"></span>
            </button>
            <div class="cselect-menu" role="listbox"></div>
          </div>
          <div id="helpDim" class="muted"></div>
        </div>

        <div>
          <label for="quantite">Quantit√©</label>
          <input type="number" id="quantite" min="1" value="1" />
        </div>

        <!-- ‚úÖ Nouveau champ demand√© -->
        <div>
          <label for="potence">Longueur de potence (mm)</label>
          <input type="number" id="potence" min="0" step="1" placeholder="ex : 600" />
          <div class="muted">Indiquez la longueur utile de la potence en millim√®tres.</div>
        </div>
      </div>
    </section>

    <!-- Options (finition obligatoire) -->
    <section class="panel" aria-label="Options">
      <h2>üéõÔ∏è Options</h2>
      <fieldset class="card" style="border:none; padding:0;">
        <legend class="muted" style="margin-bottom:8px;">Finition (obligatoire)</legend>
        <div class="grid">
          <label class="option-item"><input type="radio" name="finition" id="finPre" value="prelaque" checked /><span>Pr√©laqu√© (base)</span></label>
          <label class="option-item"><input type="radio" name="finition" id="finLq" value="laque" /><span>Laqu√©</span></label>
          <label class="option-item"><input type="radio" name="finition" id="finAj" value="ajour" /><span>Ajourage + PMMA 3 mm + lumineux (laqu√©)</span></label>
        </div>
        <div id="helpFinition" class="muted"></div>
      </fieldset>
    </section>

    <!-- R√©cap prix -->
    <section class="panel" aria-label="R√©capitulatif">
      <h2>üßæ R√©capitulatif</h2>
      <div class="result">
        <p>Prix HT : <b><span id="prixHT">0,00</span> ‚Ç¨</b></p>
        <p>Prix TTC : <b><span id="prixTTC">0,00</span> ‚Ç¨</b></p>
        <div class="muted">TVA 20 % incluse dans le calcul.</div>
      </div>
      <div style="margin-top:16px; display:flex; gap:10px; flex-wrap:wrap;">
        <button id="btnAddDevis" class="btn">‚ûï Ajouter au devis</button>
        <button id="btnReset" class="btn btn-ghost">üîÑ R√©initialiser</button>
      </div>
    </section>

  </main>
</div> <!-- fin cofel-container -->

  <footer>
    ¬© Cofel ‚Äî ZA du Perquoi, 72560 Chang√© ‚Äî SIRET 927 659 458 00024 ‚Äî TVA FR80927659458
  </footer>

  <!-- ===== LOGIQUE (inchang√©e sauf reset + d√©signation) ===== -->
  <script>
  const TVA = 0.20;
  const CSV_URL = "https://raw.githubusercontent.com/stevens-cofel/configurateur-cofel/refs/heads/main/Enseigne%20drapeaux.csv";

  let HEADS=[], ROWS=[], MAP=null;
  const $ = id=>document.getElementById(id);
  const elForme=$("forme"), elQ=$("quantite"), elDim=$("dimension"), elPot=$("potence");
  const elFinPre=$("finPre"), elFinLq=$("finLq"), elFinAj=$("finAj");
  const elHT=$("prixHT"), elTTC=$("prixTTC");
  const elHelpDim=$("helpDim"), elNote=$("noteForme"), elHelpFinition=$("helpFinition");

  function normKey(k){ return String(k||'').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[^a-z0-9+]+/g,'').trim(); }
  function numFR(v){ if(v==null) return NaN; let s=String(v).trim().replace(/‚Ç¨/g,'').replace(/[\u00A0\u202F]/g,'').replace(/\s+/g,''); if(s.includes(',') && s.includes('.')) s=s.replace(/\./g,''); s=s.replace(',', '.'); const m=s.match(/-?\d+(\.\d+)?/); return m?parseFloat(m[0]):NaN; }
  function euro(n){ return (isFinite(n)?n:0).toFixed(2).replace('.', ','); }

  function parseCSVAuto(text){
    const raw = String(text || "").replace(/^\uFEFF/, "");
    const lines = raw.split(/\r\n|\n|\r/).filter(l => l.trim() !== "");
    if (!lines.length) return { rawHeads: [], rows: [] };
    const first = lines[0];
    const sep = ((first.match(/;/g) || []).length > (first.match(/,/g) || []).length) ? ';' : ',';
    function parseCSVLine(line){
      const out=[]; let cur=''; let inQ=false;
      for(let i=0;i<line.length;i++){
        const ch=line[i], nx=line[i+1];
        if(ch === '"'){
          if(inQ && nx === '"'){ cur+='"'; i++; } else { inQ = !inQ; }
        } else if(ch === sep && !inQ){ out.push(cur); cur=''; }
        else cur += ch;
      }
      out.push(cur); return out;
    }
    const rawHeads = parseCSVLine(first).map(s => s.replace(/^"+|"+$/g,'').trim());
    const rows = lines.slice(1).map(line => {
      const cells = parseCSVLine(line).map(s => s.replace(/^"+|"+$/g,'').trim());
      const o = {}; rawHeads.forEach((h,i)=> o[h] = cells[i] ?? '');
      return o;
    });
    return { rawHeads, rows };
  }

  function buildMapping(rawHeads){
    const nk=rawHeads.map(normKey);
    const find=(k)=>{ const i=nk.indexOf(k); return i>=0?rawHeads[i]:null; };
    const like=(...res)=>{ for(let i=0;i<nk.length;i++){ const k=nk[i]; if(res.every(re=>re.test(k))) return rawHeads[i]; } return null; };
    const FORME=find('forme')||like(/forme/);
    const DIM=find('dimensionmm')||like(/dimension|dim/);
    const FIN=find('finition')||like(/fini/);
    const PRIX=find('prixeurl')||like(/prix|eur/);
    const OPTAJL=find('opt_ajourage+lumineux')||like(/ajour|lum/);
    return {FORME,DIM,FIN,PRIX,OPTAJL};
  }

  function distinct(v){return [...new Set(v)]}

  /* ===== Custom Select ===== */
  const customSelects = new Map();
  function buildCustomFromNative(native){
    const wrap = document.querySelector('.cselect[data-bind="'+native.id+'"]'); if(!wrap) return;
    const toggle = wrap.querySelector('.cselect-toggle');
    const labelSpan = wrap.querySelector('.cselect-label');
    const menu = wrap.querySelector('.cselect-menu');
    menu.innerHTML = '';
    Array.from(native.options).forEach(opt=>{
      const div=document.createElement('div');
      div.className='cselect-option'; div.setAttribute('role','option'); div.tabIndex=-1;
      div.dataset.value=opt.value; div.textContent=opt.textContent;
      if(opt.selected) div.setAttribute('aria-selected','true');
      div.addEventListener('click', ()=>{ setNativeValue(native, opt.value); closeMenu(native.id); });
      div.addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' '){ e.preventDefault(); setNativeValue(native, opt.value); closeMenu(native.id); } });
      menu.appendChild(div);
    });
    labelSpan.textContent = (native.selectedOptions[0] || native.options[0])?.textContent || '';
    toggle.onclick = ()=> { const expanded = wrap.getAttribute('aria-expanded')==='true'; expanded ? closeMenu(native.id) : openMenu(native.id); };
    toggle.onkeydown = (e)=>{
      const expanded = wrap.getAttribute('aria-expanded')==='true';
      if((e.key==='ArrowDown' || e.key==='ArrowUp') && !expanded){ e.preventDefault(); openMenu(native.id); (menu.querySelector('.cselect-option')||{}).focus?.(); }
      else if(e.key==='Enter' || e.key===' '){ e.preventDefault(); toggle.click(); }
      else if(e.key==='Escape' && expanded){ closeMenu(native.id); }
    };
    customSelects.set(native.id, { wrap, toggle, labelSpan, menu, native });
  }
  function setNativeValue(native, val){
    if(native.value !== val){ native.value = val; native.dispatchEvent(new Event('change', { bubbles:true })); }
    const api = customSelects.get(native.id);
    if(api){
      api.labelSpan.textContent = native.selectedOptions[0]?.textContent || '';
      Array.from(api.menu.children).forEach(n=>{ if(n.classList.contains('cselect-option')) n.setAttribute('aria-selected', n.dataset.value===val ? 'true' : 'false'); });
    }
  }
  function openMenu(id){
    const api = customSelects.get(id); if(!api) return;
    const {wrap, toggle, menu} = api;
    wrap.setAttribute('aria-expanded','true');
    const r = toggle.getBoundingClientRect();
    menu.style.left = Math.round(r.left) + 'px';
    menu.style.top  = Math.round(r.bottom + 6) + 'px';
    menu.style.width= Math.round(r.width) + 'px';
    if(menu.parentElement !== document.body){ document.body.appendChild(menu); }
    menu.style.display = 'block';
    const onViewport = ()=> closeMenu(id);
    const onDocClick = (e)=>{ if(!wrap.contains(e.target) && !menu.contains(e.target)) closeMenu(id); };
    window.addEventListener('scroll', onViewport, {passive:true});
    window.addEventListener('resize', onViewport);
    document.addEventListener('click', onDocClick);
    api.__off = ()=>{ window.removeEventListener('scroll', onViewport); window.removeEventListener('resize', onViewport); document.removeEventListener('click', onDocClick); };
  }
  function closeMenu(id){
    const api = customSelects.get(id); if(!api) return;
    const {wrap, menu, __off} = api;
    wrap.setAttribute('aria-expanded','false');
    menu.style.display = 'none';
    if(menu.parentElement !== wrap){ wrap.appendChild(menu); }
    if(typeof __off === 'function') __off();
    api.toggle.focus();
  }
  function rebuildCustom(native){ buildCustomFromNative(native); }

  /* ===== UI data ===== */
  function populateFormes(){
    const formes = distinct(ROWS.map(r=>String(r[MAP.FORME]||'').toLowerCase()).filter(Boolean)).sort((a,b)=>a.localeCompare(b));
    elForme.innerHTML='<option value="">(choisir)</option>';
    formes.forEach(v=> elForme.innerHTML+=`<option value="${v}">${v}</option>`);
    elNote.textContent = formes.length ? '' : 'Aucune forme disponible dans le CSV.';
    rebuildCustom(elForme);
  }
  function getFinition(){ if(elFinAj.checked) return 'ajour'; if(elFinLq.checked) return 'laque'; return 'prelaque'; }
  function setFinition(val){ elFinPre.checked = (val==='prelaque'); elFinLq.checked  = (val==='laque'); elFinAj.checked  = (val==='ajour'); }
  function filteredPool(){
    let pool=[...ROWS];
    if(elForme.value) pool=pool.filter(r=>String(r[MAP.FORME]).toLowerCase()===elForme.value);
    const fin=r=>String(r[MAP.FIN]).trim().toLowerCase();
    const opt=r=>String(r[MAP.OPTAJL]).trim().toLowerCase();
    const finSel = getFinition();
    if(elForme.value==='carr√©'){
      if(finSel==='ajour'){ pool=pool.filter(r=>opt(r)==='vrai' && fin(r)==='laqu√©'); }
      else if(finSel==='laque'){ pool=pool.filter(r=>fin(r)==='laqu√©' && opt(r)!=='vrai'); }
      else { pool=pool.filter(r=>fin(r)==='pr√©laqu√©' && opt(r)!=='vrai'); }
    } else if(elForme.value==='rond'){
      if(finSel==='ajour'){ pool=pool.filter(r=>fin(r)==='laqu√©' && opt(r)==='vrai'); }
      else { pool=pool.filter(r=>fin(r)==='laqu√©' && opt(r)!=='vrai'); }
    } else {
      if(finSel==='ajour') pool=pool.filter(r=>opt(r)==='vrai');
      else if(finSel==='laque') pool=pool.filter(r=>fin(r)==='laqu√©' && opt(r)!=='vrai');
      else pool=pool.filter(r=>fin(r)==='pr√©laqu√©' && opt(r)!=='vrai');
    }
    return pool;
  }
  function populateDimensions(){
    const prev = elDim.value;               
    const pool = filteredPool();
    const dims = distinct(pool.map(r => String(r[MAP.DIM] || '').trim()).filter(Boolean)).sort((a,b)=>a.localeCompare(b,'fr',{numeric:true}));
    let html = '<option value="">(choisir la dimension)</option>';
    for(const v of dims){ const selected = (v === prev) ? ' selected' : ''; html += `<option value="${v}"${selected}>${v}</option>`; }
    elDim.innerHTML = html;
    if (prev && !dims.includes(prev)) { elDim.value = ""; }
    elHelpDim.textContent = dims.length ? `Dimensions dispo : ${dims.slice(0,10).join(' ‚Ä¢ ')}${dims.length>10?' ‚Ä¶':''}` : '';
    rebuildCustom(elDim);
  }
  function findRow(){ const pool=filteredPool(); if(!pool.length) return null; if(elDim.value) return pool.find(r=>String(r[MAP.DIM]).trim()===elDim.value) || null; return pool[0]; }
  function syncFinitionUI(){
    if(elForme.value==='rond'){
      elFinPre.disabled = true; if(elFinPre.checked){ setFinition('laque'); }
      elHelpFinition.textContent = 'Pour les drapeaux ronds, la finition est toujours laqu√©e (ajourage possible si dispo).';
    } else { elFinPre.disabled = false; elHelpFinition.textContent = ''; }
  }
function compute(){

  // === Synchronisation UI finition ===
  syncFinitionUI();

  const row = findRow();
  const Q = Math.max(1, Number(elQ.value || 1));

  if (!row) {
    elHT.textContent = '0,00';
    elTTC.textContent = '0,00';
    return;
  }

  // === Prix interne issu du CSV ===
let unit_interne = numFR(row[MAP.PRIX]);
if (!isFinite(unit_interne)) unit_interne = 0;

// === Coefficient tarif public Cofel ===
const COEF_PUBLIC = 2;

// === Prix public de base ===
const unit_public = unit_interne * COEF_PUBLIC;

// === Remise client automatique (si profil connect√©) ===
let remiseClient = 1;
try {
  const profile = JSON.parse(localStorage.getItem('cofel_client_profile'));
  if (profile && typeof profile.discountRate === 'number') {
    remiseClient = 1 - profile.discountRate;
  }
} catch(e){}

// === PRIX NET CLIENT FINAL ===
const unit_net = unit_public * remiseClient;


  const totalHT  = unit_net * Q;
  const totalTTC = totalHT * (1 + TVA);

  // === Affichage ===
  elHT.textContent  = euro(totalHT);
  elTTC.textContent = euro(totalTTC);
}


  async function loadCSV(){
    try{ const r=await fetch(CSV_URL,{cache:'no-store'}); const txt=await r.text(); const {rawHeads,rows}=parseCSVAuto(txt); HEADS=rawHeads; ROWS=rows; MAP=buildMapping(HEADS); populateFormes(); populateDimensions(); compute(); }
    catch(e){ console.error(e); alert("Erreur lors du chargement des donn√©es. R√©essayez plus tard."); }
  }
  ["input","change"].forEach(evt=>{
    [elForme, elQ, elDim, elFinPre, elFinLq, elFinAj].forEach(el=>{
      el.addEventListener(evt, e=>{ if(e.target===elForme || e.target===elFinPre || e.target===elFinLq || e.target===elFinAj){ populateDimensions(); } compute(); });
    });
  });
  function resetAll(){ elForme.value=""; elDim.value=""; elQ.value=1; if(elPot) elPot.value=""; setFinition('prelaque'); populateFormes(); populateDimensions(); compute(); }
  buildCustomFromNative(elForme); buildCustomFromNative(elDim);
  document.getElementById("btnReset")?.addEventListener("click", resetAll);
  loadCSV();

  /* Tests rapides (masqu√©s visuellement) */
  (function runUnitTests(){
    const status = document.getElementById('testStatus');
    const prev = {HEADS, ROWS, MAP};
    try{
      const heads=["Forme","Dimension (mm)","Finition","Prix EUR l.","Opt_Ajourage + lumineux"];
      const rows=[
        {"Forme":"carr√©","Dimension (mm)":"400x400","Finition":"pr√©laqu√©","Prix EUR l.":"100","Opt_Ajourage + lumineux":"faux"},
        {"Forme":"carr√©","Dimension (mm)":"400x400","Finition":"laqu√©","Prix EUR l.":"120","Opt_Ajourage + lumineux":"faux"},
        {"Forme":"carr√©","Dimension (mm)":"500x500","Finition":"laqu√©","Prix EUR l.":"150","Opt_Ajourage + lumineux":"vrai"},
        {"Forme":"rond","Dimension (mm)":"√ò400","Finition":"laqu√©","Prix EUR l.":"130","Opt_Ajourage + lumineux":"faux"},
        {"Forme":"rond","Dimension (mm)":"√ò500","Finition":"laqu√©","Prix EUR l.":"160","Opt_Ajourage + lumineux":"vrai"}
      ];
      HEADS=heads; ROWS=rows; MAP=buildMapping(heads);
      elForme.value='carr√©'; setFinition('prelaque'); let p=filteredPool(); console.assert(p.length===1 && p[0][MAP.FIN]==='pr√©laqu√©', 'Test1');
      setFinition('ajour'); p=filteredPool(); console.assert(p.length===1 && p[0][MAP.OPTAJL]==='vrai' && p[0][MAP.FIN]==='laqu√©', 'Test2');
      elForme.value='rond'; setFinition('prelaque'); p=filteredPool(); console.assert(p.every(r=>r[MAP.FIN]==='laqu√©'), 'Test3');
      elDim.value='400x400'; setFinition('laque'); elQ.value=2; p=filteredPool(); const row=p.find(r=>String(r[MAP.DIM]).trim()==='400x400'); let unit=numFR(row[MAP.PRIX]); const totalHT = unit * 2;console.assert(totalHT===480, 'Test4');
      status.textContent='';
    }catch(err){ console.warn('Tests error', err); if(status) status.textContent='‚ö† tests partiels'; }
    finally{ HEADS=prev.HEADS; ROWS=prev.ROWS; MAP=prev.MAP; elForme.value=""; elDim.value=""; elQ.value=1; setFinition('prelaque'); }
  })();
  </script>

  <!-- Moteur de devis -->
  <script src="../js/devis-core.js"></script>
  <script>
  document.getElementById("btnAddDevis").addEventListener("click", () => {
    const quantite = Math.max(1, Number(document.getElementById("quantite").value || 1));
    const prixTotalText = document.getElementById("prixHT").innerText.trim();
    const total_ht = parseFloat(prixTotalText.replace(",", ".")) || 0;
    const pu_public_ht = total_ht / quantite;
    const designationParts = [];
    const formeVal = document.getElementById("forme").value || "";
    const dimVal = document.getElementById("dimension").value || "";
    const potVal = (document.getElementById('potence')?.value || '').trim();
    if(formeVal) designationParts.push(formeVal);
    if(dimVal) designationParts.push(dimVal);
    if(potVal) designationParts.push(`potence ${potVal} mm`);
    const finSel = (document.getElementById('finAj').checked ? 'ajour' : (document.getElementById('finLq').checked ? 'laque' : 'prelaque'));
    if(finSel==='ajour') designationParts.push('ajourage lumineux laqu√©');
    else if(finSel==='laque') designationParts.push('laqu√©');
    else designationParts.push('pr√©laqu√©');
    const designation = "Enseigne Drapeau" + (designationParts.length ? " ‚Äî " + designationParts.join(" / ") : "");
    Devis.addLine({ type: "Enseigne Drapeau", designation, quantite, pu_public_ht });
    alert(`‚úÖ Ajout√© au devis !\n${designation}\nQt√© : ${quantite}\nPU HT : ${pu_public_ht.toFixed(2)} ‚Ç¨`);
  });
  </script>

</body>
</html>






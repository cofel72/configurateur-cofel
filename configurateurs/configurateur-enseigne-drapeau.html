<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>Configurateur ‚Äî Enseignes Drapeaux | Cofel</title>

<link rel="stylesheet" href="../styles/cofel.css">
<link rel="stylesheet" href="../styles/cofel-components.css">
<link rel="stylesheet" href="../styles/cofel-glass.css">
<link rel="stylesheet" href="/styles/cofel-theme-apple-dark.css">

<style>
  /* s√©curit√© si .hidden n'existe pas dans tes CSS */
  .hidden{ display:none !important; }

  /* Bouton RAL (style ‚Äúpastille‚Äù comme T√¥le Tablette) */
  .ral-btn{
    display:inline-flex;
    align-items:center;
    gap:10px;
    padding:10px 12px;
    border:1px solid var(--glass-hr, rgba(255,255,255,.18));
    border-radius:14px;
    background:var(--glass, rgba(255,255,255,.06));
    color:var(--txt, #fff);
    user-select:none;
    white-space:nowrap;
    cursor:pointer;
  }
  .ral-btn:hover{ filter:brightness(1.12); }
  .ral-btn:disabled{
    opacity:.45;
    cursor:not-allowed;
    filter:none;
  }

  /* Modal */
  html.ral-lock, body.ral-lock{ overflow:hidden; }

  .ral-modal{
    position:fixed;
    inset:0;
    z-index:9999;
    display:flex;
    align-items:center;
    justify-content:center;
    padding:14px;
  }
  .ral-backdrop{
    position:absolute;
    inset:0;
    background:rgba(0,0,0,.65);
    backdrop-filter: blur(10px);
  }
  .ral-card{
    position:relative;
    width:min(980px, calc(100vw - 24px));
    max-height:calc(100vh - 24px);
    overflow:hidden;
    border-radius:18px;
    border:1px solid var(--glass-hr, rgba(255,255,255,.18));
    background:rgba(18,18,18,.86);
    box-shadow: 0 12px 35px rgba(0,0,0,.55);
    display:flex;
    flex-direction:column;
  }
  .ral-head{
    display:flex;
    justify-content:space-between;
    gap:12px;
    padding:14px 14px 10px;
    border-bottom:1px solid var(--glass-hr, rgba(255,255,255,.12));
  }
  .ral-title{
    font-weight:700;
    font-size:16px;
    line-height:1.2;
  }
  .ral-sub{
    margin-top:4px;
    font-size:13px;
    color:var(--txt-dim, rgba(255,255,255,.72));
  }
  .ral-close{
    background:transparent;
    border:1px solid var(--glass-hr, rgba(255,255,255,.18));
    border-radius:12px;
    color:var(--txt, #fff);
    padding:8px 10px;
    cursor:pointer;
  }

  .ral-toolbar{
    display:flex;
    gap:10px;
    padding:12px 14px;
    align-items:center;
    border-bottom:1px solid var(--glass-hr, rgba(255,255,255,.12));
    flex-wrap:wrap;
  }
  .ral-tabs{
    display:flex;
    gap:8px;
  }
  .ral-tab{
    padding:8px 10px;
    border-radius:12px;
    border:1px solid var(--glass-hr, rgba(255,255,255,.18));
    background:transparent;
    color:var(--txt, #fff);
    cursor:pointer;
  }
  .ral-tab.is-active{
    background:rgba(255,255,255,.08);
  }
  .ral-search{
    flex:1;
    min-width:220px;
    padding:10px 12px;
    border-radius:12px;
    border:1px solid var(--glass-hr, rgba(255,255,255,.18));
    background:rgba(255,255,255,.06);
    color:var(--txt, #fff);
    outline:none;
  }

  .ral-content{
    padding:14px;
    overflow:auto;
  }
  .ral-group{
    margin-bottom:14px;
    padding:12px;
    border-radius:16px;
    background:rgba(255,255,255,.04);
    border:1px solid rgba(255,255,255,.08);
  }
  .ral-group h3{
    margin:0 0 10px 0;
    font-size:14px;
    color:var(--txt, #fff);
  }
  .ral-grid{
    display:flex;
    flex-wrap:wrap;
    gap:8px;
  }
  .ral-chip{
    padding:8px 10px;
    border-radius:999px;
    border:1px solid rgba(255,255,255,.18);
    background:rgba(255,255,255,.06);
    color:var(--txt, #fff);
    cursor:pointer;
  }
  .ral-chip:hover{ filter:brightness(1.12); }

  .ral-empty{
    padding:16px;
    color:var(--txt-dim, rgba(255,255,255,.72));
  }

  .ral-foot{
    padding:10px 14px 14px;
    border-top:1px solid var(--glass-hr, rgba(255,255,255,.12));
  }
  .ral-toast{
    font-size:13px;
    color:var(--txt, #fff);
    min-height:18px;
    margin-bottom:6px;
  }
  .ral-note{
    font-size:12px;
    color:var(--txt-dim, rgba(255,255,255,.72));
  }
</style>

</head>

<body>

<header class="cofel-header">
  <div class="row">
    <a class="cofel-back" href="../index.html">‚¨Ö Retour accueil (Devis)</a>
    <div class="cofel-brand">
      <img src="../assets/logo cofel.jpg" alt="Cofel">
      <h1 class="cofel-title">Configurateur ‚Äî Enseignes Drapeaux</h1>
    </div>
  </div>
</header>

<div class="cofel-container">
  <h1>Enseigne Drapeau</h1>

  <!-- PARAM√àTRES -->
  <fieldset>
    <legend>Param√®tres</legend>
    <div class="grid">

      <div>
        <label>Forme</label>
        <select id="forme">
          <option value="">(choisir)</option>
        </select>
      </div>

      <div>
        <label>Dimension</label>
        <select id="dimension">
          <option value="">(choisir)</option>
        </select>
      </div>

      <div>
        <label>Quantit√©</label>
        <input type="number" id="quantite" min="1" value="1">
      </div>

      <div>
        <label>Longueur de potence (mm)</label>
        <input type="number" id="potence" min="0" placeholder="ex : 600">
        <div class="hint">Information indicative (sans impact tarifaire).</div>
      </div>

    </div>
  </fieldset>

  <!-- FINITION -->
  <fieldset>
    <legend>Finition</legend>

    <div class="grid">
      <div>
        <div class="radio-row" id="finitionRow">
          <label><input type="radio" name="finition" value="prelaque" checked> Pr√©laqu√©</label>
          <label><input type="radio" name="finition" value="laque"> Laqu√©</label>
          <label><input type="radio" name="finition" value="ajour"> Faces Aluminium 20/10√®me laqu√©es + ajourage + PMMA 3 mm coll√© au dos + lumineux</label>
          <label><input type="radio" name="finition" value="pmma_df"> Double face PMMA lumineux</label>
        </div>
        <div id="helpFinition" class="hint"></div>
      </div>

      <!-- ‚úÖ Bouton RAL (comme T√¥le Tablette) -->
      <div style="display:flex;justify-content:flex-end;align-items:flex-start;">
        <button type="button" id="btnRal" class="ral-btn" aria-haspopup="dialog">
          üé® RAL disponibles (pr√©-laqu√©)
        </button>
      </div>
    </div>
  </fieldset>

  <!-- R√âSULTAT -->
  <div class="result">
    <p>Total HT : <b><span id="prixHT">0,00</span> ‚Ç¨</b></p>
    <p>Total TTC : <b><span id="prixTTC">0,00</span> ‚Ç¨</b></p>
  </div>

  <div style="margin-top:16px; display:flex; gap:10px; flex-wrap:wrap;">
    <button id="btnAddDevis" class="btn">‚ûï Ajouter au devis</button>
    <button id="btnReset" class="btn">üîÑ R√©initialiser</button>
  </div>
</div>

<footer class="cofel-footer">
¬© Cofel ‚Äî ZA du Perquoi, 72560 Chang√© ‚Äî SIRET 927 659 458 00024 ‚Äî TVA FR80927659458
</footer>

<!-- ‚úÖ POPUP RAL (identique √† T√¥le Tablette) -->
<div id="ralModal" class="ral-modal hidden" role="dialog" aria-modal="true" aria-labelledby="ralTitle">
  <div class="ral-backdrop" data-close="1"></div>

  <div class="ral-card">
    <div class="ral-head">
      <div>
        <div id="ralTitle" class="ral-title">RAL disponibles ‚Äî T√¥le aluminium 15/10 pr√©-laqu√©e</div>
        <div class="ral-sub">Format 3000 √ó 1500 ‚Ä¢ Satin√© / Brillante ‚Ä¢ Clique un RAL pour le copier</div>
      </div>
      <button type="button" id="ralClose" class="ral-close" aria-label="Fermer">‚úï</button>
    </div>

    <div class="ral-toolbar">
      <div class="ral-tabs" role="tablist" aria-label="Finition">
        <button type="button" class="ral-tab is-active" data-finish="satine" role="tab" aria-selected="true">Satin√©</button>
        <button type="button" class="ral-tab" data-finish="brillante" role="tab" aria-selected="false">Brillante</button>
      </div>
      <input id="ralSearch" class="ral-search" type="text" placeholder="Rechercher : 7016, gris, noir, bleu‚Ä¶" />
    </div>

    <div id="ralContent" class="ral-content"></div>

    <div class="ral-foot">
      <div id="ralToast" class="ral-toast" aria-live="polite"></div>
      <div class="ral-note">R√©f√©rence indicative : valider la teinte finale avec un nuancier officiel RAL / √©chantillon mati√®re.</div>
    </div>
  </div>
</div>

<script>
/* ================= CONFIG ================= */
const TVA = 0.20;
const COEF_PUBLIC = 2;
const CSV_URL = "https://raw.githubusercontent.com/stevens-cofel/configurateur-cofel/refs/heads/main/Enseigne%20drapeaux.csv";

/* ‚úÖ AJOUT DIMENSIONS 700 (auto) : +102 ‚Ç¨ PUBLIC par rapport √† 600, donc + (102/COEF_PUBLIC) sur le prix CSV */
const DELTA_PUBLIC_700_FROM_600 = 102;
const DELTA_CSV_700_FROM_600 = DELTA_PUBLIC_700_FROM_600 / COEF_PUBLIC;

/* ================= UTILS ================= */
const $ = id => document.getElementById(id);
const euro = n => (isFinite(n)?n:0).toFixed(2).replace('.',',');
const numFR = v => parseFloat(String(v).replace(',', '.')) || 0;
const norm = s => String(s||'').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'');

function isTruthy(v){
  const t = norm(v).trim();
  return t === "1" || t === "true" || t === "vrai" || t === "yes" || t === "oui";
}

/* ================= DOM ================= */
const elForme = $('forme');
const elDim   = $('dimension');
const elQ     = $('quantite');
const elHT    = $('prixHT');
const elTTC   = $('prixTTC');
const elHelp  = $('helpFinition');

function getFinition(){
  return document.querySelector('input[name="finition"]:checked')?.value || "prelaque";
}
function setFinition(value){
  const r = document.querySelector(`input[name="finition"][value="${value}"]`);
  if(r && !r.disabled) r.checked = true;
}
function getFinitionLabel(v = getFinition()){
  switch(v){
    case "prelaque": return "Pr√©laqu√©";
    case "laque":    return "Laqu√©";
    case "ajour":    return "Faces Aluminium 20/10√®me laqu√©es + ajourage + PMMA 3 mm coll√© au dos + lumineux";
    case "pmma_df":  return "Double face PMMA lumineux";
    default:         return v || "";
  }
}

/* ==========================
   POPUP RAL (identique √† T√¥le Tablette)
   ========================== */
const RAL_DATA = {
  satine: {
    "Blanc cass√©": ["1013"],
    "Blanc": ["9001","9002","9003","9018"],
    "Noir": ["9004","9005","9011"],
    "Gris": ["7001","7003","7004","7005","7006","7010","7011","7012","7013","7015","7016","7021","7022","7023","7024","7030","7031","7032","7033","7035","7036","7037","7038","7039","7040","7042","7043","7044","7046","7047"],
    "Brun": ["1247","8003","8004","8011","8012","8014","8016","8017","8019","8022","8025","8028"],
    "Vert": ["6005","6006","6019","6021"],
    "Ivoire": ["1014","1015"],
    "Beige": ["1001","1019"],
    "Rouge": ["3003","3004","3009","3011","3012"],
    "Bleu": ["5003","5008","5009","5014"]
  },
  brillante: {
    "Blanc": ["9001","9002","9003"],
    "Noir": ["9005"],
    "Gris": ["7001","7005","7006","7010","7011","7012","7015","7016","7021","7022","7024","7030","7031","7032","7035","7036","7037","7038","7039","7040","7042","7043","7047"],
    "Brun": ["8011","8014","8017","8019"],
    "Vert": ["6005","6021"],
    "Ivoire": ["1013","1015"],
    "Galet": ["9660"],
    "Jaune": ["1023"],
    "Rouge": ["3002","3003","3004","3020"],
    "Bleu": ["5002","5010","5017"]
  }
};

let ralFinish = "satine";
let ralToastTimer = null;

function setRalToast(msg){
  const el = document.getElementById("ralToast");
  if(!el) return;
  el.textContent = msg || "";
  clearTimeout(ralToastTimer);
  if(msg){
    ralToastTimer = setTimeout(()=>{ el.textContent=""; }, 1200);
  }
}

function renderRal(){
  const cont = document.getElementById("ralContent");
  if(!cont) return;

  const q = norm((document.getElementById("ralSearch")?.value || "").trim());
  cont.innerHTML = "";

  const groups = RAL_DATA[ralFinish] || {};
  let any = false;

  Object.entries(groups).forEach(([family, codes])=>{
    const famNorm = norm(family);
    const filtered = codes.filter(code=>{
      if(!q) return true;
      const codeStr = String(code);
      return famNorm.includes(q) || codeStr.includes(q) || (`ral ${codeStr}`).includes(q);
    });

    if(!filtered.length) return;
    any = true;

    const sec = document.createElement("section");
    sec.className = "ral-group";
    sec.innerHTML = `<h3>${family}</h3>`;

    const grid = document.createElement("div");
    grid.className = "ral-grid";

    filtered.forEach(code=>{
      const b = document.createElement("button");
      b.type = "button";
      b.className = "ral-chip";
      b.dataset.code = String(code);
      b.textContent = `RAL ${code}`;
      grid.appendChild(b);
    });

    sec.appendChild(grid);
    cont.appendChild(sec);
  });

  if(!any){
    cont.innerHTML = `<div class="ral-empty">Aucun r√©sultat pour cette recherche.</div>`;
  }
}

function openRalModal(){
  const modal = document.getElementById("ralModal");
  if(!modal) return;
  modal.classList.remove("hidden");
  document.documentElement.classList.add("ral-lock");
  document.body.classList.add("ral-lock");

  const s = document.getElementById("ralSearch");
  if(s){ s.value = ""; }

  renderRal();
  setRalToast("");
  setTimeout(()=>{ document.getElementById("ralSearch")?.focus(); }, 50);
}

function closeRalModal(){
  const modal = document.getElementById("ralModal");
  if(!modal) return;
  modal.classList.add("hidden");
  document.documentElement.classList.remove("ral-lock");
  document.body.classList.remove("ral-lock");
  setRalToast("");
}

function updateRalBtn(){
  const btn = document.getElementById("btnRal");
  if(!btn) return;

  const fin = getFinition();
  const rPre = document.querySelector('input[name="finition"][value="prelaque"]');
  const preAvailable = rPre ? !rPre.disabled : true;

  const enabled = (fin === "prelaque") && preAvailable;
  btn.disabled = !enabled;
  btn.title = enabled
    ? "Voir les RAL disponibles en t√¥le pr√©-laqu√©e"
    : "Disponible uniquement si la finition s√©lectionn√©e est : Pr√©laqu√©";
}

function initRalModal(){
  const btn = document.getElementById("btnRal");
  const modal = document.getElementById("ralModal");
  const closeBtn = document.getElementById("ralClose");

  if(btn){
    btn.addEventListener("click", ()=>{
      if(btn.disabled) return;
      openRalModal();
    });
  }

  if(closeBtn) closeBtn.addEventListener("click", closeRalModal);

  if(modal){
    modal.addEventListener("click", (e)=>{
      const t = e.target;
      if(t && t.dataset && t.dataset.close === "1") closeRalModal();
    });
  }

  document.addEventListener("keydown", (e)=>{
    if(e.key === "Escape"){
      const m = document.getElementById("ralModal");
      if(m && !m.classList.contains("hidden")) closeRalModal();
    }
  });

  // Tabs
  document.querySelectorAll(".ral-tab").forEach(tab=>{
    tab.addEventListener("click", ()=>{
      document.querySelectorAll(".ral-tab").forEach(x=>{
        x.classList.remove("is-active");
        x.setAttribute("aria-selected","false");
      });
      tab.classList.add("is-active");
      tab.setAttribute("aria-selected","true");
      ralFinish = tab.dataset.finish || "satine";
      renderRal();
    });
  });

  // Search
  document.getElementById("ralSearch")?.addEventListener("input", renderRal);

  // Click chip => copie
  document.getElementById("ralContent")?.addEventListener("click", async (e)=>{
    const chip = e.target?.closest?.(".ral-chip");
    if(!chip) return;
    const txt = chip.textContent || "";
    try{
      await navigator.clipboard.writeText(txt);
      setRalToast(`‚úÖ ${txt} copi√©`);
    }catch(err){
      window.prompt("Copie ce RAL :", txt);
    }
  });

  updateRalBtn();
}

/* ================= CSV ================= */
let ROWS = [];
let MAP  = {};

function normalizeCSVText(txt){
  // Certains exports arrivent sur 1 seule ligne : on r√©ins√®re des retours ligne avant "Enseigne drapeau,..."
  if(!txt.includes('\n') && txt.includes('Enseigne drapeau')){
    txt = txt.replace(/\s+(?=Enseigne drapeau[,;])/g, '\n');
  }
  return txt;
}

function parseCSV(txt){
  txt = normalizeCSVText(txt);

  const lines = txt.split(/\r?\n/).map(l=>l.trim()).filter(l=>l);
  const sep = (lines[0] || "").includes(';') ? ';' : ',';
  const heads = (lines[0] || "").split(sep).map(h=>h.trim());

  const rows = lines.slice(1).map(l=>{
    const c = l.split(sep);
    const o = {};
    heads.forEach((h,i)=>o[h]= (c[i] ?? "").trim());
    return o;
  });

  return {heads, rows};
}

function buildMap(heads){
  const n = heads.map(norm);
  const find = (re) => {
    const idx = n.findIndex(h => re.test(h));
    return idx >= 0 ? heads[idx] : null;
  };
  return {
    FORME: find(/forme/),
    DIM:   find(/dimension/),
    FIN:   find(/finition/),
    PRIX:  find(/prix/),
    AJ:    find(/ajour|lumineux|opt_ajourage/)
  };
}

/* ‚úÖ Injection automatique des tailles 700 √† partir des lignes 600 (+102‚Ç¨ public) */
function injectSize700From600(){
  if(!MAP?.FORME || !MAP?.DIM || !MAP?.FIN || !MAP?.PRIX) return;

  const hasKey = (forme, dim, fin, aj) => {
    const key = `${forme}||${dim}||${fin}||${String(aj ?? "")}`;
    return existing.has(key);
  };

  const existing = new Set(
    ROWS.map(r => `${r[MAP.FORME]}||${r[MAP.DIM]}||${r[MAP.FIN]}||${String(r[MAP.AJ] ?? "")}`)
  );

  function isSquareDim600(dim){
    const m = String(dim||"").match(/(\d+)\s*[x√ó]\s*(\d+)/i);
    if(!m) return false;
    return Number(m[1]) === 600 && Number(m[2]) === 600;
  }
  function isRoundDim600(dim, formeNorm){
    // Rond : pas de x/√ó, contient 600 (√ò600 / diam 600 / 600)
    const s = String(dim||"");
    if(/[x√ó]/i.test(s)) return false;
    const nums = (s.match(/\d+/g) || []).map(Number);
    if(!nums.length) return false;
    const has600 = nums.includes(600);
    if(!has600) return false;
    // si forme indique rond, on accepte m√™me "600"
    if(formeNorm.includes("rond")) return true;
    // sinon, on exige un marqueur rond
    const ns = norm(s);
    return ns.includes("√∏") || ns.includes("diam");
  }
  function makeDim700(dim){
    return String(dim||"").replace(/600/g, "700");
  }

  const added = [];

  ROWS.forEach(r => {
    const forme = r[MAP.FORME];
    const dim   = r[MAP.DIM];
    if(!forme || !dim) return;

    const fN = norm(forme);

    const isCarre = fN.includes("carre");
    const isRond  = fN.includes("rond");

    if(!isCarre && !isRond) return;

    // On clone uniquement les lignes 600 pour cr√©er 700
    const ok600 = isCarre ? isSquareDim600(dim) : isRoundDim600(dim, fN);
    if(!ok600) return;

    const dim700 = makeDim700(dim);
    if(!dim700 || dim700 === dim) return;

    // si une ligne 700 identique (forme+dim+fin+aj) existe d√©j√†, on ne duplique pas
    const fin = r[MAP.FIN];
    const aj  = r[MAP.AJ];

    if(hasKey(forme, dim700, fin, aj)) return;

    const clone = Object.assign({}, r);
    clone[MAP.DIM] = dim700;

    const oldP = numFR(r[MAP.PRIX]);
    const newP = oldP + DELTA_CSV_700_FROM_600; // +51 si coef=2 => +102 public
    clone[MAP.PRIX] = newP.toFixed(2).replace(".", ",");

    added.push(clone);
    existing.add(`${forme}||${dim700}||${fin}||${String(aj ?? "")}`);
  });

  if(added.length){
    ROWS = ROWS.concat(added);
  }
}

/* ================= UI ================= */
function uniqueSorted(arr){
  // tri simple : √ò400, √ò500... puis 400 x 400...
  return [...new Set(arr)].sort((a,b)=>String(a).localeCompare(String(b), 'fr', {numeric:true}));
}

function populateFormes(){
  const f = uniqueSorted(ROWS.map(r=>r[MAP.FORME]).filter(Boolean));
  elForme.innerHTML = '<option value="">(choisir)</option>' + f.map(v=>`<option>${v}</option>`).join('');
}

function populateDims(){
  const dims = uniqueSorted(
    ROWS
      .filter(r => !elForme.value || r[MAP.FORME] === elForme.value)
      .map(r => r[MAP.DIM])
      .filter(Boolean)
  );

  const current = elDim.value;
  elDim.innerHTML = '<option value="">(choisir)</option>' + dims.map(v=>`<option>${v}</option>`).join('');

  // Si la dimension courante n'existe plus, on reset
  if(current && !dims.includes(current)){
    elDim.value = '';
  }else{
    elDim.value = current;
  }
}

function finitionsDisponibles(){
  const base = ROWS.filter(r =>
    (!elForme.value || r[MAP.FORME] === elForme.value) &&
    (!elDim.value   || r[MAP.DIM]   === elDim.value)
  );

  let hasPrelaque = base.some(r => norm(r[MAP.FIN]).includes('prelaque'));
  let hasLaque    = base.some(r => norm(r[MAP.FIN]).includes('laque') && !isTruthy(r[MAP.AJ]));
  let hasAjour    = base.some(r => isTruthy(r[MAP.AJ]) || norm(r[MAP.FIN]).includes('ajour'));

  let hasPmmaDF   = base.some(r => {
    const fin = norm(r[MAP.FIN]);
    return fin.includes('double') && fin.includes('face') && fin.includes('pmma');
  });

  return {hasPrelaque, hasLaque, hasAjour, hasPmmaDF};
}

function applyFinitionAvailability(){
  const {hasPrelaque, hasLaque, hasAjour, hasPmmaDF} = finitionsDisponibles();

  const rPre = document.querySelector('input[name="finition"][value="prelaque"]');
  const rLaq = document.querySelector('input[name="finition"][value="laque"]');
  const rAjo = document.querySelector('input[name="finition"][value="ajour"]');
  const rPmm = document.querySelector('input[name="finition"][value="pmma_df"]');

  if(rPre) rPre.disabled = !hasPrelaque;
  if(rLaq) rLaq.disabled = !hasLaque;
  if(rAjo) rAjo.disabled = !hasAjour;
  if(rPmm) rPmm.disabled = !hasPmmaDF;

  const cur = getFinition();
  const curDisabled =
    (cur==='prelaque' && !hasPrelaque) ||
    (cur==='laque'    && !hasLaque) ||
    (cur==='ajour'    && !hasAjour) ||
    (cur==='pmma_df'  && !hasPmmaDF);

  if(curDisabled){
    if(hasLaque) setFinition('laque');
    else if(hasPrelaque) setFinition('prelaque');
    else if(hasAjour) setFinition('ajour');
    else if(hasPmmaDF) setFinition('pmma_df');
  }

  let msg = "";
  if(elForme.value && norm(elForme.value).includes('rond') && !hasPrelaque){
    msg = "‚ÑπÔ∏è Sur les drapeaux ronds, la finition ¬´ Pr√©laqu√© ¬ª n‚Äôest pas tarif√©e dans le CSV : passe en ¬´ Laqu√© ¬ª (ou une finition lumineuse si disponible).";
  }else if(getFinition()==='pmma_df'){
    msg = "‚ÑπÔ∏è ¬´ Double face PMMA lumineux ¬ª = tarif d√©di√© (ligne CSV avec finition ‚Äúdouble face PMMA lumineux‚Äù).";
  }else{
    msg = "";
  }
  elHelp.textContent = msg;

  updateRalBtn();
}

/* ================= CALCUL ================= */
function findRow(){
  const finChoice = getFinition();

  return ROWS.find(r => {
    const okForme = r[MAP.FORME] === elForme.value;
    const okDim   = r[MAP.DIM]   === elDim.value;
    if(!okForme || !okDim) return false;

    const fin = norm(r[MAP.FIN]);
    const aj  = isTruthy(r[MAP.AJ]);

    if(finChoice === 'prelaque'){
      return fin.includes('prelaque') && !aj;
    }
    if(finChoice === 'laque'){
      return fin.includes('laque') && !aj && !fin.includes('ajour');
    }
    if(finChoice === 'pmma_df'){
      return fin.includes('double') && fin.includes('face') && fin.includes('pmma');
    }
    // ajour
    return aj || fin.includes('ajour') || (fin.includes('laque') && aj);
  });
}

function compute(){
  applyFinitionAvailability();

  const row = findRow();

  if(!row){
    elHT.textContent = '0,00';
    elTTC.textContent = '0,00';
    return;
  }

  let unitPublic = numFR(row[MAP.PRIX]) * COEF_PUBLIC;

  let remise = 1;
  try{
    const p = JSON.parse(localStorage.getItem('cofel_client_profile'));
    if(p?.discountRate) remise = 1 - p.discountRate;
  }catch{}

  const qte = Math.max(1, parseFloat(elQ.value) || 1);
  const total = unitPublic * qte * remise;

  elHT.textContent  = euro(total);
  elTTC.textContent = euro(total * (1 + TVA));

  updateRalBtn();
}

/* ================= EVENTS ================= */
elForme.addEventListener('change', ()=>{
  populateDims();
  compute();
});
elDim.addEventListener('change', compute);
elQ.addEventListener('input', compute);
document.querySelectorAll('input[name="finition"]').forEach(r => r.addEventListener('change', compute));

$('btnReset').onclick = ()=>{
  elForme.value = '';
  elDim.value   = '';
  elQ.value     = 1;

  // reset finition
  const rPre = document.querySelector('input[name="finition"][value="prelaque"]');
  if(rPre){ rPre.disabled = false; rPre.checked = true; }
  document.querySelectorAll('input[name="finition"]').forEach(r => r.disabled = false);

  populateFormes();
  populateDims();
  compute();
};

/* ================= INIT ================= */
initRalModal();

fetch(CSV_URL, {cache:"no-store"})
  .then(r=>r.text())
  .then(t=>{
    const {heads, rows} = parseCSV(t);
    ROWS = rows;
    MAP  = buildMap(heads);

    // S√©curit√© : si une colonne manque, on √©vite de planter
    if(!MAP.FORME || !MAP.DIM || !MAP.FIN || !MAP.PRIX){
      console.error("Colonnes CSV non reconnues :", MAP, heads);
      alert("‚ö†Ô∏è CSV non reconnu (colonnes). V√©rifie l‚Äôen-t√™te du fichier.");
      return;
    }

    // ‚úÖ Ajoute automatiquement Carr√© 700x700 et Rond √ò700 (ou √©quivalent) √† partir des lignes 600
    injectSize700From600();

    populateFormes();
    populateDims();
    compute();
  })
  .catch(err=>{
    console.error(err);
    alert("‚ö†Ô∏è Impossible de charger le CSV.");
  });
</script>

<script src="../js/devis-core.js"></script>
<script>
$('btnAddDevis').onclick = ()=>{
  const q = Math.max(1, parseFloat($('quantite').value) || 1);
  const ht = numFR($('prixHT').textContent);
  if(!ht){ alert("Configuration incompl√®te"); return; }

  const forme = $('forme').value;
  const dim   = $('dimension').value;
  const fin = getFinitionLabel();

  const pot   = $('potence').value;

  const d = [
    forme,
    dim,
    fin,
    pot ? `potence ${pot} mm` : null
  ].filter(Boolean).join(' ‚Äî ');

  const pu = ht / q;

  Devis.addLine({
    id: `EDR-${Date.now()}`,
    designation: `Enseigne drapeau ‚Äî ${d}`,
    quantite: q,
    pu_net_ht: pu,
    total_ligne_ht: ht,

    // compat √©ventuelle
    type: "Enseigne Drapeau",
    pu_public_ht: pu
  });

  alert("‚úÖ Ajout√© au devis");
};
</script>

</body>
</html>

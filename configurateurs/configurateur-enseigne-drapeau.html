<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Configurateur ‚Äî Enseignes Drapeaux | Cofel</title>

  <!-- Styles Cofel -->
  <link rel="stylesheet" href="../styles/cofel.css">
  <link rel="stylesheet" href="../styles/cofel-components.css">
  <link rel="stylesheet" href="../styles/cofel-glass.css">
</head>

<body>

<!-- ===================== HEADER ===================== -->
<header class="cofel-header">
  <div class="row">
    <a class="cofel-back" href="../index.html">‚¨Ö Retour accueil (Devis)</a>
    <div class="cofel-brand">
      <img src="../assets/logo cofel.jpg" alt="Cofel" />
      <h1 class="cofel-title">Configurateur ‚Äî Enseignes Drapeaux</h1>
    </div>
  </div>
</header>

<!-- ===================== CONTENU ===================== -->
<div class="cofel-container">

  <!-- PARAM√àTRES -->
  <section class="card">
    <h2>‚öôÔ∏è Param√®tres</h2>

    <div class="grid">
      <div>
        <label for="forme">Forme</label>
        <select id="forme" class="native-select">
          <option value="">(choisir)</option>
        </select>
        <div class="cselect" data-bind="forme" aria-expanded="false">
          <button type="button" class="cselect-toggle">
            <span class="cselect-label">(choisir)</span>
            <span class="cselect-caret"></span>
          </button>
          <div class="cselect-menu"></div>
        </div>
        <div id="noteForme" class="muted"></div>
      </div>

      <div>
        <label for="dimension">Dimension</label>
        <select id="dimension" class="native-select">
          <option value="">(choisir la dimension)</option>
        </select>
        <div class="cselect" data-bind="dimension" aria-expanded="false">
          <button type="button" class="cselect-toggle">
            <span class="cselect-label">(choisir la dimension)</span>
            <span class="cselect-caret"></span>
          </button>
          <div class="cselect-menu"></div>
        </div>
        <div id="helpDim" class="muted"></div>
      </div>

      <div>
        <label for="quantite">Quantit√©</label>
        <input type="number" id="quantite" min="1" value="1" />
      </div>

      <div>
        <label for="potence">Longueur de potence (mm)</label>
        <input type="number" id="potence" min="0" placeholder="Ex : 600">
        <div class="muted">Information sans impact tarifaire</div>
      </div>
    </div>
  </section>

  <!-- OPTIONS -->
  <section class="card">
    <h2>üéõÔ∏è Options</h2>

    <div class="grid">
      <label class="option-item">
        <input type="radio" name="finition" id="finPre" checked>
        <span>Pr√©laqu√© (base)</span>
      </label>

      <label class="option-item">
        <input type="radio" name="finition" id="finLq">
        <span>Laqu√©</span>
      </label>

      <label class="option-item">
        <input type="radio" name="finition" id="finAj">
        <span>Ajourage + PMMA + lumineux</span>
      </label>
    </div>

    <div id="helpFinition" class="muted"></div>
  </section>

  <!-- R√âCAP -->
  <section class="card result">
    <div>Prix HT : <b><span id="prixHT">0,00</span> ‚Ç¨</b></div>
    <div>Prix TTC : <b><span id="prixTTC">0,00</span> ‚Ç¨</b></div>

    <div style="margin-top:16px; display:flex; gap:10px; flex-wrap:wrap;">
      <button id="btnAddDevis" class="btn">‚ûï Ajouter au devis</button>
      <button id="btnReset" class="btn btn-ghost">üîÑ R√©initialiser</button>
    </div>
  </section>

</div>

<footer class="cofel-footer">
  ¬© Cofel ‚Äî ZA du Perquoi, 72560 Chang√© ‚Äî SIRET 927 659 458 00024 ‚Äî TVA FR80927659458
</footer>

<!-- ===================== SCRIPT M√âTIER (INCHANG√â) ===================== -->
<script src="../js/devis-core.js"></script>

<script>
/* ===== CONFIG ===== */
const TVA = 0.20;
const CSV_URL = "https://raw.githubusercontent.com/stevens-cofel/configurateur-cofel/refs/heads/main/Enseigne%20drapeaux.csv";

/* ===== DOM ===== */
const $ = id => document.getElementById(id);
const elForme = $('forme');
const elDim = $('dimension');
const elQ = $('quantite');
const elPot = $('potence');
const elHT = $('prixHT');
const elTTC = $('prixTTC');
const elFinPre = $('finPre');
const elFinLq = $('finLq');
const elFinAj = $('finAj');
const elHelpDim = $('helpDim');
const elHelpFinition = $('helpFinition');
const elNote = $('noteForme');

let HEADS = [], ROWS = [], MAP = null;

/* ===== UTILS ===== */
function euro(n){return (isFinite(n)?n:0).toFixed(2).replace('.',',')}
function numFR(v){return parseFloat(String(v).replace(',','.'))||0}
function normKey(k){return String(k).toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"")}

/* ===== CSV ===== */
function parseCSV(txt){
  const l = txt.split(/\r?\n/).filter(Boolean);
  const h = l.shift().split(';');
  const r = l.map(line=>{
    const o={};
    line.split(';').forEach((v,i)=>o[h[i]]=v);
    return o;
  });
  return {h,r};
}

/* ===== LOGIQUE ===== */
function getFinition(){
  if(elFinAj.checked) return 'ajour';
  if(elFinLq.checked) return 'laque';
  return 'prelaque';
}

function compute(){
  const row = ROWS.find(r =>
    (!elForme.value || r[MAP.FORME].toLowerCase()===elForme.value) &&
    (!elDim.value || r[MAP.DIM]===elDim.value)
  );
  if(!row){ elHT.textContent='0,00'; elTTC.textContent='0,00'; return; }

  let base = numFR(row[MAP.PRIX]) * 2;
  let remise = 1;
  try{
    const p = JSON.parse(localStorage.getItem('cofel_client_profile'));
    if(p?.discountRate) remise = 1 - p.discountRate;
  }catch{}

  const totalHT = base * remise * elQ.value;
  elHT.textContent = euro(totalHT);
  elTTC.textContent = euro(totalHT*(1+TVA));
}

async function load(){
  const txt = await fetch(CSV_URL,{cache:'no-store'}).then(r=>r.text());
  const {h,r} = parseCSV(txt);
  HEADS=h; ROWS=r;
  MAP={
    FORME:h.find(x=>normKey(x).includes('forme')),
    DIM:h.find(x=>normKey(x).includes('dimension')),
    PRIX:h.find(x=>normKey(x).includes('prix'))
  };
  [...new Set(r.map(x=>x[MAP.FORME]))].forEach(f=>{
    elForme.innerHTML+=`<option value="${f.toLowerCase()}">${f}</option>`;
  });
}

['change','input'].forEach(e=>{
  [elForme,elDim,elQ,elFinPre,elFinLq,elFinAj].forEach(x=>x.addEventListener(e,compute));
});

$('btnReset').onclick=()=>{location.reload()};

load();
</script>

</body>
</html>

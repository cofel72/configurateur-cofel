<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>Configurateur ‚Äî Lettres Alu 20/10 & Dibond 3 mm | Cofel</title>
  
<link rel="stylesheet" href="../styles/cofel.css">
<link rel="stylesheet" href="../styles/cofel-components.css">
<link rel="stylesheet" href="../styles/cofel-glass.css">

</head>
<body>

<!-- ===================== HERO ===================== -->
<header class="cofel-header">
  <div class="row">
    <a class="cofel-back" href="../index.html">‚¨Ö Retour accueil (devis)</a>

    <div class="cofel-brand">
      <img src="../assets/logo cofel.jpg" alt="Cofel" />
      <h1 class="cofel-title">Configurateur ‚Äî Lettres Alu 20/10 & Dibond 3 mm</h1>
    </div>
  </div>
</header>


<!-- ===================== CONTENU ===================== -->
  <div class="cofel-container">
<main class="wrap">
  <section class="panel" aria-label="Param√®tres">
    <h2>‚öôÔ∏è Param√®tres</h2>

    <div class="card grid">
      <div>
        <label for="categorie">Cat√©gorie</label>
        <select id="categorie" class="native-select">
          <option value="alu20" selected>Lettre aluminium 20/10</option>
          <option value="dibond3">Lettre alu/PVC 3 mm (type Dibond)</option>
        </select>
        <div class="cselect" data-bind="categorie" aria-haspopup="listbox" aria-expanded="false">
          <button type="button" class="cselect-toggle">
            <span class="cselect-label">Lettre aluminium 20/10</span>
            <span class="cselect-caret" aria-hidden="true"></span>
          </button>
          <div class="cselect-menu" role="listbox"></div>
        </div>
      </div>

      <div>
        <label for="quantite">Quantit√©</label>
        <input type="number" id="quantite" min="1" value="1" />
      </div>
    </div>

    <div class="card grid">
      <div>
        <label for="hauteur">Hauteur (mm)</label>
        <input type="number" id="hauteur" placeholder="Ex : 275" min="0" value="0" max="1500" />
        
        <div id="helpRanges" class="muted">Hauteur max 1500 mm</div>
      </div>

      <div>
      <div class="option-box">
  <h3>Finition</h3>

  <label class="option-btn">
    <input type="radio" name="finition" id="finitionBrut" value="brut" checked />
    <span>Brut</span>
  </label>

  <label class="option-btn">
    <input type="radio" name="finition" id="finitionLaque" value="laque" />
    <span>Laqu√©</span>
  </label>
</div>


        <fieldset>
          <div class="option-box">
  <h3>Suppl√©ment</h3>

  <label class="option-btn">
    <input type="checkbox" id="optFixation" />
    <span>Fixations</span>
  </label>

  <label class="option-btn">
    <input type="checkbox" id="optLisse" />
    <span>Pose sur lisse</span>
  </label>

  <div id="lisseBlock" class="hidden" style="margin-top:10px;">
    <label for="lisseLongueur">Longueur de la lisse (mm)</label>
    <input type="number" id="lisseLongueur" min="0" placeholder="Ex : 3000" />
  </div>
</div>

        </fieldset>
      </div>
    </div>
  </section>

  <section class="panel" aria-label="R√©capitulatif">
    <h2>üßæ R√©capitulatif</h2>
    <div class="result">
      <p>Prix HT : <b><span id="prixHT">0,00</span> ‚Ç¨</b></p>
      <p>Prix TTC : <b><span id="prixTTC">0,00</span> ‚Ç¨</b></p>
      <div class="muted">TVA 20 % incluse dans le calcul.</div>
    </div>

   <div class="cofel-actions">
  <button id="btnAddDevis" class="cofel-fab">‚ûï Ajouter au devis</button>
  <button id="btnReset" class="btn btn-ghost">üîÑ R√©initialiser</button>
</div>

  </section>
</main>
</div>

<footer class="cofel-footer">
  ¬© Cofel ‚Äî ZA du Perquoi, 72560 Chang√© ‚Äî SIRET 927 659 458 00024 ‚Äî TVA FR80927659458
</footer>

<!-- ===================== JS ===================== -->
<script>
const TVA = 0.20;
const COEF_PUBLIC = 2;
const CSV_URL = "https://raw.githubusercontent.com/stevens-cofel/configurateur-cofel/refs/heads/main/lettres/Lettre%20alu%2020_10%20%C3%A8me%20ou%20Type%20Dibond%203%20mm.csv";
const H_MAX = 1500;
const LISSE_PRICE_ML = 25; // ‚Ç¨/ml interne

let HEADS=[], ROWS=[], MAP=null;
const $ = id => document.getElementById(id);
const elH = $("hauteur");
const elQ = $("quantite");
const elFix = $("optFixation");
const elFBrut = $("finitionBrut");
const elFLaque = $("finitionLaque");
const elPrixHT = $("prixHT");
const elPrixTTC = $("prixTTC");
const elHelp = $("helpRanges");
const elLisse = $("optLisse");
const elLisseLongueur = $("lisseLongueur");

function normKey(k){
  return String(k||'').toLowerCase()
    .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
    .replace(/[^a-z0-9]+/g,'').trim();
}
function numFR(v){
  if(v==null) return NaN;
  let s = String(v).trim()
    .replace(/‚Ç¨/g,'').replace(/[\u00A0\u202F]/g,'').replace(/\s+/g,'');
  if(s.includes(',') && s.includes('.')) s = s.replace(/\./g,'');
  s = s.replace(',', '.');
  const m = s.match(/-?\d+(\.\d+)?/);
  return m ? parseFloat(m[0]) : NaN;
}
function euro(n){ return (isFinite(n)?n:0).toFixed(2).replace('.', ','); }

const customSelects = new Map();
function buildCustomFromNative(native){
  const wrap = document.querySelector('.cselect[data-bind="'+native.id+'"]');
  if(!wrap) return;
  const toggle = wrap.querySelector('.cselect-toggle');
  const labelSpan = wrap.querySelector('.cselect-label');
  const menu = wrap.querySelector('.cselect-menu');
  menu.innerHTML = '';
  Array.from(native.options).forEach(opt=>{
    const div=document.createElement('div');
    div.className='cselect-option'; div.setAttribute('role','option'); div.tabIndex=-1;
    div.dataset.value=opt.value; div.textContent=opt.textContent;
    if(opt.selected) div.setAttribute('aria-selected','true');
    div.addEventListener('click', ()=>{ setNativeValue(native, opt.value); closeMenu(native.id); });
    div.addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' '){ e.preventDefault(); setNativeValue(native, opt.value); closeMenu(native.id); } });
    menu.appendChild(div);
  });
  labelSpan.textContent = (native.selectedOptions[0] || native.options[0])?.textContent || '';
  toggle.onclick = ()=> { const expanded = wrap.getAttribute('aria-expanded')==='true'; expanded ? closeMenu(native.id) : openMenu(native.id); };
  toggle.onkeydown = (e)=>{
    const expanded = wrap.getAttribute('aria-expanded')==='true';
    if((e.key==='ArrowDown' || e.key==='ArrowUp') && !expanded){
      e.preventDefault(); openMenu(native.id);
      const first = menu.querySelector('.cselect-option'); first && first.focus();
    } else if(e.key==='Enter' || e.key===' '){ e.preventDefault(); toggle.click(); }
    else if(e.key==='Escape' && expanded){ closeMenu(native.id); }
  };
  customSelects.set(native.id, { wrap, toggle, labelSpan, menu, native });
}
function setNativeValue(native, val){
  if(native.value !== val){ native.value = val; native.dispatchEvent(new Event('change', { bubbles:true })); }
  const api = customSelects.get(native.id);
  if(api){
    api.labelSpan.textContent = native.selectedOptions[0]?.textContent || '';
    Array.from(api.menu.children).forEach(n=>{
      if(n.classList.contains('cselect-option')){
        n.setAttribute('aria-selected', n.dataset.value===val ? 'true' : 'false');
      }
    });
  }
}
function openMenu(id){
  const api = customSelects.get(id); if(!api) return;
  const {wrap, toggle, menu} = api;
  wrap.setAttribute('aria-expanded','true');
  const r = toggle.getBoundingClientRect();
  menu.style.left  = Math.round(r.left) + 'px';
  menu.style.top   = Math.round(r.bottom + 6) + 'px';
  menu.style.width = Math.round(r.width) + 'px';
  if(menu.parentElement !== document.body){ document.body.appendChild(menu); }
  menu.style.display = 'block';
  const onViewport = ()=> closeMenu(id);
  const onDocClick = (e)=>{ if(!wrap.contains(e.target) && !menu.contains(e.target)) closeMenu(id); };
  window.addEventListener('scroll', onViewport, {passive:true});
  window.addEventListener('resize', onViewport);
  document.addEventListener('click', onDocClick);
  api.__off = ()=>{
    window.removeEventListener('scroll', onViewport);
    window.removeEventListener('resize', onViewport);
    document.removeEventListener('click', onDocClick);
  };
}
function closeMenu(id){
  const api = customSelects.get(id); if(!api) return;
  const {wrap, menu, __off} = api;
  wrap.setAttribute('aria-expanded','false');
  menu.style.display = 'none';
  if(menu.parentElement !== wrap){ wrap.appendChild(menu); }
  if(typeof __off === 'function') __off();
  api.toggle.focus();
}

function parseCSVAuto(text){
  const lines = text.replace(/^\uFEFF/,'').split(/\r?\n/).filter(l=>l.trim()!=='');
  if(!lines.length) return {rawHeads:[],rows:[]};
  const first = lines[0];
  const sep = ((first.match(/;/g)||[]).length > (first.match(/,/g)||[]).length) ? ';' : ',';
  const parseLine = (line)=>{
    const out=[]; let cur=''; let inQ=false;
    for(let i=0;i<line.length;i++){
      const ch=line[i], nx=line[i+1];
      if(ch === '"'){
        if(inQ && nx === '"'){ cur+='"'; i++; }
        else inQ = !inQ;
      } else if(ch === sep && !inQ){ out.push(cur); cur=''; }
      else cur += ch;
    }
    out.push(cur); return out;
  };
  const rawHeads = parseLine(lines[0]).map(s=>s.replace(/^"+|"+$/g,'').trim());
  const rows = lines.slice(1).map(line=>{
    const cells = parseLine(line).map(s=>s.replace(/^"+|"+$/g,'').trim());
    const o={}; rawHeads.forEach((h,i)=> o[h]=cells[i]??''); return o;
  });
  return {rawHeads, rows};
}
function buildMapping(rawHeads){
  const nk = rawHeads.map(normKey);
  const find=(k)=>{const i=nk.indexOf(k); return i>=0?rawHeads[i]:null;};
  const loose=(...res)=>{ for(let i=0;i<nk.length;i++){ const k=nk[i]; if(res.every(r=>r.test(k))) return rawHeads[i]; } return null; };
  const hKey   = find('hauteurmm')      || loose(/hauteur/,/mm/);
  const brutKey= find('prixbruteur')    || loose(/brut/);
  const laqKey = find('prixlaqueeur')   || loose(/laque/);
  const fixKey = find('supfixationeur') || loose(/fix/);
  return {hKey, brutKey, laqKey, fixKey};
}

function pickRowForHeight(H){
  const k=MAP.hKey;
  const pool = ROWS
    .map(r=>({row:r, h:numFR(r[k])}))
    .filter(x=>isFinite(x.h))
    .sort((a,b)=>a.h-b.h);
  if(!pool.length) return null;
  let chosen=pool[0];
  for(const x of pool){
    if(H <= x.h){ chosen=x; break; }
    chosen=x;
  }
  return chosen.row;
}

function updateLisseUI(){
  const block = $("lisseBlock");
  if(!block) return;
  block.classList.toggle("hidden", !elLisse.checked);
}

function compute(){
  // === Remise automatique client ===
  let remiseClient = 1;
  try {
      const p = JSON.parse(localStorage.getItem('cofel_client_profile'));
      if (p && typeof p.discountRate === 'number') remiseClient = 1 - p.discountRate;
  } catch(e){}

  const Hraw = Number(elH.value || 0);
  let H = Math.min(H_MAX, Math.max(0, Hraw || 0));

  const Q = Math.max(1, Number(elQ.value || 1));  // quantit√©

  if (H <= 0) {
    elPrixHT.textContent = '0,00';
    elPrixTTC.textContent = '0,00';
    return;
  }

  const row = pickRowForHeight(H);
  if(!row){ elPrixHT.textContent='0,00'; elPrixTTC.textContent='0,00'; return; }

  const brut = MAP.brutKey ? numFR(row[MAP.brutKey]) : NaN;
  const laqe = MAP.laqKey  ? numFR(row[MAP.laqKey])  : NaN;

  let unit_interne = 0;
  if(elFLaque.checked && isFinite(laqe)) unit_interne = laqe;
  else if(isFinite(brut)) unit_interne = brut;
  else if(isFinite(laqe)) { unit_interne = laqe; elFLaque.checked=true; elFBrut.checked=false; }

  // Suppl√©ment : fixations
  if(elFix.checked && MAP.fixKey){
    const fx = numFR(row[MAP.fixKey]);
    if(isFinite(fx)) unit_interne += fx;
  }

  // Suppl√©ment : pose sur lisse (25 ‚Ç¨/ml interne)
  if (elLisse && elLisse.checked) {
    const lmm = Number(elLisseLongueur?.value || 0);
    const lml = lmm / 1000;
    if (lml > 0) {
      unit_interne += LISSE_PRICE_ML * lml;
    }
  }

  // === PRIX PUBLIC AVANT REMISE ===
const unit_public_brut = unit_interne * COEF_PUBLIC;

// === PRIX NET CLIENT ===
const unit_public = unit_public_brut * remiseClient;

  const totalHT = unit_public * Q;
  const totalTTC = totalHT * (1+TVA);

  elPrixHT.textContent  = euro(totalHT);
  elPrixTTC.textContent = euro(totalTTC);
}

async function loadCSV(){
  try{
    const r = await fetch(CSV_URL,{cache:'no-store'});
    const txt = await r.text();
    const {rawHeads, rows} = parseCSVAuto(txt);
    HEADS=rawHeads; ROWS=rows; MAP=buildMapping(HEADS);
    if (elHelp) elHelp.textContent = "Hauteur max 1500 mm";
    updateLisseUI();
    compute();
  }catch(e){
    console.error(e);
    alert("Erreur lors du chargement des donn√©es. R√©essayez plus tard.");
  }
}

["input","change"].forEach(evt=>{
  [elH, elQ, elFix, elFBrut, elFLaque, elLisse, elLisseLongueur].forEach(el=>{
    if(!el) return;
    el.addEventListener(evt, ()=>{
      updateLisseUI();
      compute();
    });
  });
});
$("btnReset").addEventListener("click", ()=>{
  elH.value=''; elQ.value=1; elFix.checked=false; elFBrut.checked=true; elFLaque.checked=false;
  if (elLisse) elLisse.checked = false;
  if (elLisseLongueur) elLisseLongueur.value = '';
  updateLisseUI();
  if (elHelp) elHelp.textContent = "Hauteur max 1500 mm";
  compute();
});
loadCSV();

buildCustomFromNative($("categorie"));
$("categorie").addEventListener("change", ()=>{ /* synchro visuelle ok */ });
</script>

<!-- ===================== MOTEUR DE DEVIS ===================== -->
<script src="../js/devis-core.js"></script>
<script>
$("btnAddDevis").addEventListener("click", ()=>{
  try{
    if(!window.Devis) throw new Error("Moteur de devis introuvable.");
    const qte = Math.max(1, Number($("quantite").value || 1));
    let hauteur = Number($("hauteur").value || 0);
    if (!isFinite(hauteur) || hauteur < 1) hauteur = 1;
    if (hauteur > 1500) { hauteur = 1500; $("hauteur").value = 1500; }

    const fin = $("finitionLaque").checked ? 'laqu√©' : 'brut';
    const fix = $("optFixation").checked ? ' + fixations' : '';

    const optLisse = $("optLisse");
    const lisseMM = Number($("lisseLongueur")?.value || 0);
    const lisseML = lisseMM / 1000;
    const supLisseText = (optLisse && optLisse.checked && lisseMM > 0)
      ? ` + pose sur lisse ‚Äî ${lisseMM} mm (${lisseML.toFixed(2)} ml)`
      : '';

    const catVal = $("categorie").value;
    const catTxt = (catVal==='alu20') ? 'Lettre aluminium 20/10' : 'Lettre alu/PVC 3 mm (type Dibond)';
    const total_ht = parseFloat($("prixHT").innerText.replace(',','.')) || 0;
    const pu_public_ht = qte>0 ? (total_ht / qte) : 0;
    const designation = `${catTxt} ‚Äî H ${hauteur || 'n.c.'} mm ‚Äî ${fin}${fix}${supLisseText}`;

    Devis.addLine({
      type: 'Lettres',
      designation,
      quantite: qte,
      pu_public_ht: Number(pu_public_ht.toFixed(2))
    });
    alert(`‚úÖ Ligne ajout√©e au devis !\n${designation}\nQt√© : ${qte}\nPU HT : ${pu_public_ht.toFixed(2)} ‚Ç¨`);
  }catch(err){ console.error(err); alert('Erreur lors de l‚Äôajout au devis : ' + err.message); }
});
</script>

</body>
</html>




<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Configurateur ‚Äî Totems Cofel (auto-mapping)</title>

<link rel="stylesheet" href="../styles/cofel.css">
<link rel="stylesheet" href="../styles/cofel-components.css">
<link rel="stylesheet" href="../styles/cofel-glass.css">
<link rel="stylesheet" href="/styles/cofel-theme-apple-dark.css">

<style>
  /* s√©curit√© si .hidden n'existe pas dans tes CSS */
  .hidden{ display:none !important; }

  /* Bouton RAL (style ‚Äúpastille‚Äù comme T√¥le Tablette) */
  .ral-btn{
    display:inline-flex;
    align-items:center;
    gap:10px;
    padding:10px 12px;
    border:1px solid var(--glass-hr, rgba(255,255,255,.18));
    border-radius:14px;
    background:var(--glass, rgba(255,255,255,.06));
    color:var(--txt, #fff);
    user-select:none;
    white-space:nowrap;
    cursor:pointer;
  }
  .ral-btn:hover{ filter:brightness(1.12); }
  .ral-btn:disabled{
    opacity:.45;
    cursor:not-allowed;
    filter:none;
  }

  /* Modal */
  html.ral-lock, body.ral-lock{ overflow:hidden; }

  .ral-modal{
    position:fixed;
    inset:0;
    z-index:9999;
    display:flex;
    align-items:center;
    justify-content:center;
    padding:14px;
  }
  .ral-backdrop{
    position:absolute;
    inset:0;
    background:rgba(0,0,0,.65);
    backdrop-filter: blur(10px);
  }
  .ral-card{
    position:relative;
    width:min(980px, calc(100vw - 24px));
    max-height:calc(100vh - 24px);
    overflow:hidden;
    border-radius:18px;
    border:1px solid var(--glass-hr, rgba(255,255,255,.18));
    background:rgba(18,18,18,.86);
    box-shadow: 0 12px 35px rgba(0,0,0,.55);
    display:flex;
    flex-direction:column;
  }
  .ral-head{
    display:flex;
    justify-content:space-between;
    gap:12px;
    padding:14px 14px 10px;
    border-bottom:1px solid var(--glass-hr, rgba(255,255,255,.12));
  }
  .ral-title{
    font-weight:700;
    font-size:16px;
    line-height:1.2;
  }
  .ral-sub{
    margin-top:4px;
    font-size:13px;
    color:var(--txt-dim, rgba(255,255,255,.72));
  }
  .ral-close{
    background:transparent;
    border:1px solid var(--glass-hr, rgba(255,255,255,.18));
    border-radius:12px;
    color:var(--txt, #fff);
    padding:8px 10px;
    cursor:pointer;
  }

  .ral-toolbar{
    display:flex;
    gap:10px;
    padding:12px 14px;
    align-items:center;
    border-bottom:1px solid var(--glass-hr, rgba(255,255,255,.12));
    flex-wrap:wrap;
  }
  .ral-tabs{
    display:flex;
    gap:8px;
  }
  .ral-tab{
    padding:8px 10px;
    border-radius:12px;
    border:1px solid var(--glass-hr, rgba(255,255,255,.18));
    background:transparent;
    color:var(--txt, #fff);
    cursor:pointer;
  }
  .ral-tab.is-active{
    background:rgba(255,255,255,.08);
  }
  .ral-search{
    flex:1;
    min-width:220px;
    padding:10px 12px;
    border-radius:12px;
    border:1px solid var(--glass-hr, rgba(255,255,255,.18));
    background:rgba(255,255,255,.06);
    color:var(--txt, #fff);
    outline:none;
  }

  .ral-content{
    padding:14px;
    overflow:auto;
  }
  .ral-group{
    margin-bottom:14px;
    padding:12px;
    border-radius:16px;
    background:rgba(255,255,255,.04);
    border:1px solid rgba(255,255,255,.08);
  }
  .ral-group h3{
    margin:0 0 10px 0;
    font-size:14px;
    color:var(--txt, #fff);
  }
  .ral-grid{
    display:flex;
    flex-wrap:wrap;
    gap:8px;
  }
  .ral-chip{
    padding:8px 10px;
    border-radius:999px;
    border:1px solid rgba(255,255,255,.18);
    background:rgba(255,255,255,.06);
    color:var(--txt, #fff);
    cursor:pointer;
  }
  .ral-chip:hover{ filter:brightness(1.12); }

  .ral-empty{
    padding:16px;
    color:var(--txt-dim, rgba(255,255,255,.72));
  }

  .ral-foot{
    padding:10px 14px 14px;
    border-top:1px solid var(--glass-hr, rgba(255,255,255,.12));
  }
  .ral-toast{
    font-size:13px;
    color:var(--txt, #fff);
    min-height:18px;
    margin-bottom:6px;
  }
  .ral-note{
    font-size:12px;
    color:var(--txt-dim, rgba(255,255,255,.72));
  }
</style>

</head>
<body>
<header class="cofel-header">
  <div class="row">
    <a class="cofel-back" href="../index.html">‚¨Ö Retour accueil (devis)</a>
    <div class="cofel-brand">
      <img src="../assets/logo cofel.jpg" alt="Cofel" />
      <h1 class="cofel-title">Configurateur ‚Äî Totems</h1>
    </div>
  </div>
</header>

<div class="cofel-container">
  <div class="wrap">

    <!-- ===== MAPPAGE TARIFS ===== -->
    <div id="mapTarifsBox" class="mapping" style="display:none">
      <h3>üìÑ Mappage des colonnes TARIFS</h3>
      <div class="two">
        <div>
          <label>Colonne ‚ÄúType de face‚Äù</label>
          <select id="mapT_Type"></select>
        </div>
        <div>
          <label>Colonne ‚ÄúPrix base HT‚Äù</label>
          <select id="mapT_Price"></select>
        </div>
        <div>
          <label>Colonne ‚ÄúHauteur (mm)‚Äù</label>
          <select id="mapT_H"></select>
        </div>
        <div>
          <label>Colonne ‚ÄúLargeur (mm)‚Äù</label>
          <select id="mapT_L"></select>
        </div>
      </div>
      <button id="applyMapTarifs" class="pill">Appliquer le mappage TARIFS</button>
    </div>

    <!-- ===== MAPPAGE OPTIONS ===== -->
    <div id="mapOptionsBox" class="mapping" style="display:none">
      <h3>üß© Mappage des colonnes OPTIONS</h3>
      <div class="two">
        <div>
          <label>Colonne ‚ÄúType d‚Äôoption‚Äù (Platine / Panier de crosses)</label>
          <select id="mapO_Type"></select>
        </div>
        <div>
          <label>Colonne ‚ÄúPrix unitaire HT‚Äù</label>
          <select id="mapO_Price"></select>
        </div>
        <div>
          <label>Colonne ‚ÄúHauteur min (mm)‚Äù</label>
          <select id="mapO_HMin"></select>
        </div>
        <div>
          <label>Colonne ‚ÄúHauteur max (mm)‚Äù</label>
          <select id="mapO_HMax"></select>
        </div>
        <div>
          <label>Colonne ‚ÄúActif‚Äù (Oui/True/1)</label>
          <select id="mapO_Actif"></select>
        </div>
      </div>
      <button id="applyMapOptions" class="pill">Appliquer le mappage OPTIONS</button>
    </div>

    <!-- ===== UI CONFIG ===== -->
    <fieldset>
      <legend>Configuration</legend>
      <label for="type">Type de face</label>
      <select id="type"><option value="">‚Äî s√©lectionnez ‚Äî</option></select>

      <div class="grid">
        <div>
          <label for="hauteur">Hauteur (mm)</label>
          <select id="hauteur"><option value="">‚Äî s√©lectionnez ‚Äî</option></select>
          <!-- ‚úÖ Note anneau de levage -->
          <div id="levageMsg" class="muted" style="display:none;margin-top:6px">‚ÑπÔ∏è Pour H ‚â• 3500 mm : un anneau de levage est inclus.</div>
        </div>
        <div>
          <label for="largeur">Largeur (mm)</label>
          <select id="largeur"><option value="">‚Äî s√©lectionnez ‚Äî</option></select>
        </div>
      </div>

      <label>Options (multi-choix)</label>
      <div id="optionsBox" class="options-wrap">
        <div class="opt-row"><em>Aucune option disponible tant que la hauteur n‚Äôest pas choisie.</em></div>
      </div>

      <!-- ====== OPTIONS FIXES ====== -->
      <div class="opt-row" id="fixedOptions" style="display:flex;gap:20px;flex-wrap:wrap">

        <!-- Pr√©-laquage (toujours inclus, donc d√©coch√© mais gris√©) -->
        <label style="display:flex;align-items:center;gap:6px;margin:0;opacity:.7">
          <input type="checkbox" id="optPreLaque" checked disabled />
          <span>Pr√©-laquage (inclus)</span>
        </label>

        <!-- Laquage RAL -->
        <label style="display:flex;align-items:center;gap:6px;margin:0">
          <input type="checkbox" id="optRAL" disabled />
          <span>Laquage RAL</span>
        </label>

        <!-- Laquage des pieds -->
        <label style="display:flex;align-items:center;gap:6px;margin:0">
          <input type="checkbox" id="optPieds" disabled />
          <span>Laquage pieds du totem</span>
        </label>

        <!-- ‚úÖ Bouton ‚ÄúRAL disponibles‚Äù (pr√©-laqu√©e) -->
        <button type="button" id="btnRal" class="ral-btn" style="margin-left:auto" aria-haspopup="dialog">
          üé® RAL disponibles (pr√©-laqu√©e)
        </button>

      </div>

      <label for="quantite">Quantit√©</label>
      <input type="number" id="quantite" value="1" min="1"/>
    </fieldset>

    <!-- ===== R√©sultats ===== -->
    <div class="result">
      <p>Prix HT : <span id="prixHT">0,00</span> ‚Ç¨</p>
      <p>Prix TTC : <span id="prixTTC">0,00</span> ‚Ç¨</p>
    </div>

    <div class="cofel-actions">
      <button id="btnAddDevis" class="cofel-fab">
        ‚ûï Ajouter au devis
      </button>
    </div>

    <div id="msg" class="muted"></div>
  </div>
</div>

<footer class="cofel-footer">
  ¬© Cofel ‚Äî ZA du Perquoi, 72560 Chang√© ‚Äî SIRET 927 659 458 00024 ‚Äî TVA FR80927659458
</footer>

<!-- ‚úÖ POPUP RAL (identique aux autres configurateurs) -->
<div id="ralModal" class="ral-modal hidden" role="dialog" aria-modal="true" aria-labelledby="ralTitle">
  <div class="ral-backdrop" data-close="1"></div>

  <div class="ral-card">
    <div class="ral-head">
      <div>
        <div id="ralTitle" class="ral-title">RAL disponibles ‚Äî T√¥le aluminium 15/10 pr√©-laqu√©e</div>
        <div class="ral-sub">Format 3000 √ó 1500 ‚Ä¢ Satin√© / Brillante ‚Ä¢ Clique un RAL pour le copier</div>
      </div>
      <button type="button" id="ralClose" class="ral-close" aria-label="Fermer">‚úï</button>
    </div>

    <div class="ral-toolbar">
      <div class="ral-tabs" role="tablist" aria-label="Finition">
        <button type="button" class="ral-tab is-active" data-finish="satine" role="tab" aria-selected="true">Satin√©</button>
        <button type="button" class="ral-tab" data-finish="brillante" role="tab" aria-selected="false">Brillante</button>
      </div>
      <input id="ralSearch" class="ral-search" type="text" placeholder="Rechercher : 7016, gris, noir, bleu‚Ä¶" />
    </div>

    <div id="ralContent" class="ral-content"></div>

    <div class="ral-foot">
      <div id="ralToast" class="ral-toast" aria-live="polite"></div>
      <div class="ral-note">R√©f√©rence indicative : valider la teinte finale avec un nuancier officiel RAL / √©chantillon mati√®re.</div>
    </div>
  </div>
</div>

<script>
/* ------- CONFIG ------- */
const URL_TARIFS  = "https://raw.githubusercontent.com/stevens-cofel/configurateur-cofel/refs/heads/main/Tarifs_Totems_.csv";
const URL_OPTIONS = "https://raw.githubusercontent.com/stevens-cofel/configurateur-cofel/refs/heads/main/option%20platine%20et%20panier%20de%20crosses%20(1).csv";
const TVA = 0.20;
const RAL_PRICE_PUBLIC_M2 = 112; // ‚úÖ d√©j√† prix PUBLIC (x2 inclus)

/* ------- STATE ------- */
let RAW_TARIFFS = []; let RAW_OPTIONS = [];
let RAW_HEADERS_T = []; let RAW_HEADERS_O = [];
let HEADS_T = []; let HEADS_O = []; let TARIFFS = []; let OPTIONS = [];

// === D√©fauts bas√©s sur normalizeKey() des CSV actuels
const MAP_T_DEFAULT = { type:'forme', h:'hauteurmm', l:'largeurmm', price:'prixbaseeur' };
const MAP_O_DEFAULT = { type:'typedoption', hmin:'hauteurminmm', hmax:'hauteurmaxmm', price:'prixunitaireht', actif:'actif' };

let MAP_T = JSON.parse(localStorage.getItem('MAP_T') || 'null') || { ...MAP_T_DEFAULT };
let MAP_O = JSON.parse(localStorage.getItem('MAP_O') || 'null') || { ...MAP_O_DEFAULT };

/* ------- ELEMENTS ------- */
const elType = document.getElementById('type');
const elH    = document.getElementById('hauteur');
const elL    = document.getElementById('largeur');
const elOptsBox = document.getElementById('optionsBox');
const elQte  = document.getElementById('quantite');
const elHT   = document.getElementById('prixHT');
const elTTC  = document.getElementById('prixTTC');
const elMsg  = document.getElementById('msg');
const elOptRAL = document.getElementById('optRAL');
const elLevage = document.getElementById('levageMsg');

/* ------- HELPERS ------- */
function num(v){
  const s = String(v == null ? '' : v).replace(/\u202F/g,'').replace(/\s/g,'').replace(',', '.');
  const m = s.match(/-?\d+(\.\d+)?/);
  return m ? parseFloat(m[0]) : NaN;
}
function normalizeKey(k){
  return String(k||'').toLowerCase()
    .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
    .replace(/[^a-z0-9]+/g,'').trim();
}
function csvSplit(line, sep){
  const out = []; let cur = ''; let inQ = false;
  for(let i=0;i<line.length;i++){
    const ch = line[i];
    if(ch === '"'){
      if(inQ && line[i+1] === '"'){ cur += '"'; i++; continue; }
      inQ = !inQ; continue;
    }
    if(ch === sep && !inQ){ out.push(cur); cur=''; continue; }
    cur += ch;
  }
  out.push(cur);
  return out.map(function(c){ return c.trim(); });
}
function parseCSVAuto(text){
  text = text.replace(/^\uFEFF/, '').trim();
  let lines = text.split(/[\r\n]+/).filter(function(l){ return l.trim().length>0; });

  let rawHeads = [], heads = [], rows = [];

  if(lines.length > 1){
    const first = lines[0];
    const sep = ((first.match(/;/g)||[]).length > (first.match(/,/g)||[]).length) ? ';' : ',';
    rawHeads = csvSplit(first, sep);
    heads = rawHeads.map(function(h){ return normalizeKey(h.replace(/^"+|"+$/g,'')); });
    rows = lines.slice(1).map(function(line){
      const cells = csvSplit(line, sep).map(function(c){ return c.replace(/^"+|"+$/g,''); });
      const o={}; heads.forEach(function(h,i){ o[h]=cells[i] == null ? '' : cells[i]; }); return o;
    });
    return { rows: rows, rawHeads: rawHeads, heads: heads };
  }

  if(lines.length === 1){
    const chunk = lines[0];
    const sep = ((chunk.match(/;/g)||[]).length > (chunk.match(/,/g)||[]).length) ? ';' : ',';
    let fields = [];
    if(chunk.includes(sep)){
      fields = csvSplit(chunk, sep);
    }else{
      const re = /"([^\"]*)"/g; let m; while((m = re.exec(chunk))){ fields.push(m[1]); }
    }
    if(fields.length < 4){ return { rows:[], rawHeads:[], heads:[] }; }
    rawHeads = fields.slice(0,5);
    heads    = rawHeads.map(function(h){ return normalizeKey(h); });
    const nCols = rawHeads.length;
    const data = fields.slice(nCols);
    for(let i=0;i<data.length;i+=nCols){
      const rec = data.slice(i,i+nCols);
      if(rec.length===nCols){ const o={}; heads.forEach(function(h,idx){ o[h]=rec[idx] == null ? '' : rec[idx]; }); rows.push(o); }
    }
    return { rows: rows, rawHeads: rawHeads, heads: heads };
  }

  return { rows:[], rawHeads:[], heads:[] };
}
function uniqueSortedNumeric(arr){
  return Array.from(new Set(arr)).map(num).filter(function(n){ return !isNaN(n); }).sort(function(a,b){ return a-b; }).map(String);
}
function fillSelect(sel, heads, rawHeads){
  let html = '<option value="">‚Äî choisir ‚Äî</option>';
  for(let i=0;i<heads.length;i++){
    html += '<option value="'+heads[i]+'">'+rawHeads[i]+'</option>';
  }
  sel.innerHTML = html;
}
function isActive(v){
  const s = String(v||'').trim().toLowerCase();
  if(s === '') return true; // vide = actif par d√©faut
  return ['true','1','oui','vrai','yes','y','x'].includes(s);
}

/* ==========================
   POPUP RAL (identique aux autres)
   ========================== */
const RAL_DATA = {
  satine: {
    "Blanc cass√©": ["1013"],
    "Blanc": ["9001","9002","9003","9018"],
    "Noir": ["9004","9005","9011"],
    "Gris": ["7001","7003","7004","7005","7006","7010","7011","7012","7013","7015","7016","7021","7022","7023","7024","7030","7031","7032","7033","7035","7036","7037","7038","7039","7040","7042","7043","7044","7046","7047"],
    "Brun": ["1247","8003","8004","8011","8012","8014","8016","8017","8019","8022","8025","8028"],
    "Vert": ["6005","6006","6019","6021"],
    "Ivoire": ["1014","1015"],
    "Beige": ["1001","1019"],
    "Rouge": ["3003","3004","3009","3011","3012"],
    "Bleu": ["5003","5008","5009","5014"]
  },
  brillante: {
    "Blanc": ["9001","9002","9003"],
    "Noir": ["9005"],
    "Gris": ["7001","7005","7006","7010","7011","7012","7015","7016","7021","7022","7024","7030","7031","7032","7035","7036","7037","7038","7039","7040","7042","7043","7047"],
    "Brun": ["8011","8014","8017","8019"],
    "Vert": ["6005","6021"],
    "Ivoire": ["1013","1015"],
    "Galet": ["9660"],
    "Jaune": ["1023"],
    "Rouge": ["3002","3003","3004","3020"],
    "Bleu": ["5002","5010","5017"]
  }
};

let ralFinish = "satine";
let ralToastTimer = null;

function ralNorm(s){
  return String(s||'').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'');
}

function setRalToast(msg){
  const el = document.getElementById("ralToast");
  if(!el) return;
  el.textContent = msg || "";
  clearTimeout(ralToastTimer);
  if(msg){
    ralToastTimer = setTimeout(()=>{ el.textContent=""; }, 1200);
  }
}

function renderRal(){
  const cont = document.getElementById("ralContent");
  if(!cont) return;

  const q = ralNorm((document.getElementById("ralSearch")?.value || "").trim());
  cont.innerHTML = "";

  const groups = RAL_DATA[ralFinish] || {};
  let any = false;

  Object.entries(groups).forEach(([family, codes])=>{
    const famNorm = ralNorm(family);
    const filtered = codes.filter(code=>{
      if(!q) return true;
      const codeStr = String(code);
      return famNorm.includes(q) || codeStr.includes(q) || (`ral ${codeStr}`).includes(q);
    });

    if(!filtered.length) return;
    any = true;

    const sec = document.createElement("section");
    sec.className = "ral-group";
    sec.innerHTML = `<h3>${family}</h3>`;

    const grid = document.createElement("div");
    grid.className = "ral-grid";

    filtered.forEach(code=>{
      const b = document.createElement("button");
      b.type = "button";
      b.className = "ral-chip";
      b.dataset.code = String(code);
      b.textContent = `RAL ${code}`;
      grid.appendChild(b);
    });

    sec.appendChild(grid);
    cont.appendChild(sec);
  });

  if(!any){
    cont.innerHTML = `<div class="ral-empty">Aucun r√©sultat pour cette recherche.</div>`;
  }
}

function openRalModal(){
  const modal = document.getElementById("ralModal");
  if(!modal) return;
  modal.classList.remove("hidden");
  document.documentElement.classList.add("ral-lock");
  document.body.classList.add("ral-lock");

  const s = document.getElementById("ralSearch");
  if(s){ s.value = ""; }

  renderRal();
  setRalToast("");
  setTimeout(()=>{ document.getElementById("ralSearch")?.focus(); }, 50);
}

function closeRalModal(){
  const modal = document.getElementById("ralModal");
  if(!modal) return;
  modal.classList.add("hidden");
  document.documentElement.classList.remove("ral-lock");
  document.body.classList.remove("ral-lock");
  setRalToast("");
}

function updateRalBtn(){
  const btn = document.getElementById("btnRal");
  if(!btn) return;

  // Sur Totem : bouton actif uniquement quand on est en ‚Äúpr√©-laquage‚Äù (donc Laquage RAL NON coch√©)
  const pre = document.getElementById('optPreLaque');
  const enabled = !!(pre && pre.checked && !(elOptRAL && elOptRAL.checked));

  btn.disabled = !enabled;
  btn.title = enabled
    ? "Voir les RAL disponibles en t√¥le pr√©-laqu√©e"
    : "Disponible uniquement quand le pr√©-laquage est actif (Laquage RAL d√©coch√©).";
}

function initRalModal(){
  const btn = document.getElementById("btnRal");
  const modal = document.getElementById("ralModal");
  const closeBtn = document.getElementById("ralClose");

  if(btn){
    btn.addEventListener("click", ()=>{
      if(btn.disabled) return;
      openRalModal();
    });
  }

  if(closeBtn) closeBtn.addEventListener("click", closeRalModal);

  if(modal){
    modal.addEventListener("click", (e)=>{
      const t = e.target;
      if(t && t.dataset && t.dataset.close === "1") closeRalModal();
    });
  }

  document.addEventListener("keydown", (e)=>{
    if(e.key === "Escape"){
      const m = document.getElementById("ralModal");
      if(m && !m.classList.contains("hidden")) closeRalModal();
    }
  });

  // Tabs
  document.querySelectorAll(".ral-tab").forEach(tab=>{
    tab.addEventListener("click", ()=>{
      document.querySelectorAll(".ral-tab").forEach(x=>{
        x.classList.remove("is-active");
        x.setAttribute("aria-selected","false");
      });
      tab.classList.add("is-active");
      tab.setAttribute("aria-selected","true");
      ralFinish = tab.dataset.finish || "satine";
      renderRal();
    });
  });

  // Search
  document.getElementById("ralSearch")?.addEventListener("input", renderRal);

  // Click chip => copie
  document.getElementById("ralContent")?.addEventListener("click", async (e)=>{
    const chip = e.target?.closest?.(".ral-chip");
    if(!chip) return;
    const txt = chip.textContent || "";
    try{
      await navigator.clipboard.writeText(txt);
      setRalToast(`‚úÖ ${txt} copi√©`);
    }catch(err){
      window.prompt("Copie ce RAL :", txt);
    }
  });

  updateRalBtn();
}

/* ------- AUTO-MAPPING ------- */
function keysExistIn(heads, keysObj){
  return Object.values(keysObj).every(function(k){ return heads.includes(k); });
}
function suggestMapTarifs(){
  if(keysExistIn(HEADS_T, MAP_T_DEFAULT)) { MAP_T = { ...MAP_T_DEFAULT }; return; }
  const f = function(re){ return HEADS_T.find(function(k){ return re.test(k); }); };
  MAP_T.type  = MAP_T.type  || f(/type/);
  MAP_T.h     = MAP_T.h     || f(/hauteur|height/);
  MAP_T.l     = MAP_T.l     || f(/largeur|width/);
  MAP_T.price = MAP_T.price || f(/prix|base|eur|ht/);
}
function suggestMapOptions(){
  if(keysExistIn(HEADS_O, MAP_O_DEFAULT)) { MAP_O = { ...MAP_O_DEFAULT }; return; }
  const f = function(re){ return HEADS_O.find(function(k){ return re.test(k); }); };
  MAP_O.type  = MAP_O.type  || f(/type|famille|option|libelle|designation/);
  MAP_O.hmin  = MAP_O.hmin  || f(/h(min|auteur.*min)|min.*h(auteur)?/);
  MAP_O.hmax  = MAP_O.hmax  || f(/h(max|auteur.*max)|max.*h(auteur)?/);
  MAP_O.price = MAP_O.price || f(/prix|ht|unitaire|price|pu/);
  MAP_O.actif = MAP_O.actif || f(/actif|active|isactive|true|oui|1|vrai|yes|enabled/);

  if(!MAP_O.type){
    const candidates = HEADS_O.filter(function(h){
      if(/(prix|ht|eur|price|pu|montant|hmin|hmax|min|max|hauteur|largeur|mm|cm|m)/.test(h)) return false;
      const values = RAW_OPTIONS.slice(0,20).map(function(r){ return String(r[h]||'').trim(); });
      const nonEmpty = values.filter(function(v){ return v!==''; });
      if(!nonEmpty.length) return false;
      const numish = nonEmpty.every(function(v){ return !isNaN(parseFloat(v.replace(',', '.'))); });
      if(numish) return false;
      const uniq = new Set(nonEmpty);
      return uniq.size <= 20;
    });
    if(candidates.length){ MAP_O.type = candidates[0]; }
  }
}

function applyTarifs(){
  if(!MAP_T.type || !MAP_T.h || !MAP_T.l || !MAP_T.price) return false;
  TARIFFS = RAW_TARIFFS.map(function(r){
    return {
      type: String(r[MAP_T.type] || '').trim(),
      h:    String(r[MAP_T.h]    || '').trim(),
      l:    String(r[MAP_T.l]    || '').trim(),
      priceBase: num(r[MAP_T.price]) || 0
    };
  }).filter(function(r){ return r.type && r.h && r.l; });
  const types = Array.from(new Set(TARIFFS.map(function(r){ return r.type; }))).sort();
  let html = '<option value="">‚Äî s√©lectionnez ‚Äî</option>';
  types.forEach(function(t){ html += '<option value="'+t+'">'+t+'</option>'; });
  elType.innerHTML = html;
  localStorage.setItem('MAP_T', JSON.stringify(MAP_T));
  try{
    const sigT = URL_TARIFS + '|' + HEADS_T.join('|');
    const dict = JSON.parse(localStorage.getItem('MAP_T_BY_SIG') || '{}');
    dict[sigT] = MAP_T; localStorage.setItem('MAP_T_BY_SIG', JSON.stringify(dict));
  }catch(_){ }
  return true;
}
function applyOptions(){
  if(!MAP_O.type || !MAP_O.price) return false;
  OPTIONS = RAW_OPTIONS.map(function(r){
    const hmin = MAP_O.hmin ? num(r[MAP_O.hmin]) : NaN;
    const hmax = MAP_O.hmax ? num(r[MAP_O.hmax]) : NaN;
    const actif = MAP_O.actif ? isActive(r[MAP_O.actif]) : true;
    return {
      typeOption: String(r[MAP_O.type] || '').trim(),
      hmin: hmin, hmax: hmax,
      priceUnit: num(r[MAP_O.price]),
      actif: actif
    };
  }).filter(function(o){ return o.typeOption && !isNaN(o.priceUnit); });
  localStorage.setItem('MAP_O', JSON.stringify(MAP_O));
  try{
    const sigO = URL_OPTIONS + '|' + HEADS_O.join('|');
    const dict = JSON.parse(localStorage.getItem('MAP_O_BY_SIG') || '{}');
    dict[sigO] = MAP_O; localStorage.setItem('MAP_O_BY_SIG', JSON.stringify(dict));
  }catch(_){ }
  return true;
}

/* ------- UI ------- */
function populateHL(){
  const t = elType.value;
  const filtered = TARIFFS.filter(function(r){ return r.type === t; });
  const H = uniqueSortedNumeric(filtered.map(function(r){ return r.h; }));
  const L = uniqueSortedNumeric(filtered.map(function(r){ return r.l; }));

  var htmlH = '<option value="">‚Äî s√©lectionnez ‚Äî</option>';
  H.forEach(function(v){ htmlH += '<option value="'+v+'">'+v+'</option>'; });
  elH.innerHTML = htmlH;

  var htmlL = '<option value="">‚Äî s√©lectionnez ‚Äî</option>';
  L.forEach(function(v){ htmlL += '<option value="'+v+'">'+v+'</option>'; });
  elL.innerHTML = htmlL;

  updateLevageNote();
  updateRALState();
}
function renderOptionsCheckboxes(){
  const families = Array.from(new Set(OPTIONS.map(function(o){ return o.typeOption; }))).filter(Boolean).sort();
  if(!families.length){
    elOptsBox.innerHTML = '<div class="opt-row"><em>Aucune option disponible.</em></div>';
    updateRALState();
    return;
  }
  const h = num(elH.value);
  const isValid = function(fam){
    if(!h) return false;
    const rows = OPTIONS.filter(function(o){ return o.typeOption===fam && o.actif; });
    if(!rows.length) return false;
    return rows.some(function(o){ return (isNaN(o.hmin) || h>=o.hmin) && (isNaN(o.hmax) || h<=o.hmax); });
  };
  elOptsBox.innerHTML = families.map(function(f){
    const ok = isValid(f);
    const note = ok ? '' : ' <span class="note">(non dispo pour H='+(elH.value||'‚Äî')+')</span>';
    return ''
      + '<label class="opt-row">'
      +   '<input type="checkbox" name="opt" value="'+f.replace(/"/g,'&quot;')+'" '+(ok?'':'disabled')+'>'
      +   '<span>'+f+'</span>'+note
      + '</label>';
  }).join('');

  Array.prototype.slice.call(elOptsBox.querySelectorAll('input[name="opt"]')).forEach(function(cb){
    cb.addEventListener('change', compute);
  });

  // ‚Äî‚Äî R√®gle m√©tier : "Panier de crosses" implique automatiquement "Platine"
  var inputs = Array.prototype.slice.call(elOptsBox.querySelectorAll('input[name="opt"]'));
  function _normOptLabel(s){ return String(s||'').toLowerCase().normalize('NFD').replace(/[ÃÄ-ÕØ]/g,''); }
  var cbPlatine = inputs.find(function(i){ return _normOptLabel(i.value).includes('platine'); });
  var cbPanier  = inputs.find(function(i){ var v=_normOptLabel(i.value); return v.includes('panier') && (v.includes('crosse')||v.includes('crosses')); });

  if(cbPanier){
    cbPanier.addEventListener('change', function(){
      if(cbPanier.checked){
        if(cbPlatine && !cbPlatine.disabled){
          cbPlatine.checked = true;
          cbPlatine.dispatchEvent(new Event('change'));
        }else if(cbPlatine && cbPlatine.disabled){
          cbPanier.checked = false;
          alert('Le panier de crosses n√©cessite la platine.');
        }
      }
    });
  }
  if(cbPlatine){
    cbPlatine.addEventListener('change', function(){
      if(!cbPlatine.checked && cbPanier && cbPanier.checked){
        cbPanier.checked = false;
        cbPanier.dispatchEvent(new Event('change'));
      }
    });
  }

  if(!h){
    elMsg.textContent = 'Choisis d‚Äôabord la hauteur pour activer les options.';
  }else{
    var valides = families.filter(function(f){
      var sel = 'input[name="opt"][value="'+f.replace(/"/g,'\\"')+'"]';
      var input = elOptsBox.querySelector(sel);
      return input && !input.disabled;
    });
    elMsg.textContent = 'Hauteur s√©lectionn√©e: ' + elH.value + ' | Options valides: ' + (valides.join(', ') || 'aucune');
  }
  updateRALState();
}

/* ------- NOTE ANNEAU DE LEVAGE ------- */
function updateLevageNote(){
  const h = num(elH.value);
  if(h && h >= 3500){
    elLevage.style.display = 'block';
    elLevage.textContent = '‚ÑπÔ∏è Pour H ‚â• 3500 mm : un anneau de levage est inclus.';
  }else{
    elLevage.style.display = 'none';
    elLevage.textContent = '';
  }
}

/* ------- LAQUAGE RAL (PUBLIC) ------- */
function area2FacesM2(){
  const h = num(elH.value), l = num(elL.value);
  if(!h || !l) return 0;
  const perFace = (h * l) / 1000000; // m¬≤
  return perFace * 2; // 2 faces
}
function updateRALState(){
  const enabled = !!(num(elH.value) && num(elL.value));

  // --- Laquage RAL ---
  elOptRAL.disabled = !enabled;
  if(!enabled) elOptRAL.checked = false;

  // --- Laquage pieds ---
  const elPieds = document.getElementById('optPieds');
  elPieds.disabled = !enabled;
  if(!enabled) elPieds.checked = false;

  updateRalBtn();
}

/* ------- CALCUL ------- */
function priceBase(){
  const t = elType.value; const h = num(elH.value); const l = num(elL.value);
  if(!t||!h||!l) return 0;
  const row = TARIFFS.find(function(r){ return r.type===t && Math.abs(num(r.h)-h)<0.001 && Math.abs(num(r.l)-l)<0.001; });
  return row ? row.priceBase : 0; // interne
}
function priceOptionsSum(){
  const checked = Array.prototype.slice.call(elOptsBox.querySelectorAll('input[name="opt"]:checked')).map(function(c){ return c.value; });
  if(!checked.length) return 0;
  const h = num(elH.value);
  return checked.reduce(function(sum, fam){
    const rows = OPTIONS.filter(function(o){
      return o.typeOption===fam && o.actif && (isNaN(o.hmin) || h>=o.hmin) && (isNaN(o.hmax) || h<=o.hmax);
    });
    if(!rows.length) return sum;
    const units = rows.map(function(o){ return o.priceUnit; }).filter(function(v){ return !isNaN(v); });
    const unit = units.length ? Math.max.apply(null, units) : NaN;
    return sum + (isFinite(unit)?unit:0);
  }, 0); // interne
}
function compute(){
  // === Remise automatique client ===
  let remiseClient = 1;
  try {
      const p = JSON.parse(localStorage.getItem('cofel_client_profile'));
      if (p && typeof p.discountRate === 'number') remiseClient = 1 - p.discountRate;
  } catch(e){}

  const base_interne = priceBase();
  const opt_interne  = priceOptionsSum();
  const qte  = Math.max(1, parseInt(elQte.value||'1',10));

  // === COEF TARIF PUBLIC COFEL ===
  const COEF_PUBLIC = 2;

  // === BASE INTERNE ===
  const unit_interne = base_interne + opt_interne;

  // === PRIX PUBLIC AVANT REMISE ===
  const unit_public_base = unit_interne * COEF_PUBLIC;

  // === OPTIONS D√âJ√Ä EN PUBLIC ===
  const ral_public_unit = elOptRAL.checked
    ? (area2FacesM2() * RAL_PRICE_PUBLIC_M2)
    : 0;

  const pieds_public_unit = document.getElementById('optPieds').checked ? 35 : 0;

  // === PRIX NET CLIENT ===
  const unit_public_total =
    (unit_public_base + ral_public_unit + pieds_public_unit) * remiseClient;

  const totalHT_pub  = unit_public_total * qte;
  const totalTTC_pub = totalHT_pub * (1+TVA);

  elHT.textContent  = totalHT_pub.toFixed(2).replace('.', ',');
  elTTC.textContent = totalTTC_pub.toFixed(2).replace('.', ',');

  updateRalBtn();
}

/* ------- CHARGEMENT ------- */
async function loadAll(){
  try{
    const rt = await fetch(URL_TARIFS);
    const ro = await fetch(URL_OPTIONS);
    if(!rt.ok || !ro.ok) throw new Error('Chargement r√©seau impossible (CSV).');
    const txtT = await rt.text();
    const txtO = await ro.text();
    const pT = parseCSVAuto(txtT); const pO = parseCSVAuto(txtO);
    RAW_TARIFFS = pT.rows; RAW_HEADERS_T = pT.rawHeads; HEADS_T = pT.heads;
    RAW_OPTIONS = pO.rows; RAW_HEADERS_O = pO.rawHeads; HEADS_O = pO.heads;

    const sigT = URL_TARIFS  + '|' + HEADS_T.join('|');
    const sigO = URL_OPTIONS + '|' + HEADS_O.join('|');
    const savedBySigT = JSON.parse(localStorage.getItem('MAP_T_BY_SIG') || '{}');
    const savedBySigO = JSON.parse(localStorage.getItem('MAP_O_BY_SIG') || '{}');
    MAP_T = savedBySigT[sigT] || MAP_T || { ...MAP_T_DEFAULT };
    MAP_O = savedBySigO[sigO] || MAP_O || { ...MAP_O_DEFAULT };

    suggestMapTarifs(); suggestMapOptions();

    const mapTarifsBox  = document.getElementById('mapTarifsBox');
    const mapOptionsBox = document.getElementById('mapOptionsBox');

    const setSel = function(id, heads, raws, val){
      const el = document.getElementById(id);
      fillSelect(el, heads, raws);
      if(val) el.value = val;
      return el;
    };
    const sTtype  = setSel('mapT_Type',  HEADS_T, RAW_HEADERS_T, MAP_T.type);
    const sTh     = setSel('mapT_H',     HEADS_T, RAW_HEADERS_T, MAP_T.h);
    const sTl     = setSel('mapT_L',     HEADS_T, RAW_HEADERS_T, MAP_T.l);
    const sTprice = setSel('mapT_Price', HEADS_T, RAW_HEADERS_T, MAP_T.price);
    const sOtype  = setSel('mapO_Type',  HEADS_O, RAW_HEADERS_O, MAP_O.type);
    const sOhmin  = setSel('mapO_HMin',  HEADS_O, RAW_HEADERS_O, MAP_O.hmin);
    const sOhmax  = setSel('mapO_HMax',  HEADS_O, RAW_HEADERS_O, MAP_O.hmax);
    const sOprice = setSel('mapO_Price', HEADS_O, RAW_HEADERS_O, MAP_O.price);
    const sOactif = setSel('mapO_Actif', HEADS_O, RAW_HEADERS_O, MAP_O.actif);

    let okT=false, okO=false;
    if(MAP_T.type && MAP_T.h && MAP_T.l && MAP_T.price) okT=applyTarifs();
    if(MAP_O.type && MAP_O.hmin && MAP_O.hmax && MAP_O.price && MAP_O.actif) okO=applyOptions();

    mapTarifsBox.style.display  = (okT ? 'none' : 'block');
    mapOptionsBox.style.display = (okO ? 'none' : 'block');

    document.getElementById('applyMapTarifs').onclick=function(){
      MAP_T.type=sTtype.value||null; MAP_T.h=sTh.value||null; MAP_T.l=sTl.value||null; MAP_T.price=sTprice.value||null;
      if(applyTarifs()){ mapTarifsBox.style.display='none'; populateHL(); compute(); }
      else alert('Merci de s√©lectionner les 4 colonnes TARIFS.');
    };
    document.getElementById('applyMapOptions').onclick=function(){
      MAP_O.type=sOtype.value||null; MAP_O.hmin=sOhmin.value||null; MAP_O.hmax=sOhmax.value||null; MAP_O.price=sOprice.value||null; MAP_O.actif=sOactif.value||null;
      if(applyOptions()){ mapOptionsBox.style.display='none'; renderOptionsCheckboxes(); compute(); }
      else alert('Merci de s√©lectionner les 5 colonnes OPTIONS.');
    };

    elType.addEventListener('change', function(){ populateHL(); renderOptionsCheckboxes(); compute(); });
    elH.addEventListener('change',   function(){ renderOptionsCheckboxes(); updateRALState(); updateLevageNote(); compute(); });
    elL.addEventListener('change',   function(){ updateRALState(); compute(); });
    elQte.addEventListener('input', compute);
    elOptRAL.addEventListener('change', compute);
    document.getElementById('optPieds').addEventListener('change', compute);

    // --- Synchronisation Pr√©-laquage <-> RAL ---
    elOptRAL.addEventListener('change', function(){
      const pre = document.getElementById('optPreLaque');
      if (elOptRAL.checked) {
        pre.checked = false;   // si RAL ‚Üí on retire pr√©-laquage
      } else {
        pre.checked = true;    // si RAL d√©coch√© ‚Üí pr√©-laquage revient
      }
      updateRalBtn();
      compute();
    });

    elMsg.textContent = 'Donn√©es charg√©es.\nEn-t√™tes TARIFS : ' + RAW_HEADERS_T.join(' | ') + '\nEn-t√™tes OPTIONS : ' + RAW_HEADERS_O.join(' | ');

    if(okT && okO){ populateHL(); renderOptionsCheckboxes(); compute(); }
    updateRalBtn();
  }catch(e){
    elMsg.textContent = 'Erreur de chargement : ' + e.message;
    console.error(e);
  }
}
initRalModal();
loadAll();

/* ====== TESTS L√âGERS (console) ====== */
(function runParseTests(){
  try{
    const lf = 'A,B,C\n1,2,3\n4,5,6';
    const crlf = 'A;B;C\r\n1;2;3\r\n4;5;6';
    const one = '"A","B","C","1","2","3","4","5","6"';
    const r1 = parseCSVAuto(lf);
    const r2 = parseCSVAuto(crlf);
    const r3 = parseCSVAuto(one);
    console.log('[TEST] LF heads/rows:', r1.heads, r1.rows.length);
    console.log('[TEST] CRLF heads/rows:', r2.heads, r2.rows.length);
    console.log('[TEST] ONE-LINE heads/rows:', r3.heads, r3.rows.length);
  }catch(e){ console.warn('[TEST] parseCSVAuto error:', e); }
})();
</script>

<script src="../js/devis-core.js"></script>
<script>
(function(){
  const btn = document.getElementById('btnAddDevis'); if(!btn) return;
  function parseHTPublic(){
    const t = (document.getElementById('prixHT').innerText || '0').trim();
    return Number(t.replace(/\s/g,'').replace(',', '.')) || 0;
  }
  function selectedOptionsList(){
    const cbs = Array.prototype.slice.call(document.querySelectorAll('#optionsBox input[name="opt"]:checked'));
    return cbs.map(function(cb){ return cb.value; });
  }
  btn.addEventListener('click', function(){
    try{
      if(!window.Devis) throw new Error('Moteur de devis introuvable.');
      const typeFace = document.getElementById('type').value || '';
      const H = document.getElementById('hauteur').value || '';
      const L = document.getElementById('largeur').value || '';
      const qte = Math.max(1, parseInt(document.getElementById('quantite').value||'1',10));
      if(!typeFace || !H || !L){ alert('Merci de s√©lectionner le type de face, la hauteur et la largeur.'); return; }
      const total_ht_public = parseHTPublic(); if(total_ht_public <= 0){ alert('Le total est √† 0, v√©rifie la configuration.'); return; }
      const pu_public_ht = Number((total_ht_public / qte).toFixed(2));

      const opts = selectedOptionsList();
      const ralChecked = document.getElementById('optRAL') && document.getElementById('optRAL').checked;
      if(ralChecked) opts.push('Laquage au RAL');

      const parts = ['Totem', typeFace, 'H ' + H + ' mm √ó L ' + L + ' mm', opts.length ? 'Options: ' + opts.join(', ') : null];
      const designation = parts.filter(Boolean).join(' ‚Äî ');

      Devis.addLine({ type: 'Totem', designation: designation, quantite: qte, pu_public_ht: pu_public_ht });
      alert('‚úÖ Ligne ajout√©e au devis !\n' + designation + '\nQt√© : ' + qte + '\nPU HT : ' + pu_public_ht.toFixed(2) + ' ‚Ç¨');
    }catch(err){
      console.error(err);
      alert('Erreur lors de l‚Äôajout au devis : ' + err.message);
    }
  });
})();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Configurateur ‚Äî Totems Cofel (auto-mapping)</title>

<link rel="stylesheet" href="../styles/cofel.css">
<link rel="stylesheet" href="../styles/cofel-components.css">
<link rel="stylesheet" href="../styles/cofel-glass.css">


</head>
<body>
<header class="cofel-header">
  <div class="row">
    <a class="cofel-back" href="../index.html">‚¨Ö Retour accueil (devis)</a>
    <div class="cofel-brand">
      <img src="../assets/logo cofel.jpg" alt="Cofel" />
      <h1 class="cofel-title">Configurateur ‚Äî Totems</h1>
    </div>
  </div>
</header>

<div class="cofel-container">
    <div class="wrap">

    <!-- ===== MAPPAGE TARIFS ===== -->
    <div id="mapTarifsBox" class="mapping" style="display:none">
      <h3>üìÑ Mappage des colonnes TARIFS</h3>
      <div class="two">
        <div>
          <label>Colonne ‚ÄúType de face‚Äù</label>
          <select id="mapT_Type"></select>
        </div>
        <div>
          <label>Colonne ‚ÄúPrix base HT‚Äù</label>
          <select id="mapT_Price"></select>
        </div>
        <div>
          <label>Colonne ‚ÄúHauteur (mm)‚Äù</label>
          <select id="mapT_H"></select>
        </div>
        <div>
          <label>Colonne ‚ÄúLargeur (mm)‚Äù</label>
          <select id="mapT_L"></select>
        </div>
      </div>
      <button id="applyMapTarifs" class="pill">Appliquer le mappage TARIFS</button>
    </div>

    <!-- ===== MAPPAGE OPTIONS ===== -->
    <div id="mapOptionsBox" class="mapping" style="display:none">
      <h3>üß© Mappage des colonnes OPTIONS</h3>
      <div class="two">
        <div>
          <label>Colonne ‚ÄúType d‚Äôoption‚Äù (Platine / Panier de crosses)</label>
          <select id="mapO_Type"></select>
        </div>
        <div>
          <label>Colonne ‚ÄúPrix unitaire HT‚Äù</label>
          <select id="mapO_Price"></select>
        </div>
        <div>
          <label>Colonne ‚ÄúHauteur min (mm)‚Äù</label>
          <select id="mapO_HMin"></select>
        </div>
        <div>
          <label>Colonne ‚ÄúHauteur max (mm)‚Äù</label>
          <select id="mapO_HMax"></select>
        </div>
        <div>
          <label>Colonne ‚ÄúActif‚Äù (Oui/True/1)</label>
          <select id="mapO_Actif"></select>
        </div>
      </div>
      <button id="applyMapOptions" class="pill">Appliquer le mappage OPTIONS</button>
    </div>

    <!-- ===== UI CONFIG ===== -->
    <fieldset>
      <legend>Configuration</legend>
      <label for="type">Type de face</label>
      <select id="type"><option value="">‚Äî s√©lectionnez ‚Äî</option></select>

      <div class="grid">
        <div>
          <label for="hauteur">Hauteur (mm)</label>
          <select id="hauteur"><option value="">‚Äî s√©lectionnez ‚Äî</option></select>
          <!-- ‚úÖ Note anneau de levage -->
          <div id="levageMsg" class="muted" style="display:none;margin-top:6px">‚ÑπÔ∏è Pour H ‚â• 3500 mm : un anneau de levage est inclus.</div>
        </div>
        <div>
          <label for="largeur">Largeur (mm)</label>
          <select id="largeur"><option value="">‚Äî s√©lectionnez ‚Äî</option></select>
        </div>
      </div>

      <label>Options (multi-choix)</label>
      <div id="optionsBox" class="options-wrap">
        <div class="opt-row"><em>Aucune option disponible tant que la hauteur n‚Äôest pas choisie.</em></div>
      </div>

      <!-- ====== OPTIONS FIXES ====== -->
<div class="opt-row" id="fixedOptions" style="display:flex;gap:20px;flex-wrap:wrap">

  <!-- Pr√©-laquage (toujours inclus, donc d√©coch√© mais gris√©) -->
  <label style="display:flex;align-items:center;gap:6px;margin:0;opacity:.7">
    <input type="checkbox" id="optPreLaque" checked disabled />
    <span>Pr√©-laquage (inclus)</span>
  </label>

  <!-- Laquage RAL -->
  <label style="display:flex;align-items:center;gap:6px;margin:0">
    <input type="checkbox" id="optRAL" disabled />
    <span>Laquage RAL</span>
  </label>

  <!-- Laquage des pieds -->
  <label style="display:flex;align-items:center;gap:6px;margin:0">
    <input type="checkbox" id="optPieds" disabled />
    <span>Laquage pieds du totem</span>
  </label>

</div>


      <label for="quantite">Quantit√©</label>
      <input type="number" id="quantite" value="1" min="1"/>
    </fieldset>

    <!-- ===== R√©sultats ===== -->
    <div class="result">
      <p>Prix HT : <span id="prixHT">0,00</span> ‚Ç¨</p>
      <p>Prix TTC : <span id="prixTTC">0,00</span> ‚Ç¨</p>
    </div>
<div class="cofel-actions">
  <button id="btnAddDevis" class="cofel-fab">
    ‚ûï Ajouter au devis
  </button>
</div>

    <div id="msg" class="muted"></div>
  </div>
</div>

<footer class="cofel-footer">
  ¬© Cofel ‚Äî ZA du Perquoi, 72560 Chang√© ‚Äî SIRET 927 659 458 00024 ‚Äî TVA FR80927659458
</footer>

<script>
/* ------- CONFIG ------- */
const URL_TARIFS  = "https://raw.githubusercontent.com/stevens-cofel/configurateur-cofel/refs/heads/main/Tarifs_Totems_.csv";
const URL_OPTIONS = "https://raw.githubusercontent.com/stevens-cofel/configurateur-cofel/refs/heads/main/option%20platine%20et%20panier%20de%20crosses%20(1).csv";
const TVA = 0.20;
const RAL_PRICE_PUBLIC_M2 = 112; // ‚úÖ d√©j√† prix PUBLIC (x2 inclus)

/* ------- STATE ------- */
let RAW_TARIFFS = []; let RAW_OPTIONS = [];
let RAW_HEADERS_T = []; let RAW_HEADERS_O = [];
let HEADS_T = []; let HEADS_O = []; let TARIFFS = []; let OPTIONS = [];

// === D√©fauts bas√©s sur normalizeKey() des CSV actuels
const MAP_T_DEFAULT = { type:'forme', h:'hauteurmm', l:'largeurmm', price:'prixbaseeur' };
const MAP_O_DEFAULT = { type:'typedoption', hmin:'hauteurminmm', hmax:'hauteurmaxmm', price:'prixunitaireht', actif:'actif' };

let MAP_T = JSON.parse(localStorage.getItem('MAP_T') || 'null') || { ...MAP_T_DEFAULT };
let MAP_O = JSON.parse(localStorage.getItem('MAP_O') || 'null') || { ...MAP_O_DEFAULT };

/* ------- ELEMENTS ------- */
const elType = document.getElementById('type');
const elH    = document.getElementById('hauteur');
const elL    = document.getElementById('largeur');
const elOptsBox = document.getElementById('optionsBox');
const elQte  = document.getElementById('quantite');
const elHT   = document.getElementById('prixHT');
const elTTC  = document.getElementById('prixTTC');
const elMsg  = document.getElementById('msg');
const elOptRAL = document.getElementById('optRAL');
const elRalNote = document.getElementById('ralNote');
const elLevage = document.getElementById('levageMsg');

/* ------- HELPERS ------- */
function num(v){
  const s = String(v == null ? '' : v).replace(/\u202F/g,'').replace(/\s/g,'').replace(',', '.');
  const m = s.match(/-?\d+(\.\d+)?/);
  return m ? parseFloat(m[0]) : NaN;
}
function normalizeKey(k){
  return String(k||'').toLowerCase()
    .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
    .replace(/[^a-z0-9]+/g,'').trim();
}
function csvSplit(line, sep){
  const out = []; let cur = ''; let inQ = false;
  for(let i=0;i<line.length;i++){
    const ch = line[i];
    if(ch === '"'){
      if(inQ && line[i+1] === '"'){ cur += '"'; i++; continue; }
      inQ = !inQ; continue;
    }
    if(ch === sep && !inQ){ out.push(cur); cur=''; continue; }
    cur += ch;
  }
  out.push(cur);
  return out.map(function(c){ return c.trim(); });
}
function parseCSVAuto(text){
  text = text.replace(/^\uFEFF/, '').trim();
  let lines = text.split(/[\r\n]+/).filter(function(l){ return l.trim().length>0; });

  let rawHeads = [], heads = [], rows = [];

  if(lines.length > 1){
    const first = lines[0];
    const sep = ((first.match(/;/g)||[]).length > (first.match(/,/g)||[]).length) ? ';' : ',';
    rawHeads = csvSplit(first, sep);
    heads = rawHeads.map(function(h){ return normalizeKey(h.replace(/^"+|"+$/g,'')); });
    rows = lines.slice(1).map(function(line){
      const cells = csvSplit(line, sep).map(function(c){ return c.replace(/^"+|"+$/g,''); });
      const o={}; heads.forEach(function(h,i){ o[h]=cells[i] == null ? '' : cells[i]; }); return o;
    });
    return { rows: rows, rawHeads: rawHeads, heads: heads };
  }

  if(lines.length === 1){
    const chunk = lines[0];
    const sep = ((chunk.match(/;/g)||[]).length > (chunk.match(/,/g)||[]).length) ? ';' : ',';
    let fields = [];
    if(chunk.includes(sep)){
      fields = csvSplit(chunk, sep);
    }else{
      const re = /"([^\"]*)"/g; let m; while((m = re.exec(chunk))){ fields.push(m[1]); }
    }
    if(fields.length < 4){ return { rows:[], rawHeads:[], heads:[] }; }
    rawHeads = fields.slice(0,5);
    heads    = rawHeads.map(function(h){ return normalizeKey(h); });
    const nCols = rawHeads.length;
    const data = fields.slice(nCols);
    for(let i=0;i<data.length;i+=nCols){
      const rec = data.slice(i,i+nCols);
      if(rec.length===nCols){ const o={}; heads.forEach(function(h,idx){ o[h]=rec[idx] == null ? '' : rec[idx]; }); rows.push(o); }
    }
    return { rows: rows, rawHeads: rawHeads, heads: heads };
  }

  return { rows:[], rawHeads:[], heads:[] };
}
function uniqueSortedNumeric(arr){
  return Array.from(new Set(arr)).map(num).filter(function(n){ return !isNaN(n); }).sort(function(a,b){ return a-b; }).map(String);
}
function fillSelect(sel, heads, rawHeads){
  let html = '<option value="">‚Äî choisir ‚Äî</option>';
  for(let i=0;i<heads.length;i++){
    html += '<option value="'+heads[i]+'">'+rawHeads[i]+'</option>';
  }
  sel.innerHTML = html;
}
function isActive(v){
  const s = String(v||'').trim().toLowerCase();
  if(s === '') return true; // vide = actif par d√©faut
  return ['true','1','oui','vrai','yes','y','x'].includes(s);
}

/* ------- AUTO-MAPPING ------- */
function keysExistIn(heads, keysObj){
  return Object.values(keysObj).every(function(k){ return heads.includes(k); });
}
function suggestMapTarifs(){
  if(keysExistIn(HEADS_T, MAP_T_DEFAULT)) { MAP_T = { ...MAP_T_DEFAULT }; return; }
  const f = function(re){ return HEADS_T.find(function(k){ return re.test(k); }); };
  MAP_T.type  = MAP_T.type  || f(/type/);
  MAP_T.h     = MAP_T.h     || f(/hauteur|height/);
  MAP_T.l     = MAP_T.l     || f(/largeur|width/);
  MAP_T.price = MAP_T.price || f(/prix|base|eur|ht/);
}
function suggestMapOptions(){
  if(keysExistIn(HEADS_O, MAP_O_DEFAULT)) { MAP_O = { ...MAP_O_DEFAULT }; return; }
  const f = function(re){ return HEADS_O.find(function(k){ return re.test(k); }); };
  MAP_O.type  = MAP_O.type  || f(/type|famille|option|libelle|designation/);
  MAP_O.hmin  = MAP_O.hmin  || f(/h(min|auteur.*min)|min.*h(auteur)?/);
  MAP_O.hmax  = MAP_O.hmax  || f(/h(max|auteur.*max)|max.*h(auteur)?/);
  MAP_O.price = MAP_O.price || f(/prix|ht|unitaire|price|pu/);
  MAP_O.actif = MAP_O.actif || f(/actif|active|isactive|true|oui|1|vrai|yes|enabled/);

  if(!MAP_O.type){
    const candidates = HEADS_O.filter(function(h){
      if(/(prix|ht|eur|price|pu|montant|hmin|hmax|min|max|hauteur|largeur|mm|cm|m)/.test(h)) return false;
      const values = RAW_OPTIONS.slice(0,20).map(function(r){ return String(r[h]||'').trim(); });
      const nonEmpty = values.filter(function(v){ return v!==''; });
      if(!nonEmpty.length) return false;
      const numish = nonEmpty.every(function(v){ return !isNaN(parseFloat(v.replace(',', '.'))); });
      if(numish) return false;
      const uniq = new Set(nonEmpty);
      return uniq.size <= 20;
    });
    if(candidates.length){ MAP_O.type = candidates[0]; }
  }
}

function applyTarifs(){
  if(!MAP_T.type || !MAP_T.h || !MAP_T.l || !MAP_T.price) return false;
  TARIFFS = RAW_TARIFFS.map(function(r){
    return {
      type: String(r[MAP_T.type] || '').trim(),
      h:    String(r[MAP_T.h]    || '').trim(),
      l:    String(r[MAP_T.l]    || '').trim(),
      priceBase: num(r[MAP_T.price]) || 0
    };
  }).filter(function(r){ return r.type && r.h && r.l; });
  const types = Array.from(new Set(TARIFFS.map(function(r){ return r.type; }))).sort();
  let html = '<option value="">‚Äî s√©lectionnez ‚Äî</option>';
  types.forEach(function(t){ html += '<option value="'+t+'">'+t+'</option>'; });
  elType.innerHTML = html;
  localStorage.setItem('MAP_T', JSON.stringify(MAP_T));
  try{
    const sigT = URL_TARIFS + '|' + HEADS_T.join('|');
    const dict = JSON.parse(localStorage.getItem('MAP_T_BY_SIG') || '{}');
    dict[sigT] = MAP_T; localStorage.setItem('MAP_T_BY_SIG', JSON.stringify(dict));
  }catch(_){ }
  return true;
}
function applyOptions(){
  if(!MAP_O.type || !MAP_O.price) return false;
  OPTIONS = RAW_OPTIONS.map(function(r){
    const hmin = MAP_O.hmin ? num(r[MAP_O.hmin]) : NaN;
    const hmax = MAP_O.hmax ? num(r[MAP_O.hmax]) : NaN;
    const actif = MAP_O.actif ? isActive(r[MAP_O.actif]) : true;
    return {
      typeOption: String(r[MAP_O.type] || '').trim(),
      hmin: hmin, hmax: hmax,
      priceUnit: num(r[MAP_O.price]),
      actif: actif
    };
  }).filter(function(o){ return o.typeOption && !isNaN(o.priceUnit); });
  localStorage.setItem('MAP_O', JSON.stringify(MAP_O));
  try{
    const sigO = URL_OPTIONS + '|' + HEADS_O.join('|');
    const dict = JSON.parse(localStorage.getItem('MAP_O_BY_SIG') || '{}');
    dict[sigO] = MAP_O; localStorage.setItem('MAP_O_BY_SIG', JSON.stringify(dict));
  }catch(_){ }
  return true;
}

/* ------- UI ------- */
function populateHL(){
  const t = elType.value;
  const filtered = TARIFFS.filter(function(r){ return r.type === t; });
  const H = uniqueSortedNumeric(filtered.map(function(r){ return r.h; }));
  const L = uniqueSortedNumeric(filtered.map(function(r){ return r.l; }));

  var htmlH = '<option value="">‚Äî s√©lectionnez ‚Äî</option>';
  H.forEach(function(v){ htmlH += '<option value="'+v+'">'+v+'</option>'; });
  elH.innerHTML = htmlH;

  var htmlL = '<option value="">‚Äî s√©lectionnez ‚Äî</option>';
  L.forEach(function(v){ htmlL += '<option value="'+v+'">'+v+'</option>'; });
  elL.innerHTML = htmlL;

  updateLevageNote();
  updateRALState();
}
function renderOptionsCheckboxes(){
  const families = Array.from(new Set(OPTIONS.map(function(o){ return o.typeOption; }))).filter(Boolean).sort();
  if(!families.length){
    elOptsBox.innerHTML = '<div class="opt-row"><em>Aucune option disponible.</em></div>';
    updateRALState();
    return;
  }
  const h = num(elH.value);
  const isValid = function(fam){
    if(!h) return false;
    const rows = OPTIONS.filter(function(o){ return o.typeOption===fam && o.actif; });
    if(!rows.length) return false;
    return rows.some(function(o){ return (isNaN(o.hmin) || h>=o.hmin) && (isNaN(o.hmax) || h<=o.hmax); });
  };
  elOptsBox.innerHTML = families.map(function(f){
    const ok = isValid(f);
    const note = ok ? '' : ' <span class="note">(non dispo pour H='+(elH.value||'‚Äî')+')</span>';
    return ''
      + '<label class="opt-row">'
      +   '<input type="checkbox" name="opt" value="'+f.replace(/"/g,'&quot;')+'" '+(ok?'':'disabled')+'>'
      +   '<span>'+f+'</span>'+note
      + '</label>';
  }).join('');

  Array.prototype.slice.call(elOptsBox.querySelectorAll('input[name="opt"]')).forEach(function(cb){
    cb.addEventListener('change', compute);
  });

  // ‚Äî‚Äî R√®gle m√©tier : "Panier de crosses" implique automatiquement "Platine"
  var inputs = Array.prototype.slice.call(elOptsBox.querySelectorAll('input[name="opt"]'));
  function _normOptLabel(s){ return String(s||'').toLowerCase().normalize('NFD').replace(/[ÃÄ-ÕØ]/g,''); }
  var cbPlatine = inputs.find(function(i){ return _normOptLabel(i.value).includes('platine'); });
  var cbPanier  = inputs.find(function(i){ var v=_normOptLabel(i.value); return v.includes('panier') && (v.includes('crosse')||v.includes('crosses')); });

  if(cbPanier){
    cbPanier.addEventListener('change', function(){
      if(cbPanier.checked){
        if(cbPlatine && !cbPlatine.disabled){
          cbPlatine.checked = true;
          cbPlatine.dispatchEvent(new Event('change'));
        }else if(cbPlatine && cbPlatine.disabled){
          // Platine indisponible ‚Üí on emp√™che le panier
          cbPanier.checked = false;
          alert('Le panier de crosses n√©cessite la platine.');
        }
      }
    });
  }
  if(cbPlatine){
    cbPlatine.addEventListener('change', function(){
      if(!cbPlatine.checked && cbPanier && cbPanier.checked){
        cbPanier.checked = false;
        cbPanier.dispatchEvent(new Event('change'));
      }
    });
  }

  if(!h){
    elMsg.textContent = 'Choisis d‚Äôabord la hauteur pour activer les options.';
  }else{
    var valides = families.filter(function(f){
      var sel = 'input[name="opt"][value="'+f.replace(/"/g,'\\"')+'"]';
      var input = elOptsBox.querySelector(sel);
      return input && !input.disabled;
    });
    elMsg.textContent = 'Hauteur s√©lectionn√©e: ' + elH.value + ' | Options valides: ' + (valides.join(', ') || 'aucune');
  }
  updateRALState();
}

/* ------- NOTE ANNEAU DE LEVAGE ------- */
function updateLevageNote(){
  const h = num(elH.value);
  if(h && h >= 3500){
    elLevage.style.display = 'block';
    elLevage.textContent = '‚ÑπÔ∏è Pour H ‚â• 3500 mm : un anneau de levage est inclus.';
  }else{
    elLevage.style.display = 'none';
    elLevage.textContent = '';
  }
}

/* ------- LAQUAGE RAL (PUBLIC) ------- */
function area2FacesM2(){
  const h = num(elH.value), l = num(elL.value);
  if(!h || !l) return 0;
  const perFace = (h * l) / 1000000; // m¬≤
  return perFace * 2; // 2 faces
}
function updateRALState(){
  const enabled = !!(num(elH.value) && num(elL.value));

  // --- Laquage RAL ---
  elOptRAL.disabled = !enabled;
  if(!enabled) elOptRAL.checked = false;

  // --- Laquage pieds ---
  const elPieds = document.getElementById('optPieds');
  elPieds.disabled = !enabled;
  if(!enabled) elPieds.checked = false;
}


/* ------- CALCUL ------- */
function priceBase(){
  const t = elType.value; const h = num(elH.value); const l = num(elL.value);
  if(!t||!h||!l) return 0;
  const row = TARIFFS.find(function(r){ return r.type===t && Math.abs(num(r.h)-h)<0.001 && Math.abs(num(r.l)-l)<0.001; });
  return row ? row.priceBase : 0; // interne
}
function priceOptionsSum(){
  const checked = Array.prototype.slice.call(elOptsBox.querySelectorAll('input[name="opt"]:checked')).map(function(c){ return c.value; });
  if(!checked.length) return 0;
  const h = num(elH.value);
  return checked.reduce(function(sum, fam){
    const rows = OPTIONS.filter(function(o){
      return o.typeOption===fam && o.actif && (isNaN(o.hmin) || h>=o.hmin) && (isNaN(o.hmax) || h<=o.hmax);
    });
    if(!rows.length) return sum;
    const units = rows.map(function(o){ return o.priceUnit; }).filter(function(v){ return !isNaN(v); });
    const unit = units.length ? Math.max.apply(null, units) : NaN;
    return sum + (isFinite(unit)?unit:0);
  }, 0); // interne
}
function compute(){
  // === Remise automatique client ===
  let remiseClient = 1;
  try {
      const p = JSON.parse(localStorage.getItem('cofel_client_profile'));
      if (p && typeof p.discountRate === 'number') remiseClient = 1 - p.discountRate;
  } catch(e){}

  const base_interne = priceBase();
  const opt_interne  = priceOptionsSum();
  const qte  = Math.max(1, parseInt(elQte.value||'1',10));

  // === COEF TARIF PUBLIC COFEL ===
const COEF_PUBLIC = 2;

// === BASE INTERNE ===
const unit_interne = base_interne + opt_interne;

// === PRIX PUBLIC AVANT REMISE ===
const unit_public_base = unit_interne * COEF_PUBLIC;

// === OPTIONS D√âJ√Ä EN PUBLIC ===
const ral_public_unit = elOptRAL.checked
  ? (area2FacesM2() * RAL_PRICE_PUBLIC_M2)
  : 0;

const pieds_public_unit = document.getElementById('optPieds').checked ? 35 : 0;

// === PRIX NET CLIENT ===
const unit_public_total =
  (unit_public_base + ral_public_unit + pieds_public_unit) * remiseClient;


  const totalHT_pub  = unit_public_total * qte;
  const totalTTC_pub = totalHT_pub * (1+TVA);

  elHT.textContent  = totalHT_pub.toFixed(2).replace('.', ',');
  elTTC.textContent = totalTTC_pub.toFixed(2).replace('.', ',');
}

/* ------- CHARGEMENT ------- */
async function loadAll(){
  try{
    const rt = await fetch(URL_TARIFS);
    const ro = await fetch(URL_OPTIONS);
    if(!rt.ok || !ro.ok) throw new Error('Chargement r√©seau impossible (CSV).');
    const txtT = await rt.text();
    const txtO = await ro.text();
    const pT = parseCSVAuto(txtT); const pO = parseCSVAuto(txtO);
    RAW_TARIFFS = pT.rows; RAW_HEADERS_T = pT.rawHeads; HEADS_T = pT.heads;
    RAW_OPTIONS = pO.rows; RAW_HEADERS_O = pO.rawHeads; HEADS_O = pO.heads;

    const sigT = URL_TARIFS  + '|' + HEADS_T.join('|');
    const sigO = URL_OPTIONS + '|' + HEADS_O.join('|');
    const savedBySigT = JSON.parse(localStorage.getItem('MAP_T_BY_SIG') || '{}');
    const savedBySigO = JSON.parse(localStorage.getItem('MAP_O_BY_SIG') || '{}');
    MAP_T = savedBySigT[sigT] || MAP_T || { ...MAP_T_DEFAULT };
    MAP_O = savedBySigO[sigO] || MAP_O || { ...MAP_O_DEFAULT };

    suggestMapTarifs(); suggestMapOptions();

    const mapTarifsBox  = document.getElementById('mapTarifsBox');
    const mapOptionsBox = document.getElementById('mapOptionsBox');

    const setSel = function(id, heads, raws, val){
      const el = document.getElementById(id);
      fillSelect(el, heads, raws);
      if(val) el.value = val;
      return el;
    };
    const sTtype  = setSel('mapT_Type',  HEADS_T, RAW_HEADERS_T, MAP_T.type);
    const sTh     = setSel('mapT_H',     HEADS_T, RAW_HEADERS_T, MAP_T.h);
    const sTl     = setSel('mapT_L',     HEADS_T, RAW_HEADERS_T, MAP_T.l);
    const sTprice = setSel('mapT_Price', HEADS_T, RAW_HEADERS_T, MAP_T.price);
    const sOtype  = setSel('mapO_Type',  HEADS_O, RAW_HEADERS_O, MAP_O.type);
    const sOhmin  = setSel('mapO_HMin',  HEADS_O, RAW_HEADERS_O, MAP_O.hmin);
    const sOhmax  = setSel('mapO_HMax',  HEADS_O, RAW_HEADERS_O, MAP_O.hmax);
    const sOprice = setSel('mapO_Price', HEADS_O, RAW_HEADERS_O, MAP_O.price);
    const sOactif = setSel('mapO_Actif', HEADS_O, RAW_HEADERS_O, MAP_O.actif);

    let okT=false, okO=false;
    if(MAP_T.type && MAP_T.h && MAP_T.l && MAP_T.price) okT=applyTarifs();
    if(MAP_O.type && MAP_O.hmin && MAP_O.hmax && MAP_O.price && MAP_O.actif) okO=applyOptions();

    mapTarifsBox.style.display  = (okT ? 'none' : 'block');
    mapOptionsBox.style.display = (okO ? 'none' : 'block');

    document.getElementById('applyMapTarifs').onclick=function(){
      MAP_T.type=sTtype.value||null; MAP_T.h=sTh.value||null; MAP_T.l=sTl.value||null; MAP_T.price=sTprice.value||null;
      if(applyTarifs()){ mapTarifsBox.style.display='none'; populateHL(); compute(); }
      else alert('Merci de s√©lectionner les 4 colonnes TARIFS.');
    };
    document.getElementById('applyMapOptions').onclick=function(){
      MAP_O.type=sOtype.value||null; MAP_O.hmin=sOhmin.value||null; MAP_O.hmax=sOhmax.value||null; MAP_O.price=sOprice.value||null; MAP_O.actif=sOactif.value||null;
      if(applyOptions()){ mapOptionsBox.style.display='none'; renderOptionsCheckboxes(); compute(); }
      else alert('Merci de s√©lectionner les 5 colonnes OPTIONS.');
    };

    elType.addEventListener('change', function(){ populateHL(); renderOptionsCheckboxes(); compute(); });
    elH.addEventListener('change',   function(){ renderOptionsCheckboxes(); updateRALState(); updateLevageNote(); compute(); });
    elL.addEventListener('change',   function(){ updateRALState(); compute(); });
    elQte.addEventListener('input', compute);
    elOptRAL.addEventListener('change', compute);
    document.getElementById('optPieds').addEventListener('change', compute);

// --- Synchronisation Pr√©-laquage <-> RAL ---
elOptRAL.addEventListener('change', function(){
    const pre = document.getElementById('optPreLaque');
    if (elOptRAL.checked) {
        pre.checked = false;   // si RAL ‚Üí on retire pr√©-laquage
    } else {
        pre.checked = true;    // si RAL d√©coch√© ‚Üí pr√©-laquage revient
    }
    compute();
});

    elMsg.textContent = 'Donn√©es charg√©es.\nEn-t√™tes TARIFS : ' + RAW_HEADERS_T.join(' | ') + '\nEn-t√™tes OPTIONS : ' + RAW_HEADERS_O.join(' | ');

    if(okT && okO){ populateHL(); renderOptionsCheckboxes(); compute(); }
  }catch(e){
    elMsg.textContent = 'Erreur de chargement : ' + e.message;
    console.error(e);
  }
}
loadAll();

/* ====== TESTS L√âGERS (console) ====== */
(function runParseTests(){
  try{
    const lf = 'A,B,C\n1,2,3\n4,5,6';
    const crlf = 'A;B;C\r\n1;2;3\r\n4;5;6';
    const one = '"A","B","C","1","2","3","4","5","6"';
    const r1 = parseCSVAuto(lf);
    const r2 = parseCSVAuto(crlf);
    const r3 = parseCSVAuto(one);
    console.log('[TEST] LF heads/rows:', r1.heads, r1.rows.length);
    console.log('[TEST] CRLF heads/rows:', r2.heads, r2.rows.length);
    console.log('[TEST] ONE-LINE heads/rows:', r3.heads, r3.rows.length);
  }catch(e){ console.warn('[TEST] parseCSVAuto error:', e); }
})();
</script>

<script src="../js/devis-core.js"></script>
<script>
(function(){
  const btn = document.getElementById('btnAddDevis'); if(!btn) return;
  function parseHTPublic(){
    const t = (document.getElementById('prixHT').innerText || '0').trim();
    return Number(t.replace(/\s/g,'').replace(',', '.')) || 0;
  }
  function selectedOptionsList(){
    const cbs = Array.prototype.slice.call(document.querySelectorAll('#optionsBox input[name="opt"]:checked'));
    return cbs.map(function(cb){ return cb.value; });
  }
  btn.addEventListener('click', function(){
    try{
      if(!window.Devis) throw new Error('Moteur de devis introuvable.');
      const typeFace = document.getElementById('type').value || '';
      const H = document.getElementById('hauteur').value || '';
      const L = document.getElementById('largeur').value || '';
      const qte = Math.max(1, parseInt(document.getElementById('quantite').value||'1',10));
      if(!typeFace || !H || !L){ alert('Merci de s√©lectionner le type de face, la hauteur et la largeur.'); return; }
      const total_ht_public = parseHTPublic(); if(total_ht_public <= 0){ alert('Le total est √† 0, v√©rifie la configuration.'); return; }
      const pu_public_ht = Number((total_ht_public / qte).toFixed(2));

      const opts = selectedOptionsList();
      const ralChecked = document.getElementById('optRAL') && document.getElementById('optRAL').checked;
      if(ralChecked) opts.push('Laquage au RAL');

      const parts = ['Totem', typeFace, 'H ' + H + ' mm √ó L ' + L + ' mm', opts.length ? 'Options: ' + opts.join(', ') : null];
      const designation = parts.filter(Boolean).join(' ‚Äî ');

      Devis.addLine({ type: 'Totem', designation: designation, quantite: qte, pu_public_ht: pu_public_ht });
      alert('‚úÖ Ligne ajout√©e au devis !\n' + designation + '\nQt√© : ' + qte + '\nPU HT : ' + pu_public_ht.toFixed(2) + ' ‚Ç¨');
    }catch(err){
      console.error(err);
      alert('Erreur lors de l‚Äôajout au devis : ' + err.message);
    }
  });
})();
</script>
</body>
</html>





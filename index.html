<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <base href="/" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Configurateurs Cofel</title>

  <!-- üîí Protection par mot de passe -->
  <script src="./auth/lock.js" type="module"></script>

  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <style>
    :root{
      --cofel:#5a2d82; --cofel-2:#7838a7;
      --glass: rgba(255,255,255,.08); --glass-hr: rgba(255,255,255,.14);
      --txt:#f5f7ff; --txt-dim:#e6e6ff; --accent:#c9b7ff;
      --radius:18px; --blur:18px; --shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--txt);
      font-family:-apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, Arial, sans-serif;
      background:
        radial-gradient(800px 500px at 20% -10%, rgba(255,255,255,.10), transparent 60%),
        radial-gradient(800px 500px at 110% 10%, rgba(255,255,255,.08), transparent 60%),
        linear-gradient(135deg, var(--cofel), var(--cofel-2));
      position:relative; overflow-x:hidden;
    }

    .hidden{ display:none !important; }

    /* ===================== HEADER / HERO (nouvelle version) ===================== */
    .hero{
      position:relative; z-index:1;
      padding:24px 20px 16px;
    }
    .hero-inner{
      max-width:1200px; margin:0 auto;
      display:flex; align-items:center; justify-content:space-between; gap:16px;
    }
    .brand-lite{
      display:flex; align-items:center; gap:12px;
    }
    .brand-lite img{
      height:42px; width:auto; object-fit:contain; border-radius:8px;
    }
    .brand-lite h1{
      font-size: clamp(18px, 2.4vw, 22px); margin:0; letter-spacing:.2px; font-weight:700;
    }
    .hero-tagline{
      max-width:1200px; margin:10px auto 0; padding:0 20px; color:var(--txt-dim);
    }
    .hero::after{
      content:""; display:block; height:1px; margin-top:14px;
      background: linear-gradient(90deg, rgba(255,255,255,.15), rgba(255,255,255,.04));
    }

    .logout-btn{
      appearance:none; border:none; cursor:pointer; font-weight:700; color:var(--txt);
      background: linear-gradient(180deg, rgba(255,255,255,.14), rgba(255,255,255,.06));
      border:1px solid rgba(255,255,255,.18); border-radius:12px; padding:8px 12px;
      box-shadow: var(--shadow); backdrop-filter: blur(var(--blur));
      opacity:.95; transition: opacity .15s, transform .15s, box-shadow .15s;
    }
    .logout-btn:hover{ opacity:1; transform: translateY(-1px); box-shadow: 0 14px 34px rgba(0,0,0,.42); }

    /* ===================== APPS GRID ===================== */
    .wrap{max-width:1200px; margin:26px auto; padding:0 20px 40px; position:relative; z-index:1;}
    .apps{ display:grid; gap:16px; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); }
    .app{
      position:relative; text-decoration:none; color:var(--txt);
      background: linear-gradient(180deg, rgba(255,255,255,.18), rgba(255,255,255,.08));
      border:1px solid rgba(255,255,255,.2); border-radius:20px; padding:18px 16px;
      box-shadow: var(--shadow); backdrop-filter: blur(var(--blur));
      transform: translateY(0); transition: transform .18s, box-shadow .18s, background .18s, border-color .18s;
    }
    .app:hover{ transform: translateY(-4px); box-shadow: 0 18px 40px rgba(0,0,0,.45); }
    .app .title{ font-weight:800; margin:0 0 6px; letter-spacing:.2px; }
    .app .hint{ color:var(--txt-dim); margin:0; font-size:13px; }

    /* ===================== PANEL (devis + client) ===================== */
    .panel{
      margin-top:28px;
      background: linear-gradient(180deg, rgba(255,255,255,.16), rgba(255,255,255,.06));
      border:1px solid rgba(255,255,255,.2);
      border-radius:20px; padding:18px;
      box-shadow: var(--shadow); backdrop-filter: blur(var(--blur));
    }
    .panel h2{ margin:0 0 12px; font-size: clamp(18px, 2.4vw, 22px); letter-spacing:.2px; }

    .client-card{
      margin:12px 0 16px;
      background: linear-gradient(180deg, rgba(255,255,255,.14), rgba(255,255,255,.06));
      border:1px solid rgba(255,255,255,.18);
      border-radius:16px;
      padding:14px;
      display:grid; gap:12px;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    }
    label{font-weight:700; font-size:12px; color:var(--accent);}
    input[type="text"], input[type="number"]{
      width:100%; margin-top:6px; padding:10px 12px;
      background: rgba(255,255,255,.08); color:var(--txt);
      border:1px solid rgba(255,255,255,.18); border-radius:12px; outline:none;
      transition: border-color .18s ease, background .18s ease;
    }
    input[type="text"]::placeholder, input[type="number"]::placeholder{ color: #f0edff; opacity:.75; }
    input[type="text"]:focus, input[type="number"]:focus{ border-color: rgba(255,255,255,.34); background: rgba(255,255,255,.12); }

    .table-wrap{overflow:auto; border-radius:14px; border:1px solid rgba(255,255,255,.16);}
    table{width:100%; border-collapse:collapse; min-width:720px;}
    thead tr{ background: linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.04)); }
    th, td{ padding:10px 12px; text-align:left; }
    th{ font-size:12px; color:var(--accent); letter-spacing:.3px; }
    tbody tr + tr td{ border-top:1px solid rgba(255,255,255,.12); }
    td.right{ text-align:right; } td.center{ text-align:center; }

    .totaux{ margin-top:16px; display:flex; justify-content:space-between; gap:16px; align-items:flex-start; flex-wrap:wrap; }
    .totaux-box{
      min-width:320px; border-radius:16px; padding:12px 14px;
      background: linear-gradient(180deg, rgba(255,255,255,.14), rgba(255,255,255,.06));
      border:1px solid rgba(255,255,255,.18);
    }
    .row{ display:flex; justify-content:space-between; padding:6px 0; border-bottom:1px dashed rgba(255,255,255,.16); }
    .row:last-child{ border-bottom:none; padding-bottom:0; }
    .grand{ font-weight:800; font-size:18px; }
    .subnote{ color:var(--txt-dim); font-size:12px; margin-top:6px; }

    .btn{
      appearance:none; border:none; cursor:pointer; font-weight:700;
      color:#0b0b0b; background:#fff; border-radius:12px; padding:10px 14px;
      box-shadow: 0 10px 24px rgba(0,0,0,.25);
      transition: transform .16s ease, box-shadow .16s ease, opacity .16s ease;
    }
    .btn:active{ transform: translateY(1px); box-shadow: 0 6px 16px rgba(0,0,0,.28); }
    .btn-ghost{ background: transparent; color:var(--txt); border:1px solid rgba(255,255,255,.24); }
    .btn-danger{ background: transparent; color:#ffe3e3; border:1px solid rgba(255, 107, 107, .45); }
    .btn[disabled]{ opacity:.45; cursor:not-allowed; box-shadow:none; pointer-events:none; }

    .app-inline{
      display:flex; align-items:center; gap:10px; padding:12px 14px; border-radius:14px; text-decoration:none; color:var(--txt);
      background: linear-gradient(180deg, rgba(255,255,255,.18), rgba(255,255,255,.08));
      border:1px solid rgba(255,255,255,.2); box-shadow: var(--shadow); backdrop-filter: blur(var(--blur));
      transition: transform .18s ease, box-shadow .18s ease;
    }
    .app-inline:hover{ transform: translateY(-2px); box-shadow: 0 14px 30px rgba(0,0,0,.42); }
    .app-inline .title{ margin:0; font-weight:800; }
    .app-inline .hint{ margin:0; color:var(--txt-dim); font-size:12px; }

    footer{ color:#f3ecff; font-size:12px; text-align:center; padding:24px 10px; opacity:.9; }
    @media (max-width:720px){ .brand h1{display:none;} }

    .toast{
      position:fixed; right:16px; bottom:16px;
      background:#fff; color:#222; padding:10px 12px; border-radius:10px;
      box-shadow:0 10px 24px rgba(0,0,0,.35); display:none; z-index:99;
    }
    .toast.show{ display:block; }
  </style>
  <link rel="stylesheet" href="/styles/cofel-theme-apple-dark.css">
</head>
<body>

  <!-- ===================== HEADER / HERO ===================== -->
  <header class="hero">
    <div class="hero-inner">
      <div class="brand-lite">
        <img src="./assets/logo cofel.jpg" alt="Cofel" />
        <h1>Configurateurs Cofel</h1>
      </div>
      <button id="logoutBtn" class="logout-btn" title="Se d√©connecter">üö™ Se d√©connecter</button>
    </div>
    <p class="hero-tagline">
      Choisissez un configurateur puis composez votre devis en quelques clics.
      L‚Äôaper√ßu et l‚Äôexport PDF sont mis √† jour automatiquement.
    </p>
  </header>

  <!-- ===================== APPS GRID ===================== -->
  <main class="wrap">
    <section class="apps" aria-label="Liste des configurateurs">
      <a class="app" href="/configurateurs/configurateur-tole-tablette.html">
        <p class="title">T√¥le Tablette</p><p class="hint">Ajourage, PMMA, ch√¢ssis‚Ä¶</p>
      </a>
      <a class="app" href="/configurateurs/configurateur-rampe-lumineuse.html">
        <p class="title">Rampe Lumineuse (PLL)</p><p class="hint">LED + laquage inclus</p>
      </a>
      <a class="app" href="/configurateurs/configurateur-enseigne-drapeau.html">
        <p class="title">Enseigne Drapeau</p><p class="hint">Rond / Carr√©, potence</p>
      </a>
      <a class="app" href="/configurateurs/configurateur-totems.html">
        <p class="title">Totems</p><p class="hint">Hauteurs, options d‚Äôinstallation</p>
      </a>
      <a class="app" href="/configurateurs/configurateur-lettres-PVC.html">
        <p class="title">Lettres PVC</p><p class="hint">Hauteur, chant, finitions</p>
      </a>
      <a class="app" href="/configurateurs/configurateur-lettre-alu-alupvc.html">
        <p class="title">Lettres Alu / Alu-PVC</p><p class="hint">Finitions et options</p>
      </a>
      <a class="app" href="/configurateurs/configurateur-lettre-boitier.html">
        <p class="title">Lettres Bo√Ætiers</p><p class="hint">Face PMMA ou Dibond</p>
      </a>
      <a class="app" href="/configurateurs/configurateur-tolerie-dibond.html">
        <p class="title">T√¥lerie Alu / Dibond</p><p class="hint">Au m¬≤, laqu√© / pr√©laqu√©</p>
      </a>
      <a class="app" href="/configurateurs/souples-rigides-adhesifs.html">
        <p class="title">Supports souples, rigides & adh√©sifs</p>
        <p class="hint">B√¢che, adh√©sif, panneau, impression & finitions</p>
      </a>
    </section>

    <!-- ===================== R√âCAP + CLIENT ===================== -->
    <section class="panel" aria-label="R√©capitulatif du devis">
      <h2>üßæ R√©capitulatif du devis</h2>

      <div class="client-card">
        <div>
          <label for="societe">Entreprise</label>
          <input type="text" id="societe" placeholder="Nom de l‚Äôentreprise">
        </div>
        <div>
          <label for="contact">Nom & pr√©nom</label>
          <input type="text" id="contact" placeholder="Nom Pr√©nom">
        </div>
        <div>
          <label for="chantier">Nom du chantier</label>
          <input type="text" id="chantier" placeholder="Nom du chantier">
        </div>
        <div style="display:none;"><label for="remise-client">Remise client (%)</label><input type="number" id="remise-client" value="0"></div>
      </div>

      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>D√©signation</th>
              <th>Qt√©</th>
              <th class="right">PU HT (net)</th>
              <th class="right">Total HT</th>
              <th class="center">Actions</th>
            </tr>
          </thead>

          <!-- === AJOUT MANUEL DE LIGNE === -->
          <tr>
            <td>
              <input type="text" id="manuDesignation" placeholder="D√©signation manuelle‚Ä¶"
                style="width:100%; padding:6px 8px; border-radius:8px; border:1px solid rgba(255,255,255,.25); background:rgba(255,255,255,.10); color:white;">
            </td>
            <td>
              <input type="number" id="manuQte" value="1" min="1"
                style="width:100%; padding:6px 8px; border-radius:8px; border:1px solid rgba(255,255,255,.25); background:rgba(255,255,255,.10); color:white; text-align:center;">
            </td>
            <td>
              <input type="number" id="manuPU" value="0" min="0" step="0.01"
                style="width:100%; padding:6px 8px; border-radius:8px; border:1px solid rgba(255,255,255,.25); background:rgba(255,255,255,.10); color:white; text-align:right;">
            </td>
            <td class="right">‚Äî</td>
            <td class="center">
              <button id="btnAddManu" class="btn btn-ghost" style="padding:6px 10px;">‚ûï Ajouter</button>
            </td>
          </tr>

          <tbody id="bodyDevis">
            <tr><td colspan="5" style="padding:12px;color:var(--txt-dim)">Aucune ligne dans le devis.</td></tr>
          </tbody>
        </table>
      </div>

      <div class="totaux">
        <div class="totaux-box">
          <div class="row"><div>Total HT</div><div id="totHT">0,00 ‚Ç¨</div></div>
          <div class="row"><div>TVA 20 %</div><div id="totTVA">0,00 ‚Ç¨</div></div>
          <div class="row grand"><div>Total TTC</div><div id="totTTC">0,00 ‚Ç¨</div></div>
        </div>

        <!-- Tuile transport (page d√©di√©e) -->
        <a class="app-inline" href="/transport.html" title="Calculer le co√ªt de transport">
          <div style="font-size:22px">üöö</div>
          <div>
            <p class="title">Co√ªt de transport</p>
            <p class="hint">Messagerie / Affr√®tement ‚Ä¢ Ajouter au devis</p>
          </div>
        </a>
      </div>

      <div style="margin-top:16px; display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
        <button id="btnPdf" class="btn" disabled
          title="Renseignez Entreprise, Nom & pr√©nom et Nom du chantier pour activer l‚Äôexport PDF">üìÑ Exporter le devis en PDF</button>
        <button id="btnClear" class="btn btn-danger">üóë Vider le devis</button>
        <div id="noteInfo" class="note-info">üí° Veuillez renseigner l‚Äôentreprise, le nom du contact et le chantier pour activer l‚Äôexport PDF.</div>
      </div>
    </section>
  </main>

  <footer>
    ¬© Cofel ‚Äî ZA du Perquoi, 72560 Chang√© ‚Äî SIRET 927 659 458 00024 ‚Äî TVA FR80927659458
  </footer>

  <!-- zone toast -->
  <div id="toast" class="toast"></div>

  <!-- Core devis -->
  <script src="./js/devis-core.js"></script>

  <!-- jsPDF + AutoTable -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.3/jspdf.plugin.autotable.min.js"></script>

  <!-- Script principal -->
  <script>
  (function(){
  /************************************************************
   * R√îLES UTILISATEURS ‚Äî Administrateur complet + √©diteurs devis
   ************************************************************/
  const FULL_ADMINS = [
    "commercial@cofel72.fr"
  ];

  const QUOTE_EDITORS = [
    "souvre@cofel72.fr", "secretaire@cofel72.fr" , "direction@deco72.com", "adv@deco72.com"
  ];

  let isFullAdmin = false;
  let canEditQuote = false;

  try {
    const profile = JSON.parse(localStorage.getItem("cofel_client_profile") || "{}");
    const email = profile.email || "";
    isFullAdmin  = FULL_ADMINS.includes(email);
    canEditQuote = isFullAdmin || QUOTE_EDITORS.includes(email);
  } catch (e) {
    console.warn("Impossible de lire le profil utilisateur", e);
  }

  if(!window.Devis){
    console.error("Devis-core non charg√©. V√©rifiez ./js/devis-core.js");
    return;
  }

  // === Webhook e-mail (GAS) ‚Äî SANS pi√®ce jointe (robuste) ===
  const MAIL_WEBHOOK = "https://script.google.com/macros/s/AKfycby7h6R8E6IYbNtItF5tf53tA5kHtA5_EV70ZUsbAdBZD3vA9WnUnWfjdrCyASFZ7TIuCg/exec";

  const toast = document.getElementById('toast');
  function showToast(msg, ok=true){
    if(!toast) return alert(msg);
    toast.textContent = msg;
    toast.style.background = ok ? "#d7ffd7" : "#ffe3e3";
    toast.style.color = "#222";
    toast.classList.add('show');
    setTimeout(()=> toast.classList.remove('show'), 3200);
  }

  // Helpers
  const fmt = n => (Number(n)||0).toFixed(2).replace('.', ',') + " ‚Ç¨";
  const STORAGE_KEY = "devisCourant_v1";
  const TVA_RATE = 0.20;

  function readStore(){ try{ return JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}"); }catch{ return {}; } }
  function writeStore(obj){ localStorage.setItem(STORAGE_KEY, JSON.stringify(obj)); }

  function genId(){
    try{
      if (window.crypto && typeof crypto.randomUUID === "function") return crypto.randomUUID();
    }catch(e){}
    return "L_" + Date.now() + "_" + Math.random().toString(16).slice(2);
  }
  function n2(x){
    const n = Number(x);
    return Number.isFinite(n) ? +(Math.round(n*100)/100).toFixed(2) : null;
  }
  function pickNumber(obj, keys){
    for(const k of keys){
      const v = n2(obj?.[k]);
      if(v != null) return v;
    }
    return null;
  }
  function repairStoredLines(){
    const st = readStore();
    if(!st || !Array.isArray(st.lignes)) return;

    let changed = false;

    for(const l of st.lignes){
      if(!l || typeof l !== "object") continue;

      if(!l.id){
        l.id = genId();
        changed = true;
      }

      const q = Number(l.quantite ?? l.qte ?? l.qty ?? 1);
      if(!Number.isFinite(q) || q <= 0){
        l.quantite = 1;
        changed = true;
      } else if(l.quantite !== q){
        l.quantite = q;
        changed = true;
      }

      let pu = n2(l.pu_net_ht);
      if(pu == null){
        pu = pickNumber(l, ["pu_ht","puHT","pu","price","price_ht","unit_price_ht","prix_unitaire_ht","prix_ht"]);
      }
      if(pu == null){
        const tot = pickNumber(l, ["total_ligne_ht","total_ht","totalHT","montant_ht","total"]);
        if(tot != null && l.quantite > 0) pu = n2(tot / l.quantite);
      }
      if(pu != null && l.pu_net_ht !== pu){
        l.pu_net_ht = pu;
        changed = true;
      }

      let totL = n2(l.total_ligne_ht);
      if(totL == null && n2(l.pu_net_ht) != null){
        totL = n2(Number(l.pu_net_ht) * Number(l.quantite));
      }
      if(totL != null && l.total_ligne_ht !== totL){
        l.total_ligne_ht = totL;
        changed = true;
      }
    }

    if(changed) writeStore(st);
  }

  function updateClientField(key, value){
    const state = readStore(); if(!state.client) state.client = {};
    state.client[key] = value; writeStore(state);
  }
  function getClient(){ const st = readStore(); return st.client || {}; }

  // üëâ Totaux avec remise EXCLUANT les lignes de type "transport"
  function totalsExcludingTransportDiscount(d){
    const lignes = d?.lignes || [];
    const remise = 0;
    let sumTransport = 0, sumNon = 0;
    for (const l of lignes){
      const q  = Number(l.quantite)||0;
      const pu = Number(l.pu_net_ht)||0;
      const total = q * pu;
      if ((l.type || "").toLowerCase() === "transport") sumTransport += total;
      else sumNon += total;
    }
    const nonAfterRemise = sumNon * (1 - remise/100);
    const total_ht  = +(nonAfterRemise + sumTransport).toFixed(2);
    const tva       = +(total_ht * TVA_RATE).toFixed(2);
    const total_ttc = +(total_ht + tva).toFixed(2);
    return { total_ht, tva, total_ttc };
  }

  // DOM refs
  const elRemise   = document.getElementById('remise-client');
  const body       = document.getElementById('bodyDevis');
  const elHT       = document.getElementById('totHT');
  const elTVA      = document.getElementById('totTVA');
  const elTTC      = document.getElementById('totTTC');
  const elSociete  = document.getElementById('societe');
  const elContact  = document.getElementById('contact');
  const elChantier = document.getElementById('chantier');
  const btnPdf     = document.getElementById('btnPdf');
  const btnClear   = document.getElementById('btnClear');
  const noteInfo   = document.getElementById('noteInfo');

  // Validation activation export PDF
  function validateExportEnabled(){
    const filled = v => (v || '').trim().length > 0;
    const ok = filled(elSociete.value) && filled(elContact.value) && filled(elChantier.value);
    btnPdf.disabled = !ok;
    btnPdf.title = ok ? "" : "Renseignez Entreprise, Nom & pr√©nom et Nom du chantier pour activer l‚Äôexport PDF";
    if(noteInfo){ noteInfo.classList.toggle('hidden', ok); }
  }

  // ‚úÖ Prefill depuis le profil client + sauvegarde devis
  (function hydrateClient(){
    try{
      const rawProfile = localStorage.getItem('cofel_client_profile');
      if (rawProfile) {
        const profile = JSON.parse(rawProfile);

        if (profile.company && !elSociete.value) elSociete.value = profile.company;
        if (profile.contactName && !elContact.value) elContact.value = profile.contactName;

        if (typeof profile.discountRate === 'number' && !isNaN(profile.discountRate)) {
          const pct = Math.max(0, Math.min(90, Math.round(profile.discountRate * 100)));
          if (elRemise) elRemise.value = pct;
          Devis.setRemise(0);
        }
      }
    } catch(e){
      console.error('Erreur lecture profil client :', e);
    }

    const c = getClient();
    if(c.societe)  elSociete.value  = c.societe;
    if(c.contact)  elContact.value  = c.contact;
    if(c.chantier) elChantier.value = c.chantier;

    validateExportEnabled();
  })();

  [ ['societe', elSociete], ['contact', elContact], ['chantier', elChantier] ]
    .forEach(([k,el]) => el?.addEventListener('input', () => { updateClientField(k, el.value); validateExportEnabled(); } ));

  function render(){
    const d = Devis.computeTotals();
    const storedRemise = Number(d.remise_pct||0);
    if(Number(elRemise?.value||0) !== storedRemise && elRemise) elRemise.value = storedRemise;

    if(!d.lignes.length){
      body.innerHTML = '<tr><td colspan="5" style="padding:12px;color:#f0edff">Aucune ligne dans le devis.</td></tr>';
    } else {
      body.innerHTML = d.lignes.map(l => `
        <tr data-id="${l.id}">
          <td>${l.designation || "-"}</td>
          <td class="center">${l.quantite}</td>
          <td class="right">${fmt(l.pu_net_ht)}</td>
          <td class="right">${fmt(l.total_ligne_ht)}</td>
          <td class="center">
            <button class="btn btn-ghost btn-qty" style="margin-right:6px;">üìù Qt√©</button>
            ${canEditQuote ? `
              <button class="btn btn-ghost btn-edit" style="margin-right:6px;">‚úèÔ∏è Modifier</button>
            ` : ""}
            <button class="btn btn-danger btn-del">Suppr.</button>
          </td>
        </tr>
      `).join("");
    }

    const t = totalsExcludingTransportDiscount(d);
    elHT.textContent  = fmt(t.total_ht);
    elTVA.textContent = fmt(t.tva);
    elTTC.textContent = fmt(t.total_ttc);
  }

  // === AJOUT MANUEL DE LIGNE ===
  document.getElementById("btnAddManu").addEventListener("click", () => {
    const designation = (document.getElementById("manuDesignation").value || "").trim();
    const qte = Number(document.getElementById("manuQte").value || 1);
    const pu = Number(document.getElementById("manuPU").value || 0);

    if (!designation) return alert("Veuillez saisir une d√©signation.");
    if (qte <= 0 || pu < 0) return alert("Valeurs invalides.");

    Devis.addLine({
      type: "manuel",
      designation,
      quantite: qte,
      pu_net_ht: pu
    });

    document.getElementById("manuDesignation").value = "";
    document.getElementById("manuQte").value = 1;
    document.getElementById("manuPU").value = 0;

    render();
  });

  body.addEventListener('click',(e)=>{
    const tr = e.target.closest('tr[data-id]');
    if(!tr) return;
    const id = tr.getAttribute('data-id');

    if (e.target.classList.contains('btn-edit')) {
      if (!canEditQuote) return alert("‚õî Vous n‚Äô√™tes pas autoris√© √† modifier une ligne.");

      const l = Devis.getLine(id);
      if (!l) return;

      const newDesignation = prompt("Nouvelle d√©signation :", l.designation || "");
      if (newDesignation === null) return;

      const newPUraw = prompt("Nouveau PU HT :", l.pu_net_ht);
      if (newPUraw === null) return;

      const newPU = Number(newPUraw);
      if (isNaN(newPU) || newPU < 0) return alert("‚ùå Prix invalide.");

      Devis.updateLine(id, {
        designation: newDesignation.trim(),
        pu_net_ht: newPU,
        total_ligne_ht: +(newPU * Number(l.quantite || 1)).toFixed(2)
      });

      render();
      return;
    }

    if(e.target.classList.contains('btn-del')){
      if(confirm("Supprimer cette ligne du devis ?")){
        Devis.removeLine(id); render();
      }
    }
    if(e.target.classList.contains('btn-qty')){
      const currentQty = Number(tr.children[1].textContent||1);
      const q = prompt("Nouvelle quantit√© :", currentQty);
      if(q !== null){ Devis.updateQty(id, q); render(); }
    }
  });

  btnClear.addEventListener('click', ()=>{
    if(confirm("Vider enti√®rement le devis ?")){
      Devis.clearAll(true);
      render();
      validateExportEnabled();
    }
  });

  // ===== Int√©gration TRANSPORT : r√©ception depuis transport.html =====
  function addTransportLine(payload){
    const st = readStore();
    if(!st.lignes) st.lignes = [];
    const exists = st.lignes.some(l => l.id === payload.id);
    if(!exists){
      const q = Number(payload.quantite||1);
      const pu = Number(payload.pu_net_ht||0);
      st.lignes.push({
        id: payload.id,
        designation: payload.designation || "Transport",
        quantite: q,
        pu_net_ht: pu,
        total_ligne_ht: +(q*pu).toFixed(2),
        type: payload.type || "transport"
      });
      writeStore(st);
      try{ Devis.reload && Devis.reload(); }catch{}
      render();
    }
  }
  function checkTransportInbox(){
    const raw = localStorage.getItem('cofel_transport_add');
    if(!raw) return;
    try{
      const payload = JSON.parse(raw);
      if(payload && payload.id){ addTransportLine(payload); }
    }catch(e){ console.warn("Transport payload invalide", e); }
    localStorage.removeItem('cofel_transport_add');
  }
  checkTransportInbox();
  window.addEventListener('storage', (ev)=>{ if(ev.key === 'cofel_transport_add' && ev.newValue){ checkTransportInbox(); } });

  // ====== CHARGEMENT LOGO (DataURL) ======
  async function loadImageDataURL(src){
    const resp = await fetch(src, { cache: "no-cache" });
    if(!resp.ok) throw new Error("Logo introuvable: " + src);
    const blob = await resp.blob();
    return await new Promise((resolve, reject) => {
      const fr = new FileReader();
      fr.onload = () => resolve(fr.result);
      fr.onerror = reject;
      fr.readAsDataURL(blob);
    });
  }

  // === Envoi e-mail (silencieux c√¥t√© client) ===
  async function sendEmail({client, devis}){
    try{
      const t = totalsExcludingTransportDiscount(devis);
      const subject = `Devis Cofel ‚Äî ${client?.societe||"Sans soci√©t√©"} ‚Äî ${client?.chantier||"Sans chantier"} ‚Äî ${((Number(t.total_ttc)||0).toFixed(2)).replace('.',',')} ‚Ç¨ ‚Äî ${new Date().toLocaleDateString("fr-FR")}`;
      const body = {
        subject,
        client,
        devis: {
          remise_pct: devis.remise_pct,
          total_ht: t.total_ht,
          tva: t.tva,
          total_ttc: t.total_ttc,
          lignes: (devis.lignes||[]).map(l=>({
            designation: l.designation, quantite: l.quantite, pu_net_ht: l.pu_net_ht, total_ligne_ht: l.total_ligne_ht, type: l.type||""
          }))
        },
        meta: { page: location.href, userAgent: navigator.userAgent, date: new Date().toISOString() },
        pdf: null
      };

      const resp = await fetch(MAIL_WEBHOOK, {
        method: "POST",
        headers: { "Content-Type": "text/plain;charset=utf-8" },
        body: JSON.stringify(body)
      });
      const text = await resp.text().catch(()=>"(no text)");
      console.log("[MAIL] status", resp.status, "body:", text);
    }catch(err){
      console.warn("Envoi email √©chou√©:", err);
    }
  }

  /* ============================================================
     EXPORT CSV EBP (ADMIN) ‚Äî T√©l√©charge PDF + CSV depuis Index
     - S√©parateur : ;
     - D√©cimales : , (FR)
     - 1 ligne CSV = 1 ligne de devis
     - ClientCode forc√© : 411CONFIGURATEUR (ton client "tampon")
     ============================================================ */

  const EBP_CLIENT_CODE = "411CONFIGURATEUR";
  const EBP_TVA_TAUX = 20.00;

  // Mapping EXACT bas√© sur ton devis EBP (AR00002 .. AR00010)
  const EBP_ARTICLE_MAP = {
    "TOLE_TABLETTE": "AR00002",
    "RAMPE_LUMINEUSE": "AR00003",
    "ENSEIGNE_DRAPEAU": "AR00004",
    "TOTEM": "AR00005",
    "LETTRE_PVC": "AR00006",
    "LETTRE_ALU_ALUPVC": "AR00007",
    "LETTRE_BOITIER": "AR00008",
    "TOLERIE_ALU_DIBOND": "AR00009",
    "SUPPORTS_SRA": "AR00010"
  };

  // Si une ligne n'est pas reconnue, on met un fallback (existant) pour garantir l'import EBP
  // üëâ Si tu pr√©f√®res, tu peux cr√©er un article "DIVERS" et le mettre ici.
  const EBP_FALLBACK_ARTICLE = "AR00010";

  function pad2(n){ return String(n).padStart(2,"0"); }
  function formatDateFR(d){
    return `${pad2(d.getDate())}/${pad2(d.getMonth()+1)}/${d.getFullYear()}`;
  }
  function formatNumberFR(n, decimals=2){
    const x = Number(n || 0);
    return x.toFixed(decimals).replace(".", ",");
  }
  function csvEscape(v){
    const s = String(v ?? "");
    if (/[;"\r\n]/.test(s)) return `"${s.replace(/"/g,'""')}"`;
    return s;
  }
  function downloadTextFile(filename, content, mime="text/csv;charset=utf-8"){
    // BOM UTF-8 pour Windows/Excel
    const blob = new Blob(["\ufeff" + content], { type: mime });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(() => URL.revokeObjectURL(url), 5000);
  }
  function makeDocRef(){
    // On tente d'utiliser quoteId si dispo, sinon un identifiant bas√© sur date/heure
    const qid = (window.lastCreatedQuoteId || "").toString().trim();
    if (qid) return `CFG-${qid}`;
    const d = new Date();
    return `CFG-${d.getFullYear()}${pad2(d.getMonth()+1)}${pad2(d.getDate())}-${pad2(d.getHours())}${pad2(d.getMinutes())}${pad2(d.getSeconds())}`;
  }

  function guessArticleCodeFromLine(line){
    // 1) Si un configurateur a d√©j√† pos√© un code, on le respecte
    const direct = (line.articleCode || line.code_article || line.codeArticle || "").toString().trim();
    if (direct) return direct;

    // 2) Si la ligne a un identifiant de configurateur
    const key = (line.configId || line.source_config || line.source || line.origin || "").toString().trim().toUpperCase();
    if (key && EBP_ARTICLE_MAP[key]) return EBP_ARTICLE_MAP[key];

    // 3) Heuristique via d√©signation
    const t = (line.designation || "").toString().toUpperCase();

    if (t.includes("TOLE TABLETTE") || t.includes("T√îLE TABLETTE")) return EBP_ARTICLE_MAP.TOLE_TABLETTE;
    if (t.includes("RAMPE LUMINEUSE")) return EBP_ARTICLE_MAP.RAMPE_LUMINEUSE;
    if (t.includes("ENSEIGNE DRAPEAU")) return EBP_ARTICLE_MAP.ENSEIGNE_DRAPEAU;
    if (t.includes("TOTEM")) return EBP_ARTICLE_MAP.TOTEM;

    // Lettres
    if (t.includes("LETTRE") && t.includes("PVC") && !t.includes("ALU")) return EBP_ARTICLE_MAP.LETTRE_PVC;
    if (t.includes("LETTRE") && (t.includes("ALU") || t.includes("ALU/PVC") || t.includes("ALU PVC"))) return EBP_ARTICLE_MAP.LETTRE_ALU_ALUPVC;
    if (t.includes("BOITIER") || t.includes("BO√éTIER")) return EBP_ARTICLE_MAP.LETTRE_BOITIER;

    // T√¥lerie / Dibond
    if (t.includes("TOLERIE") || t.includes("T√îLERIE") || t.includes("DIBOND")) return EBP_ARTICLE_MAP.TOLERIE_ALU_DIBOND;

    // Supports SR
    if (t.includes("SUPPORT") || t.includes("ADHESIF") || t.includes("ADH√âSIF") || t.includes("RIGIDE") || t.includes("SOUPLE")) return EBP_ARTICLE_MAP.SUPPORTS_SRA;

    // Transport / manuel : fallback (pour que l'import EBP ne casse pas)
    return EBP_FALLBACK_ARTICLE;
  }

  function buildEbpCsv({devis, client, docRef, docDate}){
    const header = [
      "DocType","DocRef","DocDate",
      "ClientCode","ClientSociete","ClientContact","ClientChantier",
      "LineNo","ArticleCode","Designation",
      "Quantite","PU_HT","TVA_Taux"
    ];
    const rows = [header.join(";")];

    let lineNo = 0;
    for(const l of (devis?.lignes || [])){
      const qty = Number(l.quantite ?? 0);
      if (!Number.isFinite(qty) || qty <= 0) continue;

      lineNo++;
      const pu = Number(l.pu_net_ht ?? 0);
      const designation = (l.designation || "Ligne configurateur").toString().trim();
      const articleCode = guessArticleCodeFromLine(l);
      const tva = Number(l.tva_taux ?? l.tva ?? EBP_TVA_TAUX);

      const row = [
        "DEVIS",
        docRef,
        docDate,
        EBP_CLIENT_CODE,
        client?.societe || "",
        client?.contact || "",
        client?.chantier || "",
        String(lineNo),
        articleCode,
        designation,
        formatNumberFR(qty, 2),
        formatNumberFR(pu, 2),
        formatNumberFR(tva, 2)
      ].map(csvEscape).join(";");

      rows.push(row);
    }

    return rows.join("\r\n");
  }

  function exportEbpCsvDownload({devis, client, docRef}){
    if(!isFullAdmin) return; // ‚úÖ seulement la session admin
    const docDate = formatDateFR(new Date());
    const ref = docRef || makeDocRef();
    const csv = buildEbpCsv({ devis, client, docRef: ref, docDate });
    const filename = `Devis-Cofel-EBP_${ref}.csv`;
    downloadTextFile(filename, csv);
    showToast("CSV EBP t√©l√©charg√© ‚úî", true);
  }

  // ===================== EXPORT PDF (N&B / GRIS / FOND BLANC) =====================
  document.getElementById("btnPdf").addEventListener("click", async () => {
    try {
      const { jsPDF } = window.jspdf;

      // ‚úÖ Palette N&B / gris (√©conomie d'encre)
      const COLOR_TEXT  = [20, 20, 20];
      const COLOR_MUTED = [110, 110, 110];
      const COLOR_LINE  = [170, 170, 170];
      const BORDER_SOFT = [210, 210, 210];
      const BG_HEAD     = [235, 235, 235];
      const BG_ALT      = [250, 250, 250];
      const BG_NOTICE   = [245, 245, 245];

      // Donn√©es devis
      const d = Devis.computeTotals();
      const t = totalsExcludingTransportDiscount(d);
      const client = {
        societe: (elSociete?.value || "").trim(),
        contact: (elContact?.value || "").trim(),
        chantier: (elChantier?.value || "").trim(),
      };

      const doc = new jsPDF({ unit: "pt", format: "a4", compress: true });
      const pageWidth = doc.internal.pageSize.getWidth();
      const pageHeight = doc.internal.pageSize.getHeight();
      const margin = 40;

      // Logo
      let logoData = null;
      try {
        logoData = await loadImageDataURL("./assets/logo cofel.jpg");
      } catch (e) {
        console.warn("Logo non charg√© :", e);
      }

      // ----- HEADER -----
      const drawHeader = () => {
        const yTop = margin;

        if (logoData) {
          const W = 180;
          const H = Math.round(W * 0.28);
          doc.addImage(logoData, "JPEG", margin, yTop, W, H);
        }

        doc.setFont("Helvetica", "bold");
        doc.setFontSize(18);
        doc.setTextColor(...COLOR_TEXT);
        doc.text("DEVIS", pageWidth - margin, yTop + 6, { align: "right" });

        doc.setFont("Helvetica", "normal");
        doc.setFontSize(10);
        doc.setTextColor(...COLOR_TEXT);

        const lines = [
          "COFEL72 ‚Äî ZA du Perquoi, 72560 Chang√©",
          "SIRET 927 659 458 00024 ‚Äî TVA FR80927659458",
          "Date : " + new Date().toLocaleDateString("fr-FR"),
        ];

        lines.forEach((txt, i) => {
          doc.text(txt, pageWidth - margin, yTop + 26 + i * 14, { align: "right" });
        });

        doc.setDrawColor(...COLOR_LINE);
        doc.setLineWidth(1);
        doc.line(margin, yTop + 54, pageWidth - margin, yTop + 54);
      };

      // ----- FOOTER -----
      const drawFooter = (pageNum, pageCount) => {
        const y = pageHeight - margin + 12;
        doc.setFont("Helvetica", "normal");
        doc.setFontSize(9);
        doc.setTextColor(...COLOR_MUTED);

        doc.text(
          "Offre valable 30 jours ‚Äî Sous r√©serve de faisabilit√© et validation technique",
          margin,
          y
        );
        doc.text(`Page ${pageNum} / ${pageCount}`, pageWidth - margin, y, {
          align: "right",
        });
      };

      // ----- CARTOUCHE "Sous r√©serve" (gris) -----
      function drawTechNotice(yStart) {
        const boxW = pageWidth - margin * 2;
        const boxH = 56;
        const y = Math.min(pageHeight - margin - boxH - 10, yStart);

        doc.setFillColor(...BG_NOTICE);
        doc.setDrawColor(...BORDER_SOFT);
        doc.roundedRect(margin, y, boxW, boxH, 8, 8, "FD");

        doc.setTextColor(...COLOR_TEXT);
        doc.setFont("Helvetica", "bold");
        doc.setFontSize(12);
        doc.text(
          "DEVIS SOUS R√âSERVE D'APPROBATION DE NOTRE √âQUIPE TECHNIQUE",
          margin + boxW / 2,
          y + boxH / 2 + 4,
          { align: "center", baseline: "middle" }
        );

        return y + boxH;
      }

      // ----- CARTE CLIENT (blanc + bordure grise) -----
      const drawClientCard = (yStart) => {
        const CARD_H = 90;
        const cardW = pageWidth - margin * 2;

        doc.setFillColor(255, 255, 255);
        doc.setDrawColor(...BORDER_SOFT);
        doc.roundedRect(margin, yStart, cardW, CARD_H, 8, 8, "FD");

        let y = yStart + 24;
        doc.setFont("Helvetica", "bold");
        doc.setFontSize(12);
        doc.setTextColor(...COLOR_TEXT);
        doc.text("Client", margin + 14, y);

        doc.setFont("Helvetica", "normal");
        doc.setFontSize(11);

        const rows = [
          ["Entreprise :", client.societe],
          ["Contact :", client.contact],
          ["Chantier :", client.chantier],
        ];

        rows.forEach((r, i) => {
          doc.setTextColor(...COLOR_MUTED);
          doc.text(r[0], margin + 14, y + 20 + i * 16);
          doc.setTextColor(...COLOR_TEXT);
          doc.text(r[1] || "-", margin + 95, y + 20 + i * 16);
        });

        return yStart + CARD_H + 18;
      };

      // ----- TOTAUX (blanc + bordure grise) -----
      const drawTotalsBox = (yStart) => {
        const boxW = 220;
        const boxH = 100;
        const x = pageWidth - margin - boxW;

        doc.setFillColor(255, 255, 255);
        doc.setDrawColor(...COLOR_LINE);
        doc.roundedRect(x, yStart, boxW, boxH, 8, 8, "FD");

        const row = (label, value, yy, bold = false) => {
          doc.setFont("Helvetica", bold ? "bold" : "normal");
          doc.setFontSize(11);
          doc.setTextColor(...COLOR_TEXT);
          doc.text(label, x + 12, yy);
          doc.text(value, x + boxW - 12, yy, { align: "right" });
        };

        row("Total HT", t.total_ht.toFixed(2) + " ‚Ç¨", yStart + 28);
        row("TVA 20 %", t.tva.toFixed(2) + " ‚Ç¨", yStart + 46);
        row("Total TTC", t.total_ttc.toFixed(2) + " ‚Ç¨", yStart + 68, true);

        return yStart + boxH;
      };

      // ----- TABLEAU -----
      const rows = (d.lignes || []).map((l) => [
        l.designation || "-",
        String(l.quantite),
        (Number(l.pu_net_ht) || 0).toFixed(2),
        (Number(l.total_ligne_ht) || 0).toFixed(2),
      ]);

      drawHeader();
      let cursorY = drawClientCard(margin + 90);

      doc.autoTable({
        startY: cursorY,
        head: [["D√©signation", "Qt√©", "PU HT", "Total HT"]],
        body: rows,

        styles: {
          font: "helvetica",
          fontSize: 10,
          cellPadding: 6,
          textColor: COLOR_TEXT,
          lineColor: BORDER_SOFT,
          lineWidth: 0.5
        },

        headStyles: {
          fillColor: BG_HEAD,
          textColor: COLOR_TEXT,
          lineColor: BORDER_SOFT,
          lineWidth: 0.6,
          fontStyle: "bold"
        },

        alternateRowStyles: { fillColor: BG_ALT },

        margin: { left: margin, right: margin },
        theme: "grid",
        didDrawPage: () => drawHeader(),
      });

      const afterTableY = doc.lastAutoTable.finalY + 16;
      const afterTotalsY = drawTotalsBox(afterTableY);

      doc.setPage(doc.internal.getNumberOfPages());
      drawTechNotice(afterTotalsY + 20);

      const pageCount = doc.internal.getNumberOfPages();
      for (let i = 1; i <= pageCount; i++) {
        doc.setPage(i);
        drawFooter(i, pageCount);
      }

      // ----- EMAIL SILENCIEUX -----
      await sendEmail({ client, devis: d });

      // ----- ENREGISTREMENT BD + UPLOAD (ne doit pas emp√™cher le download) -----
      let profileEmail = "";
      try {
        profileEmail = JSON.parse(localStorage.getItem("cofel_client_profile") || "{}").email;
      } catch {}

      try{
        const logResp = await fetch("https://cofel-auth.sonveven.workers.dev/log-quote", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            clientEmail: profileEmail,
            clientCompany: client.societe,
            clientName: client.contact,
            productType: "devis-index",
            totalHT: t.total_ht,
            totalTTC: t.total_ttc,
            extra: {
              chantier: client.chantier,
              date: new Date().toISOString(),
              lignes: d.lignes || [],
            },
          }),
        });

        const logData = await logResp.json().catch(()=> ({}));
        window.lastCreatedQuoteId = logData.quoteId || null;

        // PDF ‚Üí base64 (pour upload)
        const pdfBlob = doc.output("blob");
        const pdfBase64 = await new Promise((resolve) => {
          const fr = new FileReader();
          fr.onloadend = () => resolve(fr.result.split(",")[1]);
          fr.readAsDataURL(pdfBlob);
        });

        if (window.lastCreatedQuoteId) {
          await fetch("https://cofel-auth.sonveven.workers.dev/upload-pdf", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              quoteId: window.lastCreatedQuoteId,
              pdfBase64,
              clientCompany: client.societe,
              productType: "devis-index",
              createdAt: new Date().toISOString(),
            }),
          });
        } else {
          console.warn("‚ö†Ô∏è quoteId manquant : upload PDF ignor√©.");
        }
      }catch(e){
        console.warn("‚ö†Ô∏è Log/Upload √©chou√© (download conserv√©) :", e);
      }

      // ----- DOWNLOAD LOCAL : PDF + CSV (CSV seulement admin) -----
      doc.save("Devis-Cofel.pdf");

      // CSV EBP (admin seulement)
      const docRef = makeDocRef();
      exportEbpCsvDownload({ devis: d, client, docRef });

    } catch (err) {
      alert("Erreur PDF : " + err.message);
      console.error(err);
    }
  });

  // üîÅ Boot devis robuste : recharge + render, et se relance √† chaque retour/focus
  function bootDevis() {
    repairStoredLines();

    try {
      if (window.Devis && typeof Devis.reload === "function") {
        Devis.reload();
      }
    } catch (e) {
      console.warn("Reload devis impossible", e);
    }

    render();
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", bootDevis, { once: true });
  } else {
    bootDevis();
  }

  window.addEventListener("pageshow", bootDevis);
  window.addEventListener("focus", bootDevis);
  document.addEventListener("visibilitychange", () => {
    if (!document.hidden) bootDevis();
  });

  // üö™ D√©connexion (client + admin)
  (function setupLogout(){
    const btn = document.getElementById("logoutBtn");
    if (!btn) return;

    btn.addEventListener("click", () => {
      try {
        localStorage.removeItem("cofel_client_profile");
        Object.keys(localStorage).forEach(key => {
          if (key.startsWith("auth_token_")) localStorage.removeItem(key);
        });
      } catch (e) {
        console.error("Erreur nettoyage stockage lors de la d√©connexion", e);
      }
      location.href = "/auth/client-login.html";
    });
  })();

  })();
  </script>

  <!-- Lien Admin (invisible par d√©faut) -->
  <div id="admin-links" style="
      display:none;
      position:fixed;
      top:12px;
      right:12px;
      z-index:9999;
      background:#5a2d82;
      color:white;
      padding:8px 15px;
      border-radius:12px;
      font-size:14px;
  ">
      <a href="/auth/admin-clients.html" style="color:white; text-decoration:none; margin-right:10px;">üë§ Admin Clients</a>
      <a href="/auth/admin-quotes.html" style="color:white; text-decoration:none;">üìÑ Admin Devis</a>
  </div>

  <script>
    // Afficher le lien Admin seulement pour l'administrateur
    const profile = JSON.parse(localStorage.getItem("cofel_client_profile") || "{}");
    if (profile.email === "commercial@cofel72.fr") {
      document.getElementById("admin-links").style.display = "block";
    }
  </script>
</body>
</html>

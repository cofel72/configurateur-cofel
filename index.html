<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Configurateurs Cofel</title>

  <!-- üîí Protection par mot de passe -->
  <script src="./auth/lock.js" type="module"></script>

  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <style>
    :root{
      --cofel:#5a2d82; --cofel-2:#7838a7;
      --glass: rgba(255,255,255,.08); --glass-hr: rgba(255,255,255,.14);
      --txt:#f5f7ff; --txt-dim:#e6e6ff; --accent:#c9b7ff;
      --radius:18px; --blur:18px; --shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--txt);
      font-family:-apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, Arial, sans-serif;
      background:
        radial-gradient(800px 500px at 20% -10%, rgba(255,255,255,.10), transparent 60%),
        radial-gradient(800px 500px at 110% 10%, rgba(255,255,255,.08), transparent 60%),
        linear-gradient(135deg, var(--cofel), var(--cofel-2));
      position:relative; overflow-x:hidden;
    }

    /* ===================== HEADER / HERO ===================== */
    .hero{
      position:relative; z-index:1;
      padding:24px 20px 16px;
    }
    .hero-inner{
      max-width:1200px; margin:0 auto;
      display:flex; align-items:center; justify-content:space-between; gap:16px;
    }
    .brand-lite{
      display:flex; align-items:center; gap:12px;
    }
    .brand-lite img{
      height:42px; width:auto; object-fit:contain; border-radius:8px;
    }
    .brand-lite h1{
      font-size: clamp(18px, 2.4vw, 22px); margin:0; letter-spacing:.2px; font-weight:700;
    }
    .hero-tagline{
      max-width:1200px; margin:10px auto 0; padding:0 20px; color:var(--txt-dim);
    }
    .hero::after{
      content:""; display:block; height:1px; margin-top:14px;
      background: linear-gradient(90deg, rgba(255,255,255,.15), rgba(255,255,255,.04));
    }

    .logout-btn{
      appearance:none; border:none; cursor:pointer; font-weight:700; color:var(--txt);
      background: linear-gradient(180deg, rgba(255,255,255,.14), rgba(255,255,255,.06));
      border:1px solid rgba(255,255,255,.18); border-radius:12px; padding:8px 12px;
      box-shadow: var(--shadow); backdrop-filter: blur(var(--blur));
      opacity:.95; transition: opacity .15s, transform .15s, box-shadow .15s;
    }
    .logout-btn:hover{ opacity:1; transform: translateY(-1px); box-shadow: 0 14px 34px rgba(0,0,0,.42); }

    /* ===================== APPS GRID ===================== */
    .wrap{max-width:1200px; margin:26px auto; padding:0 20px 40px; position:relative; z-index:1;}
    .apps{ display:grid; gap:16px; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); }
    .app{
      position:relative; text-decoration:none; color:var(--txt);
      background: linear-gradient(180deg, rgba(255,255,255,.18), rgba(255,255,255,.08));
      border:1px solid rgba(255,255,255,.2); border-radius:20px; padding:18px 16px;
      box-shadow: var(--shadow); backdrop-filter: blur(var(--blur));
      transform: translateY(0); transition: transform .18s, box-shadow .18s, background .18s, border-color .18s;
    }
    .app:hover{ transform: translateY(-4px); box-shadow: 0 18px 40px rgba(0,0,0,.45); }
    .app .title{ font-weight:800; margin:0 0 6px; letter-spacing:.2px; }
    .app .hint{ color:var(--txt-dim); margin:0; font-size:13px; }

    /* ===================== PANEL (devis + client) ===================== */
    .panel{
      margin-top:28px;
      background: linear-gradient(180deg, rgba(255,255,255,.16), rgba(255,255,255,.06));
      border:1px solid rgba(255,255,255,.2);
      border-radius:20px; padding:18px;
      box-shadow: var(--shadow); backdrop-filter: blur(var(--blur));
    }
    .panel h2{ margin:0 0 12px; font-size: clamp(18px, 2.4vw, 22px); letter-spacing:.2px; }

    .client-card{
      margin:12px 0 16px;
      background: linear-gradient(180deg, rgba(255,255,255,.14), rgba(255,255,255,.06));
      border:1px solid rgba(255,255,255,.18);
      border-radius:16px;
      padding:14px;
      display:grid; gap:12px;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    }
    label{font-weight:700; font-size:12px; color:var(--accent);}
    input[type="text"], input[type="number"]{
      width:100%; margin-top:6px; padding:10px 12px;
      background: rgba(255,255,255,.08); color:var(--txt);
      border:1px solid rgba(255,255,255,.18); border-radius:12px; outline:none;
      transition: border-color .18s ease, background .18s ease;
    }
    input[type="text"]::placeholder, input[type="number"]::placeholder{ color: #f0edff; opacity:.75; }
    input[type="text"]:focus, input[type="number"]:focus{ border-color: rgba(255,255,255,.34); background: rgba(255,255,255,.12); }

    .table-wrap{overflow:auto; border-radius:14px; border:1px solid rgba(255,255,255,.16);}
    table{width:100%; border-collapse:collapse; min-width:720px;}
    thead tr{ background: linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.04)); }
    th, td{ padding:10px 12px; text-align:left; }
    th{ font-size:12px; color:var(--accent); letter-spacing:.3px; }
    tbody tr + tr td{ border-top:1px solid rgba(255,255,255,.12); }
    td.right{ text-align:right; } td.center{ text-align:center; }

    .totaux{ margin-top:16px; display:flex; justify-content:space-between; gap:16px; align-items:flex-start; flex-wrap:wrap; }
    .totaux-box{
      min-width:320px; border-radius:16px; padding:12px 14px;
      background: linear-gradient(180deg, rgba(255,255,255,.14), rgba(255,255,255,.06));
      border:1px solid rgba(255,255,255,.18);
    }
    .row{ display:flex; justify-content:space-between; padding:6px 0; border-bottom:1px dashed rgba(255,255,255,.16); }
    .row:last-child{ border-bottom:none; padding-bottom:0; }
    .grand{ font-weight:800; font-size:18px; }
    .subnote{ color:var(--txt-dim); font-size:12px; margin-top:6px; }

    .btn{
      appearance:none; border:none; cursor:pointer; font-weight:700;
      color:#0b0b0b; background:#fff; border-radius:12px; padding:10px 14px;
      box-shadow: 0 10px 24px rgba(0,0,0,.25);
      transition: transform .16s ease, box-shadow .16s ease, opacity .16s ease;
    }
    .btn:active{ transform: translateY(1px); box-shadow: 0 6px 16px rgba(0,0,0,.28); }
    .btn-ghost{ background: transparent; color:var(--txt); border:1px solid rgba(255,255,255,.24); }
    .btn-danger{ background: transparent; color:#ffe3e3; border:1px solid rgba(255, 107, 107, .45); }
    .btn[disabled]{ opacity:.45; cursor:not-allowed; box-shadow:none; pointer-events:none; }

    footer{ color:#f3ecff; font-size:12px; text-align:center; padding:24px 10px; opacity:.9; }
    @media (max-width:720px){ .brand h1{display:none;} }

    .toast{ position:fixed; right:16px; bottom:16px; background:#fff; color:#222; padding:10px 12px; border-radius:10px; box-shadow:0 10px 24px rgba(0,0,0,.35); display:none; z-index:99; }
    .toast.show{ display:block; }
  </style>
</head>
<body>

  <!-- ===================== HEADER ===================== -->
  <header class="hero">
    <div class="hero-inner">
      <div class="brand-lite">
        <img src="./assets/logo cofel.jpg" alt="Cofel" />
        <h1>Configurateurs Cofel</h1>
      </div>

      <button id="logoutBtn" class="logout-btn" title="Se d√©connecter">
        üö™ Se d√©connecter
      </button>
    </div>

    <p class="hero-tagline">
      Choisissez un configurateur puis composez votre devis en quelques clics.
      L‚Äôaper√ßu et l‚Äôexport PDF sont mis √† jour automatiquement.
    </p>
  </header>


  <!-- ===================== APPS GRID ===================== -->
  <main class="wrap">

    <section class="apps" aria-label="Liste des configurateurs">
      <a class="app" href="./configurateurs/configurateur-tole-tablette.html">
        <p class="title">T√¥le Tablette</p>
        <p class="hint">Ajourage, PMMA, ch√¢ssis</p>
      </a>

      <a class="app" href="./configurateurs/configurateur-rampe-lumineuse.html">
        <p class="title">Rampe Lumineuse (PLL)</p>
        <p class="hint">LED + laquage inclus</p>
      </a>

      <a class="app" href="./configurateurs/configurateur-enseigne-drapeau.html">
        <p class="title">Enseigne Drapeau</p>
        <p class="hint">Rond / Carr√©, potence</p>
      </a>

      <a class="app" href="./configurateurs/configurateur-totems.html">
        <p class="title">Totems</p>
        <p class="hint">Hauteur & installation</p>
      </a>

      <a class="app" href="./configurateurs/configurateur-lettres PVC.html">
        <p class="title">Lettres PVC</p>
        <p class="hint">Hauteur, chant, finitions</p>
      </a>

      <a class="app" href="./configurateurs/configurateur-lettre-alu-alupvc.html">
        <p class="title">Lettres Alu / Alu-PVC</p>
        <p class="hint">Finitions et options</p>
      </a>

      <a class="app" href="./configurateurs/configurateur-lettre-boitier.html">
        <p class="title">Lettres Bo√Ætiers</p>
        <p class="hint">Face PMMA ou Dibond</p>
      </a>

      <a class="app" href="./configurateurs/configurateur-tolerie-dibond.html">
        <p class="title">T√¥lerie Alu / Dibond</p>
        <p class="hint">Au m¬≤, laqu√© / pr√©laqu√©</p>
      </a>
    </section>


    <!-- ===================== PANEL R√âCAPITULATIF ===================== -->
    <section class="panel" aria-label="R√©capitulatif du devis">
      <h2>üßæ R√©capitulatif du devis</h2>

      <div class="client-card">
        <div>
          <label for="societe">Entreprise</label>
          <input type="text" id="societe" placeholder="Nom de l‚Äôentreprise">
        </div>
        <div>
          <label for="contact">Nom & pr√©nom</label>
          <input type="text" id="contact" placeholder="Nom Pr√©nom">
        </div>
        <div>
          <label for="chantier">Nom du chantier</label>
          <input type="text" id="chantier" placeholder="Nom du chantier">
        </div>

        <!-- Champ remise client (cach√©) -->
        <div style="display:none;">
          <label for="remise-client">Remise client (%)</label>
          <input type="number" id="remise-client" value="0">
        </div>
      </div>


      <!-- Tableau devis -->
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>D√©signation</th>
              <th>Qt√©</th>
              <th class="right">PU HT (net)</th>
              <th class="right">Total HT</th>
              <th class="center">Actions</th>
            </tr>
          </thead>

          <tbody id="bodyDevis">
            <tr>
              <td colspan="5" style="padding:12px;color:var(--txt-dim)">
                Aucune ligne dans le devis.
              </td>
            </tr>
          </tbody>

        </table>
      </div>

      <!-- Totaux -->
      <div class="totaux">
        <div class="totaux-box">
          <div class="row"><div>Total HT</div><div id="totHT">0,00 ‚Ç¨</div></div>
          <div class="row"><div>TVA 20 %</div><div id="totTVA">0,00 ‚Ç¨</div></div>
          <div class="row grand"><div>Total TTC</div><div id="totTTC">0,00 ‚Ç¨</div></div>
          <div class="subnote">La remise ne s‚Äôapplique pas au transport.</div>
        </div>

        <!-- Carte transport -->
        <a class="app-inline" href="./transport.html" title="Calculer le co√ªt de transport">
          <div style="font-size:22px">üöö</div>
          <div>
            <p class="title">Co√ªt de transport</p>
            <p class="hint">Messagerie / Affr√®tement ‚Ä¢ Ajouter au devis</p>
          </div>
        </a>
      </div>

      <!-- Boutons devis -->
      <div style="margin-top:16px; display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
        <button id="btnPdf" class="btn" disabled>
          üìÑ Exporter le devis en PDF
        </button>

        <button id="btnClear" class="btn btn-danger">
          üóë Vider le devis
        </button>

        <div id="noteInfo" class="note-info">
          üí° Veuillez renseigner l‚Äôentreprise, le nom du contact et le chantier.
        </div>
      </div>
    </section>

  </main>


  <footer>
    ¬© Cofel ‚Äî ZA du Perquoi, 72560 Chang√© ‚Äî SIRET 927 659 458 00024 ‚Äî TVA FR80927659458
  </footer>


  <!-- zone toast -->
  <div id="toast" class="toast"></div>
<!-- Core devis -->
<script src="./js/devis-core.js"></script>

<!-- jsPDF + AutoTable -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.3/jspdf.plugin.autotable.min.js"></script>

<script>
/* ============================================================
   UTILITAIRES
============================================================ */
const fmt = n => (Number(n)||0).toFixed(2).replace('.', ',') + " ‚Ç¨";
const STORAGE_KEY = "devisCourant_v1";
const TVA_RATE = 0.20;
function readStore(){ try{ return JSON.parse(localStorage.getItem(STORAGE_KEY)||"{}"); }catch{return {};}}
function writeStore(obj){ localStorage.setItem(STORAGE_KEY, JSON.stringify(obj)); }

function updateClientField(key, value){
  const state = readStore(); if(!state.client) state.client = {};
  state.client[key] = value; writeStore(state);
}
function getClient(){ const st = readStore(); return st.client || {}; }

/* ============================================================
   TOTaux (remise pas appliqu√©e ici : la logique reviendra apr√®s)
============================================================ */
function totalsExcludingTransportDiscount(d){
  const lignes = d?.lignes || [];
  let sumTransport = 0, sumNon = 0;

  for(const l of lignes){
    const q = Number(l.quantite)||0;
    const pu = Number(l.pu_net_ht)||0;
    const total = q * pu;
    if((l.type || "").toLowerCase()==="transport") sumTransport += total;
    else sumNon += total;
  }

  const total_ht = +(sumTransport + sumNon).toFixed(2);
  const tva = +(total_ht * TVA_RATE).toFixed(2);
  const total_ttc = +(total_ht + tva).toFixed(2);
  return { total_ht, tva, total_ttc };
}

/* ============================================================
   DOM REFERENCES
============================================================ */
const elRemise   = document.getElementById('remise-client');
const body       = document.getElementById('bodyDevis');
const elHT       = document.getElementById('totHT');
const elTVA      = document.getElementById('totTVA');
const elTTC      = document.getElementById('totTTC');
const elSociete  = document.getElementById('societe');
const elContact  = document.getElementById('contact');
const elChantier = document.getElementById('chantier');
const btnPdf     = document.getElementById('btnPdf');
const btnClear   = document.getElementById('btnClear');
const noteInfo   = document.getElementById('noteInfo');

/* ============================================================
   VALIDATION EXPORT PDF
============================================================ */
function validateExportEnabled(){
  const filled=v=>(v||"").trim().length>0;
  const ok = filled(elSociete.value) && filled(elContact.value) && filled(elChantier.value);
  btnPdf.disabled = !ok;
  if(noteInfo) noteInfo.style.display = ok ? "none" : "block";
}

/* ============================================================
   CHARGEMENT PROFIL CLIENT
============================================================ */
(function hydrateClient(){
  try{
    const rawProfile = localStorage.getItem('cofel_client_profile');
    if(rawProfile){
      const profile = JSON.parse(rawProfile);

      if(profile.company && !elSociete.value) elSociete.value = profile.company;
      if(profile.contactName && !elContact.value) elContact.value = profile.contactName;

      // Stocker la remise sans l'appliquer encore ‚Üí logique Option C
      if(typeof profile.discountRate==="number"){
        elRemise.value = Math.round(profile.discountRate * 100);
      }
    }
  }catch(e){console.error("Erreur profil client :",e);}

  // Recharger devis d√©j√† pr√©sent
  const c = getClient();
  if(c.societe) elSociete.value = c.societe;
  if(c.contact) elContact.value = c.contact;
  if(c.chantier) elChantier.value = c.chantier;

  validateExportEnabled();
})();

/* ============================================================
   LISTENERS FORM
============================================================ */
[['societe',elSociete],['contact',elContact],['chantier',elChantier]]
.forEach(([k,el])=>{
  el?.addEventListener('input',()=>{
    updateClientField(k,el.value);
    validateExportEnabled();
  });
});

/* ============================================================
   RENDER TABLE
============================================================ */
function render(){
  const d = Devis.computeTotals();

  if(!d.lignes.length){
    body.innerHTML = `<tr><td colspan="5" style="padding:12px;color:#f0edff">
      Aucune ligne dans le devis.
    </td></tr>`;
  }else{
    body.innerHTML = d.lignes.map(l=>`
      <tr data-id="${l.id}">
        <td>${l.designation||"-"}</td>
        <td class="center">${l.quantite}</td>
        <td class="right">${fmt(l.pu_net_ht)}</td>
        <td class="right">${fmt(l.total_ligne_ht)}</td>
        <td class="center">
          <button class="btn btn-ghost btn-qty">üìù Qt√©</button>
          <button class="btn btn-danger btn-del">Suppr.</button>
        </td>
      </tr>`).join("");
  }

  const t = totalsExcludingTransportDiscount(d);
  elHT.textContent = fmt(t.total_ht);
  elTVA.textContent = fmt(t.tva);
  elTTC.textContent = fmt(t.total_ttc);
}

/* ============================================================
   SUPPRESSION & MODIF QUANTIT√âS
============================================================ */
body.addEventListener('click',e=>{
  const tr = e.target.closest('tr[data-id]');
  if(!tr) return;
  const id = tr.getAttribute('data-id');

  if(e.target.classList.contains('btn-del')){
    if(confirm("Supprimer cette ligne ?")){
      Devis.removeLine(id);
      render();
    }
  }

  if(e.target.classList.contains('btn-qty')){
    const current = Number(tr.children[1].textContent||1);
    const q = prompt("Nouvelle quantit√© :",current);
    if(q!==null){
      Devis.updateQty(id,q);
      render();
    }
  }
});

/* ============================================================
   VIDER DEVIS
============================================================ */
btnClear.addEventListener('click',()=>{
  if(confirm("Vider enti√®rement le devis ?")){
    Devis.clearAll(true);
    render();
    validateExportEnabled();
  }
});

/* ============================================================
   TRANSPORT
============================================================ */
function addTransportLine(payload){
  const st = readStore();
  if(!st.lignes) st.lignes=[];
  if(!st.lignes.some(l=>l.id===payload.id)){
    const q=Number(payload.quantite||1);
    const pu=Number(payload.pu_net_ht||0);
    st.lignes.push({
      id:payload.id,
      designation:payload.designation||"Transport",
      quantite:q,
      pu_net_ht:pu,
      total_ligne_ht:+(q*pu).toFixed(2),
      type:"transport"
    });
    writeStore(st);
    try{Devis.reload&&Devis.reload();}catch{}
    render();
  }
}

function checkTransportInbox(){
  const raw = localStorage.getItem('cofel_transport_add');
  if(!raw) return;
  try{
    const payload = JSON.parse(raw);
    if(payload && payload.id) addTransportLine(payload);
  }catch{}
  localStorage.removeItem('cofel_transport_add');
}

checkTransportInbox();

/* ============================================================
   EXPORT PDF
   (inchang√©, version fiable et fonctionnelle)
============================================================ */
document.getElementById("btnPdf").addEventListener("click", async()=>{

  try{
    const { jsPDF } = window.jspdf;

    const d = Devis.computeTotals();
    const t = totalsExcludingTransportDiscount(d);

    const client = {
      societe: elSociete.value.trim(),
      contact: elContact.value.trim(),
      chantier: elChantier.value.trim(),
    };

    const doc = new jsPDF({unit:"pt",format:"a4",compress:true});
    const margin=40;
    const pageWidth=doc.internal.pageSize.getWidth();
    const pageHeight=doc.internal.pageSize.getHeight();

    // Logo
    async function loadLogo(src){
      const resp = await fetch(src,{cache:"no-cache"});
      const blob = await resp.blob();
      return new Promise(resolve=>{
        const fr = new FileReader();
        fr.onload=()=>resolve(fr.result);
        fr.readAsDataURL(blob);
      });
    }

    let logo=null;
    try{logo=await loadLogo("./assets/logo cofel.jpg");}catch{}

    // Header
    function drawHeader(){
      if(logo) doc.addImage(logo,"JPEG",margin,margin,160,45);

      doc.setFont("Helvetica","bold");
      doc.setFontSize(20);
      doc.text("DEVIS", pageWidth - margin, margin+12,{align:"right"});

      doc.setFont("Helvetica","normal");
      doc.setFontSize(10);
      doc.text("COFEL ‚Äî ZA du Perquoi ‚Äî 72560 Chang√©",pageWidth-margin,margin+30,{align:"right"});
      doc.text("Date : "+new Date().toLocaleDateString("fr-FR"),pageWidth-margin,margin+44,{align:"right"});
    }

    drawHeader();

    // Carte client
    function drawClientCard(y){
      doc.setFont("Helvetica","bold");
      doc.setFontSize(12);
      doc.text("Client :",margin,y);

      doc.setFont("Helvetica","normal");
      doc.text("Entreprise : "+client.societe,margin,y+18);
      doc.text("Contact : "+client.contact,margin,y+34);
      doc.text("Chantier : "+client.chantier,margin,y+50);

      return y+70;
    }

    let cursor = drawClientCard(margin+70);

    const rows = (d.lignes||[]).map(l=>[
      l.designation||"-",
      String(l.quantite),
      (Number(l.pu_net_ht)||0).toFixed(2),
      (Number(l.total_ligne_ht)||0).toFixed(2)
    ]);

    doc.autoTable({
      startY:cursor,
      head:[["D√©signation","Qt√©","PU HT","Total HT"]],
      body:rows,
      margin:{left:margin,right:margin},
      theme:"grid",
      headStyles:{fillColor:[90,45,130]}
    });

    const after = doc.lastAutoTable.finalY + 20;

    // Totaux
    doc.setFontSize(12);
    doc.text("Total HT : "+t.total_ht.toFixed(2)+" ‚Ç¨",margin,after);
    doc.text("TVA 20% : "+t.tva.toFixed(2)+" ‚Ç¨",margin,after+18);
    doc.setFont("Helvetica","bold");
    doc.text("Total TTC : "+t.total_ttc.toFixed(2)+" ‚Ç¨",margin,after+36);

    // Enregistrement BD Worker
    let email="";
    try{
      email = JSON.parse(localStorage.getItem("cofel_client_profile")||"{}").email;
    }catch{}

    const logResp = await fetch("https://cofel-auth.sonveven.workers.dev/log-quote",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({
        clientEmail:email,
        clientCompany:client.societe,
        clientName:client.contact,
        productType:"devis-index",
        totalHT:t.total_ht,
        totalTTC:t.total_ttc,
        extra:{
          chantier:client.chantier,
          date:new Date().toISOString(),
          lignes:d.lignes||[]
        }
      })
    });

    const logData = await logResp.json();
    window.lastCreatedQuoteId = logData.quoteId || null;

    const pdfBlob = doc.output("blob");
    const base64 = await new Promise(resolve=>{
      const fr=new FileReader();
      fr.onloadend=()=>resolve(fr.result.split(",")[1]);
      fr.readAsDataURL(pdfBlob);
    });

    if(window.lastCreatedQuoteId){
      await fetch("https://cofel-auth.sonveven.workers.dev/upload-pdf",{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({
          quoteId:window.lastCreatedQuoteId,
          pdfBase64:base64,
          clientCompany:client.societe,
          productType:"devis-index",
          createdAt:new Date().toISOString()
        })
      });
    }

    doc.save("Devis-Cofel.pdf");

  }catch(err){
    alert("Erreur PDF : "+err.message);
    console.error(err);
  }

});

/* ============================================================
   AFFICHAGE ADMIN
============================================================ */
(function adminAccess(){
  const profile = JSON.parse(localStorage.getItem("cofel_client_profile")||"{}");
  if(profile.email==="commercial@cofel72.fr"){
    document.getElementById("admin-links").style.display = "block";
  }
})();

/* ============================================================
   DECONNEXION
============================================================ */
(function setupLogout(){
  const btn = document.getElementById("logoutBtn");
  if(!btn) return;

  btn.addEventListener("click",()=>{
    try{
      localStorage.removeItem("cofel_client_profile");

      // Suppression des tokens admin
      Object.keys(localStorage).forEach(k=>{
        if(k.startsWith("auth_token_")) localStorage.removeItem(k);
      });

    }catch{}

    const parts = location.pathname.split("/").filter(Boolean);
    const project = parts.length ? parts[0] : "";
    location.href = `/${project}/auth/client-login.html`;
  });
})();

/* ============================================================
   SWITCH GLOBAL (AUCUNE LOGIQUE POUR LE MOMENT ‚Äî OPTION C)
============================================================ */
const pmLabel = document.getElementById("priceModeLabel");
const pmToggle = document.getElementById("priceModeToggle");

let priceMode = localStorage.getItem("cofel_price_mode") || "client";

function updatePriceModeDisplay(){
  if(priceMode==="pro"){
    pmLabel.textContent = "Mode Prix Remis√©";
    pmToggle.checked = true;
  }else{
    pmLabel.textContent = "Mode Client Final";
    pmToggle.checked = false;
  }
}

pmToggle.addEventListener("change",()=>{
  priceMode = pmToggle.checked ? "pro" : "client";
  localStorage.setItem("cofel_price_mode",priceMode);
  updatePriceModeDisplay();
});

updatePriceModeDisplay();

/* ============================================================
   INITIAL RENDER
============================================================ */
render();
</script>

